<!DOCTYPE html>
<!--
MIT License

Copyright (c) 2024 BR HERMOSO

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
-->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador EPVSA 2024-2030 - Versión Mejorada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Librerías para generar documentos Word -->
    <!-- docx.js eliminado - no necesario -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Librería para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        .license-footer {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .version-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-bottom: 3px solid #e5e7eb;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #667eea;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 0.5rem;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 1.25rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
            color: #6b7280;
            white-space: nowrap;
            position: relative;
        }

        .tab.completed::after {
            content: '✓';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #16a34a;
            color: white;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .tab:hover {
            background: white;
            color: #667eea;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        .tab-content {
            padding: 2rem;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-indicator {
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 800;
            flex-shrink: 0;
        }

        .step-text {
            flex: 1;
        }

        .step-text h3 {
            font-size: 1.2rem;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .step-text p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .alert-info {
            background: #dbeafe;
            border: 2px solid #93c5fd;
            color: #1e40af;
        }

        .alert-success {
            background: #dcfce7;
            border: 2px solid #86efac;
            color: #166534;
        }

        .alert-warning {
            background: #fef3c7;
            border: 2px solid #fcd34d;
            color: #92400e;
        }

        .alert-danger {
            background: #fee2e2;
            border: 2px solid #fca5a5;
            color: #991b1b;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            background: #f0f4ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 2rem;
        }

        .upload-zone:hover {
            border-color: #764ba2;
            background: #e0e7ff;
        }

        .upload-zone.dragging {
            border-color: #16a34a;
            background: #dcfce7;
        }

        /* MEJORA 8: Modal Tutorial */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem 1rem 0 0;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1rem 2rem;
            border-top: 2px solid #e5e7eb;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Estilos para el tutorial interactivo */
        .tutorial-overlay {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s ease;
        }

        .tutorial-overlay.active {
            display: block;
        }

        .tutorial-spotlight {
            position: relative;
            z-index: 2001;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.7);
            border-radius: 0.5rem;
            animation: pulse 2s ease-in-out infinite;
        }

        .tutorial-tooltip {
            position: fixed;
            z-index: 2002;
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }

        .tutorial-tooltip h3 {
            color: #667eea;
            margin-bottom: 0.75rem;
            font-size: 1.25rem;
        }

        .tutorial-tooltip p {
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .tutorial-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .tutorial-progress-bar {
            flex: 1;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }

        .tutorial-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .tutorial-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 9999px rgba(0,0,0,0.7), 0 0 20px rgba(102, 126, 234, 0.5); }
            50% { box-shadow: 0 0 0 9999px rgba(0,0,0,0.7), 0 0 40px rgba(102, 126, 234, 0.8); }
        }

        /* Botones de año para cuadro de mandos */
        .year-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 1rem;
            min-width: 80px;
        }

        .year-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
        }

        .year-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            color: white !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* MEJORA 3: Sugerencias Inteligentes */
        .suggestion-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #38bdf8;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .suggestion-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .suggestion-icon {
            font-size: 2rem;
        }

        .suggestion-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #0369a1;
        }

        .suggestion-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }

        .suggestion-item {
            display: flex;
            align-items: start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: white;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .suggestion-check {
            width: 20px;
            height: 20px;
            margin-top: 0.1rem;
        }

        /* MEJORA 5: Plantillas de Actuaciones */
        .plantilla-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plantilla-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .plantilla-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .plantilla-icon {
            font-size: 1.5rem;
        }

        .plantilla-title {
            font-weight: 700;
            color: #1f2937;
            font-size: 0.95rem;
            flex: 1;
        }

        .plantilla-btn {
            padding: 0.35rem 0.75rem;
            font-size: 0.8rem;
        }

        .plantilla-descripcion {
            color: #6b7280;
            font-size: 0.85rem;
            line-height: 1.5;
            padding-left: 2.25rem;
        }

        /* MEJORA 2: Panel de Validación */
        .validation-panel {
            background: white;
            border: 3px solid #f59e0b;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .validation-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .validation-item {
            display: flex;
            align-items: start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .validation-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .validation-text {
            flex: 1;
            font-size: 0.9rem;
        }

        .validation-status {
            font-weight: 700;
            margin-right: 0.5rem;
        }

        /* MEJORA 10: Botón Info EPVSA */
        .epvsa-info-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .epvsa-info-btn:hover {
            background: #2563eb;
        }

        /* Estilos adicionales del árbol jerárquico */
        .tree-container {
            margin-top: 2rem;
        }

        .tree-linea {
            background: white;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tree-linea-header {
            padding: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s;
        }

        .tree-linea-header:hover {
            opacity: 0.9;
        }

        .tree-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .tree-expand {
            font-size: 1.2rem;
            transition: transform 0.3s;
            flex-shrink: 0;
        }

        .tree-expand.expanded {
            transform: rotate(90deg);
        }

        .tree-linea-title {
            flex: 1;
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
        }

        .tree-linea-count {
            background: rgba(255,255,255,0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
        }

        .tree-linea-content {
            display: none;
            padding: 0 1.5rem 1.5rem 1.5rem;
            background: #f9fafb;
        }

        .tree-linea-content.show {
            display: block;
        }

        .tree-objetivo {
            background: white;
            border-left: 4px solid;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .tree-objetivo-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .tree-objetivo-id {
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .tree-objetivo-nombre {
            flex: 1;
            font-weight: 600;
            color: #1f2937;
        }

        .tree-objetivo-toggle {
            font-size: 0.9rem;
            color: #6b7280;
            flex-shrink: 0;
        }

        .tree-objetivo-content {
            display: none;
            margin-top: 1rem;
            padding-left: 2rem;
        }

        .tree-objetivo-content.show {
            display: block;
        }

        .tree-section {
            margin-bottom: 1rem;
        }

        .tree-section-title {
            font-weight: 700;
            color: #4b5563;
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tree-section-icon {
            font-size: 1rem;
        }

        .tree-list {
            list-style: none;
            padding: 0;
        }

        .tree-list-item {
            padding: 0.5rem;
            background: #f9fafb;
            border-radius: 0.25rem;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: #374151;
            line-height: 1.5;
        }

        .tree-programa {
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .tree-programa-codigo {
            display: inline-block;
            background: #f59e0b;
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .tree-programa-nombre {
            font-weight: 700;
            color: #92400e;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .tree-actuacion {
            padding: 0.4rem 0.4rem 0.4rem 0rem;
            font-size: 0.85rem;
            color: #78350f;
            line-height: 1.4;
            margin-bottom: 0.25rem;
        }

        /* Entornos y agendas */
        .entorno-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .entorno-card {
            background: white;
            border: 3px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .entorno-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .entorno-card.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .entorno-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .entorno-name {
            font-weight: 700;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .year-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .year-tab {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .year-tab:hover {
            border-color: #667eea;
        }

        .year-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .actividad-registro {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .actividad-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        textarea.input-field {
            min-height: 100px;
            resize: vertical;
        }

        input[type="checkbox"] {
            cursor: pointer;
            accent-color: #667eea;
        }

        input[type="checkbox"]:hover {
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.75rem;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                min-width: 100%;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .entorno-selector {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos para el Compilador Word */
        .compile-section {
            background: #f0fdf4;
            border: 3px solid #16a34a;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .btn-compile {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 0.75rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-compile:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(22, 163, 74, 0.4);
        }

        .btn-compile:active {
            transform: translateY(0);
        }

        .btn-compile:disabled {
            background: #9ca3af !important;
            cursor: not-allowed !important;
            transform: none !important;
        }
    </style>
</head>
<body>
    <!-- MEJORA 8: Modal Tutorial -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>👋 Bienvenido al Planificador EPVSA 2024-2030</h2>
            </div>
            <div class="modal-body">
                <h3 style="color: #667eea; margin-bottom: 1rem;">¿Primera vez usando el planificador?</h3>
                <p style="margin-bottom: 1.5rem; line-height: 1.6; color: #4b5563;">
                    Te guiaremos paso a paso en la elaboración de tu Plan Local de Salud. El proceso completo toma aproximadamente 2-3 horas.
                </p>
                
                <div style="background: #f0f9ff; border-left: 4px solid #38bdf8; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <h4 style="color: #0369a1; margin-bottom: 0.5rem;">📋 Pasos del planificador:</h4>
                    <ol style="margin-left: 1.5rem; color: #4b5563; line-height: 2;">
                        <li><strong>Configuración:</strong> Identifica tu municipio y carga el Perfil de Salud</li>
                        <li><strong>Selección EPVSA:</strong> Elige líneas, objetivos y programas</li>
                        <li><strong>Plan Local:</strong> Genera el documento estructurado</li>
                        <li><strong>Cuadro de Mandos:</strong> Completa los 58 indicadores</li>
                        <li><strong>Agendas Anuales:</strong> Planifica actuaciones por año y entorno</li>
                        <li><strong>Conclusiones:</strong> Revisa y exporta el plan completo</li>
                    </ol>
                </div>

                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <span style="font-size: 1.5rem;">💡</span>
                    <div>
                        <strong>Consejo:</strong> El planificador te sugerirá objetivos según tu área prioritaria. También incluye plantillas de actuaciones para facilitar tu trabajo.
                    </div>
                </div>

                <div class="alert alert-warning">
                    <span style="font-size: 1.5rem;">⚠️</span>
                    <div>
                        <strong>Importante:</strong> Usa el botón "💾 Guardar borrador" para no perder tu progreso si necesitas hacer una pausa.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarTutorial()">Ya sé usarlo</button>
                <button class="btn btn-primary" onclick="iniciarTutorial()">Comenzar tutorial guiado</button>
            </div>
        </div>
    </div>

    <!-- Overlay del Tutorial Interactivo -->
    <div id="tutorialOverlay" class="tutorial-overlay"></div>
    <div id="tutorialTooltip" class="tutorial-tooltip" style="display: none;"></div>


    <!-- MEJORA 10: Modal Info EPVSA -->
    <div id="epvsaInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ℹ️ Información del Programa EPVSA</h2>
            </div>
            <div class="modal-body" id="epvsaInfoBody">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="cerrarEpvsaInfo()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MEJORA 6: Modal Recuperar Borrador -->
    <div id="borradorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>💾 Borrador encontrado</h2>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <span style="font-size: 1.5rem;">📋</span>
                    <div>
                        <strong>Tienes un borrador guardado</strong><br>
                        <span id="borradorFecha">Guardado el: --</span>
                    </div>
                </div>
                <p style="margin: 1rem 0; line-height: 1.6; color: #4b5563;">
                    ¿Deseas recuperar tu trabajo anterior o empezar un nuevo plan desde cero?
                </p>
                <div style="background: #fef3c7; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem;">
                    <strong style="color: #92400e;">⚠️ Atención:</strong>
                    <p style="color: #78350f; font-size: 0.9rem; margin-top: 0.5rem;">
                        Si empiezas de cero, perderás todo el trabajo guardado en el borrador.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="empezarDeCero()">🗑️ Empezar de cero</button>
                <button class="btn btn-primary" onclick="recuperarBorrador()">✅ Recuperar borrador</button>
            </div>
        </div>
    </div>

    <!-- Modal Panel de Administración -->
    <div id="adminModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);">
                <h2>🔐 Panel de Administración RELAS</h2>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
                    <span style="font-size: 1.5rem;">⚠️</span>
                    <div>
                        <strong>Área de Administración</strong><br>
                        Aquí puedes ver todos los planes creados por los municipios RELAS. Esta información es solo para coordinación y análisis.
                    </div>
                </div>
                
                <div id="listaMunicipios" style="margin-top: 2rem;">
                    <h3 style="color: #dc2626; margin-bottom: 1rem;">📊 Municipios con Planes Guardados</h3>
                    <div id="municipiosContainer"></div>
                </div>
                
                <div id="detallesPlan" style="display: none; margin-top: 2rem; border-top: 2px solid #e5e7eb; padding-top: 2rem;">
                    <h3 style="color: #dc2626; margin-bottom: 1rem;">📋 Detalles del Plan</h3>
                    <div id="detallesPlanContainer"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarAdminPanel()">Cerrar</button>
                <button class="btn btn-primary" onclick="exportarTodosDatos()">📥 Exportar Todos los Datos</button>
            </div>
        </div>
    </div>

    <!-- Modal de Login (OCULTO por defecto, TÚ entras directo como admin) -->
    <div id="loginModal" class="modal" style="z-index: 10000; display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);">
                <h2>🔐 Acceso al Sistema</h2>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="background: #dbeafe; border-left: 4px solid #3b82f6;">
                    <span style="font-size: 1.5rem;">👋</span>
                    <div>
                        <strong>Bienvenido al Planificador EPVSA</strong><br>
                        Introduce tus credenciales para acceder
                    </div>
                </div>
                
                <form id="loginForm" onsubmit="intentarLogin(event)" style="margin-top: 2rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                            👤 Usuario:
                        </label>
                        <input 
                            type="text" 
                            id="loginUsuario" 
                            class="input-field" 
                            placeholder="Nombre del municipio o 'admin'"
                            style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 1rem;"
                            required
                            autocomplete="username"
                        >
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">
                            💡 Municipios: introduce el nombre de tu municipio<br>
                            💡 Administrador: escribe "admin"
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                            🔑 Contraseña:
                        </label>
                        <input 
                            type="password" 
                            id="loginPassword" 
                            class="input-field" 
                            placeholder="Tu contraseña"
                            style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 1rem;"
                            required
                            autocomplete="current-password"
                        >
                    </div>
                    
                    <div id="loginError" style="display: none; background: #fee2e2; border: 2px solid #ef4444; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                        <span style="color: #dc2626; font-weight: 600;">❌ Error de acceso</span>
                        <p style="color: #991b1b; margin-top: 0.5rem; font-size: 0.9rem;" id="loginErrorMsg"></p>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 700;">
                        🚀 Acceder al Sistema
                    </button>
                </form>
                
                <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
                    <p style="font-size: 0.9rem; color: #6b7280; text-align: center;">
                        ℹ️ <strong>Municipios:</strong> Si no tienes contraseña, solicítala al coordinador RELAS<br>
                        📧 Contacto: coordinador@relas-andalucia.es
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="appContainer">
        <!-- HEADER -->
        <div class="header">
            <h1 id="headerTitle">🎯 Planificador EPVSA 2024-2030</h1>
            <p id="headerSubtitle">Estrategia para una Vida Saludable en Andalucía</p>
            <span class="version-badge">📋 Sistema de Planificación Local de la Salud</span>
            <div class="license-footer">
                © 2024 BR HERMOSO | Licencia MIT
            </div>
            <!-- MEJORA 6: Botón Guardar Borrador -->
            <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-secondary btn-small" onclick="guardarBorrador()" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white;">
                    💾 Guardar borrador
                </button>
                <button class="btn btn-danger btn-small" onclick="limpiarFormulario()" style="background: rgba(220, 38, 38, 0.8); color: white; border: 2px solid white;">
                    🗑️ Limpiar formulario
                </button>
                <button class="btn btn-small" onclick="cerrarSesion()" style="background: rgba(107, 114, 128, 0.8); color: white; border: 2px solid white;">
                    🚪 Cerrar sesión
                </button>
            </div>
        </div>

        <!-- STATS BAR -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-number" id="statIndicadores">0</div>
                <div class="stat-label">Indicadores CMI</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statProgramas">0</div>
                <div class="stat-label">Programas EPVSA</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statConclusiones">0</div>
                <div class="stat-label">Conclusiones</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statPrioridad">0</div>
                <div class="stat-label">Áreas Prioritarias</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statActuaciones">0</div>
                <div class="stat-label">Actuaciones</div>
            </div>
        </div>

        <!-- Botón de Administración VISIBLE -->
        <div style="text-align: center; padding: 1rem 2rem; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-top: 3px solid #dc2626;">
            <button onclick="verificarAccesoAdmin()" 
                    style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); 
                           color: white; 
                           border: none; 
                           padding: 1rem 2rem; 
                           border-radius: 0.75rem; 
                           font-size: 1.1rem; 
                           font-weight: 700; 
                           cursor: pointer; 
                           box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                           transition: all 0.3s;
                           display: inline-flex;
                           align-items: center;
                           gap: 0.75rem;"
                    onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 12px rgba(220, 38, 38, 0.4)'"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.3)'">
                <span style="font-size: 1.5rem;">🔐</span>
                <span>PANEL DE ADMINISTRACIÓN RELAS</span>
            </button>
            <div style="margin-top: 0.75rem; color: #94a3b8; font-size: 0.85rem;">
                🔑 Gestiona claves y visualiza planes de todos los municipios
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <div class="tab active" data-tab="configuracion">
                <span class="tab-icon">⚙️</span>
                Configuración
            </div>
            <div class="tab" data-tab="lineas">
                <span class="tab-icon">🎯</span>
                Selección EPVSA
            </div>
            <div class="tab" data-tab="plan">
                <span class="tab-icon">📋</span>
                Plan de Acción
            </div>
            <div class="tab" data-tab="agendas">
                <span class="tab-icon">📅</span>
                Agendas Anuales
            </div>
            <div class="tab" data-tab="conclusiones">
                <span class="tab-icon">📦</span>
                Compilador
            </div>
            <div class="tab" data-tab="indicadores">
                <span class="tab-icon">📊</span>
                Cuadro de Mandos
            </div>
        </div>

        <!-- TAB: CONFIGURACIÓN -->
        <div id="configuracion" class="tab-content active">
            <div class="step-indicator">
                <div class="step-number">0</div>
                <div class="step-text">
                    <h3>Diseño asistido de planes locales de salud</h3>
                    <p>Identifica tu municipio y carga el Perfil de Salud Local</p>
                </div>
            </div>

            <!-- NOMBRE DEL MUNICIPIO -->
            <div style="background: white; border: 3px solid #667eea; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                <h3 style="color: #667eea; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    🏛️ Datos del Municipio
                </h3>
                <div class="input-group">
                    <label class="input-label">Municipio *</label>
                    <input type="text" id="nombreMunicipio" class="input-field" 
                           placeholder="Ej: Granada, Málaga, Sevilla..." 
                           style="font-size: 1.1rem; padding: 1rem;">
                </div>
                <div class="input-row" style="margin-top: 1rem;">
                    <div class="input-group">
                        <label class="input-label">Provincia</label>
                        <input type="text" id="provinciaMunicipio" class="input-field" 
                               placeholder="Ej: Granada, Málaga, Sevilla...">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Población</label>
                        <input type="number" id="poblacionMunicipio" class="input-field" 
                               placeholder="Ej: 50000">
                    </div>
                </div>

                <!-- MEJORA 9: Equipo Elaborador -->
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e5e7eb;">
                    <h4 style="color: #667eea; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        👥 Equipo Elaborador del Plan
                    </h4>
                    <div id="equipoElaborador">
                        <div class="input-row" style="margin-bottom: 1rem;">
                            <div class="input-group">
                                <label class="input-label">Coordinador/a</label>
                                <input type="text" id="coordinador" class="input-field" placeholder="Nombre y cargo">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Técnico/a Salud Pública</label>
                                <input type="text" id="tecnicoSalud" class="input-field" placeholder="Nombre y cargo">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label class="input-label">Representante Municipal</label>
                                <input type="text" id="representanteMunicipal" class="input-field" placeholder="Nombre y cargo">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Otros miembros (opcional)</label>
                                <input type="text" id="otrosMiembros" class="input-field" placeholder="Nombres separados por comas">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANALIZADOR DE PDF -->
            <div style="background: white; border: 3px solid #10b981; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                <h3 style="color: #10b981; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    📊 Analizador de Perfil de Salud Local
                </h3>
                
                <div id="uploadZone" class="upload-zone">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📄</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: #10b981; margin-bottom: 0.5rem;">
                        Arrastra tu Perfil de Salud aquí o haz clic para seleccionar
                    </div>
                    <div style="color: #6b7280; font-size: 0.9rem;">
                        Archivo PDF (ejemplo: OI241_Modelo_IS_inf.pdf)
                    </div>
                    <input type="file" id="pdfInput" accept=".pdf" style="display: none;">
                </div>

                <div id="analisisResultados" style="display: none;">
                    <div class="alert alert-success" style="margin-bottom: 1.5rem;">
                        <span style="font-size: 1.5rem;">✅</span>
                        <div>
                            <strong>Perfil analizado correctamente</strong><br>
                            Se han extraído los 58 indicadores del Cuadro de Mandos Integral
                        </div>
                    </div>

                    <!-- ÁREA PRIORITARIA -->
                    <div id="priorizacionCard" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">🎯 ÁREA PRIORITARIA IDENTIFICADA</div>
                        <div style="font-size: 1.8rem; font-weight: 700;">
                            <input type="text" 
                                   id="areaPrioritaria" 
                                   value="Bienestar Emocional"
                                   placeholder="Ej: Bienestar Emocional, Alimentación Saludable..."
                                   style="background: transparent; border: none; border-bottom: 2px solid white; color: white; font-size: 1.8rem; font-weight: 700; width: 100%; outline: none;"
                                   onchange="actualizarAreaPrioritaria(this.value)">
                        </div>
                        <p style="margin-top: 0.5rem; opacity: 0.9; font-size: 0.9rem;">Puedes editar el área según tu diagnóstico local</p>
                    </div>

                    <!-- SESIÓN GRUPO MOTOR -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">📅 SESIÓN DE PRIORIZACIÓN DEL GRUPO-MOTOR</div>
                        <div style="font-size: 1.3rem; font-weight: 700;">
                            <input type="text" 
                                   id="sesionGrupoMotor" 
                                   value="Febrero de 2025"
                                   placeholder="Ej: Febrero de 2025, 15 de marzo de 2024..."
                                   style="background: transparent; border: none; border-bottom: 2px solid white; color: white; font-size: 1.3rem; font-weight: 700; width: 100%; outline: none;"
                                   onchange="state.sesionGrupoMotor = this.value">
                        </div>
                        <p style="margin-top: 0.75rem; opacity: 0.95; font-size: 0.9rem; line-height: 1.5;">
                            En esta sesión, el Grupo-Motor acordó establecer el <strong>Bienestar Emocional</strong> como eje central articulador del II Plan Local de Salud.
                        </p>
                    </div>

                    <!-- CONCLUSIONES PRINCIPALES -->
                    <div style="background: white; border: 3px solid #10b981; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="color: #10b981; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ✅ Conclusiones Principales del Diagnóstico
                        </h3>
                        <div id="conclusionesResumen"></div>
                    </div>

                    <!-- RECOMENDACIONES ESTRATÉGICAS -->
                    <div style="background: white; border: 3px solid #f59e0b; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="color: #f59e0b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            💡 Recomendaciones Estratégicas
                        </h3>
                        <div id="recomendacionesResumen"></div>
                    </div>

                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem; font-size: 1.05rem; padding: 1rem;" onclick="mostrarIndicadoresExtraidos()">
                        📊 Ver Cuadro de Mandos Integral Completo (58 Indicadores)
                    </button>
                </div>

                <div class="alert alert-info" style="margin-top: 1.5rem;">
                    <span style="font-size: 1.5rem;">ℹ️</span>
                    <div>
                        <strong>Análisis Automático</strong><br>
                        El analizador extrae del documento:<br>
                        • 58 indicadores del Cuadro de Mandos Integral completo<br>
                        • 4 conclusiones principales del diagnóstico<br>
                        • 4 recomendaciones estratégicas<br>
                        • Priorización identificada (Bienestar Emocional)
                    </div>
                </div>
            </div>

            <!-- MEJORA 2: Panel de Validación -->
            <div id="validacionConfiguracion" style="display: none;">
                <div class="validation-panel">
                    <div class="validation-header">
                        <span style="font-size: 1.5rem;">🔍</span>
                        <h3 style="color: #f59e0b; font-size: 1.2rem; margin: 0;">Estado de la Configuración</h3>
                    </div>
                    <div id="validacionItems"></div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button id="btnContinuar" class="btn btn-primary" 
                        style="font-size: 1.1rem; padding: 1rem 2rem;" 
                        onclick="continuarAPlanificacion()">
                    ➡️ Continuar a Planificación
                </button>
            </div>
        </div>

        <!-- TAB: LÍNEAS ESTRATÉGICAS -->
        <div id="lineas" class="tab-content">
            <div class="step-indicator">
                <div class="step-number">1</div>
                <div class="step-text">
                    <h3>Líneas Estratégicas del Plan Local de Salud</h3>
                    <p>Selecciona las líneas, objetivos, indicadores, programas y actuaciones de la EPVSA 2024-2030</p>
                </div>
            </div>

            <!-- MENSAJE CUANDO NO HAY PERFIL CARGADO -->
            <div id="mensajeSinPerfil" class="alert alert-warning" style="margin-bottom: 2rem;">
                <span style="font-size: 1.5rem;">⚠️</span>
                <div>
                    <strong>Primero debes cargar el Perfil de Salud Local</strong><br>
                    Para ver el área prioritaria y las sugerencias inteligentes, ve al tab "Configuración" y carga el PDF de tu Perfil de Salud Local.<br><br>
                    Mientras tanto, puedes explorar libremente la estructura completa de la EPVSA 2024-2030 más abajo.
                </div>
            </div>

            <!-- PRIORIZACIÓN PRINCIPAL -->
            <div id="areaPrioritariaBanner" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem; display: none;">
                <h3 style="margin-bottom: 1rem; font-size: 1.5rem;">🎯 ÁREA PRIORITARIA</h3>
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;" id="areaPrioritariaDisplay">Bienestar Emocional</div>
                <p style="opacity: 0.95; font-size: 1rem;">Según la sesión de priorización del Grupo-Motor</p>
            </div>

            <!-- MEJORA 3: Sugerencias Inteligentes -->
            <div id="sugerenciasInteligentes" class="suggestion-card" style="display: none;">
                <div class="suggestion-header">
                    <span class="suggestion-icon">💡</span>
                    <div>
                        <div class="suggestion-title">Selección Sugerida según tu Área Prioritaria</div>
                        <p style="color: #0369a1; font-size: 0.9rem; margin-top: 0.25rem;">
                            Basado en "<span id="areaSugerida">Bienestar Emocional</span>", te recomendamos estos objetivos:
                        </p>
                    </div>
                </div>
                <ul class="suggestion-list" id="sugerenciasList">
                    <!-- Se generará dinámicamente -->
                </ul>
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="aplicarSeleccionSugerida()">
                        ✨ Aplicar selección sugerida
                    </button>
                    <button class="btn btn-secondary" style="margin-left: 0.5rem;" onclick="cerrarSugerencias()">
                        Seleccionar manualmente
                    </button>
                </div>
            </div>

            <div class="alert alert-info" style="margin-bottom: 2rem;">
                <span style="font-size: 1.5rem;">ℹ️</span>
                <div>
                    <strong>Estructura Completa de la EPVSA 2024-2030</strong><br>
                    4 Líneas Estratégicas → 10 Objetivos → 30+ Indicadores → 15 Programas Oficiales → Actuaciones Específicas<br><br>
                    Selecciona los elementos que se alinean con tu área prioritaria y las necesidades de tu municipio.
                </div>
            </div>

            <!-- LÍNEAS ESTRATÉGICAS -->
            <div id="lineasEstrategicasContainer" class="tree-container">
                <!-- El contenido se generará dinámicamente -->
            </div>

            <!-- RESUMEN DE SELECCIÓN -->
            <div style="background: #f0f4ff; border: 3px solid #667eea; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                <h3 style="color: #667eea; margin-bottom: 1rem;">📋 Resumen de tu selección</h3>
                <div id="resumenLineas" style="color: #4b5563; font-size: 1rem; line-height: 1.8;">
                    Has seleccionado <strong id="numLineas">0</strong> líneas estratégicas para tu Plan Local de Salud.
                </div>
            </div>

            <!-- MEJORA 2: Validación de Selección -->
            <div id="validacionSeleccion" style="display: none;">
                <div class="validation-panel">
                    <div class="validation-header">
                        <span style="font-size: 1.5rem;">🔍</span>
                        <h3 style="color: #f59e0b; font-size: 1.2rem; margin: 0;">Completitud de la Selección</h3>
                    </div>
                    <div id="validacionSeleccionItems"></div>
                </div>
            </div>

            <!-- BOTONES DE NAVEGACIÓN -->
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="cambiarTab('configuracion')" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                    ⬅️ Volver al Planificador
                </button>
                <button class="btn btn-primary" onclick="guardarYGenerarPlan()" style="font-size: 1.1rem; padding: 1rem 2rem;">
                    ➡️ Generar Plan de Acción
                </button>
            </div>
        </div>

        <!-- TAB: PLAN DE ACCIÓN -->
        <div id="plan" class="tab-content">
            <div class="step-indicator">
                <div class="step-number">2</div>
                <div class="step-text">
                    <h3>Plan de Acción según Metodología RELAS</h3>
                    <p>Documento estructurado con tu selección de líneas, objetivos, indicadores y programas EPVSA</p>
                </div>
            </div>

            <div id="planContainer"></div>

            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="cambiarTab('lineas')" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                    ⬅️ Volver a Selección
                </button>
                <button class="btn btn-primary" onclick="cambiarTab('conclusiones')" style="font-size: 1.1rem; padding: 1rem 2rem;">
                    ➡️ Ir al Compilador
                </button>
            </div>
        </div>

        <!-- TAB: CUADRO DE MANDOS -->
        <div id="indicadores" class="tab-content">
            <div class="step-indicator">
                <div class="step-number">5</div>
                <div class="step-text">
                    <h3>Cuadro de Mandos Integral - 58 Indicadores</h3>
                    <p>Herramienta para el seguimiento y la evaluación del Plan Local de Salud</p>
                </div>
            </div>

            <!-- Selector de Año para Cuadro de Mandos -->
            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #38bdf8; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem;">
                <h3 style="color: #0369a1; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    📅 Selecciona el Año del Cuadro de Mandos
                </h3>
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <button class="year-btn active" data-year="2024" onclick="cambiarAnoCuadro(2024)">
                        2024
                    </button>
                    <button class="year-btn" data-year="2025" onclick="cambiarAnoCuadro(2025)">
                        2025
                    </button>
                    <button class="year-btn" data-year="2026" onclick="cambiarAnoCuadro(2026)">
                        2026
                    </button>
                    <button class="year-btn" data-year="2027" onclick="cambiarAnoCuadro(2027)">
                        2027
                    </button>
                    <button class="year-btn" data-year="2028" onclick="cambiarAnoCuadro(2028)">
                        2028
                    </button>
                    <button class="year-btn" data-year="2029" onclick="cambiarAnoCuadro(2029)">
                        2029
                    </button>
                    <button class="year-btn" data-year="2030" onclick="cambiarAnoCuadro(2030)">
                        2030
                    </button>
                </div>
                <p style="margin: 0; color: #0369a1; font-size: 0.9rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                    <span style="flex-shrink: 0;">💡</span>
                    <span><strong>Tip:</strong> Cada año tiene su propio cuadro de mandos independiente. Los datos del 2024 ya están pre-rellenados con información de AVISTA.</span>
                </p>
            </div>

            <!-- MEJORA 2: Validación de Indicadores -->
            <div id="validacionIndicadores" style="display: none;">
                <div class="validation-panel">
                    <div class="validation-header">
                        <span style="font-size: 1.5rem;">🔍</span>
                        <h3 style="color: #f59e0b; font-size: 1.2rem; margin: 0;">Estado del Cuadro de Mandos</h3>
                    </div>
                    <div id="validacionIndicadoresItems"></div>
                </div>
            </div>

            <div id="indicadoresContainer"></div>

            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="cambiarTab('configuracion')" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); font-size: 1.1rem; padding: 1rem 2rem;">
                    ⬅️ Volver a Configuración
                </button>
                <button class="btn btn-primary" onclick="cambiarTab('lineas')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 1.1rem; padding: 1rem 2rem;">
                    ⬅️ Volver a Selección EPVSA
                </button>
            </div>
        </div>

        <!-- TAB: AGENDAS ANUALES -->
        <div id="agendas" class="tab-content">
            <div class="step-indicator">
                <div class="step-number">3</div>
                <div class="step-text">
                    <h3>Planifica Actuaciones por Entornos y Años</h3>
                    <p>Registra actuaciones concretas diferenciadas por entornos (Sanitario, Comunitario, Educativo, Laboral)</p>
                </div>
            </div>

            <!-- MEJORA 2: Validación de Actuaciones -->
            <div id="validacionActuaciones" style="display: none;">
                <div class="validation-panel">
                    <div class="validation-header">
                        <span style="font-size: 1.5rem;">🔍</span>
                        <h3 style="color: #f59e0b; font-size: 1.2rem; margin: 0;">Estado de las Actuaciones RELAS</h3>
                    </div>
                    <div id="validacionActuacionesItems"></div>
                </div>
            </div>

            <div class="alert alert-info">
                <span style="font-size: 1.5rem;">ℹ️</span>
                <div>
                    <strong>4 Entornos de Intervención EPVSA</strong><br>
                    Las actuaciones se organizan por: Sanitario, Comunitario, Educativo y Laboral
                </div>
            </div>

            <!-- Selector de Entorno -->
            <div class="entorno-selector" id="entornoSelector"></div>

            <!-- Contenido del Entorno Activo -->
            <div id="entornoContent"></div>

            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="generarAgendaRELAS()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    📅 Generar Agendas RELAS
                </button>
                <button class="btn btn-primary" onclick="cambiarTab('conclusiones')" style="font-size: 1.1rem; padding: 1rem 2rem;">
                    ➡️ Ir al Compilador
                </button>
            </div>
        </div>

        <!-- TAB: COMPILADOR DE PLANES LOCALES DE SALUD -->
        <div id="conclusiones" class="tab-content">
            <div class="step-indicator">
                <div class="step-number">4</div>
                <div class="step-text">
                    <h3>Compilador de Planes Locales de Salud</h3>
                    <p>Genera el documento final completo con Perfil de Salud, Plan de Acción y Agendas RELAS</p>
                </div>
            </div>

            <div id="conclusionesContainer"></div>
        </div>
    </div>

    <script>
        // Configurar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // MEJORA 10: Base de datos de información de programas EPVSA
        const PROGRAMAS_EPVSA_INFO = {
            'P01': {
                codigo: 'P01',
                nombre: 'Promoción de hábitos saludables y redes de apoyo comunitario a través de la Red de Acción Local en Salud (RELAS)',
                descripcion: 'Este programa promueve hábitos saludables a través de la participación comunitaria, creando redes de apoyo social y dinamizando activos locales para la salud. Se basa en el enfoque salutogénico y de activos comunitarios.',
                ambito: 'Ámbito comunitario',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Creación de grupos comunitarios de apoyo',
                    'Talleres de hábitos saludables en centros comunitarios',
                    'Ferias y mercados locales de salud',
                    'Mapeo y dinamización de activos comunitarios',
                    'Formación de agentes comunitarios de salud'
                ]
            },
            'P02': {
                codigo: 'P02',
                nombre: 'Medidas específicas en entornos y sistemas de movilidad y transporte para facilitar los hábitos saludables en la población',
                descripcion: 'Intervenciones en el entorno urbano para facilitar la movilidad activa y el acceso a espacios saludables. Incluye carriles bici, zonas peatonales, espacios verdes y mejoras en transporte público.',
                ambito: 'Ámbito comunitario',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Carriles bici y vías ciclistas urbanas',
                    'Zonas peatonales y calles con prioridad peatonal',
                    'Sistemas de préstamo de bicicletas públicas',
                    'Mejora de espacios públicos para actividad física',
                    'Fuentes de agua potable en espacios públicos'
                ]
            },
            'P03': {
                codigo: 'P03',
                nombre: 'Promoción de hábitos saludables en los centros sanitarios',
                descripcion: 'Integra la promoción de salud en la práctica clínica habitual. Incluye valoración de hábitos, consejo sanitario, intervención avanzada y prescripción social de activos comunitarios.',
                ambito: 'Ámbito sanitario',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Valoración de hábitos en consultas de atención primaria',
                    'Consejo sanitario breve sobre estilos de vida',
                    'Intervención Avanzada en Hábitos Saludables (IAHS)',
                    'Prescripción social de activos comunitarios',
                    'Derivación a Unidades de Actividad Física (UAEF)'
                ]
            },
            'P04': {
                codigo: 'P04',
                nombre: 'Identificación y dinamización de activos para la salud',
                descripcion: 'Mapeo sistemático de recursos comunitarios (asociaciones, espacios, servicios) que promueven la salud, creando catálogos accesibles para profesionales y ciudadanía.',
                ambito: 'Ámbito sanitario',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Mapeo de activos para la salud',
                    'Catálogo de recursos comunitarios',
                    'Plataforma digital de activos',
                    'Formación de activos en salud comunitaria',
                    'Coordinación intersectorial de activos'
                ]
            },
            'P05': {
                codigo: 'P05',
                nombre: 'Promoción de hábitos saludables en los centros de atención a personas con adicciones',
                descripcion: 'Programas de promoción de salud integral en centros de tratamiento de adicciones, abordando alimentación, actividad física y bienestar emocional.',
                ambito: 'Ámbito sanitario',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Talleres de hábitos saludables en centros de adicciones',
                    'Actividad física terapéutica',
                    'Grupos de apoyo emocional',
                    'Alimentación saludable en programas de tratamiento'
                ]
            },
            'P06': {
                codigo: 'P06',
                nombre: 'Promoción de hábitos saludables en centros educativos',
                descripcion: 'Programa Creciendo en Salud y otras iniciativas para promover estilos de vida saludables en el entorno escolar, incluyendo alimentación, actividad física y bienestar emocional.',
                ambito: 'Centros docentes',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Programa Creciendo en Salud',
                    'Menús escolares saludables',
                    'Recreos activos y dinámicos',
                    'Huertos escolares educativos',
                    'Educación emocional y convivencia'
                ]
            },
            'P07': {
                codigo: 'P07',
                nombre: 'Promoción de hábitos saludables en centros universitarios',
                descripcion: 'Programa Universidad Saludable para promover estilos de vida saludables en el ámbito universitario, adaptado a las necesidades de población joven adulta.',
                ambito: 'Centros docentes',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.7'],
                actuaciones_tipo: [
                    'Programa Universidad Saludable',
                    'Instalaciones deportivas universitarias',
                    'Servicios de apoyo psicológico',
                    'Comedores universitarios saludables',
                    'Talleres de gestión del estrés'
                ]
            },
            'P08': {
                codigo: 'P08',
                nombre: 'Promoción de hábitos saludables en los centros de servicios sociales',
                descripcion: 'Programas de promoción de salud en residencias, centros de día y servicios sociales comunitarios, con especial atención a personas mayores y en situación de vulnerabilidad.',
                ambito: 'Centros de servicios sociales',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Programas de envejecimiento activo',
                    'Menús saludables en residencias',
                    'Actividades de estimulación cognitiva',
                    'Talleres de cocina saludable',
                    'Actividades de relación social'
                ]
            },
            'P09': {
                codigo: 'P09',
                nombre: 'Promoción de hábitos saludables en los programas de apoyo social para personas con enfermedad mental',
                descripcion: 'Intervenciones de promoción de salud física en dispositivos de salud mental comunitaria, abordando la importancia de los hábitos saludables en la recuperación.',
                ambito: 'Centros de servicios sociales',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Talleres de hábitos saludables en salud mental',
                    'Actividad física adaptada',
                    'Grupos de apoyo mutuo',
                    'Alimentación saludable terapéutica'
                ]
            },
            'P10': {
                codigo: 'P10',
                nombre: 'Promoción de hábitos saludables en los centros de acogida temporal para inmigrantes',
                descripcion: 'Programas de promoción de salud adaptados culturalmente para población inmigrante en centros de acogida.',
                ambito: 'Centros de servicios sociales',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Talleres interculturales de alimentación saludable',
                    'Actividades deportivas inclusivas',
                    'Apoyo psicosocial y bienestar emocional'
                ]
            },
            'P11': {
                codigo: 'P11',
                nombre: 'Promoción de hábitos saludables en centros y servicios de justicia juvenil y centros penitenciarios',
                descripcion: 'Programas de promoción de salud en entornos de internamiento, como herramienta de reinserción social.',
                ambito: 'Centros de servicios sociales',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Talleres de hábitos saludables en centros de justicia juvenil',
                    'Actividades deportivas terapéuticas',
                    'Alimentación saludable en comedores',
                    'Apoyo psicosocial'
                ]
            },
            'P12': {
                codigo: 'P12',
                nombre: 'Promoción de la Salud en el Lugar de Trabajo (PSLT)',
                descripcion: 'Programa para crear entornos laborales saludables, promoviendo hábitos saludables entre trabajadores y mejorando condiciones de trabajo.',
                ambito: 'Centros de trabajo',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Comedores laborales con opciones saludables',
                    'Pausas activas en el trabajo',
                    'Programas de actividad física para empleados',
                    'Medidas de conciliación',
                    'Prevención del estrés laboral'
                ]
            },
            'P13': {
                codigo: 'P13',
                nombre: 'Establecimiento de alianzas con los operadores económicos en el campo de la alimentación, la restauración, el deporte y el ocio',
                descripcion: 'Convenios con sector empresarial para promover oferta saludable y consumo responsable.',
                ambito: 'Sector empresarial',
                objetivos: ['2.1'],
                actuaciones_tipo: [
                    'Convenios con empresas de alimentación',
                    'Acuerdos con sector de restauración',
                    'Colaboración con empresas de deporte',
                    'Certificación de empresas responsables con la salud'
                ]
            },
            'P14': {
                codigo: 'P14',
                nombre: 'Difusión de información veraz sobre hábitos saludables y medidas para hacer frente a la publicidad de productos y actividades perjudiciales para la salud',
                descripcion: 'Campañas de comunicación basadas en evidencia científica y regulación de publicidad de productos no saludables.',
                ambito: 'Información y comunicación',
                objetivos: ['3.1'],
                actuaciones_tipo: [
                    'Portal Mi Guía de Salud',
                    'Campañas en redes sociales institucionales',
                    'Material divulgativo basado en evidencia',
                    'Regulación de publicidad de productos no saludables',
                    'Colaboración con medios de comunicación'
                ]
            },
            'P15': {
                codigo: 'P15',
                nombre: 'Fomento de la formación, investigación e innovación en promoción de hábitos saludables y los determinantes que los condicionan',
                descripcion: 'Formación de profesionales, investigación en determinantes sociales de la salud e innovación en metodologías de intervención comunitaria.',
                ambito: 'Formación e investigación',
                objetivos: ['4.1'],
                actuaciones_tipo: [
                    'Formación de profesionales en promoción de salud',
                    'Investigación en determinantes sociales',
                    'Evaluación de impacto de políticas',
                    'Observatorio de hábitos saludables',
                    'Innovación en intervención comunitaria'
                ]
            }
        };

        // MEJORA 5: Plantillas de actuaciones por entorno
        const PLANTILLAS_ACTUACIONES = {
            'sanitario': [
                {
                    titulo: 'Consulta de valoración de hábitos saludables',
                    descripcion: 'Evaluación sistemática de alimentación, actividad física, sueño y bienestar emocional en consultas de atención primaria.',
                    icon: '🏥'
                },
                {
                    titulo: 'Intervención Avanzada en Hábitos Saludables (IAHS)',
                    descripcion: 'Programa intensivo individual o grupal para personas con factores de riesgo relacionados con estilos de vida.',
                    icon: '💪'
                },
                {
                    titulo: 'Prescripción social de activos comunitarios',
                    descripcion: 'Recomendación de recursos comunitarios (grupos de paseo, talleres, asociaciones) desde atención primaria.',
                    icon: '🌍'
                },
                {
                    titulo: 'Grupos de apoyo para cuidadores',
                    descripcion: 'Sesiones grupales de apoyo mutuo y educación para salud de personas cuidadoras.',
                    icon: '👥'
                },
                {
                    titulo: 'Consultas de salud mental en atención primaria',
                    descripcion: 'Detección e intervención precoz en malestar emocional, ansiedad y depresión leve-moderada.',
                    icon: '🧠'
                }
            ],
            'comunitario': [
                {
                    titulo: 'Rutas saludables comunitarias',
                    descripcion: 'Circuitos peatonales señalizados en el municipio para promover la actividad física.',
                    icon: '🚶'
                },
                {
                    titulo: 'Huertos comunitarios',
                    descripcion: 'Espacios de cultivo compartido que promueven alimentación saludable, actividad física y cohesión social.',
                    icon: '🌱'
                },
                {
                    titulo: 'Ferias de salud y bienestar',
                    descripcion: 'Eventos comunitarios con talleres, actividades y stands informativos sobre estilos de vida saludables.',
                    icon: '🎪'
                },
                {
                    titulo: 'Grupos de actividad física comunitaria',
                    descripcion: 'Actividades dirigidas de ejercicio físico en espacios públicos (gimnasia de mantenimiento, tai chi, baile).',
                    icon: '🤸'
                },
                {
                    titulo: 'Talleres de cocina saludable',
                    descripcion: 'Sesiones prácticas de elaboración de recetas saludables basadas en dieta mediterránea.',
                    icon: '👨‍🍳'
                },
                {
                    titulo: 'Programa de prevención de la soledad no deseada',
                    descripcion: 'Actividades de relación social y acompañamiento para personas en riesgo de aislamiento social.',
                    icon: '❤️'
                }
            ],
            'educativo': [
                {
                    titulo: 'Programa Creciendo en Salud - Alimentación',
                    descripcion: 'Actividades educativas sobre alimentación saludable, desayuno saludable y comedores escolares.',
                    icon: '🍎'
                },
                {
                    titulo: 'Recreos activos y dinámicos',
                    descripcion: 'Organización de actividades físicas y juegos en los recreos escolares.',
                    icon: '⚽'
                },
                {
                    titulo: 'Huertos escolares educativos',
                    descripcion: 'Espacios de cultivo en centros educativos como herramienta pedagógica transversal.',
                    icon: '🌻'
                },
                {
                    titulo: 'Programa de educación emocional',
                    descripcion: 'Sesiones de gestión emocional, habilidades sociales y prevención del acoso escolar.',
                    icon: '😊'
                },
                {
                    titulo: 'Rutas escolares seguras',
                    descripcion: 'Caminos seguros para ir andando o en bicicleta al centro educativo.',
                    icon: '🚸'
                }
            ],
            'laboral': [
                {
                    titulo: 'Pausas activas en el trabajo',
                    descripcion: 'Breves sesiones de ejercicios de estiramiento y movilidad durante la jornada laboral.',
                    icon: '🧘'
                },
                {
                    titulo: 'Comedores laborales saludables',
                    descripcion: 'Menús equilibrados basados en dieta mediterránea en comedores de empresa.',
                    icon: '🥗'
                },
                {
                    titulo: 'Programa de prevención del estrés laboral',
                    descripcion: 'Formación en gestión del estrés, mindfulness y técnicas de relajación para trabajadores.',
                    icon: '😌'
                },
                {
                    titulo: 'Incentivos para desplazamiento activo',
                    descripcion: 'Medidas para fomentar ir al trabajo andando, en bicicleta o en transporte público.',
                    icon: '🚴'
                },
                {
                    titulo: 'Espacios de descanso y desconexión',
                    descripcion: 'Áreas acondicionadas para pausas, con opciones de lectura, juegos o relajación.',
                    icon: '☕'
                }
            ]
        };

        // ESTRUCTURA JERÁRQUICA EPVSA 2024-2030 CON PROGRAMAS INTEGRADOS
        const ESTRUCTURA_EPVSA = [
            {
                id: 1,
                codigo: "LE 1",
                nombre: "Promoción de hábitos de vida saludable mediante intervenciones en políticas y entornos y dinamización de activos comunitarios para la salud",
                color: "#667eea",
                objetivos: [
                    {
                        id: "1.1",
                        codigo: "OE 1.1",
                        nombre: "Incrementar los niveles de lactancia materna y el consumo de alimentos saludables en detrimento de los no saludables",
                        indicadores: [
                            "Indicador 1.1.1.a - Porcentaje de menores que recibieron lactancia materna exclusiva los 6 primeros meses (CONTEXTO)",
                            "Indicador 1.1.1.b - Aumento del porcentaje de menores que recibieron lactancia materna exclusiva los 6 primeros meses (IMPACTO)",
                            "Indicador 1.1.2.a - Porcentaje de menores que consume verduras 5 o más veces por semana (CONTEXTO)",
                            "Indicador 1.1.3.a - Porcentaje de menores con buena adherencia a la dieta mediterránea (CONTEXTO)",
                            "Indicador 1.1.3.b - Aumento del porcentaje de menores con buena adherencia a la dieta mediterránea (IMPACTO)",
                            "Indicador 1.1.4.a - Porcentaje de personas adultas que toman comida rápida 3 o más veces por semana (CONTEXTO)",
                            "Indicador 1.1.5.a - Porcentaje de personas adultas con buena adherencia a la dieta mediterránea (CONTEXTO)",
                            "Indicador 1.1.5.b - Aumento del porcentaje de personas adultas con buena adherencia a la dieta mediterránea (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Promoción de hábitos saludables y redes de apoyo comunitario a través de la Red de Acción Local en Salud (RELAS)',
                                actuaciones: [
                                    'Creación y dinamización de grupos comunitarios de apoyo a la lactancia materna',
                                    'Talleres de alimentación saludable en centros comunitarios',
                                    'Ferias y mercados locales de productos saludables',
                                    'Programa de huertos comunitarios escolares y vecinales',
                                    'Formación de agentes comunitarios en promoción de alimentación saludable'
                                ]
                            },
                            {
                                codigo: 'P02',
                                nombre: 'Medidas específicas en entornos y sistemas de movilidad y transporte',
                                actuaciones: [
                                    'Creación de espacios públicos amigables para la lactancia materna',
                                    'Instalación de fuentes de agua potable en espacios públicos',
                                    'Mercados de proximidad y puntos de venta de productos frescos'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoción de hábitos saludables en los centros sanitarios',
                                actuaciones: [
                                    'Acreditación IHAN (Iniciativa para la Humanización de la Asistencia al Nacimiento y la Lactancia)',
                                    'Consultas de asesoramiento en lactancia materna',
                                    'Programas de educación alimentaria en atención primaria',
                                    'Intervención avanzada en hábitos saludables (IAHS)',
                                    'Prescripción social de activos comunitarios para alimentación saludable'
                                ]
                            },
                            {
                                codigo: 'P06',
                                nombre: 'Promoción de hábitos saludables en centros educativos',
                                actuaciones: [
                                    'Programa Creciendo en Salud: módulo de alimentación',
                                    'Menús escolares saludables basados en dieta mediterránea',
                                    'Eliminación de máquinas expendedoras de productos no saludables',
                                    'Desayunos saludables en centros educativos',
                                    'Huertos escolares educativos'
                                ]
                            },
                            {
                                codigo: 'P08',
                                nombre: 'Promoción de hábitos saludables en centros de servicios sociales',
                                actuaciones: [
                                    'Menús saludables en residencias y centros de día',
                                    'Talleres de cocina saludable para mayores',
                                    'Asesoramiento nutricional en servicios sociales'
                                ]
                            },
                            {
                                codigo: 'P12',
                                nombre: 'Promoción de la Salud en el Lugar de Trabajo (PSLT)',
                                actuaciones: [
                                    'Comedores laborales con opciones saludables',
                                    'Máquinas expendedoras con productos saludables',
                                    'Talleres de alimentación saludable para trabajadores',
                                    'Espacios habilitados para lactancia materna en centros de trabajo'
                                ]
                            }
                        ]
                    },
                    {
                        id: "1.2",
                        codigo: "OE 1.2",
                        nombre: "Aumentar los niveles de actividad física y disminuir los hábitos sedentarios",
                        indicadores: [
                            "Indicador 1.2.1.a - Porcentaje de población infantil que practica ejercicio físico regular o varias veces por semana (CONTEXTO)",
                            "Indicador 1.2.1.b - Aumento del porcentaje de población infantil que practica ejercicio físico regular (IMPACTO)",
                            "Indicador 1.2.2.a - Porcentaje de personas adultas que practica ejercicio físico regular o varias veces por semana (CONTEXTO)",
                            "Indicador 1.2.2.b - Aumento del porcentaje de personas adultas que practica ejercicio físico regular (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Red de Acción Local en Salud (RELAS)',
                                actuaciones: [
                                    'Rutas saludables comunitarias señalizadas',
                                    'Grupos de caminata y actividad física comunitaria',
                                    'Gimnasios al aire libre en espacios públicos',
                                    'Programas de deporte inclusivo en barrios',
                                    'Escuelas deportivas municipales'
                                ]
                            },
                            {
                                codigo: 'P02',
                                nombre: 'Medidas en entornos y sistemas de movilidad',
                                actuaciones: [
                                    'Carriles bici y vías ciclistas urbanas',
                                    'Zonas peatonales y calles con prioridad peatonal',
                                    'Aparcamientos seguros para bicicletas',
                                    'Sistemas de préstamo de bicicletas públicas',
                                    'Señalización de rutas peatonales y ciclistas'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoción en centros sanitarios',
                                actuaciones: [
                                    'Consultas de actividad física en atención primaria',
                                    'Prescripción de ejercicio físico personalizado',
                                    'Derivación a Unidades de Actividad Física (UAEF)',
                                    'Prescripción social de activos comunitarios deportivos',
                                    'Programa Forma Joven en centros de salud'
                                ]
                            },
                            {
                                codigo: 'P04',
                                nombre: 'Identificación y dinamización de activos para la salud',
                                actuaciones: [
                                    'Mapeo de instalaciones deportivas y espacios para actividad física',
                                    'Catálogo de recursos comunitarios para ejercicio físico',
                                    'Red de activos deportivos municipales',
                                    'Programa de prescripción social de actividad física'
                                ]
                            },
                            {
                                codigo: 'P06',
                                nombre: 'Promoción en centros educativos',
                                actuaciones: [
                                    'Programa Creciendo en Salud: módulo de actividad física',
                                    'Recreos activos y dinámicos',
                                    'Descansos activos en el aula',
                                    'Programa de Deporte en la Escuela',
                                    'Rutas escolares seguras a pie o en bicicleta'
                                ]
                            },
                            {
                                codigo: 'P07',
                                nombre: 'Promoción en centros universitarios',
                                actuaciones: [
                                    'Instalaciones deportivas universitarias accesibles',
                                    'Programa Universidad Saludable: actividad física',
                                    'Competiciones deportivas interuniversitarias',
                                    'Descuentos en instalaciones deportivas para estudiantes'
                                ]
                            },
                            {
                                codigo: 'P12',
                                nombre: 'Promoción en el Lugar de Trabajo',
                                actuaciones: [
                                    'Pausas activas en el trabajo',
                                    'Instalaciones deportivas en centros de trabajo',
                                    'Programas de actividad física para empleados',
                                    'Incentivos para desplazamiento activo al trabajo',
                                    'Formación de empresas en entornos laborales saludables'
                                ]
                            }
                        ]
                    },
                    {
                        id: "1.3",
                        codigo: "OE 1.3",
                        nombre: "Incrementar las horas y la calidad del sueño en la población",
                        indicadores: [
                            "Indicador 1.3.1.a - Porcentaje de población infantil que duerme las horas recomendadas (CONTEXTO)",
                            "Indicador 1.3.1.b - Aumento del porcentaje de población infantil que duerme las horas recomendadas (IMPACTO)",
                            "Indicador 1.3.2.a - Porcentaje de población adulta que duerme las horas recomendadas (CONTEXTO)",
                            "Indicador 1.3.2.b - Aumento del porcentaje de población adulta que duerme las horas recomendadas (IMPACTO)",
                            "Indicador 1.3.3.a - Porcentaje de población adulta que descansa lo suficiente (CONTEXTO)",
                            "Indicador 1.3.3.b - Aumento del porcentaje de población adulta que descansa lo suficiente (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Red de Acción Local en Salud',
                                actuaciones: [
                                    'Talleres comunitarios sobre higiene del sueño',
                                    'Sesiones informativas sobre hábitos de sueño saludable',
                                    'Programa de educación para familias sobre sueño infantil'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoción en centros sanitarios',
                                actuaciones: [
                                    'Consultas de asesoramiento en higiene del sueño',
                                    'Valoración de hábitos de sueño en atención primaria',
                                    'Intervención avanzada en hábitos de sueño',
                                    'Programa Forma Joven: módulo de sueño saludable'
                                ]
                            },
                            {
                                codigo: 'P06',
                                nombre: 'Promoción en centros educativos',
                                actuaciones: [
                                    'Programa Creciendo en Salud: módulo de descanso y sueño',
                                    'Educación sobre higiene del sueño en el currículo',
                                    'Horarios escolares que respeten el descanso',
                                    'Información a familias sobre sueño infantil y adolescente'
                                ]
                            },
                            {
                                codigo: 'P12',
                                nombre: 'Promoción en el Lugar de Trabajo',
                                actuaciones: [
                                    'Formación en higiene del sueño para trabajadores',
                                    'Medidas de conciliación que favorezcan el descanso',
                                    'Espacios de descanso en centros de trabajo',
                                    'Gestión de turnos que respeten el ciclo circadiano'
                                ]
                            }
                        ]
                    },
                    {
                        id: "1.4",
                        codigo: "OE 1.4",
                        nombre: "Incrementar la percepción de calidad de vida y de bienestar emocional",
                        indicadores: [
                            "Indicador 1.4.1.a - Media del índice de calidad de vida en población infantil - Kidscreen (CONTEXTO)",
                            "Indicador 1.4.1.b - Aumento de la calidad de vida media en población infantil - Kidscreen (IMPACTO)",
                            "Indicador 1.4.2.a - Media del índice de calidad de vida en población adulta - componente física (CONTEXTO)",
                            "Indicador 1.4.2.b - Aumento de la media del índice de calidad de vida - componente física (IMPACTO)",
                            "Indicador 1.4.3.a - Media del índice de calidad de vida en población adulta - componente mental (CONTEXTO)",
                            "Indicador 1.4.3.b - Aumento de la media del índice de calidad de vida - componente mental (IMPACTO)",
                            "Indicador 1.4.4.a - Porcentaje de población adulta que se considera completamente feliz (CONTEXTO)",
                            "Indicador 1.4.4.b - Aumento del porcentaje de población adulta que se considera completamente feliz (IMPACTO)",
                            "Indicador 1.4.5.a - Porcentaje de población adulta con apoyo social y afectivo bajo (CONTEXTO)",
                            "Indicador 1.4.5.b - Disminución del porcentaje de población adulta con apoyo social y afectivo bajo (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Red de Acción Local en Salud',
                                actuaciones: [
                                    'Grupos de apoyo mutuo y redes comunitarias',
                                    'Actividades de ocio saludable y relación social',
                                    'Programas intergeneracionales',
                                    'Espacios de encuentro y convivencia comunitaria',
                                    'Voluntariado social y participación ciudadana',
                                    'Programas de prevención de la soledad no deseada'
                                ]
                            },
                            {
                                codigo: 'P02',
                                nombre: 'Medidas en entornos y movilidad',
                                actuaciones: [
                                    'Espacios públicos de calidad para la convivencia',
                                    'Zonas verdes y espacios naturales accesibles',
                                    'Plazas y parques comunitarios',
                                    'Mejora de la accesibilidad universal'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoción en centros sanitarios',
                                actuaciones: [
                                    'Detección de malestar emocional en atención primaria',
                                    'Intervenciones breves en salud mental',
                                    'Programa Forma Joven: salud mental y bienestar emocional',
                                    'Prescripción social de activos comunitarios',
                                    'Derivación a recursos de salud mental cuando proceda'
                                ]
                            },
                            {
                                codigo: 'P04',
                                nombre: 'Identificación y dinamización de activos',
                                actuaciones: [
                                    'Mapeo de activos comunitarios para el bienestar emocional',
                                    'Catálogo de recursos de apoyo social y emocional',
                                    'Red de activos para la salud mental comunitaria',
                                    'Programa de recomendación social de activos'
                                ]
                            },
                            {
                                codigo: 'P06',
                                nombre: 'Promoción en centros educativos',
                                actuaciones: [
                                    'Programa Creciendo en Salud: educación emocional',
                                    'Programa de prevención del acoso escolar',
                                    'Formación en gestión emocional y habilidades sociales',
                                    'Espacios de mediación y convivencia',
                                    'Red andaluza de Escuelas Promotoras de Salud'
                                ]
                            },
                            {
                                codigo: 'P07',
                                nombre: 'Promoción en centros universitarios',
                                actuaciones: [
                                    'Programa Universidad Saludable: salud mental',
                                    'Servicios de apoyo psicológico universitario',
                                    'Talleres de gestión del estrés y ansiedad',
                                    'Actividades de cohesión y relación social'
                                ]
                            },
                            {
                                codigo: 'P08',
                                nombre: 'Promoción en centros de servicios sociales',
                                actuaciones: [
                                    'Programas de envejecimiento activo y saludable',
                                    'Talleres de estimulación cognitiva',
                                    'Actividades de ocio y relación social para mayores',
                                    'Programas de apoyo a cuidadores'
                                ]
                            },
                            {
                                codigo: 'P09',
                                nombre: 'Promoción en programas de salud mental',
                                actuaciones: [
                                    'Apoyo psicosocial en centros de rehabilitación',
                                    'Talleres de habilidades sociales',
                                    'Grupos de apoyo mutuo',
                                    'Programas de inserción social y laboral'
                                ]
                            },
                            {
                                codigo: 'P12',
                                nombre: 'Promoción en el Lugar de Trabajo',
                                actuaciones: [
                                    'Programas de prevención del estrés laboral',
                                    'Medidas de conciliación trabajo-vida personal',
                                    'Formación en gestión emocional para trabajadores',
                                    'Protocolo de actuación ante riesgos psicosociales',
                                    'Espacios de descanso y desconexión'
                                ]
                            }
                        ]
                    },
                    {
                        id: "1.5",
                        codigo: "OE 1.5",
                        nombre: "Incrementar la percepción de satisfacción con las relaciones sexuales para todas las partes",
                        indicadores: [
                            "Indicador 1.5.1.a - Porcentaje de población adulta que considera satisfactorias las relaciones sexuales (CONTEXTO)",
                            "Indicador 1.5.1.b - Aumento del porcentaje de población adulta que considera satisfactorias las relaciones sexuales (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Red de Acción Local en Salud',
                                actuaciones: [
                                    'Talleres de educación sexual integral en espacios comunitarios',
                                    'Charlas sobre sexualidad saludable y diversidad',
                                    'Formación en igualdad y prevención de violencia de género'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoción en centros sanitarios',
                                actuaciones: [
                                    'Consultas de salud sexual y reproductiva',
                                    'Asesoramiento en salud sexual',
                                    'Programa Forma Joven: educación afectivo-sexual',
                                    'Detección de violencia de género'
                                ]
                            },
                            {
                                codigo: 'P06',
                                nombre: 'Promoción en centros educativos',
                                actuaciones: [
                                    'Programa Creciendo en Salud: educación afectivo-sexual',
                                    'Formación en igualdad y respeto a la diversidad',
                                    'Prevención de violencia de género entre adolescentes',
                                    'Talleres de educación sexual integral'
                                ]
                            },
                            {
                                codigo: 'P07',
                                nombre: 'Promoción en centros universitarios',
                                actuaciones: [
                                    'Talleres de salud sexual en universidades',
                                    'Programas de prevención de violencia de género',
                                    'Servicios de asesoramiento en salud sexual'
                                ]
                            }
                        ]
                    },
                    {
                        id: "1.6",
                        codigo: "OE 1.6",
                        nombre: "Disminuir el tiempo dedicado al uso de aparatos electrónicos",
                        indicadores: [
                            "Indicador 1.6.1.a - Porcentaje de población infantil que ve TV 2+ horas diarias (CONTEXTO)",
                            "Indicador 1.6.2.a - Porcentaje de niños/as 3-7 años que usa aparatos electrónicos 1+ hora/día (CONTEXTO)",
                            "Indicador 1.6.2.b - Disminución del porcentaje de niños/as 3-7 años que usa aparatos electrónicos 1+ hora/día (IMPACTO)",
                            "Indicador 1.6.3.a - Porcentaje de niños/as 8-15 años que usa aparatos electrónicos 2+ horas/día (CONTEXTO)",
                            "Indicador 1.6.3.b - Disminución del porcentaje de niños/as 8-15 años que usa aparatos electrónicos 2+ horas/día (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Red de Acción Local en Salud',
                                actuaciones: [
                                    'Talleres para familias sobre uso saludable de pantallas',
                                    'Actividades de ocio alternativo sin pantallas',
                                    'Espacios libres de tecnología en centros comunitarios',
                                    'Campañas de concienciación sobre uso responsable de tecnología'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoción en centros sanitarios',
                                actuaciones: [
                                    'Valoración del tiempo de uso de pantallas en consultas',
                                    'Consejo sanitario sobre uso saludable de tecnología',
                                    'Intervención en uso problemático de pantallas',
                                    'Programa Forma Joven: uso saludable de tecnología'
                                ]
                            },
                            {
                                codigo: 'P06',
                                nombre: 'Promoción en centros educativos',
                                actuaciones: [
                                    'Programa Creciendo en Salud: uso responsable de tecnología',
                                    'Normas sobre uso de dispositivos en centros educativos',
                                    'Educación digital y prevención de adicciones tecnológicas',
                                    'Recreos sin pantallas',
                                    'Formación a familias sobre control parental'
                                ]
                            },
                            {
                                codigo: 'P08',
                                nombre: 'Promoción en centros de servicios sociales',
                                actuaciones: [
                                    'Talleres de ocio alternativo para mayores',
                                    'Uso responsable de tecnología en residencias',
                                    'Actividades sin pantallas en centros de día'
                                ]
                            },
                            {
                                codigo: 'P12',
                                nombre: 'Promoción en el Lugar de Trabajo',
                                actuaciones: [
                                    'Medidas de desconexión digital laboral',
                                    'Formación en uso saludable de tecnología en el trabajo',
                                    'Pausas sin pantallas durante la jornada laboral'
                                ]
                            }
                        ]
                    },
                    {
                        id: "1.7",
                        codigo: "OE 1.7",
                        nombre: "Incrementar las recomendaciones sobre activos comunitarios para la salud",
                        indicadores: [
                            "Indicador 1.7.1.a - Número de recomendaciones sobre activos comunitarios desde el SSPA (CONTEXTO)",
                            "Indicador 1.7.1.b - Aumento anual del número de recomendaciones sobre activos comunitarios desde el SSPA (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Red de Acción Local en Salud',
                                actuaciones: [
                                    'Identificación de activos comunitarios locales',
                                    'Guía de activos para la salud del municipio',
                                    'Difusión de activos comunitarios disponibles',
                                    'Coordinación entre activos y servicios sanitarios'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoción en centros sanitarios',
                                actuaciones: [
                                    'Formación de profesionales en prescripción social',
                                    'Sistema de registro de recomendaciones a activos',
                                    'Catálogo de activos disponible en atención primaria',
                                    'Coordinación entre atención primaria y activos locales'
                                ]
                            },
                            {
                                codigo: 'P04',
                                nombre: 'Identificación y dinamización de activos',
                                actuaciones: [
                                    'Mapeo sistemático de activos para la salud',
                                    'Base de datos de activos comunitarios',
                                    'Plataforma digital de activos para la salud',
                                    'Formación de activos en salud comunitaria',
                                    'Coordinación intersectorial de activos'
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                id: 2,
                codigo: "LE 2",
                nombre: "Fomento de responsabilidad social ante la salud por parte del sector empresarial",
                color: "#10b981",
                objetivos: [
                    {
                        id: "2.1",
                        codigo: "OE 2.1",
                        nombre: "Incrementar el número de empresas que favorezcan hábitos saludables y consumo sostenible",
                        indicadores: [
                            "Indicador 2.1.1.a - Número de empresas andaluzas que favorecen hábitos saludables y consumo sostenible (CONTEXTO)",
                            "Indicador 2.1.1.b - Aumento anual del número de empresas andaluzas que favorecen hábitos saludables (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P13',
                                nombre: 'Establecimiento de alianzas con operadores económicos',
                                actuaciones: [
                                    'Convenios con empresas de alimentación para promoción de productos saludables',
                                    'Acuerdos con sector de restauración para oferta saludable',
                                    'Colaboración con empresas de deporte y ocio activo',
                                    'Certificación de empresas responsables con la salud',
                                    'Incentivos fiscales para empresas que promuevan salud',
                                    'Red de empresas comprometidas con hábitos saludables',
                                    'Eliminación de publicidad de productos no saludables en espacios públicos'
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                id: 3,
                codigo: "LE 3",
                nombre: "Difusión y comunicación de información veraz sobre vida saludable",
                color: "#f59e0b",
                objetivos: [
                    {
                        id: "3.1",
                        codigo: "OE 3.1",
                        nombre: "Incrementar la difusión de información sobre hábitos saludables",
                        indicadores: [
                            "Indicador 3.1.1.a - Número de visitas al portal 'Mi Guía de Salud' (CONTEXTO)",
                            "Indicador 3.1.1.b - Aumento anual del número de visitas al portal 'Mi Guía de Salud' (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P14',
                                nombre: 'Difusión de información veraz sobre hábitos saludables',
                                actuaciones: [
                                    'Portal web "Mi Guía de Salud" con información basada en evidencia',
                                    'Campañas de comunicación en medios sobre hábitos saludables',
                                    'Redes sociales institucionales con contenido de salud',
                                    'Material divulgativo impreso y digital',
                                    'Participación en ferias y eventos de salud',
                                    'Colaboración con medios de comunicación para información veraz',
                                    'Formación de periodistas en información de salud',
                                    'Actuaciones contra publicidad engañosa de productos no saludables',
                                    'Protección frente a influencers que promocionen productos no saludables',
                                    'Regulación de publicidad de alimentos y bebidas no saludables dirigida a menores'
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                id: 4,
                codigo: "LE 4",
                nombre: "Impulso a la gestión del conocimiento, investigación e innovación en promoción de salud",
                color: "#ef4444",
                objetivos: [
                    {
                        id: "4.1",
                        codigo: "OE 4.1",
                        nombre: "Incrementar la formación y la investigación en promoción de hábitos saludables",
                        indicadores: [
                            "Indicador 4.1.1.a - Número de profesionales en actividades formativas sobre hábitos saludables (CONTEXTO)",
                            "Indicador 4.1.1.b - Aumento anual del número de profesionales en actividades formativas (IMPACTO)",
                            "Indicador 4.1.2.a - Número de proyectos de investigación financiados sobre hábitos saludables (CONTEXTO)",
                            "Indicador 4.1.2.b - Aumento anual del número de proyectos de investigación financiados (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P15',
                                nombre: 'Fomento de la formación, investigación e innovación',
                                actuaciones: [
                                    'Cursos de formación para profesionales sanitarios en promoción de salud',
                                    'Formación en prescripción social y uso de activos',
                                    'Formación para profesionales de educación en promoción de salud',
                                    'Formación para profesionales de servicios sociales',
                                    'Jornadas y congresos sobre promoción de hábitos saludables',
                                    'Líneas de investigación en determinantes sociales de la salud',
                                    'Proyectos de investigación en intervenciones comunitarias',
                                    'Estudios sobre efectividad de programas de promoción de salud',
                                    'Observatorio de hábitos saludables en Andalucía',
                                    'Encuestas poblacionales sobre estilos de vida',
                                    'Evaluación de impacto de políticas de salud pública',
                                    'Innovación en metodologías de intervención comunitaria'
                                ]
                            }
                        ]
                    }
                ]
            }
        ];

        // DATOS DEL CUADRO DE MANDOS INTEGRAL (58 INDICADORES)
        const INDICADORES_CMI = [
            // Población
            { numero: 1, indicador: "Población total", unidad: "Número", dato: "9.536", fuente: "IECA (2024)", categoria: "Población" },
            { numero: 2, indicador: "Población mayor de 65", unidad: "%", dato: "17,5", fuente: "IECA (2024)", categoria: "Población" },
            { numero: 3, indicador: "Población menor de 20", unidad: "%", dato: "20,1", fuente: "IECA (2024)", categoria: "Población" },
            { numero: 4, indicador: "Índice de envejecimiento", unidad: "%", dato: "104,3", fuente: "IECA (2022)", categoria: "Población" },
            
            // Género
            { numero: 5, indicador: "Partes remitidos a los juzgados de violencia de género", unidad: "Número", dato: "5", fuente: "HERMES (2024)", categoria: "Género" },
            { numero: 6, indicador: "Interrupción voluntaria del embarazo", unidad: "Número", dato: "—", fuente: "UE (2025)", categoria: "Género" },
            
            // Mortalidad
            { numero: 7, indicador: "Mortalidad cardiovascular", unidad: "%", dato: "35", fuente: "IECA (2022)", categoria: "Mortalidad" },
            { numero: 8, indicador: "Mortalidad tumoral", unidad: "%", dato: "19", fuente: "IECA (2022)", categoria: "Mortalidad" },
            { numero: 9, indicador: "Mortalidad respiratoria", unidad: "%", dato: "6", fuente: "IECA (2022)", categoria: "Mortalidad" },
            { numero: 10, indicador: "Mortalidad infecciosa", unidad: "%", dato: "10", fuente: "IECA (2022)", categoria: "Mortalidad" },
            { numero: 11, indicador: "Mortalidad sistema nervioso y órganos sentidos", unidad: "%", dato: "3", fuente: "IECA (2022)", categoria: "Mortalidad" },
            
            // Morbilidad
            { numero: 12, indicador: "Dislipemia", unidad: "Casos", dato: "3.551", fuente: "BPS (2023)", categoria: "Morbilidad" },
            { numero: 13, indicador: "Artrosis/Espondiloartrosis", unidad: "Casos", dato: "801", fuente: "BPS (2023)", categoria: "Morbilidad" },
            { numero: 14, indicador: "HTA", unidad: "Casos", dato: "945", fuente: "BPS (2023)", categoria: "Morbilidad" },
            { numero: 15, indicador: "Trastornos de ansiedad", unidad: "Casos", dato: "416", fuente: "BPS (2023)", categoria: "Morbilidad" },
            { numero: 16, indicador: "Asma", unidad: "Casos", dato: "547", fuente: "BPS (2023)", categoria: "Morbilidad" },
            { numero: 17, indicador: "Hipotiroidismo", unidad: "Casos", dato: "121", fuente: "BPS (2023)", categoria: "Morbilidad" },
            
            // Cáncer Hombres
            { numero: 18, indicador: "Cáncer piel no melanoma (H)", unidad: "Casos", dato: "184", fuente: "Reg. cáncer", categoria: "Cáncer Hombres" },
            { numero: 19, indicador: "Cáncer próstata", unidad: "Casos", dato: "151", fuente: "Reg. cáncer", categoria: "Cáncer Hombres" },
            { numero: 20, indicador: "Cáncer colon-recto (H)", unidad: "Casos", dato: "61", fuente: "Reg. cáncer", categoria: "Cáncer Hombres" },
            { numero: 21, indicador: "Cáncer vejiga (H)", unidad: "Casos", dato: "44", fuente: "Reg. cáncer", categoria: "Cáncer Hombres" },
            { numero: 22, indicador: "Cáncer pulmón, tráquea, bronquios (H)", unidad: "Casos", dato: "40", fuente: "Reg. cáncer", categoria: "Cáncer Hombres" },
            
            // Cáncer Mujeres
            { numero: 23, indicador: "Cáncer piel no melanoma (M)", unidad: "Casos", dato: "143", fuente: "Reg. cáncer", categoria: "Cáncer Mujeres" },
            { numero: 24, indicador: "Cáncer mama", unidad: "Casos", dato: "118", fuente: "Reg. cáncer", categoria: "Cáncer Mujeres" },
            { numero: 25, indicador: "Cáncer cuerpo uterino", unidad: "Casos", dato: "50", fuente: "Reg. cáncer", categoria: "Cáncer Mujeres" },
            { numero: 26, indicador: "Cáncer colon-recto (M)", unidad: "Casos", dato: "39", fuente: "Reg. cáncer", categoria: "Cáncer Mujeres" },
            { numero: 27, indicador: "Cáncer vejiga (M)", unidad: "Casos", dato: "17", fuente: "Reg. cáncer", categoria: "Cáncer Mujeres" },
            
            // Programas
            { numero: 28, indicador: "Vacunación infantil captación (1 año antes)", unidad: "%", dato: "98,8", fuente: "INFOWEB (2023)", categoria: "Programas" },
            { numero: 29, indicador: "Vacunación infantil captación (2 años antes)", unidad: "%", dato: "100", fuente: "INFOWEB (2023)", categoria: "Programas" },
            { numero: 30, indicador: "Vacunación infantil captación (4 años antes)", unidad: "%", dato: "98,87", fuente: "INFOWEB (2021)", categoria: "Programas" },
            { numero: 31, indicador: "Cribado cáncer colon-recto (% participación invitadas)", unidad: "%", dato: "39,8", fuente: "INFOWEB (2024)", categoria: "Programas" },
            { numero: 32, indicador: "Cribado cáncer colon-recto (% participación aceptación)", unidad: "%", dato: "—", fuente: "INFOWEB (2023)", categoria: "Programas" },
            { numero: 33, indicador: "Cribado cáncer mama (% participación invitadas)", unidad: "%", dato: "37,5", fuente: "INFOWEB (2023)", categoria: "Programas" },
            { numero: 34, indicador: "Cribado cáncer mama (% participación aceptación)", unidad: "%", dato: "—", fuente: "INFOWEB (2023)", categoria: "Programas" },
            { numero: 35, indicador: "Cribado cáncer cérvix (% participación invitadas)", unidad: "%", dato: "—", fuente: "INFOWEB (2023)", categoria: "Programas" },
            { numero: 36, indicador: "Cribado cáncer cérvix (% participación aceptación)", unidad: "%", dato: "—", fuente: "INFOWEB (2023)", categoria: "Programas" },
            
            // Hábitos
            { numero: 37, indicador: "Personas valoradas en dieta", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 38, indicador: "Personas valoradas en dieta con baja adhesión", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 39, indicador: "Personas valoradas en actividad física (15-64 años)", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 40, indicador: "Personas valoradas en actividad física con sedentarismo (15-64 años)", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 41, indicador: "Personas valoradas en actividad física inactivas (15-64 años)", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 42, indicador: "Personas valoradas en actividad física con sedentarismo (65+ años)", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 43, indicador: "Personas valoradas en actividad física inactivas (65+ años)", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 44, indicador: "Personas valoradas en consumo de alcohol", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 45, indicador: "Personas valoradas en alcohol posible alto riesgo", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 46, indicador: "Personas valoradas en alcohol alto riesgo", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 47, indicador: "Intervención avanzada individual en hábitos", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 48, indicador: "Intervención avanzada grupal en hábitos", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 49, indicador: "Personas con registros en formulario IAHS", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 50, indicador: "Personas con al menos una visita IAHS individual", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 51, indicador: "Personas con al menos una sesión IAHS grupal", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 52, indicador: "Personas derivadas a UAEF", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 53, indicador: "Personas a las que se recomienda activo para salud", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 54, indicador: "PITA: intervenciones individuales", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 55, indicador: "PITA: intervenciones grupales", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 56, indicador: "PITA: intervenciones con población fumadora", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 57, indicador: "PITA: intervenciones con población ex-fumadora", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" },
            { numero: 58, indicador: "PITA: intervenciones con población no fumadora", unidad: "Número", dato: "—", fuente: "INFOWEB (2024)", categoria: "Hábitos" }
        ];

        const CONCLUSIONES = [
            {
                numero: '01',
                titulo: 'Trastornos de ansiedad y malestar emocional',
                texto: 'Los trastornos de ansiedad aparecen tanto en hombres como en mujeres entre las causas de morbilidad más frecuentes. Las adicciones y el malestar emocional destacan también entre las principales preocupaciones ciudadanas.'
            },
            {
                numero: '02',
                titulo: 'Oportunidad de la Estrategia',
                texto: 'La Estrategia es una oportunidad para incorporarse a una herramienta de planificación validada, a través de una selección de sus líneas estratégicas, objetivos e indicadores de contexto e impacto.'
            },
            {
                numero: '03',
                titulo: 'Enfoque de Salud comunitaria basada en activos',
                texto: 'El enfoque de Salud comunitaria basada en activos se considera el más adecuado para orientar el Plan Local de Salud. Son principios transversales de la acción local en salud la intersectorialidad, la participación ciudadana y la reducción de las inequidades y desigualdades sociales en materia de salud.'
            },
            {
                numero: '04',
                titulo: 'Necesidad de datos locales mediante encuesta',
                texto: 'La planificación requiere de datos que con frecuencia no están disponibles para el nivel municipal. Pero es posible producirlos mediante encuesta local. Dadas las limitaciones metodológicas, los resultados de la encuesta no son un reflejo estadístico de la realidad, pero resultan de ayuda en el momento de priorizar.'
            }
        ];

        const RECOMENDACIONES = [
            {
                numero: '01',
                titulo: 'Bienestar Emocional como eje central articulador',
                texto: 'Establecer el Bienestar Emocional como eje central articulador del Plan Local de Salud.'
            },
            {
                numero: '02',
                titulo: 'Acompasar el diseño y evaluación del II Plan a la Estrategia',
                texto: 'Acompasar el diseño y la evaluación del Plan Local de Salud a la Estrategia, articulando sectores, actores, medidas, programas y actuaciones en los distintos entornos potencialmente salutogénicos del espacio local: el centro de salud; los centros educativos; el lugar de trabajo y el espacio social y comunitario.'
            },
            {
                numero: '03',
                titulo: 'Vigilancia de hábitos, mapeo de activos y recomendación social',
                texto: 'Promover la vigilancia de los hábitos a través de la Encuesta local de salud; dinamizar el Mapeo continuo de activos para la salud en el espacio comunitario, y favorecer la Recomendación social de esos activos, a través de Campañas de comunicación y de Generación de contenido para redes sociales.'
            },
            {
                numero: '04',
                titulo: 'Realizar Encuesta local de salud',
                texto: 'Realizar, durante el periodo de ejecución del Plan Local de Salud, una Encuesta local de salud, incluyendo en ella preguntas sobre autopercepción de salud y hábitos saludables de la EAS_2024, con objeto de facilitar la comparación de datos y la evaluabilidad del Plan.'
            }
        ];

        // ENTORNOS Y AÑOS PARA AGENDAS
        const ENTORNOS = [
            { id: 'sanitario', nombre: 'Sanitario', icono: '🏥' },
            { id: 'comunitario', nombre: 'Comunitario', icono: '🏘️' },
            { id: 'educativo', nombre: 'Educativo', icono: '🎓' },
            { id: 'laboral', nombre: 'Laboral', icono: '💼' }
        ];

        const ANOS = [2024, 2025, 2026, 2027, 2028, 2029, 2030];

        // MEJORA 3: Mapeo de sugerencias según área prioritaria
        const SUGERENCIAS_POR_AREA = {
            'bienestar emocional': [
                { objetivo: '1.4', linea: 1, descripcion: 'OE 1.4: Incrementar la percepción de calidad de vida y de bienestar emocional' },
                { objetivo: '1.3', linea: 1, descripcion: 'OE 1.3: Incrementar las horas y la calidad del sueño (relacionado con bienestar)' },
                { objetivo: '1.7', linea: 1, descripcion: 'OE 1.7: Incrementar las recomendaciones sobre activos comunitarios' },
                { objetivo: '3.1', linea: 3, descripcion: 'OE 3.1: Incrementar la difusión de información sobre hábitos saludables' }
            ],
            'alimentación saludable': [
                { objetivo: '1.1', linea: 1, descripcion: 'OE 1.1: Incrementar lactancia materna y consumo de alimentos saludables' },
                { objetivo: '2.1', linea: 2, descripcion: 'OE 2.1: Empresas que favorezcan hábitos saludables y consumo sostenible' },
                { objetivo: '3.1', linea: 3, descripcion: 'OE 3.1: Difusión de información veraz sobre alimentación' }
            ],
            'actividad física': [
                { objetivo: '1.2', linea: 1, descripcion: 'OE 1.2: Aumentar niveles de actividad física y disminuir sedentarismo' },
                { objetivo: '1.7', linea: 1, descripcion: 'OE 1.7: Incrementar recomendaciones sobre activos comunitarios' },
                { objetivo: '3.1', linea: 3, descripcion: 'OE 3.1: Difusión de información sobre actividad física' }
            ],
            'sueño': [
                { objetivo: '1.3', linea: 1, descripcion: 'OE 1.3: Incrementar horas y calidad del sueño' },
                { objetivo: '1.6', linea: 1, descripcion: 'OE 1.6: Disminuir tiempo de uso de aparatos electrónicos' },
                { objetivo: '3.1', linea: 3, descripcion: 'OE 3.1: Difusión de información sobre higiene del sueño' }
            ],
            'default': [
                { objetivo: '1.4', linea: 1, descripcion: 'OE 1.4: Incrementar la percepción de calidad de vida y de bienestar emocional' },
                { objetivo: '1.7', linea: 1, descripcion: 'OE 1.7: Incrementar las recomendaciones sobre activos comunitarios' },
                { objetivo: '3.1', linea: 3, descripcion: 'OE 3.1: Incrementar la difusión de información sobre hábitos saludables' }
            ]
        };

        // Estado de la aplicación
        // ============================================
        // SISTEMA DE LOGIN Y AUTENTICACIÓN
        // ============================================
        
        // Usuario actual (se establece después del login)
        let usuarioActual = {
            tipo: null, // 'admin' o 'municipio'
            nombre: null,
            esAdmin: false
        };
        
        // Función principal de login
        function intentarLogin(event) {
            event.preventDefault();
            
            const usuario = document.getElementById('loginUsuario').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            console.log('🔐 Intento de login:', {usuario, password: '***'});
            
            // Verificar si es admin
            if (usuario === 'admin' && password === 'admin') {
                console.log('✅ Login admin correcto');
                loginExitoso('admin', 'Administrador', true);
                return;
            }
            
            console.log('❌ No es admin, verificando municipios...');
            
            // Verificar si es un municipio con contraseña válida
            const passwordsMunicipios = JSON.parse(localStorage.getItem('planificadorEPVSA_passwords_municipios') || '{}');
            console.log('📋 Contraseñas municipios:', passwordsMunicipios);
            
            if (passwordsMunicipios[usuario] === password) {
                console.log('✅ Login municipio correcto:', usuario);
                loginExitoso('municipio', usuario, false);
                return;
            }
            
            console.log('❌ Login fallido');
            // Login fallido
            mostrarErrorLogin('Usuario o contraseña incorrectos.\n\nMunicipios: Si no tienes contraseña, solicítala al coordinador RELAS.');
        }
        
        function loginExitoso(tipo, nombre, esAdmin) {
            console.log('✅ Login exitoso:', {tipo, nombre, esAdmin});
            
            usuarioActual = {
                tipo: tipo,
                nombre: nombre,
                esAdmin: esAdmin
            };
            
            // Guardar sesión
            sessionStorage.setItem('planificadorEPVSA_sesion', JSON.stringify(usuarioActual));
            console.log('💾 Sesión guardada:', usuarioActual);
            
            // Ocultar modal de login
            document.getElementById('loginModal').classList.remove('active');
            console.log('🚪 Modal de login cerrado');
            
            // Mostrar aplicación
            document.getElementById('appContainer').style.display = 'block';
            console.log('📱 Aplicación mostrada');
            
            // Si es municipio, auto-rellenar nombre
            if (tipo === 'municipio') {
                state.municipio.nombre = nombre;
                document.getElementById('nombreMunicipio').value = nombre;
                document.getElementById('nombreMunicipio').disabled = true; // No puede cambiarlo
                console.log('🏛️ Nombre municipio auto-rellenado:', nombre);
            }
            
            // Ocultar botón de admin si no es admin
            if (!esAdmin) {
                const botonAdmin = document.querySelector('[onclick="verificarAccesoAdmin()"]');
                if (botonAdmin) {
                    botonAdmin.parentElement.style.display = 'none';
                    console.log('🔒 Botón admin ocultado');
                }
            } else {
                console.log('👑 Usuario es admin, botón visible');
            }
            
            // Cargar borrador si existe
            setTimeout(() => {
                cargarBorradorSiExiste();
            }, 500);
            
            // Mensaje de bienvenida
            const mensajeBienvenida = esAdmin 
                ? '👋 Bienvenido, Administrador\n\n✅ Acceso completo al sistema'
                : `👋 Bienvenido, ${nombre}\n\n✅ Puedes trabajar en el plan local de salud de tu municipio`;
            
            setTimeout(() => {
                alert(mensajeBienvenida);
            }, 300);
        }
        
        function mostrarErrorLogin(mensaje) {
            const errorDiv = document.getElementById('loginError');
            const errorMsg = document.getElementById('loginErrorMsg');
            errorMsg.textContent = mensaje;
            errorDiv.style.display = 'block';
            
            // Limpiar contraseña
            document.getElementById('loginPassword').value = '';
        }
        
        function cerrarSesion() {
            if (confirm('¿Seguro que quieres cerrar sesión?')) {
                sessionStorage.removeItem('planificadorEPVSA_sesion');
                location.reload();
            }
        }
        
        // Verificar sesión al cargar
        function verificarSesionExistente() {
            const sesionGuardada = sessionStorage.getItem('planificadorEPVSA_sesion');
            if (sesionGuardada) {
                const sesion = JSON.parse(sesionGuardada);
                usuarioActual = sesion;
                
                // Ocultar login y mostrar app
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('appContainer').style.display = 'block';
                
                // Si es municipio, auto-rellenar
                if (sesion.tipo === 'municipio') {
                    state.municipio.nombre = sesion.nombre;
                    setTimeout(() => {
                        document.getElementById('nombreMunicipio').value = sesion.nombre;
                        document.getElementById('nombreMunicipio').disabled = true;
                    }, 100);
                }
                
                // Ocultar botón admin si no es admin
                if (!sesion.esAdmin) {
                    setTimeout(() => {
                        const botonAdmin = document.querySelector('[onclick="verificarAccesoAdmin()"]');
                        if (botonAdmin) {
                            botonAdmin.parentElement.style.display = 'none';
                        }
                    }, 100);
                }
                
                return true;
            }
            return false;
        }

        const state = {
            municipio: {
                nombre: '',
                provincia: '',
                poblacion: null
            },
            equipo: {
                coordinador: '',
                tecnicoSalud: '',
                representanteMunicipal: '',
                otrosMiembros: ''
            },
            perfilCargado: false,
            indicadoresExtraidos: [],
            areaPrioritaria: 'Bienestar Emocional',
            sesionGrupoMotor: 'Febrero de 2025',
            lineasEstrategicas: [],
            programasSeleccionados: [],
            actuaciones: {},
            currentEntorno: 'sanitario',
            currentYear: 2024,
            planGenerado: null,
            sugerenciasAplicadas: false,
            pdfData: null,
            pdfNumPages: 0,
            // Sistema multianual de cuadros de mandos
            cuadrosMandosAnuales: {
                2024: JSON.parse(JSON.stringify(INDICADORES_CMI)) // Copia profunda con datos 2024
            },
            anoActivoCuadro: 2024
        };


        // MEJORA 6: Funciones de localStorage
        function guardarBorrador() {
            const borrador = {
                state: state,
                fecha: new Date().toISOString(),
                version: '2.0'
            };
            
            try {
                localStorage.setItem('planificadorEPVSA_borrador', JSON.stringify(borrador));
                alert('✅ Borrador guardado correctamente\n\nPuedes cerrar y recuperar tu trabajo más tarde.');
            } catch (e) {
                alert('⚠️ Error al guardar el borrador. Es posible que el navegador no permita almacenamiento local.');
            }
        }

        function cargarBorradorSiExiste() {
            try {
                // Primero intentar cargar el municipio actual si existe
                const municipioId = generarIdMunicipio();
                let borradorStr = localStorage.getItem(`planificadorEPVSA_${municipioId}`);
                
                // Si no existe para este municipio, buscar el borrador antiguo
                if (!borradorStr) {
                    borradorStr = localStorage.getItem('planificadorEPVSA_borrador');
                }
                
                if (borradorStr) {
                    const borrador = JSON.parse(borradorStr);
                    
                    // Mostrar modal de recuperación
                    const fecha = new Date(borrador.fechaGuardado || borrador.fecha).toLocaleString('es-ES');
                    const nombreMunicipio = borrador.nombreMunicipio || 'Municipio';
                    document.getElementById('borradorFecha').textContent = `${nombreMunicipio} - Guardado el: ${fecha}`;
                    document.getElementById('borradorModal').classList.add('active');
                    
                    return true;
                }
            } catch (e) {
                console.error('Error al cargar borrador:', e);
            }
            return false;
        }

        function recuperarBorrador() {
            try {
                const municipioId = generarIdMunicipio();
                let borradorStr = localStorage.getItem(`planificadorEPVSA_${municipioId}`);
                
                if (!borradorStr) {
                    borradorStr = localStorage.getItem('planificadorEPVSA_borrador');
                }
                
                if (borradorStr) {
                    const borrador = JSON.parse(borradorStr);
                    
                    // Restaurar estado
                    Object.assign(state, borrador.state);
                    
                    // Asegurar que cuadrosMandosAnuales existe
                    if (!state.cuadrosMandosAnuales) {
                        state.cuadrosMandosAnuales = {
                            2024: JSON.parse(JSON.stringify(INDICADORES_CMI))
                        };
                    }
                    if (!state.anoActivoCuadro) {
                        state.anoActivoCuadro = 2024;
                    }
                    
                    // Actualizar UI
                    document.getElementById('nombreMunicipio').value = state.municipio.nombre || '';
                    document.getElementById('provinciaMunicipio').value = state.municipio.provincia || '';
                    document.getElementById('poblacionMunicipio').value = state.municipio.poblacion || '';
                    
                    document.getElementById('coordinador').value = state.equipo.coordinador || '';
                    document.getElementById('tecnicoSalud').value = state.equipo.tecnicoSalud || '';
                    document.getElementById('representanteMunicipal').value = state.equipo.representanteMunicipal || '';
                    document.getElementById('otrosMiembros').value = state.equipo.otrosMiembros || '';
                    
                    if (state.perfilCargado) {
                        document.getElementById('uploadZone').style.display = 'none';
                        document.getElementById('analisisResultados').style.display = 'block';
                        renderConclusionesResumen();
                        renderRecomendacionesResumen();
                    }
                    
                    actualizarEstadisticas();
                    
                    document.getElementById('borradorModal').classList.remove('active');
                    
                    alert('✅ Borrador recuperado correctamente\n\n¡Puedes continuar donde lo dejaste!');
                }
            } catch (e) {
                alert('❌ Error al recuperar el borrador');
                console.error(e);
            }
        }

        function empezarDeCero() {
            if (confirm('⚠️ ¿Estás seguro de que quieres empezar de cero?\n\nSe eliminará el trabajo guardado para este municipio.')) {
                const municipioId = generarIdMunicipio();
                localStorage.removeItem(`planificadorEPVSA_${municipioId}`);
                localStorage.removeItem('planificadorEPVSA_borrador'); // Limpiar también el antiguo
                document.getElementById('borradorModal').classList.remove('active');
            }
        }

        // ============================================
        // SISTEMA MULTI-MUNICIPIO
        // ============================================
        
        function generarIdMunicipio() {
            const nombre = state.municipio.nombre || 'sin-nombre';
            const pdfHash = state.pdfData ? simpleHash(state.pdfData) : 'sin-pdf';
            return `municipio_${nombre.toLowerCase().replace(/\s+/g, '-')}_${pdfHash}`;
        }
        
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < Math.min(str.length, 1000); i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36).substring(0, 8);
        }
        
        function guardarEstado() {
            try {
                const municipioId = generarIdMunicipio();
                const borrador = {
                    fechaGuardado: new Date().toISOString(),
                    municipioId: municipioId,
                    nombreMunicipio: state.municipio.nombre,
                    state: state
                };
                
                // Guardar con ID específico del municipio
                localStorage.setItem(`planificadorEPVSA_${municipioId}`, JSON.stringify(borrador));
                
                // Mantener lista de municipios (solo para administrador)
                const listaMunicipios = JSON.parse(localStorage.getItem('planificadorEPVSA_lista_municipios') || '[]');
                if (!listaMunicipios.includes(municipioId)) {
                    listaMunicipios.push(municipioId);
                    localStorage.setItem('planificadorEPVSA_lista_municipios', JSON.stringify(listaMunicipios));
                }
                
                console.log('💾 Estado guardado para:', municipioId);
            } catch (e) {
                console.error('Error al guardar estado:', e);
            }
        }

        // ============================================
        // PANEL DE ADMINISTRACIÓN
        // ============================================
        
        function verificarAccesoAdmin() {
            // Verificar que el usuario actual sea admin
            if (!usuarioActual.esAdmin) {
                alert('❌ Acceso denegado\n\nEsta función es solo para administradores.');
                return;
            }
            
            mostrarMenuMaestro();
        }
        
        function mostrarMenuMaestro() {
            const opciones = 
                '🔐 MENÚ DE ADMINISTRACIÓN\n\n' +
                '1️⃣ Ver Panel de Municipios\n' +
                '2️⃣ Gestionar Contraseñas de Municipios\n' +
                '3️⃣ Cerrar Sesión\n\n' +
                'Selecciona una opción (1-3):';
            
            const opcion = prompt(opciones);
            
            switch(opcion) {
                case '1':
                    abrirAdminPanel();
                    break;
                case '2':
                    gestionarPasswordsMunicipios();
                    break;
                case '3':
                    cerrarSesion();
                    break;
                default:
                    return;
            }
        }
        
        function gestionarPasswordsMunicipios() {
            const passwords = JSON.parse(localStorage.getItem('planificadorEPVSA_passwords_municipios') || '{}');
            const municipios = Object.keys(passwords);
            
            const menu = 
                '🔑 GESTIÓN DE CONTRASEÑAS MUNICIPIOS\n\n' +
                `Municipios registrados: ${municipios.length}\n` +
                (municipios.length > 0 ? `\n📋 Lista:\n${municipios.map((m, i) => `${i+1}. ${m}`).join('\n')}\n` : '') +
                '\n' +
                '1️⃣ Crear/Actualizar contraseña de municipio\n' +
                '2️⃣ Eliminar contraseña de municipio\n' +
                '3️⃣ Ver todas las contraseñas\n' +
                '4️⃣ Volver\n\n' +
                'Selecciona (1-4):';
            
            const opcion = prompt(menu);
            
            switch(opcion) {
                case '1':
                    crearPasswordMunicipio();
                    break;
                case '2':
                    eliminarPasswordMunicipio();
                    break;
                case '3':
                    verPasswordsMunicipios();
                    break;
                default:
                    mostrarMenuMaestro();
                    return;
            }
        }
        
        function crearPasswordMunicipio() {
            const municipio = prompt('🏛️ Nombre del municipio:\n\n(Escribe el nombre exacto como aparecerá en el login)');
            
            if (!municipio || municipio.trim() === '') {
                alert('❌ Operación cancelada');
                gestionarPasswordsMunicipios();
                return;
            }
            
            const municipioNombre = municipio.trim();
            
            const password = prompt(`🔑 Contraseña para "${municipioNombre}":\n\n(Mínimo 4 caracteres)`);
            
            if (!password || password.length < 4) {
                alert('❌ La contraseña debe tener al menos 4 caracteres');
                crearPasswordMunicipio();
                return;
            }
            
            // Guardar
            const passwords = JSON.parse(localStorage.getItem('planificadorEPVSA_passwords_municipios') || '{}');
            const esNuevo = !passwords[municipioNombre];
            passwords[municipioNombre] = password;
            localStorage.setItem('planificadorEPVSA_passwords_municipios', JSON.stringify(passwords));
            
            alert(
                `✅ ${esNuevo ? 'Contraseña creada' : 'Contraseña actualizada'}\n\n` +
                `🏛️ Municipio: ${municipioNombre}\n` +
                `🔑 Contraseña: ${password}\n\n` +
                `💡 Comparte estas credenciales con el municipio`
            );
            
            gestionarPasswordsMunicipios();
        }
        
        function eliminarPasswordMunicipio() {
            const passwords = JSON.parse(localStorage.getItem('planificadorEPVSA_passwords_municipios') || '{}');
            const municipios = Object.keys(passwords);
            
            if (municipios.length === 0) {
                alert('No hay contraseñas para eliminar');
                gestionarPasswordsMunicipios();
                return;
            }
            
            const lista = municipios.map((m, i) => `${i+1}. ${m}`).join('\n');
            const indice = prompt(`🗑️ Eliminar contraseña\n\nMunicipios:\n${lista}\n\nIntroduce el número del municipio:`);
            
            const idx = parseInt(indice) - 1;
            
            if (isNaN(idx) || idx < 0 || idx >= municipios.length) {
                alert('❌ Número inválido');
                gestionarPasswordsMunicipios();
                return;
            }
            
            const municipio = municipios[idx];
            
            if (confirm(`¿Eliminar la contraseña de "${municipio}"?\n\nEste municipio perderá el acceso.`)) {
                delete passwords[municipio];
                localStorage.setItem('planificadorEPVSA_passwords_municipios', JSON.stringify(passwords));
                alert(`✅ Contraseña de "${municipio}" eliminada`);
            }
            
            gestionarPasswordsMunicipios();
        }
        
        function verPasswordsMunicipios() {
            const passwords = JSON.parse(localStorage.getItem('planificadorEPVSA_passwords_municipios') || '{}');
            const municipios = Object.keys(passwords);
            
            if (municipios.length === 0) {
                alert('📭 No hay contraseñas creadas\n\nCrea contraseñas para dar acceso a los municipios.');
            } else {
                const lista = municipios.map((m, i) => `${i+1}. ${m} → ${passwords[m]}`).join('\n');
                alert(`🔑 CONTRASEÑAS DE MUNICIPIOS (${municipios.length}):\n\n${lista}\n\n💡 Comparte estas credenciales con cada municipio.`);
            }
            
            gestionarPasswordsMunicipios();
        }
        
        function abrirAdminPanel() {
            const listaMunicipios = JSON.parse(localStorage.getItem('planificadorEPVSA_lista_municipios') || '[]');
            const container = document.getElementById('municipiosContainer');
            
            if (listaMunicipios.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <span style="font-size: 1.5rem;">📭</span>
                        <div>
                            <strong>No hay planes guardados</strong><br>
                            Aún no se han creado planes municipales.
                        </div>
                    </div>
                `;
            } else {
                let html = '<div style="display: grid; gap: 1rem;">';
                
                listaMunicipios.forEach(municipioId => {
                    const borradorStr = localStorage.getItem(`planificadorEPVSA_${municipioId}`);
                    if (borradorStr) {
                        const borrador = JSON.parse(borradorStr);
                        const fecha = new Date(borrador.fechaGuardado).toLocaleString('es-ES');
                        const nombre = borrador.nombreMunicipio || 'Sin nombre';
                        const poblacion = borrador.state.municipio.poblacion || 'N/A';
                        const programas = borrador.state.programasSeleccionados.length;
                        const actuaciones = Object.values(borrador.state.actuaciones || {}).flat().length;
                        
                        html += `
                            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; cursor: pointer; transition: all 0.3s;"
                                 onclick="verDetallePlan('${municipioId}')"
                                 onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'"
                                 onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                                <h4 style="color: #1f2937; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    🏛️ ${nombre}
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-top: 1rem;">
                                    <div style="background: #f0f9ff; padding: 0.5rem; border-radius: 0.5rem;">
                                        <div style="font-size: 0.75rem; color: #0369a1;">Población</div>
                                        <div style="font-weight: 700; color: #1e40af;">${poblacion}</div>
                                    </div>
                                    <div style="background: #f0fdf4; padding: 0.5rem; border-radius: 0.5rem;">
                                        <div style="font-size: 0.75rem; color: #065f46;">Programas</div>
                                        <div style="font-weight: 700; color: #047857;">${programas}</div>
                                    </div>
                                    <div style="background: #fef3c7; padding: 0.5rem; border-radius: 0.5rem;">
                                        <div style="font-size: 0.75rem; color: #92400e;">Actuaciones</div>
                                        <div style="font-weight: 700; color: #b45309;">${actuaciones}</div>
                                    </div>
                                </div>
                                <div style="margin-top: 0.75rem; font-size: 0.85rem; color: #6b7280;">
                                    📅 Última actualización: ${fecha}
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #9ca3af; font-family: monospace;">
                                    ID: ${municipioId}
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
                container.innerHTML = html;
            }
            
            document.getElementById('adminModal').classList.add('active');
        }
        
        function verDetallePlan(municipioId) {
            const borradorStr = localStorage.getItem(`planificadorEPVSA_${municipioId}`);
            if (!borradorStr) return;
            
            const borrador = JSON.parse(borradorStr);
            const st = borrador.state;
            
            const container = document.getElementById('detallesPlanContainer');
            let html = `
                <div style="background: white; border: 2px solid #3b82f6; border-radius: 0.75rem; padding: 1.5rem;">
                    <h4 style="color: #1f2937; margin-bottom: 1rem;">🏛️ ${st.municipio.nombre}</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div>
                            <strong style="color: #6b7280;">Provincia:</strong><br>
                            ${st.municipio.provincia || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #6b7280;">Población:</strong><br>
                            ${st.municipio.poblacion || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #6b7280;">Área Prioritaria:</strong><br>
                            ${st.areaPrioritaria || 'N/A'}
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem;">
                        <strong style="color: #1f2937;">📊 Estadísticas:</strong>
                        <ul style="margin-top: 0.5rem; color: #4b5563;">
                            <li>Líneas estratégicas: ${st.lineasEstrategicas.length}</li>
                            <li>Programas seleccionados: ${st.programasSeleccionados.length}</li>
                            <li>Total actuaciones: ${Object.values(st.actuaciones || {}).flat().length}</li>
                        </ul>
                    </div>
                    
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem;">
                        <strong style="color: #1f2937;">👥 Equipo:</strong>
                        <ul style="margin-top: 0.5rem; color: #4b5563; font-size: 0.9rem;">
                            ${st.equipo.coordinador ? `<li><strong>Coordinador:</strong> ${st.equipo.coordinador}</li>` : ''}
                            ${st.equipo.tecnicoSalud ? `<li><strong>Técnico de Salud:</strong> ${st.equipo.tecnicoSalud}</li>` : ''}
                            ${st.equipo.representanteMunicipal ? `<li><strong>Representante Municipal:</strong> ${st.equipo.representanteMunicipal}</li>` : ''}
                        </ul>
                    </div>
                    
                    <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-small btn-primary" onclick="exportarPlanMunicipio('${municipioId}')">
                            📥 Exportar Datos
                        </button>
                        <button class="btn btn-small btn-danger" onclick="eliminarPlanMunicipio('${municipioId}')">
                            🗑️ Eliminar
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            document.getElementById('detallesPlan').style.display = 'block';
        }
        
        function cerrarAdminPanel() {
            document.getElementById('adminModal').classList.remove('active');
            document.getElementById('detallesPlan').style.display = 'none';
        }
        
        function exportarPlanMunicipio(municipioId) {
            const borradorStr = localStorage.getItem(`planificadorEPVSA_${municipioId}`);
            if (!borradorStr) return;
            
            const blob = new Blob([borradorStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Plan_${municipioId}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportarTodosDatos() {
            const listaMunicipios = JSON.parse(localStorage.getItem('planificadorEPVSA_lista_municipios') || '[]');
            const todosLosDatos = {};
            
            listaMunicipios.forEach(municipioId => {
                const borradorStr = localStorage.getItem(`planificadorEPVSA_${municipioId}`);
                if (borradorStr) {
                    todosLosDatos[municipioId] = JSON.parse(borradorStr);
                }
            });
            
            const blob = new Blob([JSON.stringify(todosLosDatos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Todos_Planes_RELAS_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`✅ Exportados ${Object.keys(todosLosDatos).length} planes municipales`);
        }
        
        function eliminarPlanMunicipio(municipioId) {
            if (confirm(`⚠️ ¿Estás seguro de eliminar este plan?\n\nEsta acción no se puede deshacer.`)) {
                localStorage.removeItem(`planificadorEPVSA_${municipioId}`);
                
                const listaMunicipios = JSON.parse(localStorage.getItem('planificadorEPVSA_lista_municipios') || '[]');
                const nuevaLista = listaMunicipios.filter(id => id !== municipioId);
                localStorage.setItem('planificadorEPVSA_lista_municipios', JSON.stringify(nuevaLista));
                
                alert('✅ Plan eliminado');
                abrirAdminPanel(); // Recargar lista
            }
        }

        function limpiarFormulario() {
            // Confirmación con doble verificación para evitar borrados accidentales
            const confirmacion1 = confirm(
                '⚠️ ADVERTENCIA: LIMPIAR FORMULARIO\n\n' +
                'Esta acción eliminará:\n' +
                '✗ Todos los datos del municipio\n' +
                '✗ El perfil de salud cargado\n' +
                '✗ Todas las líneas y objetivos seleccionados\n' +
                '✗ Todas las actuaciones registradas\n' +
                '✗ El borrador guardado\n\n' +
                '¿Estás seguro de que deseas continuar?'
            );
            
            if (!confirmacion1) return;
            
            // Segunda confirmación
            const confirmacion2 = confirm(
                '🚨 ÚLTIMA CONFIRMACIÓN\n\n' +
                'Esta acción NO se puede deshacer.\n' +
                'Perderás TODO el trabajo realizado.\n\n' +
                '¿Confirmas que deseas ELIMINAR TODO?'
            );
            
            if (!confirmacion2) return;
            
            try {
                // Limpiar localStorage completamente
                localStorage.removeItem('planificadorEPVSA_borrador');
                
                // Resetear COMPLETAMENTE el estado a los valores iniciales originales
                state.municipio = { nombre: '', provincia: '', poblacion: null };
                state.equipo = { coordinador: '', tecnicoSalud: '', representanteMunicipal: '', otrosMiembros: '' };
                state.perfilCargado = false;
                state.indicadoresExtraidos = [];
                state.areaPrioritaria = 'Bienestar Emocional';
                state.sesionGrupoMotor = 'Febrero de 2025';
                state.lineasEstrategicas = [];
                state.programasSeleccionados = [];
                state.actuaciones = {};
                state.currentEntorno = 'sanitario';
                state.currentYear = 2024;
                state.planGenerado = null;
                state.sugerenciasAplicadas = false;
                state.pdfData = null;
                state.pdfNumPages = 0;
                
                // Limpiar TODOS los campos del formulario
                const camposTexto = [
                    'nombreMunicipio', 'provinciaMunicipio', 'poblacionMunicipio',
                    'coordinador', 'tecnicoSalud', 'representanteMunicipal', 'otrosMiembros',
                    'areaPrioritaria'
                ];
                
                camposTexto.forEach(id => {
                    const campo = document.getElementById(id);
                    if (campo) campo.value = '';
                });
                
                // Resetear input de archivo PDF
                const pdfInput = document.getElementById('pdfInput');
                if (pdfInput) pdfInput.value = '';
                
                // Resetear visualización del perfil
                const uploadZone = document.getElementById('uploadZone');
                const analisisResultados = document.getElementById('analisisResultados');
                if (uploadZone) uploadZone.style.display = 'block';
                if (analisisResultados) analisisResultados.style.display = 'none';
                
                // Limpiar TODOS los contenedores dinámicos
                const contenedoresDinamicos = [
                    'conclusionesResumen', 'recomendacionesResumen', 'planGeneradoContainer',
                    'lineasEstrategicasContainer', 'indicadoresContainer', 'planContainer',
                    'resumenLineas', 'resumenProgramas', 'entornoContent', 'conclusionesContainer'
                ];
                
                contenedoresDinamicos.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) container.innerHTML = '';
                });
                
                // Limpiar actuaciones en TODOS los entornos
                ['sanitario', 'comunitario', 'educativo', 'laboral'].forEach(entorno => {
                    const container = document.getElementById(`actuaciones-${entorno}`);
                    if (container) container.innerHTML = '';
                });
                
                // Resetear todos los selectores y checks
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
                
                const selects = document.querySelectorAll('select');
                selects.forEach(sel => sel.selectedIndex = 0);
                
                // Limpiar banners y displays
                const areaBanner = document.getElementById('areaPrioritariaBanner');
                const areaDisplay = document.getElementById('areaPrioritariaDisplay');
                if (areaBanner) areaBanner.style.display = 'none';
                if (areaDisplay) areaDisplay.textContent = '';
                
                // Actualizar estadísticas a CERO
                actualizarEstadisticas();
                
                // Resetear las estadísticas manualmente por si acaso
                const stats = ['statIndicadores', 'statProgramas', 'statConclusiones', 'statPrioridad', 'statActuaciones'];
                stats.forEach(id => {
                    const stat = document.getElementById(id);
                    if (stat) stat.textContent = '0';
                });
                
                // Volver a la primera pestaña y limpiar clases
                const tabs = document.querySelectorAll('.tab');
                const tabContents = document.querySelectorAll('.tab-content');
                tabs.forEach(t => t.classList.remove('active', 'completed'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                if (tabs.length > 0) tabs[0].classList.add('active');
                if (tabContents.length > 0) tabContents[0].classList.add('active');
                
                // Mensaje de confirmación
                alert('✅ Formulario limpiado completamente\n\n' +
                      'Todos los datos han sido eliminados.\n' +
                      'Puedes comenzar un nuevo plan desde cero.');
                
                // Recargar la página para asegurar limpieza total
                if (confirm('💡 ¿Deseas recargar la página para asegurar una limpieza completa?')) {
                    location.reload();
                }
                      
            } catch (e) {
                console.error('Error al limpiar formulario:', e);
                alert('❌ Error al limpiar el formulario\n\n' +
                      'Detalles: ' + e.message + '\n\n' +
                      'Recarga la página manualmente (F5) para comenzar de nuevo.');
            }
        }

        // MEJORA 8: Funciones de tutorial
        function mostrarTutorialSiNecesario() {
            // Mostrar el modal de bienvenida si no hay un borrador guardado
            // (ya no usamos localStorage para esto, así siempre aparece en sesiones nuevas)
            if (!cargarBorradorSiExiste()) {
                document.getElementById('tutorialModal').classList.add('active');
            }
        }

        function cerrarTutorial() {
            // Solo cerrar el modal, no guardar nada en localStorage
            document.getElementById('tutorialModal').classList.remove('active');
        }

        // Variables globales del tutorial
        let tutorialPasoActual = 0;
        let elementoAnterior = null;

        const pasosTutorial = [
            {
                selector: '.tabs',
                titulo: '📑 Paso 1: Navegación por Pestañas',
                descripcion: 'El planificador está organizado en 6 pestañas. Cada pestaña representa una etapa del proceso. Completa cada sección en orden para crear tu Plan Local de Salud.',
                posicion: 'bottom'
            },
            {
                selector: '[data-tab="configuracion"]',
                titulo: '⚙️ Paso 2: Configuración Inicial',
                descripcion: 'Comienza aquí identificando tu municipio y subiendo el Perfil de Salud Local en PDF. Selecciona el área prioritaria que trabajarás.',
                posicion: 'bottom',
                accion: () => cambiarTab('configuracion')
            },
            {
                selector: '#nombreMunicipio',
                titulo: '🏛️ Paso 3: Nombre del Municipio',
                descripcion: 'Escribe el nombre de tu municipio. Este dato aparecerá en todos los documentos generados. Es un campo obligatorio.',
                posicion: 'bottom'
            },
            {
                selector: '#areaPrioritaria',
                titulo: '🎯 Paso 4: Área Prioritaria',
                descripcion: 'Selecciona el área de salud prioritaria identificada en tu Perfil de Salud. El sistema te sugerirá objetivos EPVSA relacionados.',
                posicion: 'bottom'
            },
            {
                selector: '[data-tab="lineas"]',
                titulo: '✅ Paso 5: Selección de Líneas EPVSA',
                descripcion: 'Aquí seleccionarás las líneas estratégicas, objetivos y programas EPVSA que implementarás en tu municipio. Puedes elegir múltiples opciones.',
                posicion: 'bottom',
                accion: () => cambiarTab('lineas')
            },
            {
                selector: '[data-tab="plan"]',
                titulo: '📋 Paso 6: Plan Local de Salud',
                descripcion: 'En esta pestaña verás el plan completo estructurado con todas las líneas, objetivos y programas que has seleccionado.',
                posicion: 'bottom',
                accion: () => cambiarTab('plan')
            },
            {
                selector: '[data-tab="indicadores"]',
                titulo: '📊 Paso 7: Cuadro de Mandos',
                descripcion: 'Completa los 58 indicadores del cuadro de mandos EPVSA. Puedes guardar tu progreso y volver más tarde.',
                posicion: 'bottom',
                accion: () => cambiarTab('indicadores')
            },
            {
                selector: '[data-tab="agendas"]',
                titulo: '📅 Paso 8: Agendas Anuales RELAS',
                descripcion: 'Planifica las actuaciones concretas que realizarás cada año (2024-2030) organizadas por entornos: Sanitario, Comunitario, Educativo y Laboral.',
                posicion: 'bottom',
                accion: () => cambiarTab('agendas')
            },
            {
                selector: '.stats-bar',
                titulo: '💾 Paso 9: Estadísticas y Progreso',
                descripcion: 'En la parte superior verás siempre el resumen de tu progreso: líneas seleccionadas, objetivos, programas y actuaciones registradas.',
                posicion: 'bottom'
            },
            {
                selector: '[data-tab="conclusiones"]',
                titulo: '📥 Paso 10: Exportar Documentos',
                descripcion: 'Cuando termines, aquí podrás exportar todos los documentos en formato PDF. Incluye el Plan Completo con los 3 documentos principales.',
                posicion: 'bottom',
                accion: () => cambiarTab('conclusiones')
            }
        ];

        function iniciarTutorial() {
            // Cerrar el modal de bienvenida
            document.getElementById('tutorialModal').classList.remove('active');
            
            tutorialPasoActual = 0;
            mostrarPasoTutorial();
        }

        function mostrarPasoTutorial() {
            if (tutorialPasoActual >= pasosTutorial.length) {
                finalizarTutorial();
                return;
            }

            const paso = pasosTutorial[tutorialPasoActual];
            const elemento = document.querySelector(paso.selector);
            
            if (!elemento) {
                console.warn('Elemento no encontrado:', paso.selector);
                tutorialPasoActual++;
                mostrarPasoTutorial();
                return;
            }

            // Ejecutar acción si existe (como cambiar de tab)
            if (paso.accion) {
                paso.accion();
                setTimeout(() => continuarConPaso(paso, elemento), 300);
            } else {
                continuarConPaso(paso, elemento);
            }
        }

        function continuarConPaso(paso, elemento) {
            // Limpiar spotlight anterior
            if (elementoAnterior) {
                elementoAnterior.classList.remove('tutorial-spotlight');
            }

            // Activar overlay
            const overlay = document.getElementById('tutorialOverlay');
            overlay.classList.add('active');

            // Añadir spotlight al elemento actual
            elemento.classList.add('tutorial-spotlight');
            elementoAnterior = elemento;

            // Scroll al elemento
            elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Mostrar tooltip
            setTimeout(() => {
                mostrarTooltip(paso, elemento);
            }, 500);
        }

        function mostrarTooltip(paso, elemento) {
            const tooltip = document.getElementById('tutorialTooltip');
            const rect = elemento.getBoundingClientRect();
            
            const progreso = Math.round(((tutorialPasoActual + 1) / pasosTutorial.length) * 100);
            
            tooltip.innerHTML = `
                <div class="tutorial-progress">
                    <span>Paso ${tutorialPasoActual + 1} de ${pasosTutorial.length}</span>
                    <div class="tutorial-progress-bar">
                        <div class="tutorial-progress-fill" style="width: ${progreso}%"></div>
                    </div>
                </div>
                <h3>${paso.titulo}</h3>
                <p>${paso.descripcion}</p>
                <div class="tutorial-buttons">
                    <button class="btn btn-secondary" onclick="salirTutorial()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        Salir
                    </button>
                    ${tutorialPasoActual > 0 ? 
                        '<button class="btn btn-secondary" onclick="pasoAnteriorTutorial()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">← Anterior</button>' 
                        : ''}
                    <button class="btn btn-primary" onclick="siguientePasoTutorial()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        ${tutorialPasoActual === pasosTutorial.length - 1 ? 'Finalizar ✓' : 'Siguiente →'}
                    </button>
                </div>
            `;

            // Posicionar tooltip
            tooltip.style.display = 'block';
            
            let top, left;
            const tooltipRect = tooltip.getBoundingClientRect();
            
            if (paso.posicion === 'bottom') {
                top = rect.bottom + 20;
                left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            } else if (paso.posicion === 'left') {
                top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                left = rect.left - tooltipRect.width - 20;
            } else if (paso.posicion === 'right') {
                top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                left = rect.right + 20;
            }

            // Asegurar que el tooltip esté dentro de la ventana
            if (left < 20) left = 20;
            if (left + tooltipRect.width > window.innerWidth - 20) {
                left = window.innerWidth - tooltipRect.width - 20;
            }
            if (top < 20) top = 20;
            if (top + tooltipRect.height > window.innerHeight - 20) {
                top = window.innerHeight - tooltipRect.height - 20;
            }

            tooltip.style.top = top + 'px';
            tooltip.style.left = left + 'px';
        }

        function siguientePasoTutorial() {
            tutorialPasoActual++;
            mostrarPasoTutorial();
        }

        function pasoAnteriorTutorial() {
            if (tutorialPasoActual > 0) {
                tutorialPasoActual--;
                mostrarPasoTutorial();
            }
        }

        function salirTutorial() {
            // Limpiar spotlight
            if (elementoAnterior) {
                elementoAnterior.classList.remove('tutorial-spotlight');
                elementoAnterior = null;
            }

            // Ocultar overlay y tooltip
            document.getElementById('tutorialOverlay').classList.remove('active');
            document.getElementById('tutorialTooltip').style.display = 'none';
            
            // Resetear paso
            tutorialPasoActual = 0;
        }

        function finalizarTutorial() {
            // Limpiar spotlight
            if (elementoAnterior) {
                elementoAnterior.classList.remove('tutorial-spotlight');
                elementoAnterior = null;
            }

            // Ocultar overlay y tooltip
            document.getElementById('tutorialOverlay').classList.remove('active');
            document.getElementById('tutorialTooltip').style.display = 'none';

            // Mensaje de finalización
            alert('✅ ¡Tutorial completado!\n\nYa puedes comenzar a crear tu Plan Local de Salud.\n\n💡 Recuerda guardar tu progreso frecuentemente usando el botón "💾 Guardar borrador".');
        }

        function reiniciarTutorial() {
            tutorialPasoActual = 0;
            iniciarTutorial();
        }


        // MEJORA 10: Funciones de información EPVSA
        function mostrarInfoEPVSA(codigoPrograma) {
            const programa = PROGRAMAS_EPVSA_INFO[codigoPrograma];
            if (!programa) return;
            
            const body = document.getElementById('epvsaInfoBody');
            body.innerHTML = `
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #38bdf8; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: inline-block; background: #3b82f6; color: white; padding: 0.35rem 0.75rem; border-radius: 9999px; font-size: 0.85rem; font-weight: 800; margin-bottom: 0.75rem;">
                        ${programa.codigo}
                    </div>
                    <h3 style="color: #0369a1; font-size: 1.2rem; font-weight: 700; margin-bottom: 0.75rem; line-height: 1.4;">
                        ${programa.nombre}
                    </h3>
                    <div style="background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <strong style="color: #0284c7;">Ámbito:</strong>
                        <span style="color: #4b5563;">${programa.ambito}</span>
                    </div>
                    <p style="color: #4b5563; line-height: 1.7; margin-bottom: 1rem;">
                        ${programa.descripcion}
                    </p>
                </div>

                <div style="background: #f9fafb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #667eea; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        🎯 Objetivos EPVSA relacionados
                    </h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${programa.objetivos.map(obj => `
                            <span style="background: #667eea; color: white; padding: 0.35rem 0.75rem; border-radius: 9999px; font-size: 0.85rem; font-weight: 600;">
                                ${obj}
                            </span>
                        `).join('')}
                    </div>
                </div>

                <div style="background: #fffbeb; border-radius: 0.75rem; padding: 1.5rem;">
                    <h4 style="color: #f59e0b; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        💡 Ejemplos de actuaciones
                    </h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        ${programa.actuaciones_tipo.map(act => `
                            <li style="display: flex; align-items: start; gap: 0.5rem; padding: 0.5rem; color: #78350f; line-height: 1.6;">
                                <span style="color: #f59e0b; font-weight: 700; flex-shrink: 0;">▸</span>
                                <span>${act}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>

                <div class="alert alert-info" style="margin-top: 1.5rem;">
                    <span style="font-size: 1.5rem;">📖</span>
                    <div>
                        <strong>Más información oficial:</strong><br>
                        Consulta el documento completo de la EPVSA 2024-2030 en el portal de la Consejería de Salud y Consumo de la Junta de Andalucía.
                    </div>
                </div>
            `;
            
            document.getElementById('epvsaInfoModal').classList.add('active');
        }

        function cerrarEpvsaInfo() {
            document.getElementById('epvsaInfoModal').classList.remove('active');
        }

        // MEJORA 2: Funciones de validación
        function validarConfiguracion() {
            const nombre = document.getElementById('nombreMunicipio').value.trim();
            const perfilCargado = state.perfilCargado;
            
            const validacion = {
                municipio: nombre !== '',
                perfil: perfilCargado,
                area: state.areaPrioritaria !== '',
                sesion: state.sesionGrupoMotor !== ''
            };
            
            // Mostrar panel de validación
            const panel = document.getElementById('validacionConfiguracion');
            if (nombre || perfilCargado) {
                panel.style.display = 'block';
                
                const items = document.getElementById('validacionItems');
                items.innerHTML = `
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.municipio ? '✅' : '⚠️'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.municipio ? 'Completo' : 'Pendiente'}:</span>
                            Municipio identificado
                        </div>
                    </div>
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.perfil ? '✅' : '⚠️'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.perfil ? 'Completo' : 'Pendiente'}:</span>
                            Perfil de salud cargado
                        </div>
                    </div>
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.area ? '✅' : '⚠️'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.area ? 'Completo' : 'Pendiente'}:</span>
                            Área prioritaria definida
                        </div>
                    </div>
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.sesion ? '✅' : '⚠️'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.sesion ? 'Completo' : 'Pendiente'}:</span>
                            Sesión Grupo-Motor registrada
                        </div>
                    </div>
                `;
            }
            
            // Habilitar/deshabilitar botón continuar
            document.getElementById('btnContinuar').disabled = !validacion.municipio;
        }

        function validarSeleccion() {
            let objetivosCount = 0;
            let indicadoresCount = 0;
            let programasCount = 0;
            let actuacionesCount = 0;
            
            ESTRUCTURA_EPVSA.forEach((linea) => {
                linea.objetivos.forEach((objetivo, objIdx) => {
                    const objCheckbox = document.getElementById(`obj${linea.id}_${objIdx}`);
                    if (objCheckbox && objCheckbox.checked) objetivosCount++;
                    
                    objetivo.indicadores.forEach((ind, indIdx) => {
                        const indCheckbox = document.getElementById(`ind${linea.id}_${objIdx}_${indIdx}`);
                        if (indCheckbox && indCheckbox.checked) indicadoresCount++;
                    });
                    
                    objetivo.programas.forEach((programa, progIdx) => {
                        const progCheckbox = document.getElementById(`prog${linea.id}_${objIdx}_${progIdx}`);
                        if (progCheckbox && progCheckbox.checked) programasCount++;
                        
                        programa.actuaciones.forEach((act, actIdx) => {
                            const actCheckbox = document.getElementById(`act${linea.id}_${objIdx}_${progIdx}_${actIdx}`);
                            if (actCheckbox && actCheckbox.checked) actuacionesCount++;
                        });
                    });
                });
            });
            
            const validacion = {
                objetivos: objetivosCount >= 3,
                indicadores: indicadoresCount >= 5,
                programas: programasCount >= 2,
                actuaciones: actuacionesCount >= 5
            };
            
            // Mostrar panel de validación
            const panel = document.getElementById('validacionSeleccion');
            if (objetivosCount > 0) {
                panel.style.display = 'block';
                
                const items = document.getElementById('validacionSeleccionItems');
                items.innerHTML = `
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.objetivos ? '✅' : '⚠️'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.objetivos ? 'Adecuado' : 'Insuficiente'}:</span>
                            ${objetivosCount} objetivos seleccionados ${validacion.objetivos ? '' : '(mínimo recomendado: 3)'}
                        </div>
                    </div>
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.indicadores ? '✅' : '⚠️'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.indicadores ? 'Adecuado' : 'Insuficiente'}:</span>
                            ${indicadoresCount} indicadores seleccionados ${validacion.indicadores ? '' : '(mínimo recomendado: 5)'}
                        </div>
                    </div>
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.programas ? '✅' : '⚠️'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.programas ? 'Adecuado' : 'Insuficiente'}:</span>
                            ${programasCount} programas EPVSA seleccionados ${validacion.programas ? '' : '(mínimo recomendado: 2)'}
                        </div>
                    </div>
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.actuaciones ? '✅' : '⚠️'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.actuaciones ? 'Adecuado' : 'Insuficiente'}:</span>
                            ${actuacionesCount} actuaciones seleccionadas ${validacion.actuaciones ? '' : '(mínimo recomendado: 5)'}
                        </div>
                    </div>
                `;
            }
        }

        function validarIndicadores() {
            const indicadoresSinDatos = state.indicadoresExtraidos.filter(i => i.dato === '-').length;
            const total = state.indicadoresExtraidos.length;
            const conDatos = total - indicadoresSinDatos;
            
            const validacion = {
                basico: conDatos >= 20,
                bueno: conDatos >= 40,
                completo: conDatos >= 55
            };
            
            const panel = document.getElementById('validacionIndicadores');
            panel.style.display = 'block';
            
            const items = document.getElementById('validacionIndicadoresItems');
            items.innerHTML = `
                <div class="validation-item">
                    <span class="validation-icon">${validacion.completo ? '✅' : validacion.bueno ? '⚠️' : '❌'}</span>
                    <div class="validation-text">
                        <span class="validation-status">${validacion.completo ? 'Excelente' : validacion.bueno ? 'Bien' : 'Insuficiente'}:</span>
                        ${conDatos} de 58 indicadores con datos (${indicadoresSinDatos} sin datos)
                    </div>
                </div>
                ${!validacion.completo ? `
                    <div class="alert alert-warning" style="margin-top: 1rem;">
                        <span style="font-size: 1.2rem;">💡</span>
                        <div style="font-size: 0.9rem;">
                            <strong>Recomendación:</strong> Completa al menos 40 indicadores para garantizar un seguimiento adecuado del Plan.
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function validarActuaciones() {
            const actuacionesPorEntorno = {};
            ENTORNOS.forEach(ent => {
                const total = ANOS.reduce((sum, year) => {
                    const key = `${ent.id}-${year}`;
                    return sum + (state.actuaciones[key] ? state.actuaciones[key].length : 0);
                }, 0);
                actuacionesPorEntorno[ent.id] = total;
            });
            
            const totalActuaciones = Object.values(actuacionesPorEntorno).reduce((a, b) => a + b, 0);
            
            const validacion = {
                basico: totalActuaciones >= 4, // Al menos 1 por entorno
                bueno: totalActuaciones >= 12, // Al menos 3 por entorno
                completo: Object.values(actuacionesPorEntorno).every(n => n >= 3)
            };
            
            const panel = document.getElementById('validacionActuaciones');
            panel.style.display = 'block';
            
            const items = document.getElementById('validacionActuacionesItems');
            items.innerHTML = `
                <div class="validation-item">
                    <span class="validation-icon">${validacion.completo ? '✅' : validacion.bueno ? '⚠️' : '❌'}</span>
                    <div class="validation-text">
                        <span class="validation-status">${validacion.completo ? 'Completo' : validacion.bueno ? 'Bien' : 'Insuficiente'}:</span>
                        ${totalActuaciones} actuaciones RELAS registradas
                    </div>
                </div>
                ${ENTORNOS.map(ent => `
                    <div class="validation-item">
                        <span class="validation-icon">${actuacionesPorEntorno[ent.id] >= 3 ? '✅' : actuacionesPorEntorno[ent.id] > 0 ? '⚠️' : '❌'}</span>
                        <div class="validation-text">
                            ${ent.icono} <strong>${ent.nombre}:</strong> ${actuacionesPorEntorno[ent.id]} actuaciones
                        </div>
                    </div>
                `).join('')}
                ${!validacion.completo ? `
                    <div class="alert alert-warning" style="margin-top: 1rem;">
                        <span style="font-size: 1.2rem;">💡</span>
                        <div style="font-size: 0.9rem;">
                            <strong>Recomendación:</strong> Registra al menos 3 actuaciones en cada entorno para garantizar una intervención integral.
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // MEJORA 3: Funciones de sugerencias inteligentes
        function generarSugerencias() {
            const areaLower = state.areaPrioritaria.toLowerCase();
            const sugerencias = SUGERENCIAS_POR_AREA[areaLower] || SUGERENCIAS_POR_AREA['default'];
            
            document.getElementById('areaSugerida').textContent = state.areaPrioritaria;
            
            const lista = document.getElementById('sugerenciasList');
            lista.innerHTML = sugerencias.map(sug => `
                <li class="suggestion-item">
                    <input type="checkbox" class="suggestion-check" id="sug_${sug.linea}_${sug.objetivo}">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                            ${sug.descripcion}
                        </div>
                        <div style="font-size: 0.85rem; color: #6b7280;">
                            Línea Estratégica ${sug.linea} de la EPVSA 2024-2030
                        </div>
                    </div>
                </li>
            `).join('');
        }

        function aplicarSeleccionSugerida() {
            const areaLower = state.areaPrioritaria.toLowerCase();
            const sugerencias = SUGERENCIAS_POR_AREA[areaLower] || SUGERENCIAS_POR_AREA['default'];
            
            let objetivosSeleccionados = 0;
            
            // Marcar checkboxes sugeridos
            sugerencias.forEach(sug => {
                const linea = ESTRUCTURA_EPVSA.find(l => l.id === sug.linea);
                if (!linea) return;
                
                const objIdx = linea.objetivos.findIndex(o => o.id === sug.objetivo);
                if (objIdx === -1) return;
                
                // Marcar objetivo SOLAMENTE
                const objCheckbox = document.getElementById(`obj${linea.id}_${objIdx}`);
                if (objCheckbox) {
                    objCheckbox.checked = true;
                    objetivosSeleccionados++;
                }
                
                // Expandir objetivo para mostrar programas y actuaciones (pero SIN marcarlos)
                toggleObjetivoExpand(linea.id, objIdx);
            });
            
            // Actualizar después de marcar los objetivos
            setTimeout(() => {
                actualizarResumenLineas();
                validarSeleccion();
            }, 100);
            
            state.sugerenciasAplicadas = true;
            cerrarSugerencias();
            
            // Mostrar mensaje después de un pequeño delay
            setTimeout(() => {
                alert(`✅ Selección sugerida aplicada correctamente\n\n` +
                      `📊 Se han seleccionado ${objetivosSeleccionados} objetivos estratégicos recomendados.\n\n` +
                      `⚠️ IMPORTANTE: Ahora debes seleccionar manualmente:\n` +
                      `• Los indicadores de evaluación que consideres relevantes\n` +
                      `• Los programas EPVSA que implementarás\n` +
                      `• Las actuaciones específicas de cada programa\n\n` +
                      `💡 Personaliza la selección según las necesidades específicas de tu municipio.`);
            }, 300);
        }

        function cerrarSugerencias() {
            document.getElementById('sugerenciasInteligentes').style.display = 'none';
        }

        function actualizarAreaPrioritaria(valor) {
            state.areaPrioritaria = valor;
            const display = document.getElementById('areaPrioritariaDisplay');
            if (display) display.textContent = valor;
            
            // Regenerar sugerencias
            if (!state.sugerenciasAplicadas) {
                generarSugerencias();
            }
        }

        // MEJORA 5: Funciones de plantillas de actuaciones
        function mostrarPlantillasActuaciones() {
            const entorno = state.currentEntorno;
            const plantillas = PLANTILLAS_ACTUACIONES[entorno] || [];
            
            if (plantillas.length === 0) return '';
            
            return `
                <div style="background: #f0f9ff; border: 2px solid #38bdf8; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem;">
                    <h4 style="color: #0369a1; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        💡 Plantillas de Actuaciones - Entorno ${ENTORNOS.find(e => e.id === entorno).nombre}
                    </h4>
                    <p style="color: #4b5563; font-size: 0.9rem; margin-bottom: 1rem;">
                        Selecciona una plantilla y personalízala según las necesidades de tu municipio:
                    </p>
                    ${plantillas.map((plantilla, idx) => `
                        <div class="plantilla-card" onclick="insertarPlantilla(${idx}, '${entorno}')">
                            <div class="plantilla-header">
                                <span class="plantilla-icon">${plantilla.icon}</span>
                                <span class="plantilla-title">${plantilla.titulo}</span>
                                <button class="btn btn-primary plantilla-btn" onclick="event.stopPropagation(); insertarPlantilla(${idx}, '${entorno}')">
                                    ➕ Insertar
                                </button>
                            </div>
                            <div class="plantilla-descripcion">
                                ${plantilla.descripcion}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function insertarPlantilla(idx, entorno) {
            const plantilla = PLANTILLAS_ACTUACIONES[entorno][idx];
            
            document.getElementById('inputTituloActuacion').value = plantilla.titulo;
            document.getElementById('textActuacion').value = plantilla.descripcion;
            
            // Scroll al formulario
            document.querySelector('.actividad-registro').scrollIntoView({ behavior: 'smooth' });
            
            // Efecto visual
            const form = document.querySelector('.actividad-registro');
            form.style.animation = 'pulse 1s ease-in-out';
            setTimeout(() => {
                form.style.animation = '';
            }, 1000);
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            // AUTO-LOGIN COMO ADMIN - TÚ SIEMPRE TIENES ACCESO
            usuarioActual = {
                tipo: 'admin',
                nombre: 'Administrador',
                esAdmin: true
            };
            sessionStorage.setItem('planificadorEPVSA_sesion', JSON.stringify(usuarioActual));
            console.log('✅ AUTO-LOGIN ADMIN ACTIVADO');
            
            inicializarTabs();
            inicializarAnalizadorPDF();
            renderEntornoSelector();
            
            document.getElementById('nombreMunicipio').addEventListener('input', validarConfiguracion);
            document.getElementById('areaPrioritaria').addEventListener('change', (e) => actualizarAreaPrioritaria(e.target.value));
            
            // Sincronizar población del municipio con indicador #1
            document.getElementById('poblacionMunicipio').addEventListener('input', (e) => {
                const poblacion = e.target.value.trim();
                state.municipio.poblacion = poblacion;
                
                // Actualizar indicador #1 en todos los años
                Object.keys(state.cuadrosMandosAnuales).forEach(ano => {
                    const indicador = state.cuadrosMandosAnuales[ano].find(i => i.numero === 1);
                    if (indicador) {
                        indicador.dato = poblacion || '—';
                    }
                });
                
                // Si estamos en la pestaña de indicadores, re-renderizar
                if (document.getElementById('indicadores').classList.contains('active')) {
                    renderIndicadores();
                }
                
                guardarEstado();
            });
            
            // MEJORA 8: Mostrar tutorial si es primera vez
            setTimeout(() => {
                mostrarTutorialSiNecesario();
            }, 500);
            
            validarConfiguracion();
        });

        function inicializarTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    cambiarTab(tabId);
                });
            });
        }

        function cambiarTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            // Resetear scroll al inicio del contenedor al cambiar de tab
            if (tabId === 'lineas') {
                setTimeout(() => {
                    const container = document.querySelector('.container');
                    if (container) container.scrollTop = 0;
                    window.scrollTo(0, 0);
                }, 0);
            }

            if (tabId === 'lineas') {
                renderArbolLineas();
                if (!state.sugerenciasAplicadas) {
                    generarSugerencias();
                }
            }
            if (tabId === 'plan') renderPlanLocal();
            if (tabId === 'indicadores') {
                renderIndicadores();
                if (state.indicadoresExtraidos.length > 0) {
                    validarIndicadores();
                }
            }
            if (tabId === 'agendas') {
                renderAgendas();
                validarActuaciones();
            }
            if (tabId === 'conclusiones') renderConclusiones();
        }

        function inicializarAnalizadorPDF() {
            const uploadZone = document.getElementById('uploadZone');
            const pdfInput = document.getElementById('pdfInput');

            uploadZone.addEventListener('click', () => pdfInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragging');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragging');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragging');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'application/pdf') {
                    procesarPDF(file);
                }
            });

            pdfInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) procesarPDF(file);
            });
        }

        async function procesarPDF(file) {
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;">⏳</div>
                <div style="font-size: 1.2rem; font-weight: 600; color: #10b981;">
                    Analizando perfil de salud...
                </div>
            `;

            try {
                // Configurar PDF.js worker
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                // Leer el archivo PDF
                const arrayBuffer = await file.arrayBuffer();
                
                // Guardar PRIMERO el PDF en memoria (antes de que PDF.js lo consuma)
                state.pdfData = arrayBuffer.slice(0); // copia del arrayBuffer
                
                // AHORA sí procesar con PDF.js
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                state.pdfNumPages = pdf.numPages;
                console.log(`✅ PDF guardado en memoria: ${pdf.numPages} páginas`);
                
                uploadZone.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📄</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: #10b981;">
                        Extrayendo indicadores (${pdf.numPages} páginas)...
                    </div>
                `;
                
                // Extraer texto de todas las páginas
                let textoCompleto = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    textoCompleto += pageText + '\n';
                }
                
                // Inicializar array de indicadores extraídos con la estructura base
                // IMPORTANTE: NO intentamos extraer valores automáticamente porque es muy propenso a errores
                // El usuario debe completar los valores manualmente en el tab "Indicadores"
                state.indicadoresExtraidos = INDICADORES_CMI.map(ind => ({...ind}));
                
                // ========== EXTRACCIÓN DE METADATOS DEL PDF ==========
                
                // 1. EXTRAER NOMBRE DEL MUNICIPIO
                console.log('Buscando nombre del municipio en el PDF...');
                
                // Patrones para detectar el nombre del municipio
                // Buscar en las primeras páginas (portada y primeras secciones)
                const primeras5Paginas = textoCompleto.substring(0, Math.min(textoCompleto.length, 5000));
                
                const patronesMunicipio = [
                    /perfil\s+(?:de\s+)?salud\s+(?:local\s+)?(?:de\s+)?([A-ZÁÉÍÓÚÑ][a-záéíóúñ]+(?:\s+(?:de|del|la|los|las)\s+)?[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+?)/i,
                    /municipio\s+(?:de\s+)?([A-ZÁÉÍÓÚÑ][a-záéíóúñ]+(?:\s+(?:de|del|la|los|las)\s+)?[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+?)/i,
                    /plan\s+(?:local\s+)?(?:de\s+)?salud\s+(?:de\s+)?([A-ZÁÉÍÓÚÑ][a-záéíóúñ]+(?:\s+(?:de|del|la|los|las)\s+)?[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+?)/i,
                    /ayuntamiento\s+(?:de\s+)?([A-ZÁÉÍÓÚÑ][a-záéíóúñ]+(?:\s+(?:de|del|la|los|las)\s+)?[A-ZÁÉÍÓÚÑ][a-záéíóúñ]+?)/i
                ];
                
                let nombreMunicipioExtraido = null;
                for (const patron of patronesMunicipio) {
                    const match = primeras5Paginas.match(patron);
                    if (match && match[1]) {
                        const nombre = match[1].trim();
                        
                        // Validar que sea un nombre razonable (entre 3 y 50 caracteres, sin números)
                        if (nombre.length >= 3 && nombre.length <= 50 && !/\d/.test(nombre)) {
                            // Limpiar palabras comunes que no son parte del nombre
                            const nombreLimpio = nombre
                                .replace(/\s+(local|municipal|perfil|salud|plan)$/i, '')
                                .trim();
                            
                            if (nombreLimpio.length >= 3) {
                                nombreMunicipioExtraido = nombreLimpio;
                                console.log('✅ Municipio extraído del PDF:', nombreLimpio);
                                
                                // Rellenar automáticamente el campo (con pequeño delay para asegurar DOM cargado)
                                setTimeout(() => {
                                    const campoMunicipio = document.getElementById('nombreMunicipio');
                                    if (campoMunicipio) {
                                        campoMunicipio.value = nombreLimpio;
                                        state.municipio.nombre = nombreLimpio;
                                        console.log('✅ Campo municipio rellenado con:', nombreLimpio);
                                    } else {
                                        console.error('❌ No se encontró el campo nombreMunicipio en el DOM');
                                    }
                                }, 100);
                                break;
                            }
                        }
                    }
                }
                
                if (!nombreMunicipioExtraido) {
                    console.log('⚠️ No se pudo extraer el nombre del municipio. El usuario deberá introducirlo manualmente.');
                }
                
                // 2. EXTRAER CONCLUSIONES DEL PDF
                const seccionConclusiones = textoCompleto.match(/conclusiones[:\s]+(.*?)(?=recomendaciones|área prioritaria|$)/is);
                if (seccionConclusiones) {
                    console.log('Conclusiones encontradas en el PDF');
                }
                
                // 3. EXTRAER RECOMENDACIONES
                const seccionRecomendaciones = textoCompleto.match(/recomendaciones[:\s]+(.*?)(?=área prioritaria|$)/is);
                if (seccionRecomendaciones) {
                    console.log('Recomendaciones encontradas en el PDF');
                }
                
                // 4. EXTRAER ÁREA PRIORITARIA
                const seccionAreaPrioritaria = textoCompleto.match(/área prioritaria[:\s]+(.*?)(?:\n|$)/is);
                if (seccionAreaPrioritaria && seccionAreaPrioritaria[1]) {
                    const areaPrio = seccionAreaPrioritaria[1].trim();
                    if (areaPrio.length > 5 && areaPrio.length < 200) {
                        state.areaPrioritaria = areaPrio;
                        console.log('Área prioritaria extraída:', areaPrio);
                    }
                }
                
                // 5. EXTRAER POBLACIÓN DEL PDF - BUSCAR INDICADOR 1 EN CUADRO DE MANDOS
                // Buscar específicamente "Indicador 1 Población Total" o "Población total" en el CMI
                
                console.log('Buscando Indicador 1 - Población Total en el Cuadro de Mandos...');
                
                // Buscar múltiples patrones posibles
                const patronesPoblacion = [
                    // Patrón 1: Con "Indicador 1"
                    /indicador\s*1[:\s]*población\s*total[:\s]*(\d{1,3}(?:[.,\s]\d{3})*)/i,
                    // Patrón 2: Solo "Población total" (tu caso)
                    /población\s*total[:\s]*(\d{1,3}(?:[.,\s]\d{3})*)/i,
                    // Patrón 3: Con código del indicador (ej: D1.1)
                    /d1\.1[:\s]*población\s*total[:\s]*(\d{1,3}(?:[.,\s]\d{3})*)/i
                ];
                
                let poblacionExtraida = null;
                
                for (const patron of patronesPoblacion) {
                    const matchPoblacion = textoCompleto.match(patron);
                    
                    if (matchPoblacion && matchPoblacion[1]) {
                        // Limpiar el número (eliminar puntos, comas y espacios)
                        const numeroLimpio = matchPoblacion[1].replace(/[.,\s]/g, '');
                        const poblacion = parseInt(numeroLimpio);
                        
                        // Validar que sea un número razonable para un municipio español
                        if (poblacion >= 100 && poblacion <= 3500000) {
                            poblacionExtraida = poblacion;
                            console.log('✅ Población extraída del Cuadro de Mandos:', poblacion);
                            
                            // Rellenar automáticamente el campo (con pequeño delay para asegurar DOM cargado)
                            setTimeout(() => {
                                const campoPoblacion = document.getElementById('poblacionMunicipio');
                                if (campoPoblacion) {
                                    campoPoblacion.value = poblacion;
                                    state.municipio.poblacion = poblacion;
                                    console.log('✅ Campo población rellenado con:', poblacion);
                                } else {
                                    console.error('❌ No se encontró el campo poblacionMunicipio en el DOM');
                                }
                            }, 100);
                            break; // Salir del bucle si encontró la población
                        } else {
                            console.log('⚠️ Población encontrada pero fuera de rango válido:', poblacion);
                        }
                    }
                }
                
                if (!poblacionExtraida) {
                    console.log('⚠️ No se encontró la Población Total en el PDF.');
                    console.log('ℹ️ El usuario deberá introducir la población manualmente.');
                }
                
                // Contar indicadores (siempre serán 58 con datos en blanco)
                const indicadoresConDatos = 0; // Ninguno extraído automáticamente
                
                state.perfilCargado = true;
                
                // MOSTRAR banner de área prioritaria y sugerencias inteligentes
                document.getElementById('mensajeSinPerfil').style.display = 'none';
                document.getElementById('areaPrioritariaBanner').style.display = 'block';
                document.getElementById('sugerenciasInteligentes').style.display = 'block';
                
                document.getElementById('statIndicadores').textContent = '58';
                document.getElementById('statConclusiones').textContent = '4';
                document.getElementById('statPrioridad').textContent = '1';
                
                document.getElementById('uploadZone').style.display = 'none';
                document.getElementById('analisisResultados').style.display = 'block';
                
                renderConclusionesResumen();
                renderRecomendacionesResumen();
                
                document.querySelector('[data-tab="configuracion"]').classList.add('completed');
                
                validarConfiguracion();
                
                alert('✅ Perfil de salud cargado correctamente\n\n' +
                      '📊 Los 58 indicadores del Cuadro de Mandos están listos en el tab "Indicadores".\n\n' +
                      '⚠️ IMPORTANTE: Debes completar los valores de los indicadores manualmente con tus datos locales.\n\n' +
                      '💡 El sistema NO extrae valores automáticamente del PDF para evitar errores.');
                
            } catch (error) {
                console.error('Error al procesar PDF:', error);
                uploadZone.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 1rem;">❌</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: #ef4444;">
                        Error al analizar el PDF
                    </div>
                    <div style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                        ${error.message}
                    </div>
                    <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">
                        Reintentar
                    </button>
                `;
            }
        }

        function renderArbolLineas() {
            const container = document.getElementById('lineasEstrategicasContainer');
            
            const html = ESTRUCTURA_EPVSA.map(linea => `
                <div class="tree-linea" style="border: 3px solid ${linea.color};">
                    <div class="tree-linea-header" style="background: ${linea.color};" onclick="toggleLineaExpand(${linea.id})">
                        <input type="checkbox" 
                               id="linea${linea.id}" 
                               class="tree-checkbox"
                               onchange="toggleLineaSeleccion(${linea.id})"
                               onclick="event.stopPropagation();">
                        <span class="tree-expand" id="expand${linea.id}">▶</span>
                        <div class="tree-linea-title">
                            Línea ${linea.id}: ${linea.nombre}
                        </div>
                        <span class="tree-linea-count">
                            ${linea.objetivos.length} objetivos
                        </span>
                    </div>
                    <div class="tree-linea-content" id="content${linea.id}">
                        ${linea.objetivos.map((objetivo, objIdx) => `
                            <div class="tree-objetivo" style="border-color: ${linea.color};">
                                <div class="tree-objetivo-header">
                                    <input type="checkbox" 
                                           id="obj${linea.id}_${objIdx}" 
                                           class="tree-checkbox"
                                           style="width: 20px; height: 20px; margin-right: 0.5rem;"
                                           onchange="actualizarResumenLineas(); validarSeleccion();"
                                           onclick="event.stopPropagation();">
                                    <span class="tree-objetivo-id" style="color: ${linea.color};">${objetivo.id}</span>
                                    <span class="tree-objetivo-nombre" style="flex: 1; cursor: pointer;" onclick="toggleObjetivoExpand(${linea.id}, ${objIdx})">${objetivo.nombre}</span>
                                    <span class="tree-objetivo-toggle" id="toggleObj${linea.id}_${objIdx}" style="cursor: pointer;" onclick="toggleObjetivoExpand(${linea.id}, ${objIdx})">Ver más ▼</span>
                                </div>
                                <div class="tree-objetivo-content" id="objContent${linea.id}_${objIdx}">
                                    <!-- Indicadores -->
                                    <div class="tree-section">
                                        <div class="tree-section-title">
                                            <span class="tree-section-icon">📊</span>
                                            Indicadores de Evaluación (${objetivo.indicadores.length})
                                        </div>
                                        <ul class="tree-list" style="list-style: none; padding: 0;">
                                            ${objetivo.indicadores.map((ind, indIdx) => `
                                                <li class="tree-list-item" style="display: flex; align-items: start; gap: 0.5rem;">
                                                    <input type="checkbox" 
                                                           id="ind${linea.id}_${objIdx}_${indIdx}" 
                                                           style="width: 18px; height: 18px; margin-top: 0.2rem; flex-shrink: 0;"
                                                           onchange="actualizarResumenLineas(); validarSeleccion();">
                                                    <span style="flex: 1;">${ind}</span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                    
                                    <!-- Programas y Actuaciones -->
                                    <div class="tree-section">
                                        <div class="tree-section-title">
                                            <span class="tree-section-icon">🎯</span>
                                            Programas y Actuaciones (${objetivo.programas.length} programas)
                                        </div>
                                        ${objetivo.programas.length === 0 ? '<p style="color: #6b7280; font-style: italic; padding: 0.5rem;">No hay programas específicos para este objetivo</p>' : ''}
                                        ${objetivo.programas.map((programa, progIdx) => `
                                            <div class="tree-programa">
                                                <div class="tree-programa-nombre" style="display: flex; align-items: start; gap: 0.5rem;">
                                                    <input type="checkbox" 
                                                           id="prog${linea.id}_${objIdx}_${progIdx}" 
                                                           style="width: 18px; height: 18px; margin-top: 0.1rem; flex-shrink: 0;"
                                                           onchange="actualizarProgramasSeleccionados(${linea.id}, ${objIdx}, ${progIdx})">
                                                    <div style="flex: 1;">
                                                        <span class="tree-programa-codigo">${programa.codigo}</span>
                                                        ${programa.nombre}
                                                        <button class="epvsa-info-btn" onclick="event.stopPropagation(); mostrarInfoEPVSA('${programa.codigo}')">
                                                            ℹ️ Ver detalles
                                                        </button>
                                                    </div>
                                                </div>
                                                <div style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                                    ${programa.actuaciones.map((act, actIdx) => `
                                                        <div class="tree-actuacion" style="display: flex; align-items: start; gap: 0.5rem; padding-left: 0rem;">
                                                            <input type="checkbox" 
                                                                   id="act${linea.id}_${objIdx}_${progIdx}_${actIdx}" 
                                                                   style="width: 16px; height: 16px; margin-top: 0.2rem; flex-shrink: 0;"
                                                                   onchange="actualizarResumenLineas(); validarSeleccion();">
                                                            <span style="flex: 1;">• ${act}</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function toggleLineaExpand(lineaId) {
            const content = document.getElementById(`content${lineaId}`);
            const expand = document.getElementById(`expand${lineaId}`);
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                expand.classList.remove('expanded');
            } else {
                content.classList.add('show');
                expand.classList.add('expanded');
            }
        }

        function toggleLineaSeleccion(lineaId) {
            const lineaCheckbox = document.getElementById(`linea${lineaId}`);
            const isChecked = lineaCheckbox.checked;
            
            const linea = ESTRUCTURA_EPVSA.find(l => l.id === lineaId);
            if (!linea) return;
            
            const content = document.getElementById(`content${lineaId}`);
            const expand = document.getElementById(`expand${lineaId}`);
            
            if (isChecked) {
                content.classList.add('show');
                expand.classList.add('expanded');
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    const objContent = document.getElementById(`objContent${lineaId}_${objIdx}`);
                    const objToggle = document.getElementById(`toggleObj${lineaId}_${objIdx}`);
                    if (objContent && objToggle) {
                        objContent.classList.add('show');
                        objToggle.textContent = 'Ocultar ▲';
                    }
                });
            } else {
                linea.objetivos.forEach((objetivo, objIdx) => {
                    const objCheckbox = document.getElementById(`obj${lineaId}_${objIdx}`);
                    if (objCheckbox) objCheckbox.checked = false;
                    
                    objetivo.indicadores.forEach((ind, indIdx) => {
                        const indCheckbox = document.getElementById(`ind${lineaId}_${objIdx}_${indIdx}`);
                        if (indCheckbox) indCheckbox.checked = false;
                    });
                    
                    objetivo.programas.forEach((programa, progIdx) => {
                        const progCheckbox = document.getElementById(`prog${lineaId}_${objIdx}_${progIdx}`);
                        if (progCheckbox) progCheckbox.checked = false;
                        
                        programa.actuaciones.forEach((act, actIdx) => {
                            const actCheckbox = document.getElementById(`act${lineaId}_${objIdx}_${progIdx}_${actIdx}`);
                            if (actCheckbox) actCheckbox.checked = false;
                        });
                    });
                });
            }
            
            actualizarResumenLineas();
            validarSeleccion();
        }

        function toggleObjetivoExpand(lineaId, objIdx) {
            const content = document.getElementById(`objContent${lineaId}_${objIdx}`);
            const toggle = document.getElementById(`toggleObj${lineaId}_${objIdx}`);
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                toggle.textContent = 'Ver más ▼';
            } else {
                content.classList.add('show');
                toggle.textContent = 'Ocultar ▲';
            }
        }

        function actualizarProgramasSeleccionados(lineaId, objIdx, progIdx) {
            const linea = ESTRUCTURA_EPVSA.find(l => l.id === lineaId);
            if (!linea) return;
            
            const programa = linea.objetivos[objIdx].programas[progIdx];
            const progCheckbox = document.getElementById(`prog${lineaId}_${objIdx}_${progIdx}`);
            
            if (progCheckbox.checked) {
                if (!state.programasSeleccionados.includes(programa.codigo)) {
                    state.programasSeleccionados.push(programa.codigo);
                }
            } else {
                const index = state.programasSeleccionados.indexOf(programa.codigo);
                if (index > -1) {
                    state.programasSeleccionados.splice(index, 1);
                }
            }
            
            actualizarResumenLineas();
            actualizarEstadisticas();
            validarSeleccion();
        }

        function renderConclusionesResumen() {
            const container = document.getElementById('conclusionesResumen');
            container.innerHTML = CONCLUSIONES.map((c, idx) => `
                <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; margin-bottom: ${idx < CONCLUSIONES.length - 1 ? '0.75rem' : '0'}; border-radius: 0.5rem;">
                    <div style="display: flex; gap: 0.75rem; align-items: start;">
                        <div style="background: #10b981; color: white; width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 800; flex-shrink: 0;">
                            ${c.numero}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #059669; font-size: 0.95rem; margin-bottom: 0.25rem;">${c.titulo}</div>
                            <div style="color: #374151; font-size: 0.85rem; line-height: 1.6;">${c.texto}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderRecomendacionesResumen() {
            const container = document.getElementById('recomendacionesResumen');
            container.innerHTML = RECOMENDACIONES.map((r, idx) => `
                <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: ${idx < RECOMENDACIONES.length - 1 ? '0.75rem' : '0'}; border-radius: 0.5rem;">
                    <div style="display: flex; gap: 0.75rem; align-items: start;">
                        <div style="background: #f59e0b; color: white; width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 800; flex-shrink: 0;">
                            ${r.numero}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #d97706; font-size: 0.95rem; margin-bottom: 0.25rem;">${r.titulo}</div>
                            <div style="color: #374151; font-size: 0.85rem; line-height: 1.6;">${r.texto}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function mostrarIndicadoresExtraidos() {
            cambiarTab('indicadores');
        }

        function renderIndicadores() {
            const container = document.getElementById('indicadoresContainer');
            
            // Obtener indicadores del año activo
            const anoActivo = state.anoActivoCuadro;
            const indicadores = state.cuadrosMandosAnuales[anoActivo] || INDICADORES_CMI;
            const categorias = [...new Set(indicadores.map(i => i.categoria))];
            
            // Contar indicadores completados
            const completados = indicadores.filter(i => i.dato && i.dato !== '-' && i.dato !== '—').length;
            
            let html = `
                <div class="alert alert-info" style="margin-bottom: 2rem;">
                    <span style="font-size: 1.5rem;">ℹ️</span>
                    <div>
                        <strong>Cuadro de Mandos Integral ${anoActivo}</strong><br>
                        Estos son los 58 indicadores oficiales para el seguimiento y evaluación de tu Plan Local de Salud.
                        ${anoActivo === 2024 ? 'Los datos del 2024 ya están pre-rellenados. ' : ''}Puedes editarlos manualmente.
                        <br><strong>Completados: ${completados}/58</strong>
                    </div>
                </div>
            `;
            
            categorias.forEach(categoria => {
                const indicadoresCategoria = indicadores.filter(i => i.categoria === categoria);
                
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem; padding: 0.75rem; background: #f0f4ff; border-radius: 0.5rem;">
                            📊 ${categoria} (${indicadoresCategoria.length} indicadores)
                        </h3>
                        <div style="background: white; border: 2px solid #10b981; border-radius: 0.75rem; padding: 1.5rem;">
                            ${indicadoresCategoria.map(ind => `
                                <div style="background: #f9fafb; border-left: 4px solid #667eea; padding: 1rem; margin-bottom: 0.75rem; border-radius: 0.5rem; display: grid; grid-template-columns: 60px 1fr 120px 150px; gap: 1rem; align-items: center; font-size: 0.85rem;">
                                    <div style="font-weight: 700; color: #667eea; font-size: 1rem;">#${ind.numero}</div>
                                    <div style="color: #4b5563;">${ind.indicador}</div>
                                    <div style="font-weight: 700; color: #1f2937; text-align: right;">
                                        <input type="text" 
                                               value="${ind.dato}" 
                                               placeholder="-"
                                               style="width: 80px; padding: 0.25rem; border: 1px solid #e5e7eb; border-radius: 0.25rem; text-align: right;"
                                               onchange="actualizarIndicador(${ind.numero}, this.value);">
                                        <span style="margin-left: 0.25rem; color: #6b7280; font-size: 0.85rem;">${ind.unidad}</span>
                                    </div>
                                    <div style="color: #6b7280; font-size: 0.75rem; text-align: right;">${ind.fuente}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="exportarCuadroMandos()" style="margin-right: 1rem;">
                        📥 Exportar Cuadro ${anoActivo} a CSV
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function actualizarIndicador(numero, valor) {
            const anoActivo = state.anoActivoCuadro;
            const index = state.cuadrosMandosAnuales[anoActivo].findIndex(i => i.numero === numero);
            if (index !== -1) {
                state.cuadrosMandosAnuales[anoActivo][index].dato = valor;
                guardarEstado();
            }
        }

        function cambiarAnoCuadro(ano) {
            state.anoActivoCuadro = ano;
            
            // Crear cuadro para este año si no existe
            if (!state.cuadrosMandosAnuales[ano]) {
                // Copiar estructura de INDICADORES_CMI pero sin datos
                state.cuadrosMandosAnuales[ano] = INDICADORES_CMI.map(ind => ({
                    ...ind,
                    dato: "-"
                }));
            }
            
            // Actualizar botones
            document.querySelectorAll('.year-btn').forEach(btn => {
                if (parseInt(btn.dataset.year) === ano) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Re-renderizar indicadores del año seleccionado
            renderIndicadores();
            guardarEstado();
        }

        function exportarCuadroMandos() {
            const anoActivo = state.anoActivoCuadro;
            const datos = state.cuadrosMandosAnuales[anoActivo] || INDICADORES_CMI;
            const csv = 'Número,Indicador,Unidad,Dato,Fuente,Categoría\n' + 
                datos.map(i => `${i.numero},"${i.indicador}",${i.unidad},${i.dato},${i.fuente},${i.categoria}`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Cuadro_Mandos_${anoActivo}_${state.municipio.nombre || 'Municipal'}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // AGENDAS ANUALES
        function renderEntornoSelector() {
            const container = document.getElementById('entornoSelector');
            container.innerHTML = ENTORNOS.map(ent => `
                <div class="entorno-card ${state.currentEntorno === ent.id ? 'active' : ''}"
                     onclick="cambiarEntorno('${ent.id}')">
                    <div class="entorno-icon">${ent.icono}</div>
                    <div class="entorno-name">${ent.nombre}</div>
                </div>
            `).join('');
        }

        function cambiarEntorno(entornoId) {
            state.currentEntorno = entornoId;
            renderEntornoSelector();
            renderAgendas();
        }

        function renderAgendas() {
            const container = document.getElementById('entornoContent');
            
            if (state.programasSeleccionados.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <span style="font-size: 1.5rem;">⚠️</span>
                        <div>
                            <strong>No hay programas seleccionados</strong><br>
                            Por favor, selecciona programas primero en el paso de Líneas Estratégicas.
                        </div>
                    </div>
                `;
                return;
            }

            const entorno = ENTORNOS.find(e => e.id === state.currentEntorno);
            
            container.innerHTML = `
                <h3 style="color: #667eea; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    ${entorno.icono} Entorno ${entorno.nombre}
                </h3>

                <div class="year-tabs">
                    ${ANOS.map(year => `
                        <div class="year-tab ${state.currentYear === year ? 'active' : ''}"
                             onclick="cambiarYear(${year})">${year}</div>
                    `).join('')}
                </div>

                ${mostrarPlantillasActuaciones()}

                <div class="actividad-registro">
                    <h4 style="margin-bottom: 1.5rem; color: #667eea; display: flex; align-items: center; gap: 0.5rem;">
                        ➕ Registrar Nueva Actuación - ${state.currentYear}
                    </h4>

                    <!-- INFORMACIÓN BÁSICA -->
                    <div style="background: #f0f9ff; border: 2px solid #bae6fd; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h5 style="color: #0284c7; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            📝 Información Básica
                        </h5>
                        <div class="input-group">
                            <label class="input-label">Título de la Actuación *</label>
                            <input type="text" id="inputTituloActuacion" class="input-field" 
                                   placeholder="Ej: Campaña de promoción de actividad física">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Descripción Detallada *</label>
                            <textarea id="textActuacion" class="input-field" rows="3"
                                      placeholder="Describe la actuación en detalle..."></textarea>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label class="input-label">Fecha de Inicio</label>
                                <input type="date" id="fechaInicioActuacion" class="input-field">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Fecha de Fin</label>
                                <input type="date" id="fechaFinActuacion" class="input-field">
                            </div>
                        </div>
                    </div>

                    <!-- RESPONSABLES -->
                    <div style="background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h5 style="color: #16a34a; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            👤 Responsables
                        </h5>
                        <div class="input-row">
                            <div class="input-group">
                                <label class="input-label">Responsable Principal *</label>
                                <input type="text" id="inputResponsablePrincipal" class="input-field" 
                                       placeholder="Nombre y cargo">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Entidad Responsable</label>
                                <input type="text" id="inputResponsableEntidad" class="input-field" 
                                       placeholder="Organismo o entidad">
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="agregarActuacion()" 
                            style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                        💾 Guardar Actuación
                    </button>
                </div>

                <div id="listaActuaciones" style="margin-top: 2rem;">
                    ${renderListaActuaciones()}
                </div>
            `;
        }

        function cambiarYear(year) {
            state.currentYear = year;
            renderAgendas();
        }

        function agregarActuacion() {
            const titulo = document.getElementById('inputTituloActuacion').value;
            const descripcion = document.getElementById('textActuacion').value;
            const fechaInicio = document.getElementById('fechaInicioActuacion').value;
            const fechaFin = document.getElementById('fechaFinActuacion').value;
            const responsablePrincipal = document.getElementById('inputResponsablePrincipal').value;
            const responsableEntidad = document.getElementById('inputResponsableEntidad').value;

            if (!titulo) {
                alert('⚠️ Por favor ingresa el Título de la actuación');
                return;
            }
            if (!descripcion) {
                alert('⚠️ Por favor ingresa la Descripción de la actuación');
                return;
            }
            if (!responsablePrincipal) {
                alert('⚠️ Por favor ingresa el Responsable Principal');
                return;
            }

            const key = `${state.currentEntorno}-${state.currentYear}`;
            if (!state.actuaciones[key]) {
                state.actuaciones[key] = [];
            }

            state.actuaciones[key].push({
                id: Date.now(),
                titulo: titulo,
                descripcion: descripcion,
                fechaInicio: fechaInicio,
                fechaFin: fechaFin,
                responsablePrincipal: responsablePrincipal,
                responsableEntidad: responsableEntidad,
                entorno: state.currentEntorno,
                year: state.currentYear
            });

            renderAgendas();
            actualizarEstadisticas();
            validarActuaciones();
            
            alert('✅ Actuación guardada correctamente');
        }

        function renderListaActuaciones() {
            const key = `${state.currentEntorno}-${state.currentYear}`;
            const actuaciones = state.actuaciones[key] || [];

            if (actuaciones.length === 0) {
                return `<div class="alert alert-info">
                    <span style="font-size: 1.5rem;">ℹ️</span>
                    <div>No hay actuaciones registradas para este entorno y año.</div>
                </div>`;
            }

            return `
                <h4 style="margin-bottom: 1rem;">Actuaciones Registradas (${actuaciones.length})</h4>
                ${actuaciones.map(act => `
                    <div class="actividad-item" style="margin-bottom: 1.5rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 0.25rem;">
                                        ${act.titulo || 'Sin título'}
                                    </div>
                                </div>
                                <button class="btn btn-danger btn-small" onclick="eliminarActuacion(${act.id})" 
                                        style="background: rgba(255,255,255,0.2); border: none;">
                                    🗑️
                                </button>
                            </div>
                        </div>
                        
                        <div style="padding: 1.5rem; background: white;">
                            ${act.descripcion ? `
                                <div style="margin-bottom: 1.5rem;">
                                    <h6 style="color: #667eea; font-weight: 700; margin-bottom: 0.5rem;">📝 Descripción</h6>
                                    <p style="color: #4b5563; line-height: 1.6;">${act.descripcion}</p>
                                </div>
                            ` : ''}

                            ${act.fechaInicio || act.fechaFin ? `
                                <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f0f9ff; border-radius: 0.5rem;">
                                    <h6 style="color: #0284c7; font-weight: 700; margin-bottom: 0.75rem;">📅 Temporalidad</h6>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; font-size: 0.9rem;">
                                        ${act.fechaInicio ? `<div><strong>Inicio:</strong> ${act.fechaInicio}</div>` : ''}
                                        ${act.fechaFin ? `<div><strong>Fin:</strong> ${act.fechaFin}</div>` : ''}
                                    </div>
                                </div>
                            ` : ''}

                            ${act.responsablePrincipal || act.responsableEntidad ? `
                                <div style="padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
                                    <h6 style="color: #16a34a; font-weight: 700; margin-bottom: 0.75rem;">👤 Responsables</h6>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.9rem;">
                                        ${act.responsablePrincipal ? `<div><strong>Principal:</strong> ${act.responsablePrincipal}</div>` : ''}
                                        ${act.responsableEntidad ? `<div><strong>Entidad:</strong> ${act.responsableEntidad}</div>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function eliminarActuacion(id) {
            const key = `${state.currentEntorno}-${state.currentYear}`;
            if (state.actuaciones[key]) {
                state.actuaciones[key] = state.actuaciones[key].filter(act => act.id !== id);
                renderAgendas();
                actualizarEstadisticas();
                validarActuaciones();
            }
        }

        function renderConclusiones() {
            const container = document.getElementById('conclusionesContainer');
            
            if (!state.perfilCargado) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <span style="font-size: 1.5rem;">⚠️</span>
                        <div>
                            <strong>Completa estos pasos primero:</strong><br>
                            1. Carga un Perfil de Salud (PDF) en Configuración<br>
                            2. Selecciona objetivos y programas en Líneas Estratégicas<br>
                            3. Vuelve aquí para descargar tu Plan de Acción en PDF
                        </div>
                    </div>
                `;
                return;
            }
            
            const totalActuaciones = Object.values(state.actuaciones).reduce((sum, arr) => sum + arr.length, 0);
            
            container.innerHTML = `
                <!-- PRIORIZACIÓN -->
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; font-size: 1.5rem;">🎯 PRIORIZACIÓN</h3>
                    <div style="font-size: 1.8rem; font-weight: 700; margin-bottom: 1rem;">${state.areaPrioritaria || 'Bienestar Emocional'}</div>
                    <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 1rem; font-weight: 600;">
                        📅 Sesión del Grupo-Motor: ${state.sesionGrupoMotor || 'Febrero de 2025'}
                    </div>
                </div>

                <!-- RESUMEN EJECUTIVO -->
                <div style="background: #f9fafb; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
                    <h2 style="color: #667eea; margin-bottom: 1.5rem;">📊 Resumen Ejecutivo del Plan</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center; border: 2px solid #667eea;">
                            <div style="font-size: 3rem; font-weight: 800; color: #667eea;" id="resumenLineas">0</div>
                            <div style="color: #6b7280; font-weight: 600;">Líneas Seleccionadas</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center; border: 2px solid #10b981;">
                            <div style="font-size: 3rem; font-weight: 800; color: #10b981;" id="resumenProgramas">0</div>
                            <div style="color: #6b7280; font-weight: 600;">Programas</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center; border: 2px solid #f59e0b;">
                            <div style="font-size: 3rem; font-weight: 800; color: #f59e0b;">${totalActuaciones}</div>
                            <div style="color: #6b7280; font-weight: 600;">Actuaciones</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center; border: 2px solid #ef4444;">
                            <div style="font-size: 3rem; font-weight: 800; color: #ef4444;">58</div>
                            <div style="color: #6b7280; font-weight: 600;">Indicadores CMI</div>
                        </div>
                    </div>
                </div>

                <!-- CONCLUSIONES -->
                <div style="background: white; border: 3px solid #10b981; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="color: #10b981; margin-bottom: 1.5rem; font-size: 1.5rem;">
                        ✅ CONCLUSIONES DEL DIAGNÓSTICO (${CONCLUSIONES.length})
                    </h3>
                    ${CONCLUSIONES.map(c => `
                        <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: #10b981; color: white; width: 3rem; height: 3rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 800;">
                                    ${c.numero}
                                </div>
                                <div style="font-weight: 700; color: #059669; font-size: 1.1rem;">${c.titulo}</div>
                            </div>
                            <div style="color: #374151; line-height: 1.8; padding-left: 4rem;">${c.texto}</div>
                        </div>
                    `).join('')}
                </div>

                <!-- RECOMENDACIONES -->
                <div style="background: white; border: 3px solid #f59e0b; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="color: #f59e0b; margin-bottom: 1.5rem; font-size: 1.5rem;">
                        💡 RECOMENDACIONES ESTRATÉGICAS (${RECOMENDACIONES.length})
                    </h3>
                    ${RECOMENDACIONES.map(r => `
                        <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: #f59e0b; color: white; width: 3rem; height: 3rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 800;">
                                    ${r.numero}
                                </div>
                                <div style="font-weight: 700; color: #d97706; font-size: 1.1rem;">${r.titulo}</div>
                            </div>
                            <div style="color: #374151; line-height: 1.8; padding-left: 4rem;">${r.texto}</div>
                        </div>
                    `).join('')}
                </div>

                <!-- COMPILADOR FINAL - 3 DOCUMENTOS -->
                <div class="compile-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; margin-bottom: 2rem;">
                    <h3 style="color: white; font-size: 1.8rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 2.5rem;">📦</span>
                        Compilador de Plan Local de Salud Completo
                    </h3>
                    
                    <p style="color: white; margin-bottom: 1.5rem; line-height: 1.6; font-size: 1.05rem; opacity: 0.95;">
                        <strong>Genera un único PDF</strong> que integra los 3 documentos esenciales de tu Plan Local de Salud
                    </p>
                    
                    <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                        <div style="color: white; font-size: 1rem; line-height: 1.8;">
                            <strong style="font-size: 1.1rem;">📋 El Plan Local de Salud Completo incluye:</strong><br><br>
                            
                            <div style="margin-left: 1rem;">
                                <strong>1️⃣ Perfil de Salud Local</strong><br>
                                <span style="opacity: 0.9; font-size: 0.95rem;">→ Documento PDF cargado con diagnóstico y 58 indicadores CMI</span><br><br>
                                
                                <strong>2️⃣ Plan de Acción Generado</strong><br>
                                <span style="opacity: 0.9; font-size: 0.95rem;">→ Líneas estratégicas, objetivos, indicadores, programas EPVSA y actuaciones seleccionadas</span><br><br>
                                
                                <strong>3️⃣ Agendas Anuales RELAS</strong><br>
                                <span style="opacity: 0.9; font-size: 0.95rem;">→ Actuaciones registradas organizadas por entornos (Sanitario, Comunitario, Educativo-Laboral)</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-compile" onclick="generarPDFCompleto()" 
                            style="background: white; color: #667eea; border: 3px solid white; font-weight: 700; box-shadow: 0 6px 20px rgba(0,0,0,0.3); font-size: 1.1rem; padding: 1.25rem 2rem;">
                        <span style="font-size: 1.8rem;">📄</span>
                        Descargar Plan Local de Salud Completo
                    </button>
                    
                    <p style="margin-top: 1.5rem; font-size: 0.9rem; color: rgba(255,255,255,0.9); font-style: italic; text-align: center;">
                        ✨ Documento profesional listo para presentar, aprobar e implementar
                    </p>
                </div>


            `;
            
            // Actualizar contadores en el resumen
            document.getElementById('resumenLineas').textContent = state.lineasEstrategicas.length;
            document.getElementById('resumenProgramas').textContent = state.programasSeleccionados.length;
        }

        function exportarInformeCompleto() {
            const municipio = state.municipio.nombre || 'Municipal';
            const fecha = new Date().toLocaleDateString('es-ES');
            
            const contenido = `
INFORME DE SALUD LOCAL - ${municipio.toUpperCase()}
Estrategia para una Vida Saludable en Andalucía (EPVSA) 2024-2030
Fecha de elaboración: ${fecha}

================================================================================
EQUIPO ELABORADOR
================================================================================

Coordinador/a: ${state.equipo.coordinador || '-'}
Técnico/a Salud Pública: ${state.equipo.tecnicoSalud || '-'}
Representante Municipal: ${state.equipo.representanteMunicipal || '-'}
Otros miembros: ${state.equipo.otrosMiembros || '-'}

================================================================================
PRIORIZACIÓN
================================================================================

Área Prioritaria: ${state.areaPrioritaria || 'Bienestar Emocional'}
Sesión del Grupo-Motor: ${state.sesionGrupoMotor || 'Febrero de 2025'}

================================================================================
CONCLUSIONES DEL DIAGNÓSTICO
================================================================================

${CONCLUSIONES.map(c => `[${c.numero}] ${c.titulo}\n${c.texto}`).join('\n\n')}

================================================================================
RECOMENDACIONES ESTRATÉGICAS
================================================================================

${RECOMENDACIONES.map(r => `[${r.numero}] ${r.titulo}\n${r.texto}`).join('\n\n')}

================================================================================
CUADRO DE MANDOS INTEGRAL (58 INDICADORES)
================================================================================

${(state.indicadoresExtraidos.length > 0 ? state.indicadoresExtraidos : INDICADORES_CMI).map(i => 
`[${i.numero}] ${i.indicador}: ${i.dato} ${i.unidad} (${i.fuente})`
).join('\n')}

================================================================================
Documento generado automáticamente por el Planificador EPVSA 2024-2030 v2.0
UGC Interniveles Prevención, Promoción y Vigilancia de la Salud
`;

            const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Informe_Salud_${municipio.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            
            alert('✅ Informe completo exportado correctamente');
        }

        function imprimirInforme() {
            window.print();
        }

        function continuarAPlanificacion() {
            const nombre = document.getElementById('nombreMunicipio').value.trim();
            
            if (!nombre) {
                alert('⚠️ Por favor, ingresa el nombre del municipio antes de continuar.');
                return;
            }
            
            state.municipio.nombre = nombre;
            state.municipio.provincia = document.getElementById('provinciaMunicipio').value.trim();
            state.municipio.poblacion = parseInt(document.getElementById('poblacionMunicipio').value) || null;
            
            state.equipo.coordinador = document.getElementById('coordinador').value.trim();
            state.equipo.tecnicoSalud = document.getElementById('tecnicoSalud').value.trim();
            state.equipo.representanteMunicipal = document.getElementById('representanteMunicipal').value.trim();
            state.equipo.otrosMiembros = document.getElementById('otrosMiembros').value.trim();
            
            document.getElementById('headerTitle').innerHTML = `🎯 Plan Local de Salud - ${state.municipio.nombre}`;
            if (state.municipio.provincia) {
                document.getElementById('headerSubtitle').innerHTML = `${state.municipio.nombre}, ${state.municipio.provincia} • EPVSA 2024-2030`;
            } else {
                document.getElementById('headerSubtitle').innerHTML = `${state.municipio.nombre} • EPVSA 2024-2030`;
            }
            
            document.querySelector('[data-tab="configuracion"]').classList.add('completed');
            cambiarTab('lineas');
            
            setTimeout(() => {
                const areaPrioEl = document.getElementById('areaPrioritariaDisplay');
                if (areaPrioEl && state.areaPrioritaria) {
                    areaPrioEl.textContent = state.areaPrioritaria;
                }
            }, 100);
        }

        function guardarYGenerarPlan() {
            // Si ya hay un plan generado previamente, simplemente regenerar la vista y cambiar de tab
            if (state.planGenerado && state.planGenerado.length > 0) {
                console.log('Plan ya generado, regenerando vista...');
                
                // Calcular totales del plan existente
                let totalObjetivos = 0;
                let totalIndicadores = 0;
                let totalProgramas = 0;
                let totalActuaciones = 0;
                
                state.planGenerado.forEach(linea => {
                    totalObjetivos += linea.objetivos.length;
                    linea.objetivos.forEach(obj => {
                        totalIndicadores += obj.indicadores.length;
                        totalProgramas += obj.programas.length;
                        obj.programas.forEach(prog => {
                            totalActuaciones += prog.actuaciones.length;
                        });
                    });
                });
                
                // Mostrar confirmación
                const confirmar = confirm(
                    `Ya tienes un Plan de Acción generado:\n\n` +
                    `📊 Contenido actual:\n` +
                    `• ${state.planGenerado.length} Líneas Estratégicas\n` +
                    `• ${totalObjetivos} Objetivos Estratégicos\n` +
                    `• ${totalIndicadores} Indicadores\n` +
                    `• ${totalProgramas} Programas EPVSA\n` +
                    `• ${totalActuaciones} Actuaciones\n\n` +
                    `¿Deseas regenerar el plan con las selecciones actuales?\n\n` +
                    `• SI = Regenerar con selecciones actuales\n` +
                    `• NO = Mantener el plan actual`
                );
                
                if (!confirmar) {
                    // Mantener el plan actual y solo cambiar de tab
                    cambiarTab('plan');
                    return;
                }
                // Si confirma, continuar con la regeneración normal
            }
            
            // Recopilar elementos seleccionados del DOM
            let lineasSeleccionadas = [];
            
            ESTRUCTURA_EPVSA.forEach((linea) => {
                let lineaData = {
                    id: linea.id,
                    codigo: linea.codigo,
                    nombre: linea.nombre,
                    color: linea.color,
                    objetivos: []
                };
                
                let lineaTieneSeleccion = false;
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    const objCheckbox = document.getElementById(`obj${linea.id}_${objIdx}`);
                    
                    if (objCheckbox && objCheckbox.checked) {
                        let objetivoData = {
                            id: objetivo.id,
                            codigo: objetivo.codigo,
                            nombre: objetivo.nombre,
                            indicadores: [],
                            programas: []
                        };
                        
                        // Recopilar indicadores seleccionados
                        objetivo.indicadores.forEach((ind, indIdx) => {
                            const indCheckbox = document.getElementById(`ind${linea.id}_${objIdx}_${indIdx}`);
                            if (indCheckbox && indCheckbox.checked) {
                                objetivoData.indicadores.push(ind);
                            }
                        });
                        
                        // Recopilar programas y actuaciones seleccionados
                        objetivo.programas.forEach((programa, progIdx) => {
                            const progCheckbox = document.getElementById(`prog${linea.id}_${objIdx}_${progIdx}`);
                            if (progCheckbox && progCheckbox.checked) {
                                let programaData = {
                                    codigo: programa.codigo,
                                    nombre: programa.nombre,
                                    actuaciones: []
                                };
                                
                                programa.actuaciones.forEach((act, actIdx) => {
                                    const actCheckbox = document.getElementById(`act${linea.id}_${objIdx}_${progIdx}_${actIdx}`);
                                    if (actCheckbox && actCheckbox.checked) {
                                        programaData.actuaciones.push(act);
                                    }
                                });
                                
                                objetivoData.programas.push(programaData);
                            }
                        });
                        
                        lineaData.objetivos.push(objetivoData);
                        lineaTieneSeleccion = true;
                    }
                });
                
                if (lineaTieneSeleccion) {
                    lineasSeleccionadas.push(lineaData);
                }
            });
            
            if (lineasSeleccionadas.length === 0) {
                // Si no hay checkboxes marcados, verificar si existe un plan previo
                if (state.planGenerado && state.planGenerado.length > 0) {
                    console.log('No hay checkboxes marcados, pero existe plan previo. Usando plan existente.');
                    
                    // Calcular totales del plan existente
                    let totalObjetivos = 0;
                    let totalIndicadores = 0;
                    let totalProgramas = 0;
                    let totalActuaciones = 0;
                    
                    state.planGenerado.forEach(linea => {
                        totalObjetivos += linea.objetivos.length;
                        linea.objetivos.forEach(obj => {
                            totalIndicadores += obj.indicadores.length;
                            totalProgramas += obj.programas.length;
                            obj.programas.forEach(prog => {
                                totalActuaciones += prog.actuaciones.length;
                            });
                        });
                    });
                    
                    // Usar el plan existente y cambiar al tab
                    alert(`✅ Mostrando tu Plan de Acción guardado\n\n` +
                          `📊 Contenido del Plan:\n` +
                          `• ${state.planGenerado.length} Líneas Estratégicas\n` +
                          `• ${totalObjetivos} Objetivos Estratégicos\n` +
                          `• ${totalIndicadores} Indicadores\n` +
                          `• ${totalProgramas} Programas EPVSA\n` +
                          `• ${totalActuaciones} Actuaciones Seleccionadas`);
                    
                    cambiarTab('plan');
                    return;
                }
                
                // Si no hay checkboxes marcados ni plan previo, mostrar error
                alert('⚠️ Por favor, selecciona al menos un objetivo estratégico para generar el Plan de Acción.\n\n' +
                      'Ve al tab "Selección EPVSA" y marca las casillas de:\n' +
                      '• Objetivos estratégicos\n' +
                      '• Indicadores\n' +
                      '• Programas EPVSA\n' +
                      '• Actuaciones');
                cambiarTab('lineas');
                return;
            }
            
            // Guardar en el estado
            state.planGenerado = lineasSeleccionadas;
            
            // Marcar tab como completado
            document.querySelector('[data-tab="lineas"]').classList.add('completed');
            
            // Calcular totales
            let totalObjetivos = 0;
            let totalIndicadores = 0;
            let totalProgramas = 0;
            let totalActuaciones = 0;
            
            lineasSeleccionadas.forEach(linea => {
                totalObjetivos += linea.objetivos.length;
                linea.objetivos.forEach(obj => {
                    totalIndicadores += obj.indicadores.length;
                    totalProgramas += obj.programas.length;
                    obj.programas.forEach(prog => {
                        totalActuaciones += prog.actuaciones.length;
                    });
                });
            });
            
            alert(`✅ Plan de Acción generado correctamente\n\n` +
                  `📊 Resumen del Plan de Acción:\n` +
                  `• ${lineasSeleccionadas.length} Líneas Estratégicas\n` +
                  `• ${totalObjetivos} Objetivos Estratégicos\n` +
                  `• ${totalIndicadores} Indicadores\n` +
                  `• ${totalProgramas} Programas EPVSA\n` +
                  `• ${totalActuaciones} Actuaciones Seleccionadas`);
            
            // Cambiar al tab del Plan
            cambiarTab('plan');
        }

        function generarPlanSilencioso() {
            // Versión silenciosa de guardarYGenerarPlan (sin alertas ni cambio de tab)
            let lineasSeleccionadas = [];
            
            ESTRUCTURA_EPVSA.forEach((linea) => {
                let lineaData = {
                    id: linea.id,
                    codigo: linea.codigo,
                    nombre: linea.nombre,
                    color: linea.color,
                    objetivos: []
                };
                
                let lineaTieneSeleccion = false;
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    const objCheckbox = document.getElementById(`obj${linea.id}_${objIdx}`);
                    
                    if (objCheckbox && objCheckbox.checked) {
                        let objetivoData = {
                            id: objetivo.id,
                            codigo: objetivo.codigo,
                            nombre: objetivo.nombre,
                            indicadores: [],
                            programas: []
                        };
                        
                        // Recopilar indicadores seleccionados
                        objetivo.indicadores.forEach((ind, indIdx) => {
                            const indCheckbox = document.getElementById(`ind${linea.id}_${objIdx}_${indIdx}`);
                            if (indCheckbox && indCheckbox.checked) {
                                objetivoData.indicadores.push(ind);
                            }
                        });
                        
                        // Recopilar programas y actuaciones seleccionados
                        objetivo.programas.forEach((programa, progIdx) => {
                            const progCheckbox = document.getElementById(`prog${linea.id}_${objIdx}_${progIdx}`);
                            if (progCheckbox && progCheckbox.checked) {
                                let programaData = {
                                    codigo: programa.codigo,
                                    nombre: programa.nombre,
                                    actuaciones: []
                                };
                                
                                programa.actuaciones.forEach((act, actIdx) => {
                                    const actCheckbox = document.getElementById(`act${linea.id}_${objIdx}_${progIdx}_${actIdx}`);
                                    if (actCheckbox && actCheckbox.checked) {
                                        programaData.actuaciones.push(act);
                                    }
                                });
                                
                                objetivoData.programas.push(programaData);
                            }
                        });
                        
                        lineaData.objetivos.push(objetivoData);
                        lineaTieneSeleccion = true;
                    }
                });
                
                if (lineaTieneSeleccion) {
                    lineasSeleccionadas.push(lineaData);
                }
            });
            
            // Guardar en el estado (sin alertas)
            state.planGenerado = lineasSeleccionadas;
            
            return lineasSeleccionadas.length > 0;
        }

        function renderPlanLocal() {
            const container = document.getElementById('planContainer');
            
            if (!state.planGenerado || state.planGenerado.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <span style="font-size: 1.5rem;">⚠️</span>
                        <div>
                            <strong>No hay plan generado</strong><br>
                            Por favor, vuelve al paso anterior y selecciona elementos de la EPVSA.
                        </div>
                    </div>
                `;
                return;
            }
            
            const municipio = state.municipio.nombre || 'Municipal';
            const fecha = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // Calcular totales
            let totalObjetivos = 0;
            let totalIndicadores = 0;
            let totalProgramas = 0;
            let totalActuaciones = 0;
            
            state.planGenerado.forEach(linea => {
                totalObjetivos += linea.objetivos.length;
                linea.objetivos.forEach(obj => {
                    totalIndicadores += obj.indicadores.length;
                    totalProgramas += obj.programas.length;
                    obj.programas.forEach(prog => {
                        totalActuaciones += prog.actuaciones.length;
                    });
                });
            });
            
            let html = `
                <!-- PORTADA DEL PLAN -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3rem; border-radius: 1rem; margin-bottom: 2rem; text-align: center;">
                    <h1 style="font-size: 2.5rem; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                        📋 Plan de Acción Local en Salud
                    </h1>
                    <h2 style="font-size: 2rem; margin-bottom: 0.5rem;">${municipio}</h2>
                    <p style="font-size: 1.2rem; opacity: 0.95; margin-bottom: 1.5rem;">
                        ${state.municipio.provincia ? state.municipio.provincia : 'Andalucía'}
                    </p>
                    ${state.equipo.coordinador ? `
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; display: inline-block;">
                            <p style="font-size: 0.9rem; margin: 0;">
                                <strong>Coordinación:</strong> ${state.equipo.coordinador}
                            </p>
                        </div>
                    ` : ''}
                    <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 0.5rem; display: inline-block;">
                        <p style="font-size: 1rem; margin: 0;">
                            En el marco de la Estrategia para una Vida Saludable en Andalucía (EPVSA) 2024-2030
                        </p>
                    </div>
                    <div style="margin-top: 1.5rem; font-size: 0.9rem; opacity: 0.9;">
                        📅 Fecha de elaboración: ${fecha}
                    </div>
                </div>

                <!-- ÁREA PRIORITARIA -->
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
                    <h3 style="font-size: 1.3rem; margin-bottom: 0.5rem; opacity: 0.9;">🎯 ÁREA PRIORITARIA</h3>
                    <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">
                        ${state.areaPrioritaria || 'Bienestar Emocional'}
                    </div>
                    <p style="font-size: 1rem; opacity: 0.95; line-height: 1.6;">
                        Establecida como eje central articulador del Plan de Acción en la sesión de priorización del Grupo-Motor (${state.sesionGrupoMotor || 'Febrero de 2025'})
                    </p>
                </div>

                <!-- RESUMEN EJECUTIVO -->
                <div style="background: white; border: 3px solid #667eea; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="color: #667eea; margin-bottom: 1.5rem; font-size: 1.5rem;">📊 Resumen Ejecutivo</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div style="text-align: center; padding: 1.5rem; background: #f0f4ff; border-radius: 0.75rem;">
                            <div style="font-size: 3rem; font-weight: 800; color: #667eea; line-height: 1;">${state.planGenerado.length}</div>
                            <div style="font-size: 0.9rem; color: #6b7280; font-weight: 600; margin-top: 0.5rem;">Líneas Estratégicas</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: #f0fdf4; border-radius: 0.75rem;">
                            <div style="font-size: 3rem; font-weight: 800; color: #10b981; line-height: 1;">${totalObjetivos}</div>
                            <div style="font-size: 0.9rem; color: #6b7280; font-weight: 600; margin-top: 0.5rem;">Objetivos Estratégicos</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: #fffbeb; border-radius: 0.75rem;">
                            <div style="font-size: 3rem; font-weight: 800; color: #f59e0b; line-height: 1;">${totalIndicadores}</div>
                            <div style="font-size: 0.9rem; color: #6b7280; font-weight: 600; margin-top: 0.5rem;">Indicadores</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: #fef2f2; border-radius: 0.75rem;">
                            <div style="font-size: 3rem; font-weight: 800; color: #ef4444; line-height: 1;">${totalProgramas}</div>
                            <div style="font-size: 0.9rem; color: #6b7280; font-weight: 600; margin-top: 0.5rem;">Programas EPVSA</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: #faf5ff; border-radius: 0.75rem;">
                            <div style="font-size: 3rem; font-weight: 800; color: #8b5cf6; line-height: 1;">${totalActuaciones}</div>
                            <div style="font-size: 0.9rem; color: #6b7280; font-weight: 600; margin-top: 0.5rem;">Actuaciones</div>
                        </div>
                    </div>
                </div>

                <!-- ESTRUCTURA DEL PLAN -->
                <div style="background: white; border: 3px solid #10b981; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="color: #10b981; margin-bottom: 1.5rem; font-size: 1.5rem;">📋 Estructura del Plan de Acción</h3>
                    
                    ${state.planGenerado.map((linea, lineaIdx) => `
                        <div style="margin-bottom: 3rem; ${lineaIdx < state.planGenerado.length - 1 ? 'padding-bottom: 3rem; border-bottom: 3px solid #e5e7eb;' : ''}">
                            <!-- LÍNEA ESTRATÉGICA -->
                            <div style="background: ${linea.color}; color: white; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem;">
                                <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem; font-weight: 600;">
                                    LÍNEA ESTRATÉGICA ${linea.id}
                                </div>
                                <div style="font-size: 1.4rem; font-weight: 700; line-height: 1.4;">
                                    ${linea.nombre}
                                </div>
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid rgba(255,255,255,0.3); display: flex; gap: 2rem; font-size: 0.9rem;">
                                    <div><strong>${linea.objetivos.length}</strong> Objetivos</div>
                                    <div><strong>${linea.objetivos.reduce((sum, obj) => sum + obj.indicadores.length, 0)}</strong> Indicadores</div>
                                    <div><strong>${linea.objetivos.reduce((sum, obj) => sum + obj.programas.length, 0)}</strong> Programas</div>
                                </div>
                            </div>

                            <!-- OBJETIVOS -->
                            ${linea.objetivos.map((objetivo, objIdx) => `
                                <div style="margin-left: 2rem; margin-bottom: 2.5rem;">
                                    <!-- OBJETIVO ESTRATÉGICO -->
                                    <div style="background: #f9fafb; border-left: 5px solid ${linea.color}; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                                        <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1rem;">
                                            <div style="background: ${linea.color}; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 800; font-size: 1rem; flex-shrink: 0;">
                                                ${objetivo.codigo}
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 700; color: #1f2937; font-size: 1.1rem; line-height: 1.5;">
                                                    ${objetivo.nombre}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- INDICADORES -->
                                    ${objetivo.indicadores.length > 0 ? `
                                        <div style="margin-left: 2rem; margin-bottom: 1.5rem;">
                                            <div style="background: #dbeafe; padding: 1rem 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                                <h5 style="color: #1e40af; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                                    <span>📊</span> Indicadores de Evaluación (${objetivo.indicadores.length})
                                                </h5>
                                            </div>
                                            ${objetivo.indicadores.map((ind, indIdx) => `
                                                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem;">
                                                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                                                        <div style="background: #3b82f6; color: white; width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 700; flex-shrink: 0;">
                                                            ${indIdx + 1}
                                                        </div>
                                                        <div style="flex: 1; color: #374151; font-size: 0.95rem; line-height: 1.6;">
                                                            ${ind}
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}

                                    <!-- PROGRAMAS Y ACTUACIONES -->
                                    ${objetivo.programas.length > 0 ? `
                                        <div style="margin-left: 2rem;">
                                            <div style="background: #fef3c7; padding: 1rem 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                                <h5 style="color: #92400e; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                                    <span>🎯</span> Programas EPVSA y Actuaciones (${objetivo.programas.length})
                                                </h5>
                                            </div>
                                            ${objetivo.programas.map((programa, progIdx) => `
                                                <div style="background: white; border: 3px solid #f59e0b; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                                                    <div style="margin-bottom: 1rem;">
                                                        <div style="display: inline-block; background: #f59e0b; color: white; padding: 0.35rem 0.85rem; border-radius: 9999px; font-size: 0.85rem; font-weight: 800; margin-bottom: 0.75rem;">
                                                            ${programa.codigo}
                                                        </div>
                                                        <div style="font-weight: 700; color: #92400e; font-size: 1.05rem; line-height: 1.5;">
                                                            ${programa.nombre}
                                                        </div>
                                                    </div>
                                                    
                                                    ${programa.actuaciones.length > 0 ? `
                                                        <div style="background: #fffbeb; padding: 1rem; border-radius: 0.5rem;">
                                                            <div style="font-weight: 600; color: #78350f; font-size: 0.9rem; margin-bottom: 0.75rem;">
                                                                Actuaciones Seleccionadas:
                                                            </div>
                                                            ${programa.actuaciones.map((act, actIdx) => `
                                                                <div style="display: flex; align-items: start; gap: 0.5rem; margin-bottom: 0.5rem; color: #78350f; font-size: 0.9rem; line-height: 1.6;">
                                                                    <span style="color: #f59e0b; font-weight: 700; flex-shrink: 0;">▸</span>
                                                                    <span>${act}</span>
                                                                </div>
                                                            `).join('')}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>

                <!-- BOTONES DE EXPORTACIÓN -->
                <div style="background: #f9fafb; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
                    <h4 style="color: #667eea; margin-bottom: 1.5rem;">💾 Exportar Plan de Acción</h4>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="exportarPlanPDF()" style="padding: 1rem 2rem;">
                            📄 Exportar como PDF
                        </button>
                        <button class="btn btn-secondary" onclick="exportarPlanEditable()" style="padding: 1rem 2rem; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);">
                            📝 Exportar Plan Editable (Texto)
                        </button>
                        <button class="btn btn-primary" onclick="imprimirPlan()" style="padding: 1rem 2rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            🖨️ Imprimir
                        </button>
                    </div>
                    <p style="margin-top: 1rem; color: #6b7280; font-size: 0.9rem; text-align: center;">
                        El <strong>Plan Editable</strong> genera un archivo de texto estructurado que puedes copiar y pegar en Word, Google Docs o cualquier editor
                    </p>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Marcar tab como completado
            document.querySelector('[data-tab="plan"]').classList.add('completed');
        }

        function exportarPlanPDF() {
            console.log('Intentando exportar PDF...');
            console.log('Estado actual planGenerado:', state.planGenerado);
            
            // Si no hay plan generado, intentar generarlo automáticamente
            if (!state.planGenerado || state.planGenerado.length === 0) {
                console.log('No hay plan generado, intentando generar automáticamente...');
                const generado = generarPlanSilencioso();
                console.log('Resultado de generación:', generado);
                console.log('Plan después de generar:', state.planGenerado);
            }
            
            // Verificar de nuevo después de generar
            if (!state.planGenerado || state.planGenerado.length === 0) {
                alert('⚠️ No se puede exportar el plan.\n\n' +
                      'Por favor, ve al tab "Líneas Estratégicas" y:\n' +
                      '1. Selecciona al menos un objetivo estratégico\n' +
                      '2. Selecciona al menos un programa EPVSA\n' +
                      '3. Selecciona al menos una actuación\n\n' +
                      'Luego intenta exportar nuevamente.');
                cambiarTab('lineas');
                return;
            }
            
            console.log('Preparando para abrir ventana de impresión...');
            
            // Intentar abrir window.print() inmediatamente (sin setTimeout)
            try {
                console.log('Ejecutando window.print()...');
                window.print();
                console.log('window.print() ejecutado');
            } catch (error) {
                console.error('ERROR al ejecutar window.print():', error);
                alert('❌ No se pudo abrir la ventana de impresión.\n\n' +
                      'Por favor, usa el atajo de teclado:\n' +
                      '• Windows/Linux: Ctrl + P\n' +
                      '• Mac: Cmd + P\n\n' +
                      'O intenta con otro navegador.');
            }
        }

        function exportarPlanWord() {
            console.log('Intentando exportar Word...');
            console.log('Estado actual planGenerado:', state.planGenerado);
            
            // Si no hay plan generado, intentar generarlo automáticamente
            if (!state.planGenerado || state.planGenerado.length === 0) {
                console.log('No hay plan generado, intentando generar automáticamente...');
                const generado = generarPlanSilencioso();
                console.log('Resultado de generación:', generado);
                console.log('Plan después de generar:', state.planGenerado);
            }
            
            // Verificar de nuevo después de generar
            if (!state.planGenerado || state.planGenerado.length === 0) {
                alert('⚠️ No se puede exportar el plan.\n\n' +
                      'Por favor, ve al tab "Líneas Estratégicas" y:\n' +
                      '1. Selecciona al menos un objetivo estratégico\n' +
                      '2. Selecciona al menos un programa EPVSA\n' +
                      '3. Selecciona al menos una actuación\n\n' +
                      'Luego intenta exportar nuevamente.');
                cambiarTab('lineas');
                return;
            }
            
            console.log('Generando contenido del plan...');
            
            const municipio = state.municipio.nombre || 'Municipal';
            const fecha = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let contenido = `PLAN LOCAL DE SALUD - ${municipio.toUpperCase()}\n`;
            contenido += `${state.municipio.provincia ? state.municipio.provincia : 'Andalucía'}\n\n`;
            contenido += `En el marco de la Estrategia para una Vida Saludable en Andalucía (EPVSA) 2024-2030\n`;
            contenido += `Fecha de elaboración: ${fecha}\n\n`;
            
            if (state.equipo.coordinador) {
                contenido += `EQUIPO ELABORADOR\n`;
                contenido += `Coordinador/a: ${state.equipo.coordinador}\n`;
                if (state.equipo.tecnicoSalud) contenido += `Técnico/a Salud Pública: ${state.equipo.tecnicoSalud}\n`;
                if (state.equipo.representanteMunicipal) contenido += `Representante Municipal: ${state.equipo.representanteMunicipal}\n`;
                if (state.equipo.otrosMiembros) contenido += `Otros miembros: ${state.equipo.otrosMiembros}\n`;
                contenido += `\n`;
            }
            
            contenido += `${'='.repeat(80)}\n\n`;
            
            contenido += `ÁREA PRIORITARIA\n\n`;
            contenido += `${state.areaPrioritaria || 'Bienestar Emocional'}\n\n`;
            contenido += `Establecida como eje central articulador del Plan de Acción en la sesión de\n`;
            contenido += `priorización del Grupo-Motor (${state.sesionGrupoMotor || 'Febrero de 2025'})\n\n`;
            contenido += `${'='.repeat(80)}\n\n`;
            
            state.planGenerado.forEach((linea, lineaIdx) => {
                contenido += `LÍNEA ESTRATÉGICA ${linea.id}\n`;
                contenido += `${linea.nombre}\n\n`;
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    contenido += `  ${objetivo.codigo} - ${objetivo.nombre}\n\n`;
                    
                    if (objetivo.indicadores.length > 0) {
                        contenido += `    INDICADORES DE EVALUACIÓN:\n`;
                        objetivo.indicadores.forEach((ind, indIdx) => {
                            contenido += `      ${indIdx + 1}. ${ind}\n`;
                        });
                        contenido += `\n`;
                    }
                    
                    if (objetivo.programas.length > 0) {
                        contenido += `    PROGRAMAS EPVSA:\n`;
                        objetivo.programas.forEach((programa, progIdx) => {
                            contenido += `      ${programa.codigo} - ${programa.nombre}\n`;
                            if (programa.actuaciones.length > 0) {
                                contenido += `        Actuaciones:\n`;
                                programa.actuaciones.forEach((act, actIdx) => {
                                    contenido += `          • ${act}\n`;
                                });
                            }
                            contenido += `\n`;
                        });
                    }
                    
                    contenido += `\n`;
                });
                
                contenido += `${'-'.repeat(80)}\n\n`;
            });
            
            console.log('Contenido generado. Longitud:', contenido.length, 'caracteres');
            console.log('Creando blob...');
            
            try {
                const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8;' });
                console.log('Blob creado:', blob);
                
                const nombreArchivo = `Plan_Local_Salud_${municipio.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
                console.log('Nombre del archivo:', nombreArchivo);
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nombreArchivo;
                
                console.log('Link creado:', link.href);
                console.log('Agregando link al documento...');
                
                // Agregar el link al documento temporalmente
                document.body.appendChild(link);
                
                console.log('Haciendo clic en el link...');
                link.click();
                
                console.log('Click ejecutado. Removiendo link...');
                
                // Remover el link después de un momento
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    console.log('Link removido y URL liberada');
                }, 100);
                
                alert('✅ Plan exportado correctamente como archivo de texto.\n\nPuedes abrirlo en Word para darle formato adicional.');
                
            } catch (error) {
                console.error('ERROR al crear el archivo:', error);
                alert('❌ Error al crear el archivo de exportación.\n\nError: ' + error.message + '\n\nPor favor, intenta de nuevo o contacta con soporte.');
            }
        }

        function imprimirPlan() {
            console.log('Intentando imprimir...');
            console.log('Estado actual planGenerado:', state.planGenerado);
            
            // Si no hay plan generado, intentar generarlo automáticamente
            if (!state.planGenerado || state.planGenerado.length === 0) {
                console.log('No hay plan generado, intentando generar automáticamente...');
                const generado = generarPlanSilencioso();
                console.log('Resultado de generación:', generado);
                console.log('Plan después de generar:', state.planGenerado);
            }
            
            // Verificar de nuevo después de generar
            if (!state.planGenerado || state.planGenerado.length === 0) {
                alert('⚠️ No se puede imprimir el plan.\n\n' +
                      'Por favor, ve al tab "Líneas Estratégicas" y:\n' +
                      '1. Selecciona al menos un objetivo estratégico\n' +
                      '2. Selecciona al menos un programa EPVSA\n' +
                      '3. Selecciona al menos una actuación\n\n' +
                      'Luego intenta imprimir nuevamente.');
                cambiarTab('lineas');
                return;
            }
            
            console.log('Preparando para abrir ventana de impresión...');
            
            // Intentar abrir window.print()
            try {
                console.log('Ejecutando window.print()...');
                window.print();
                console.log('window.print() ejecutado');
            } catch (error) {
                console.error('ERROR al ejecutar window.print():', error);
                alert('❌ No se pudo abrir la ventana de impresión.\n\n' +
                      'Por favor, usa el atajo de teclado:\n' +
                      '• Windows/Linux: Ctrl + P\n' +
                      '• Mac: Cmd + P\n\n' +
                      'O intenta con otro navegador.');
            }
        }

        function exportarPlanEditable() {
            console.log('Iniciando exportación de plan editable...');
            
            // Si no hay plan generado, intentar generarlo automáticamente
            if (!state.planGenerado || state.planGenerado.length === 0) {
                const generado = generarPlanSilencioso();
                if (!generado || !state.planGenerado || state.planGenerado.length === 0) {
                    alert('⚠️ No se puede exportar el plan.\n\n' +
                          'Por favor, ve al tab "Selección EPVSA" y:\n' +
                          '1. Selecciona al menos un objetivo estratégico\n' +
                          '2. Selecciona al menos un programa EPVSA\n' +
                          '3. Selecciona al menos una actuación\n\n' +
                          'Luego intenta exportar nuevamente.');
                    cambiarTab('lineas');
                    return;
                }
            }
            
            // Generar contenido estructurado
            const municipio = state.municipio.nombre || 'Sin especificar';
            const provincia = state.municipio.provincia || 'Andalucía';
            const poblacion = state.municipio.poblacion || 'Sin especificar';
            const fecha = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let contenido = '';
            
            // ========== PORTADA ==========
            contenido += '═'.repeat(80) + '\n';
            contenido += 'PLAN LOCAL DE SALUD\n';
            contenido += `${municipio.toUpperCase()}\n`;
            contenido += `${provincia}\n`;
            contenido += '═'.repeat(80) + '\n\n';
            
            contenido += 'En el marco de:\n';
            contenido += 'ESTRATEGIA PARA UNA VIDA SALUDABLE EN ANDALUCÍA (EPVSA) 2024-2030\n\n';
            contenido += `Fecha de elaboración: ${fecha}\n`;
            contenido += `Población: ${poblacion} habitantes\n\n`;
            
            // ========== EQUIPO ELABORADOR ==========
            contenido += '─'.repeat(80) + '\n';
            contenido += 'EQUIPO ELABORADOR DEL PLAN\n';
            contenido += '─'.repeat(80) + '\n\n';
            
            if (state.equipo.coordinador) {
                contenido += `• Coordinador/a: ${state.equipo.coordinador}\n`;
            }
            if (state.equipo.tecnicoSalud) {
                contenido += `• Técnico/a de Salud Pública: ${state.equipo.tecnicoSalud}\n`;
            }
            if (state.equipo.representanteMunicipal) {
                contenido += `• Representante Municipal: ${state.equipo.representanteMunicipal}\n`;
            }
            if (state.equipo.otrosMiembros) {
                contenido += `• Otros miembros: ${state.equipo.otrosMiembros}\n`;
            }
            
            if (!state.equipo.coordinador && !state.equipo.tecnicoSalud) {
                contenido += '(Equipo por determinar)\n';
            }
            contenido += '\n';
            
            // ========== ÁREA PRIORITARIA ==========
            contenido += '═'.repeat(80) + '\n';
            contenido += 'ÁREA PRIORITARIA DE SALUD\n';
            contenido += '═'.repeat(80) + '\n\n';
            
            contenido += `📌 ${state.areaPrioritaria || 'Bienestar Emocional'}\n\n`;
            contenido += 'Establecida como eje central articulador del Plan de Acción\n';
            contenido += `en la sesión de priorización del Grupo-Motor.\n`;
            contenido += `Fecha de la sesión: ${state.sesionGrupoMotor || 'Febrero de 2025'}\n\n`;
            
            // ========== CONCLUSIONES DEL PERFIL DE SALUD ==========
            if (state.perfilCargado) {
                contenido += '═'.repeat(80) + '\n';
                contenido += 'CONCLUSIONES DEL PERFIL DE SALUD LOCAL\n';
                contenido += '═'.repeat(80) + '\n\n';
                
                CONCLUSIONES.forEach((c, idx) => {
                    contenido += `${c.numero}. ${c.titulo.toUpperCase()}\n`;
                    contenido += `${c.texto}\n\n`;
                });
                
                // ========== RECOMENDACIONES ==========
                contenido += '─'.repeat(80) + '\n';
                contenido += 'RECOMENDACIONES ESTRATÉGICAS\n';
                contenido += '─'.repeat(80) + '\n\n';
                
                RECOMENDACIONES.forEach((r, idx) => {
                    contenido += `${r.numero}. ${r.titulo.toUpperCase()}\n`;
                    contenido += `${r.texto}\n\n`;
                });
            }
            
            // ========== PLAN DE ACCIÓN ==========
            contenido += '═'.repeat(80) + '\n';
            contenido += 'PLAN DE ACCIÓN - LÍNEAS ESTRATÉGICAS EPVSA\n';
            contenido += '═'.repeat(80) + '\n\n';
            
            state.planGenerado.forEach((linea, lineaIdx) => {
                contenido += `\n${'▓'.repeat(80)}\n`;
                contenido += `LÍNEA ESTRATÉGICA ${linea.id}: ${linea.nombre.toUpperCase()}\n`;
                contenido += `${'▓'.repeat(80)}\n\n`;
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    contenido += `┌${'─'.repeat(78)}┐\n`;
                    contenido += `│ OBJETIVO ${objetivo.codigo}: ${objetivo.nombre}\n`;
                    contenido += `└${'─'.repeat(78)}┘\n\n`;
                    
                    // Indicadores
                    if (objetivo.indicadores && objetivo.indicadores.length > 0) {
                        contenido += `  📊 INDICADORES DE EVALUACIÓN:\n`;
                        objetivo.indicadores.forEach((ind, indIdx) => {
                            contenido += `     ${indIdx + 1}. ${ind}\n`;
                        });
                        contenido += `\n`;
                    }
                    
                    // Programas EPVSA
                    if (objetivo.programas && objetivo.programas.length > 0) {
                        contenido += `  🎯 PROGRAMAS EPVSA SELECCIONADOS:\n\n`;
                        objetivo.programas.forEach((programa, progIdx) => {
                            contenido += `     ► ${programa.codigo} - ${programa.nombre}\n\n`;
                            
                            // Actuaciones del programa
                            if (programa.actuaciones && programa.actuaciones.length > 0) {
                                contenido += `       ACTUACIONES:\n`;
                                programa.actuaciones.forEach((act, actIdx) => {
                                    contenido += `       • ${act}\n`;
                                });
                                contenido += `\n`;
                            }
                        });
                    }
                    
                    contenido += `\n`;
                });
                
                contenido += `${'═'.repeat(80)}\n`;
            });
            
            // ========== AGENDAS ANUALES RELAS ==========
            const totalActuaciones = Object.values(state.actuaciones).reduce((sum, arr) => sum + arr.length, 0);
            
            if (totalActuaciones > 0) {
                contenido += `\n\n`;
                contenido += '═'.repeat(80) + '\n';
                contenido += 'AGENDAS ANUALES - RED LOCAL DE ACCIÓN EN SALUD (RELAS)\n';
                contenido += '═'.repeat(80) + '\n\n';
                
                contenido += `Total de actuaciones registradas: ${totalActuaciones}\n\n`;
                
                const entornos = [
                    { key: 'sanitario', nombre: 'ENTORNO SANITARIO', icono: '🏥' },
                    { key: 'comunitario', nombre: 'ENTORNO COMUNITARIO', icono: '🌍' },
                    { key: 'educativo', nombre: 'ENTORNO EDUCATIVO', icono: '🎓' },
                    { key: 'laboral', nombre: 'ENTORNO LABORAL', icono: '💼' }
                ];
                
                entornos.forEach(entorno => {
                    const actuaciones = state.actuaciones[entorno.key] || [];
                    
                    if (actuaciones.length > 0) {
                        contenido += `\n${'▓'.repeat(80)}\n`;
                        contenido += `${entorno.icono} ${entorno.nombre} (${actuaciones.length} actuaciones)\n`;
                        contenido += `${'▓'.repeat(80)}\n\n`;
                        
                        actuaciones.forEach((act, idx) => {
                            contenido += `${idx + 1}. ${act.nombre}\n`;
                            if (act.descripcion) contenido += `   Descripción: ${act.descripcion}\n`;
                            if (act.responsable) contenido += `   Responsable: ${act.responsable}\n`;
                            if (act.fecha) contenido += `   Fecha prevista: ${act.fecha}\n`;
                            if (act.indicadores) contenido += `   Indicadores: ${act.indicadores}\n`;
                            contenido += `\n`;
                        });
                    }
                });
            }
            
            // ========== PIE DE DOCUMENTO ==========
            contenido += '\n\n' + '═'.repeat(80) + '\n';
            contenido += 'Documento generado con el Planificador EPVSA 2024-2030\n';
            contenido += `Fecha de generación: ${new Date().toLocaleString('es-ES')}\n`;
            contenido += '═'.repeat(80) + '\n';
            
            // ========== EXPORTAR ARCHIVO ==========
            try {
                const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
                const nombreArchivo = `Plan_Local_Salud_${municipio.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nombreArchivo;
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }, 100);
                
                alert('✅ Plan exportado correctamente\n\n' +
                      `Archivo: ${nombreArchivo}\n\n` +
                      '💡 Este archivo de texto está estructurado y listo para:\n' +
                      '• Copiar y pegar en Microsoft Word\n' +
                      '• Abrir en Google Docs\n' +
                      '• Editar en cualquier procesador de texto\n\n' +
                      'Puedes darle el formato visual que prefieras manteniendo la estructura del contenido.');
                
            } catch (error) {
                console.error('Error al exportar:', error);
                alert('❌ Error al generar el archivo\n\n' +
                      `Detalles: ${error.message}\n\n` +
                      'Por favor, intenta de nuevo.');
            }
        }

        function exportarPlanWord() {
            console.log('Intentando exportar Word...');
            console.log('Estado actual planGenerado:', state.planGenerado);
            
            // Si no hay plan generado, intentar generarlo automáticamente
            if (!state.planGenerado || state.planGenerado.length === 0) {
                console.log('No hay plan generado, intentando generar automáticamente...');
                const generado = generarPlanSilencioso();
                console.log('Resultado de generación:', generado);
                console.log('Plan después de generar:', state.planGenerado);
            }
            
            // Verificar de nuevo después de generar
            if (!state.planGenerado || state.planGenerado.length === 0) {
                alert('⚠️ No se puede exportar el plan.\n\n' +
                      'Por favor, ve al tab "Líneas Estratégicas" y:\n' +
                      '1. Selecciona al menos un objetivo estratégico\n' +
                      '2. Selecciona al menos un programa EPVSA\n' +
                      '3. Selecciona al menos una actuación\n\n' +
                      'Luego intenta exportar nuevamente.');
                cambiarTab('lineas');
                return;
            }
            
            console.log('Generando contenido del plan...');
            
            const municipio = state.municipio.nombre || 'Municipal';
            const fecha = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let contenido = `PLAN LOCAL DE SALUD - ${municipio.toUpperCase()}\n`;
            contenido += `${state.municipio.provincia ? state.municipio.provincia : 'Andalucía'}\n\n`;
            contenido += `En el marco de la Estrategia para una Vida Saludable en Andalucía (EPVSA) 2024-2030\n`;
            contenido += `Fecha de elaboración: ${fecha}\n\n`;
            
            if (state.equipo.coordinador) {
                contenido += `EQUIPO ELABORADOR\n`;
                contenido += `Coordinador/a: ${state.equipo.coordinador}\n`;
                if (state.equipo.tecnicoSalud) contenido += `Técnico/a Salud Pública: ${state.equipo.tecnicoSalud}\n`;
                if (state.equipo.representanteMunicipal) contenido += `Representante Municipal: ${state.equipo.representanteMunicipal}\n`;
                if (state.equipo.otrosMiembros) contenido += `Otros miembros: ${state.equipo.otrosMiembros}\n`;
                contenido += `\n`;
            }
            
            contenido += `${'='.repeat(80)}\n\n`;
            
            contenido += `ÁREA PRIORITARIA\n\n`;
            contenido += `${state.areaPrioritaria || 'Bienestar Emocional'}\n\n`;
            contenido += `Establecida como eje central articulador del Plan de Acción en la sesión de\n`;
            contenido += `priorización del Grupo-Motor (${state.sesionGrupoMotor || 'Febrero de 2025'})\n\n`;
            contenido += `${'='.repeat(80)}\n\n`;
            
            state.planGenerado.forEach((linea, lineaIdx) => {
                contenido += `LÍNEA ESTRATÉGICA ${linea.id}\n`;
                contenido += `${linea.nombre}\n\n`;
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    contenido += `  ${objetivo.codigo} - ${objetivo.nombre}\n\n`;
                    
                    if (objetivo.indicadores.length > 0) {
                        contenido += `    INDICADORES DE EVALUACIÓN:\n`;
                        objetivo.indicadores.forEach((ind, indIdx) => {
                            contenido += `      ${indIdx + 1}. ${ind}\n`;
                        });
                        contenido += `\n`;
                    }
                    
                    if (objetivo.programas.length > 0) {
                        contenido += `    PROGRAMAS EPVSA:\n`;
                        objetivo.programas.forEach((programa, progIdx) => {
                            contenido += `      ${programa.codigo} - ${programa.nombre}\n`;
                            if (programa.actuaciones.length > 0) {
                                contenido += `        Actuaciones:\n`;
                                programa.actuaciones.forEach((act, actIdx) => {
                                    contenido += `          • ${act}\n`;
                                });
                            }
                            contenido += `\n`;
                        });
                    }
                    
                    contenido += `\n`;
                });
                
                contenido += `${'-'.repeat(80)}\n\n`;
            });
            
            console.log('Contenido generado. Longitud:', contenido.length, 'caracteres');
            console.log('Creando blob...');
            
            try {
                const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8;' });
                console.log('Blob creado:', blob);
                
                const nombreArchivo = `Plan_Local_Salud_${municipio.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
                console.log('Nombre del archivo:', nombreArchivo);
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nombreArchivo;
                
                console.log('Link creado:', link.href);
                console.log('Agregando link al documento...');
                
                // Agregar el link al documento temporalmente
                document.body.appendChild(link);
                
                console.log('Haciendo clic en el link...');
                link.click();
                
                console.log('Click ejecutado. Removiendo link...');
                
                // Remover el link después de un momento
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    console.log('Link removido y URL liberada');
                }, 100);
                
                alert('✅ Plan exportado correctamente como archivo de texto.\n\nPuedes abrirlo en Word para darle formato adicional.');
                
            } catch (error) {
                console.error('ERROR al crear el archivo:', error);
                alert('❌ Error al crear el archivo de exportación.\n\nError: ' + error.message + '\n\nPor favor, intenta de nuevo o contacta con soporte.');
            }
        }

        function imprimirPlan() {
            console.log('Intentando imprimir...');
            console.log('Estado actual planGenerado:', state.planGenerado);
            
            // Si no hay plan generado, intentar generarlo automáticamente
            if (!state.planGenerado || state.planGenerado.length === 0) {
                console.log('No hay plan generado, intentando generar automáticamente...');
                const generado = generarPlanSilencioso();
                console.log('Resultado de generación:', generado);
                console.log('Plan después de generar:', state.planGenerado);
            }
            
            // Verificar de nuevo después de generar
            if (!state.planGenerado || state.planGenerado.length === 0) {
                alert('⚠️ No se puede imprimir el plan.\n\n' +
                      'Por favor, ve al tab "Líneas Estratégicas" y:\n' +
                      '1. Selecciona al menos un objetivo estratégico\n' +
                      '2. Selecciona al menos un programa EPVSA\n' +
                      '3. Selecciona al menos una actuación\n\n' +
                      'Luego intenta imprimir nuevamente.');
                cambiarTab('lineas');
                return;
            }
            
            window.print();
        }

        function actualizarResumenLineas() {
            let lineasCount = 0;
            let objetivosCount = 0;
            let indicadoresCount = 0;
            let programasCount = 0;
            let actuacionesCount = 0;
            
            ESTRUCTURA_EPVSA.forEach((linea) => {
                // Verificar si hay algo seleccionado en esta línea
                let tieneSeleccion = false;
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    const objCheckbox = document.getElementById(`obj${linea.id}_${objIdx}`);
                    if (objCheckbox && objCheckbox.checked) {
                        objetivosCount++;
                        tieneSeleccion = true;
                    }
                    
                    objetivo.indicadores.forEach((ind, indIdx) => {
                        const indCheckbox = document.getElementById(`ind${linea.id}_${objIdx}_${indIdx}`);
                        if (indCheckbox && indCheckbox.checked) {
                            indicadoresCount++;
                            tieneSeleccion = true;
                        }
                    });
                    
                    objetivo.programas.forEach((programa, progIdx) => {
                        const progCheckbox = document.getElementById(`prog${linea.id}_${objIdx}_${progIdx}`);
                        if (progCheckbox && progCheckbox.checked) {
                            programasCount++;
                            tieneSeleccion = true;
                        }
                        
                        programa.actuaciones.forEach((act, actIdx) => {
                            const actCheckbox = document.getElementById(`act${linea.id}_${objIdx}_${progIdx}_${actIdx}`);
                            if (actCheckbox && actCheckbox.checked) {
                                actuacionesCount++;
                                tieneSeleccion = true;
                            }
                        });
                    });
                });
                
                // Marcar o desmarcar el checkbox de la línea según si tiene selección
                const lineaCheckbox = document.getElementById(`linea${linea.id}`);
                if (lineaCheckbox) {
                    lineaCheckbox.checked = tieneSeleccion;
                    if (tieneSeleccion) lineasCount++;
                }
            });
            
            // Actualizar estado
            state.lineasEstrategicas = Array.from({length: lineasCount}, (_, i) => i + 1);
            
            const resumenEl = document.getElementById('resumenLineas');
            if (resumenEl) {
                resumenEl.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 800; color: #667eea;">${lineasCount}</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Líneas</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 800; color: #10b981;">${objetivosCount}</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Objetivos</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 800; color: #f59e0b;">${indicadoresCount}</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Indicadores</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 800; color: #ef4444;">${programasCount}</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Programas</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 800; color: #8b5cf6;">${actuacionesCount}</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Actuaciones</div>
                        </div>
                    </div>
                `;
            }
            
            actualizarEstadisticas();
        }

        function actualizarEstadisticas() {
            document.getElementById('statProgramas').textContent = state.programasSeleccionados.length;
            
            const totalActuaciones = Object.values(state.actuaciones).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('statActuaciones').textContent = totalActuaciones;
        }

        // ========== COMPILADOR DE DOCUMENTOS WORD ==========
        


        // ========== FUNCIÓN PARA GENERAR PDF DE SELECCIONES ==========
        async function generarPDFSelecciones() {
            console.log('🔄 Iniciando generación de PDF...');
            
            const btn = event.target;
            const textoOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '⏳ Generando PDF...';
            
            try {
                // VALIDACIÓN 1: Verificar que jsPDF está disponible
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('La librería jsPDF no está cargada. Por favor, recarga la página.');
                }
                
                console.log('✅ jsPDF disponible');
                
                // VALIDACIÓN 2: Verificar que hay selecciones
                if (!state.planGenerado || state.planGenerado.length === 0) {
                    alert('⚠️ No hay selecciones para exportar.\n\nPor favor:\n1. Ve al tab "Líneas Estratégicas"\n2. Marca al menos un objetivo\n3. Marca al menos un programa\n4. Marca al menos una actuación\n\nLuego vuelve aquí para generar el PDF.');
                    btn.disabled = false;
                    btn.innerHTML = textoOriginal;
                    return;
                }
                
                console.log('✅ Selecciones encontradas:', state.planGenerado.length, 'líneas');
                
                // Crear el PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                console.log('✅ Documento PDF creado');
                
                let yPos = 20;
                const margen = 20;
                const anchoMaximo = 170;
                const altoLinea = 7;
                
                // Función auxiliar para añadir texto
                const agregarTexto = (texto, fontSize, negrita = false, color = [0, 0, 0]) => {
                    doc.setFontSize(fontSize);
                    doc.setTextColor(color[0], color[1], color[2]);
                    doc.setFont(undefined, negrita ? 'bold' : 'normal');
                    
                    const lineas = doc.splitTextToSize(texto, anchoMaximo);
                    
                    lineas.forEach(linea => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(linea, margen, yPos);
                        yPos += altoLinea;
                    });
                };
                
                const agregarEspacio = (cantidad = 1) => {
                    yPos += altoLinea * cantidad;
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                };
                
                // === PORTADA ===
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text('PLAN LOCAL DE SALUD', 105, yPos, { align: 'center' });
                yPos += 15;
                
                doc.setFontSize(18);
                doc.setTextColor(118, 75, 162);
                doc.text('Selección EPVSA 2024-2030', 105, yPos, { align: 'center' });
                yPos += 20;
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const nombreMunicipio = state.municipio.nombre || 'Municipio';
                doc.text(nombreMunicipio, 105, yPos, { align: 'center' });
                yPos += 10;
                
                if (state.municipio.provincia) {
                    doc.setFontSize(12);
                    doc.text(state.municipio.provincia, 105, yPos, { align: 'center' });
                    yPos += 8;
                }
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                const fecha = new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                doc.text(fecha, 105, yPos, { align: 'center' });
                yPos += 20;
                
                // Área prioritaria si existe
                if (state.areaPrioritaria) {
                    agregarEspacio(2);
                    doc.setFillColor(245, 87, 108);
                    doc.rect(margen, yPos - 5, anchoMaximo, 12, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('ÁREA PRIORITARIA', margen + 3, yPos);
                    yPos += 7;
                    doc.setFontSize(11);
                    doc.text(state.areaPrioritaria, margen + 3, yPos);
                    yPos += 10;
                }
                
                console.log('✅ Portada creada');
                
                // Nueva página para contenido
                doc.addPage();
                yPos = 20;
                
                // === CONTENIDO ===
                agregarTexto('SELECCIÓN DE LÍNEAS ESTRATÉGICAS Y PROGRAMAS', 16, true, [102, 126, 234]);
                agregarEspacio(1);
                
                console.log('📝 Generando contenido de', state.planGenerado.length, 'líneas...');
                
                state.planGenerado.forEach((linea, idxLinea) => {
                    console.log('  Procesando línea', linea.id);
                    
                    // Línea estratégica
                    agregarEspacio(1);
                    doc.setFillColor(240, 240, 250);
                    doc.rect(margen - 2, yPos - 5, anchoMaximo + 4, 8, 'F');
                    agregarTexto(`LÍNEA ${linea.id}: ${linea.nombre.toUpperCase()}`, 13, true, [102, 126, 234]);
                    agregarEspacio(0.5);
                    
                    // Objetivos
                    linea.objetivos.forEach((objetivo, idxObj) => {
                        agregarTexto(`${objetivo.codigo} ${objetivo.nombre}`, 11, true, [0, 0, 0]);
                        
                        // Indicadores
                        if (objetivo.indicadores && objetivo.indicadores.length > 0) {
                            agregarTexto('Indicadores de Evaluación:', 9, true, [80, 80, 80]);
                            objetivo.indicadores.forEach(indicador => {
                                agregarTexto(`  • ${indicador}`, 9, false, [60, 60, 60]);
                            });
                            agregarEspacio(0.3);
                        }
                        
                        // Programas
                        if (objetivo.programas && objetivo.programas.length > 0) {
                            agregarTexto('Programas EPVSA:', 9, true, [16, 185, 129]);
                            objetivo.programas.forEach(programa => {
                                agregarTexto(`  ${programa.codigo} - ${programa.nombre}`, 9, true, [16, 185, 129]);
                                
                                // Actuaciones
                                if (programa.actuaciones && programa.actuaciones.length > 0) {
                                    agregarTexto('    Actuaciones:', 8, false, [80, 80, 80]);
                                    programa.actuaciones.forEach(actuacion => {
                                        agregarTexto(`      ○ ${actuacion}`, 8, false, [60, 60, 60]);
                                    });
                                }
                                agregarEspacio(0.3);
                            });
                        }
                        
                        agregarEspacio(0.5);
                    });
                    
                    agregarEspacio(1);
                });
                
                console.log('✅ Contenido generado');
                
                // Pie de página
                const totalPaginas = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPaginas; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Página ${i} de ${totalPaginas}`, 105, 290, { align: 'center' });
                    doc.text('Planificador EPVSA 2024-2030', margen, 290);
                }
                
                console.log('✅ Pie de página añadido');
                
                // Guardar el PDF
                const fechaArchivo = new Date().toISOString().split('T')[0];
                const nombreArchivo = `Plan_Salud_${nombreMunicipio.replace(/\s+/g, '_')}_${fechaArchivo}.pdf`;
                
                console.log('💾 Guardando PDF:', nombreArchivo);
                doc.save(nombreArchivo);
                console.log('✅ PDF guardado');
                
                // Mensaje de éxito
                setTimeout(() => {
                    alert(`✅ PDF generado exitosamente!\n\nArchivo: ${nombreArchivo}\n\nPáginas: ${totalPaginas}\n\nEl documento incluye todas tus selecciones de líneas estratégicas, objetivos, programas y actuaciones.\n\nAhora puedes combinar este PDF con tu Perfil de Salud usando iLovePDF.com`);
                }, 500);
                
            } catch (error) {
                console.error('❌ Error al generar PDF:', error);
                console.error('Stack:', error.stack);
                alert(`❌ Error al generar el PDF:\n\n${error.message}\n\nDetalles en la consola del navegador (presiona F12).`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = textoOriginal;
            }
        }

        // ========== NUEVA FUNCIÓN: GENERAR AGENDA RELAS ==========
        async function generarAgendaRELAS() {
            console.log('🔄 Iniciando generación de Agenda RELAS...');
            
            const btn = event.target;
            const textoOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '⏳ Generando Agenda...';
            
            try {
                // VALIDACIÓN: Verificar que jsPDF está disponible
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('La librería jsPDF no está cargada. Por favor, recarga la página.');
                }
                
                // Verificar que hay actuaciones registradas
                const totalActuaciones = Object.values(state.actuaciones).reduce((sum, arr) => sum + arr.length, 0);
                
                if (totalActuaciones === 0) {
                    alert('⚠️ No hay actuaciones RELAS registradas.\n\nPor favor:\n1. Registra al menos una actuación en la sección de Agendas Anuales\n2. Vuelve aquí para generar la Agenda');
                    btn.disabled = false;
                    btn.innerHTML = textoOriginal;
                    return;
                }
                
                console.log('✅ Actuaciones encontradas:', totalActuaciones);
                
                // Crear el PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                let yPos = 20;
                const margen = 20;
                const anchoMaximo = 170;
                const altoLinea = 6;
                
                // Función auxiliar para añadir texto
                const agregarTexto = (texto, fontSize, negrita = false, color = [0, 0, 0]) => {
                    doc.setFontSize(fontSize);
                    doc.setTextColor(color[0], color[1], color[2]);
                    doc.setFont(undefined, negrita ? 'bold' : 'normal');
                    
                    const lineas = doc.splitTextToSize(texto, anchoMaximo);
                    
                    lineas.forEach(linea => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(linea, margen, yPos);
                        yPos += altoLinea;
                    });
                };
                
                const agregarEspacio = (cantidad = 1) => {
                    yPos += altoLinea * cantidad;
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                };
                
                // === PORTADA ===
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(16, 185, 129);
                doc.text('AGENDAS ANUALES RELAS', 105, yPos, { align: 'center' });
                yPos += 15;
                
                doc.setFontSize(16);
                doc.setTextColor(102, 126, 234);
                doc.text('Red de Acción Local en Salud', 105, yPos, { align: 'center' });
                yPos += 20;
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const nombreMunicipio = state.municipio.nombre || 'Municipio';
                doc.text(nombreMunicipio, 105, yPos, { align: 'center' });
                yPos += 10;
                
                if (state.municipio.provincia) {
                    doc.setFontSize(12);
                    doc.text(state.municipio.provincia, 105, yPos, { align: 'center' });
                    yPos += 8;
                }
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                const fecha = new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                doc.text(fecha, 105, yPos, { align: 'center' });
                yPos += 30;
                
                // Nueva página para contenido
                doc.addPage();
                yPos = 20;
                
                // === ACTUACIONES POR AÑO Y ENTORNO ===
                agregarTexto('ACTUACIONES RELAS 2024-2030', 18, true, [16, 185, 129]);
                agregarTexto('Organizadas por año y entorno', 11, false, [100, 100, 100]);
                agregarEspacio(2);
                
                const anos = [2024, 2025, 2026, 2027, 2028, 2029, 2030];
                const entornos = [
                    { key: 'sanitario', nombre: 'ENTORNO SANITARIO', icono: '🏥', color: [59, 130, 246] },
                    { key: 'comunitario', nombre: 'ENTORNO COMUNITARIO', icono: '🌍', color: [16, 185, 129] },
                    { key: 'educativo', nombre: 'ENTORNO EDUCATIVO', icono: '🎓', color: [245, 158, 11] },
                    { key: 'laboral', nombre: 'ENTORNO LABORAL', icono: '💼', color: [139, 92, 246] }
                ];
                
                // Iterar por cada año
                anos.forEach(ano => {
                    let tieneActuacionesEnAno = false;
                    
                    // Verificar si hay actuaciones en este año
                    entornos.forEach(entorno => {
                        const key = `${entorno.key}-${ano}`;
                        const actuaciones = state.actuaciones[key] || [];
                        if (actuaciones.length > 0) {
                            tieneActuacionesEnAno = true;
                        }
                    });
                    
                    // Si hay actuaciones, mostrar el año
                    if (tieneActuacionesEnAno) {
                        agregarEspacio(2);
                        doc.setFillColor(102, 126, 234);
                        doc.rect(margen - 2, yPos - 5, anchoMaximo + 4, 12, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(16);
                        doc.setFont(undefined, 'bold');
                        doc.text(`📅 AÑO ${ano}`, margen + 3, yPos + 3);
                        yPos += 14;
                        doc.setTextColor(0, 0, 0);
                        
                        // Mostrar actuaciones por entorno dentro del año
                        entornos.forEach(entorno => {
                            const key = `${entorno.key}-${ano}`;
                            const actuaciones = state.actuaciones[key] || [];
                            
                            if (actuaciones.length > 0) {
                                agregarEspacio(1);
                                
                                // Título del entorno
                                doc.setFillColor(240, 240, 250);
                                doc.rect(margen - 2, yPos - 5, anchoMaximo + 4, 10, 'F');
                                agregarTexto(`${entorno.icono} ${entorno.nombre} (${actuaciones.length} actuaciones)`, 12, true, entorno.color);
                                agregarEspacio(0.5);
                                
                                // Listar actuaciones
                                actuaciones.forEach((act, idx) => {
                                    agregarTexto(`${idx + 1}. ${act.titulo || act.nombre}`, 10, true, [0, 0, 0]);
                                    
                                    if (act.descripcion) {
                                        agregarTexto(`   Descripción: ${act.descripcion}`, 9, false, [60, 60, 60]);
                                    }
                                    
                                    if (act.responsablePrincipal) {
                                        agregarTexto(`   Responsable: ${act.responsablePrincipal}`, 9, false, [60, 60, 60]);
                                    }
                                    
                                    if (act.responsableEntidad) {
                                        agregarTexto(`   Entidad: ${act.responsableEntidad}`, 9, false, [60, 60, 60]);
                                    }
                                    
                                    if (act.fechaInicio || act.fechaFin) {
                                        const periodo = act.fechaInicio && act.fechaFin ? `${act.fechaInicio} - ${act.fechaFin}` : (act.fechaInicio || act.fechaFin);
                                        agregarTexto(`   Periodo: ${periodo}`, 9, false, [60, 60, 60]);
                                    }
                                    
                                    agregarEspacio(0.4);
                                });
                                
                                agregarEspacio(0.5);
                            }
                        });
                    }
                });
                
                // Resumen final
                agregarEspacio(2);
                doc.setFillColor(240, 253, 244);
                doc.rect(margen - 2, yPos - 3, anchoMaximo + 4, 15, 'F');
                agregarTexto(`TOTAL DE ACTUACIONES REGISTRADAS: ${totalActuaciones}`, 12, true, [16, 185, 129]);
                
                // Pie de página
                const totalPaginas = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPaginas; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Página ${i} de ${totalPaginas}`, 105, 290, { align: 'center' });
                    doc.text('Agendas RELAS - Planificador EPVSA 2024-2030', margen, 290);
                }
                
                // Guardar el PDF
                const fechaArchivo = new Date().toISOString().split('T')[0];
                const nombreArchivo = `Agendas_RELAS_${nombreMunicipio.replace(/\s+/g, '_')}_${fechaArchivo}.pdf`;
                
                console.log('💾 Guardando Agenda:', nombreArchivo);
                doc.save(nombreArchivo);
                console.log('✅ Agenda guardada');
                
                // Mensaje de éxito
                setTimeout(() => {
                    alert(`✅ Agendas RELAS generadas exitosamente!\n\nArchivo: ${nombreArchivo}\n\nTotal de actuaciones: ${totalActuaciones}\nPáginas: ${totalPaginas}\n\nEl documento incluye todas las actuaciones registradas organizadas por año (2024-2030) y por entorno.`);
                }, 500);
                
            } catch (error) {
                console.error('❌ Error al generar Agenda:', error);
                alert(`❌ Error al generar la Agenda:\n\n${error.message}\n\nDetalles en la consola del navegador (presiona F12).`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = textoOriginal;
            }
        }

        // ========== NUEVA FUNCIÓN: GENERAR PDF COMPLETO (3 DOCUMENTOS) ==========
        async function generarPDFCompleto() {
            console.log('🔄 Iniciando compilación de Plan Local de Salud Completo...');
            
            const btn = event.target;
            const textoOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '⏳ Compilando documentos...';
            
            try {
                // VALIDACIONES
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('La librería jsPDF no está cargada. Por favor, recarga la página.');
                }
                
                if (!state.perfilCargado) {
                    alert('⚠️ No se ha cargado el Perfil de Salud Local.\n\nPor favor:\n1. Ve al tab "Configuración"\n2. Carga el PDF del Perfil de Salud\n3. Vuelve aquí para compilar');
                    btn.disabled = false;
                    btn.innerHTML = textoOriginal;
                    return;
                }
                
                if (!state.planGenerado || state.planGenerado.length === 0) {
                    alert('⚠️ No hay Plan de Acción generado.\n\nPor favor:\n1. Ve al tab "Líneas Estratégicas"\n2. Selecciona objetivos y programas\n3. Genera el Plan de Acción\n4. Vuelve aquí para compilar');
                    btn.disabled = false;
                    btn.innerHTML = textoOriginal;
                    return;
                }
                
                console.log('✅ Validaciones pasadas');
                
                // Crear el PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                let yPos = 20;
                const margen = 20;
                const anchoMaximo = 170;
                const altoLinea = 6;
                
                const agregarTexto = (texto, fontSize, negrita = false, color = [0, 0, 0]) => {
                    doc.setFontSize(fontSize);
                    doc.setTextColor(color[0], color[1], color[2]);
                    doc.setFont(undefined, negrita ? 'bold' : 'normal');
                    
                    const lineas = doc.splitTextToSize(texto, anchoMaximo);
                    
                    lineas.forEach(linea => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(linea, margen, yPos);
                        yPos += altoLinea;
                    });
                };
                
                const agregarEspacio = (cantidad = 1) => {
                    yPos += altoLinea * cantidad;
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                };
                
                // ===== PORTADA PRINCIPAL =====
                doc.setFontSize(26);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text('PLAN LOCAL DE SALUD', 105, 60, { align: 'center' });
                yPos = 80;
                
                doc.setFontSize(20);
                doc.setTextColor(118, 75, 162);
                doc.text('DOCUMENTO COMPLETO', 105, yPos, { align: 'center' });
                yPos += 25;
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const nombreMunicipio = state.municipio.nombre || 'Municipio';
                doc.text(nombreMunicipio, 105, yPos, { align: 'center' });
                yPos += 12;
                
                if (state.municipio.provincia) {
                    doc.setFontSize(14);
                    doc.text(state.municipio.provincia, 105, yPos, { align: 'center' });
                    yPos += 10;
                }
                
                yPos = 150;
                doc.setFillColor(240, 240, 250);
                doc.rect(margen, yPos, anchoMaximo, 60, 'F');
                yPos += 10;
                
                doc.setFontSize(12);
                doc.setTextColor(102, 126, 234);
                doc.setFont(undefined, 'bold');
                doc.text('Este documento integra:', margen + 5, yPos);
                yPos += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);
                doc.text('1. Perfil de Salud Local', margen + 10, yPos);
                yPos += 7;
                doc.text('2. Plan de Acción (EPVSA 2024-2030)', margen + 10, yPos);
                yPos += 7;
                doc.text('3. Agendas Anuales RELAS', margen + 10, yPos);
                
                yPos = 240;
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                const fecha = new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                doc.text(fecha, 105, yPos, { align: 'center' });
                
                // ===== ÍNDICE =====
                doc.addPage();
                yPos = 30;
                
                agregarTexto('ÍNDICE', 20, true, [102, 126, 234]);
                agregarEspacio(2);
                
                agregarTexto('1. PERFIL DE SALUD LOCAL ................................................ 3', 12, false, [60, 60, 60]);
                agregarTexto('   Diagnóstico y Cuadro de Mandos Integral (58 Indicadores)', 10, false, [100, 100, 100]);
                agregarEspacio(1);
                
                agregarTexto('2. PLAN DE ACCIÓN ........................................................... XX', 12, false, [60, 60, 60]);
                agregarTexto('   Líneas Estratégicas, Objetivos, Indicadores, Programas y Actuaciones EPVSA', 10, false, [100, 100, 100]);
                agregarEspacio(1);
                
                agregarTexto('3. AGENDAS ANUALES RELAS ................................................ XX', 12, false, [60, 60, 60]);
                agregarTexto('   Actuaciones Registradas por Entornos', 10, false, [100, 100, 100]);
                
                // ===== DOCUMENTO 1: PERFIL DE SALUD =====
                doc.addPage();
                yPos = 20;
                
                agregarTexto('DOCUMENTO 1', 14, true, [102, 126, 234]);
                agregarTexto('PERFIL DE SALUD LOCAL', 20, true, [102, 126, 234]);
                agregarEspacio(2);
                
                // Incluir PDF completo si está disponible
                if (state.pdfData && state.pdfNumPages > 0 && typeof pdfjsLib !== 'undefined') {
                    try {
                        console.log('📄 Iniciando inclusión de PDF...');
                        btn.innerHTML = '⏳ Incluyendo Perfil de Salud (17 páginas)...';
                        
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        const pdfDoc = await pdfjsLib.getDocument({ data: state.pdfData }).promise;
                        console.log(`✅ PDF cargado: ${pdfDoc.numPages} páginas`);
                        
                        for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                            console.log(`📄 Procesando página ${pageNum}/${pdfDoc.numPages}...`);
                            btn.innerHTML = `⏳ Página ${pageNum}/${pdfDoc.numPages}...`;
                            
                            const page = await pdfDoc.getPage(pageNum);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            const imgData = canvas.toDataURL('image/jpeg', 0.95);
                            if (pageNum > 1) doc.addPage();
                            const imgWidth = 210;
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;
                            doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                            console.log(`✅ Página ${pageNum} incluida`);
                        }
                        console.log('✅ PDF completo incluido');
                        btn.innerHTML = '⏳ Compilando documentos...';
                    } catch (error) {
                        console.error('❌ Error incluyendo PDF:', error);
                        console.error('Detalles del error:', error.message, error.stack);
                        agregarTexto('⚠️ Error al incluir el PDF completo', 11, true, [220, 38, 38]);
                        agregarTexto(`Error: ${error.message}`, 9, false, [220, 38, 38]);
                    }
                } else {
                    console.warn('⚠️ PDF no disponible:', {
                        hasPdfData: !!state.pdfData,
                        numPages: state.pdfNumPages,
                        hasPdfjsLib: typeof pdfjsLib !== 'undefined'
                    });
                    agregarTexto('⚠️ PDF del Perfil de Salud no disponible', 11, true, [220, 38, 38]);
                }
                
                // ===== DOCUMENTO 2: PLAN DE ACCIÓN =====
                doc.addPage();
                yPos = 20;
                
                agregarTexto('DOCUMENTO 2', 14, true, [102, 126, 234]);
                agregarTexto('PLAN DE ACCIÓN - EPVSA 2024-2030', 20, true, [102, 126, 234]);
                agregarEspacio(2);
                
                if (state.areaPrioritaria) {
                    doc.setFillColor(245, 87, 108);
                    doc.rect(margen, yPos - 5, anchoMaximo, 12, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('ÁREA PRIORITARIA', margen + 3, yPos);
                    yPos += 7;
                    doc.setFontSize(11);
                    doc.text(state.areaPrioritaria, margen + 3, yPos);
                    yPos += 12;
                    doc.setTextColor(0, 0, 0);
                }
                
                agregarTexto('Líneas Estratégicas y Programas Seleccionados:', 14, true, [102, 126, 234]);
                agregarEspacio(1);
                
                state.planGenerado.forEach((linea) => {
                    agregarEspacio(1);
                    doc.setFillColor(240, 240, 250);
                    doc.rect(margen - 2, yPos - 5, anchoMaximo + 4, 8, 'F');
                    agregarTexto(`LÍNEA ${linea.id}: ${linea.nombre.toUpperCase()}`, 12, true, [102, 126, 234]);
                    agregarEspacio(0.5);
                    
                    linea.objetivos.forEach((objetivo) => {
                        agregarTexto(`${objetivo.codigo} ${objetivo.nombre}`, 11, true, [0, 0, 0]);
                        
                        if (objetivo.indicadores && objetivo.indicadores.length > 0) {
                            agregarTexto('Indicadores:', 9, true, [80, 80, 80]);
                            objetivo.indicadores.forEach(ind => {
                                agregarTexto(`  • ${ind}`, 9, false, [60, 60, 60]);
                            });
                            agregarEspacio(0.3);
                        }
                        
                        if (objetivo.programas && objetivo.programas.length > 0) {
                            agregarTexto('Programas EPVSA:', 9, true, [16, 185, 129]);
                            objetivo.programas.forEach(programa => {
                                agregarTexto(`  ${programa.codigo} - ${programa.nombre}`, 9, true, [16, 185, 129]);
                                
                                if (programa.actuaciones && programa.actuaciones.length > 0) {
                                    agregarTexto('    Actuaciones:', 8, false, [80, 80, 80]);
                                    programa.actuaciones.forEach(act => {
                                        agregarTexto(`      ○ ${act}`, 8, false, [60, 60, 60]);
                                    });
                                }
                                agregarEspacio(0.3);
                            });
                        }
                        
                        agregarEspacio(0.5);
                    });
                });
                
                // ===== DOCUMENTO 3: AGENDA RELAS =====
                doc.addPage();
                yPos = 20;
                
                agregarTexto('DOCUMENTO 3', 14, true, [102, 126, 234]);
                agregarTexto('AGENDAS ANUALES RELAS', 20, true, [16, 185, 129]);
                agregarEspacio(2);
                
                const totalActuaciones = Object.values(state.actuaciones).reduce((sum, arr) => sum + arr.length, 0);
                
                if (totalActuaciones === 0) {
                    agregarTexto('No hay actuaciones RELAS registradas actualmente.', 11, false, [220, 38, 38]);
                    agregarTexto('Las actuaciones deben registrarse en el tab "Agendas Anuales".', 10, false, [100, 100, 100]);
                } else {
                    agregarTexto(`Total de actuaciones registradas: ${totalActuaciones}`, 11, true, [16, 185, 129]);
                    agregarTexto('(Organizadas por año y entorno)', 10, false, [100, 100, 100]);
                    agregarEspacio(1);
                    
                    const anos = [2024, 2025, 2026, 2027, 2028, 2029, 2030];
                    const entornos = [
                        { key: 'sanitario', nombre: 'ENTORNO SANITARIO', icono: '🏥' },
                        { key: 'comunitario', nombre: 'ENTORNO COMUNITARIO', icono: '🌍' },
                        { key: 'educativo', nombre: 'ENTORNO EDUCATIVO', icono: '🎓' },
                        { key: 'laboral', nombre: 'ENTORNO LABORAL', icono: '💼' }
                    ];
                    
                    // Iterar por cada año
                    anos.forEach(ano => {
                        let tieneActuacionesEnAno = false;
                        
                        // Primero verificar si hay actuaciones en este año
                        entornos.forEach(entorno => {
                            const key = `${entorno.key}-${ano}`;
                            const actuaciones = state.actuaciones[key] || [];
                            if (actuaciones.length > 0) {
                                tieneActuacionesEnAno = true;
                            }
                        });
                        
                        // Si hay actuaciones en este año, mostrar el año como encabezado
                        if (tieneActuacionesEnAno) {
                            agregarEspacio(2);
                            doc.setFillColor(102, 126, 234);
                            doc.rect(margen - 2, yPos - 5, anchoMaximo + 4, 10, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(14);
                            doc.setFont(undefined, 'bold');
                            doc.text(`📅 AÑO ${ano}`, margen + 3, yPos + 2);
                            yPos += 12;
                            doc.setTextColor(0, 0, 0);
                            
                            // Ahora mostrar cada entorno dentro de este año
                            entornos.forEach(entorno => {
                                const key = `${entorno.key}-${ano}`;
                                const actuaciones = state.actuaciones[key] || [];
                                
                                if (actuaciones.length > 0) {
                                    agregarEspacio(1);
                                    doc.setFillColor(240, 253, 244);
                                    doc.rect(margen - 2, yPos - 5, anchoMaximo + 4, 8, 'F');
                                    agregarTexto(`${entorno.icono} ${entorno.nombre} (${actuaciones.length} actuaciones)`, 11, true, [16, 185, 129]);
                                    agregarEspacio(0.5);
                                    
                                    actuaciones.forEach((act, idx) => {
                                        agregarTexto(`${idx + 1}. ${act.titulo || act.nombre}`, 10, true, [0, 0, 0]);
                                        if (act.descripcion) agregarTexto(`   ${act.descripcion}`, 9, false, [60, 60, 60]);
                                        if (act.responsablePrincipal) agregarTexto(`   Responsable: ${act.responsablePrincipal}`, 9, false, [60, 60, 60]);
                                        if (act.responsableEntidad) agregarTexto(`   Entidad: ${act.responsableEntidad}`, 9, false, [60, 60, 60]);
                                        if (act.fechaInicio || act.fechaFin) {
                                            const periodo = act.fechaInicio && act.fechaFin ? `${act.fechaInicio} - ${act.fechaFin}` : (act.fechaInicio || act.fechaFin);
                                            agregarTexto(`   Periodo: ${periodo}`, 9, false, [60, 60, 60]);
                                        }
                                        agregarEspacio(0.3);
                                    });
                                }
                            });
                        }
                    });
                }
                
                // Pie de página en todas las páginas
                const totalPaginas = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPaginas; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`Página ${i} de ${totalPaginas}`, 105, 290, { align: 'center' });
                    doc.text(`Plan Local de Salud - ${nombreMunicipio}`, margen, 290);
                }
                
                // Guardar el PDF
                const fechaArchivo = new Date().toISOString().split('T')[0];
                const nombreArchivo = `Plan_Local_Salud_COMPLETO_${nombreMunicipio.replace(/\s+/g, '_')}_${fechaArchivo}.pdf`;
                
                console.log('💾 Guardando Plan Completo:', nombreArchivo);
                doc.save(nombreArchivo);
                console.log('✅ Plan Completo guardado');
                
                // Mensaje de éxito
                setTimeout(() => {
                    alert(`✅ ¡Plan Local de Salud Completo generado!\n\nArchivo: ${nombreArchivo}\n\nPáginas: ${totalPaginas}\n\nEl documento incluye:\n1. Perfil de Salud Local (conclusiones y recomendaciones)\n2. Plan de Acción completo (${state.planGenerado.length} líneas)\n3. Agendas RELAS (${totalActuaciones} actuaciones)\n\n📌 Nota: Para incluir el PDF completo del Perfil de Salud, combina este documento con tu PDF original usando iLovePDF.com`);
                }, 500);
                
            } catch (error) {
                console.error('❌ Error al compilar Plan Completo:', error);
                alert(`❌ Error al generar el Plan Completo:\n\n${error.message}\n\nDetalles en la consola del navegador (presiona F12).`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = textoOriginal;
            }
        }

    </script>
</body>
</html>