<!DOCTYPE html>
<!--
MIT License

Copyright (c) 2024 BR HERMOSO

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
-->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador EPVSA 2024-2030 - Versi√≥n Mejorada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Librer√≠as para generar documentos Word -->
    <!-- docx.js eliminado - no necesario -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Librer√≠a para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
        }

        .license-footer {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .version-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-bottom: 3px solid #e5e7eb;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: #667eea;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 0.5rem;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 1.25rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
            color: #6b7280;
            white-space: nowrap;
            position: relative;
        }

        .tab.completed::after {
            content: '‚úì';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #16a34a;
            color: white;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .tab:hover {
            background: white;
            color: #667eea;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        .tab-content {
            padding: 2rem;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-indicator {
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .step-number {
            background: #667eea;
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 800;
            flex-shrink: 0;
        }

        .step-text {
            flex: 1;
        }

        .step-text h3 {
            font-size: 1.2rem;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .step-text p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .alert-info {
            background: #dbeafe;
            border: 2px solid #93c5fd;
            color: #1e40af;
        }

        .alert-success {
            background: #dcfce7;
            border: 2px solid #86efac;
            color: #166534;
        }

        .alert-warning {
            background: #fef3c7;
            border: 2px solid #fcd34d;
            color: #92400e;
        }

        .alert-danger {
            background: #fee2e2;
            border: 2px solid #fca5a5;
            color: #991b1b;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .input-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }

        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            background: #f0f4ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 2rem;
        }

        .upload-zone:hover {
            border-color: #764ba2;
            background: #e0e7ff;
        }

        .upload-zone.dragging {
            border-color: #16a34a;
            background: #dcfce7;
        }

        /* MEJORA 8: Modal Tutorial */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem 1rem 0 0;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1rem 2rem;
            border-top: 2px solid #e5e7eb;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Estilos para el tutorial interactivo */
        .tutorial-overlay {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s ease;
        }

        .tutorial-overlay.active {
            display: block;
        }

        .tutorial-spotlight {
            position: relative;
            z-index: 2001;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.7);
            border-radius: 0.5rem;
            animation: pulse 2s ease-in-out infinite;
        }

        .tutorial-tooltip {
            position: fixed;
            z-index: 2002;
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease;
        }

        .tutorial-tooltip h3 {
            color: #667eea;
            margin-bottom: 0.75rem;
            font-size: 1.25rem;
        }

        .tutorial-tooltip p {
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .tutorial-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .tutorial-progress-bar {
            flex: 1;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }

        .tutorial-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .tutorial-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 9999px rgba(0,0,0,0.7), 0 0 20px rgba(102, 126, 234, 0.5); }
            50% { box-shadow: 0 0 0 9999px rgba(0,0,0,0.7), 0 0 40px rgba(102, 126, 234, 0.8); }
        }

        /* Botones de a√±o para cuadro de mandos */
        .year-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 1rem;
            min-width: 80px;
        }

        .year-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
        }

        .year-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            color: white !important;
            border-color: #3b82f6 !important;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* MEJORA 3: Sugerencias Inteligentes */
        .suggestion-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #38bdf8;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .suggestion-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .suggestion-icon {
            font-size: 2rem;
        }

        .suggestion-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #0369a1;
        }

        .suggestion-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }

        .suggestion-item {
            display: flex;
            align-items: start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: white;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .suggestion-check {
            width: 20px;
            height: 20px;
            margin-top: 0.1rem;
        }

        /* MEJORA 5: Plantillas de Actuaciones */
        .plantilla-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plantilla-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .plantilla-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .plantilla-icon {
            font-size: 1.5rem;
        }

        .plantilla-title {
            font-weight: 700;
            color: #1f2937;
            font-size: 0.95rem;
            flex: 1;
        }

        .plantilla-btn {
            padding: 0.35rem 0.75rem;
            font-size: 0.8rem;
        }

        .plantilla-descripcion {
            color: #6b7280;
            font-size: 0.85rem;
            line-height: 1.5;
            padding-left: 2.25rem;
        }

        /* MEJORA 2: Panel de Validaci√≥n */
        .validation-panel {
            background: white;
            border: 3px solid #f59e0b;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .validation-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .validation-item {
            display: flex;
            align-items: start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .validation-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .validation-text {
            flex: 1;
            font-size: 0.9rem;
        }

        .validation-status {
            font-weight: 700;
            margin-right: 0.5rem;
        }

        /* MEJORA 10: Bot√≥n Info EPVSA */
        .epvsa-info-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }

        .epvsa-info-btn:hover {
            background: #2563eb;
        }

        /* Estilos adicionales del √°rbol jer√°rquico */
        .tree-container {
            margin-top: 2rem;
        }

        .tree-linea {
            background: white;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tree-linea-header {
            padding: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s;
        }

        .tree-linea-header:hover {
            opacity: 0.9;
        }

        .tree-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .tree-expand {
            font-size: 1.2rem;
            transition: transform 0.3s;
            flex-shrink: 0;
        }

        .tree-expand.expanded {
            transform: rotate(90deg);
        }

        .tree-linea-title {
            flex: 1;
            font-size: 1.2rem;
            font-weight: 700;
            color: white;
        }

        .tree-linea-count {
            background: rgba(255,255,255,0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
        }

        .tree-linea-content {
            display: none;
            padding: 0 1.5rem 1.5rem 1.5rem;
            background: #f9fafb;
        }

        .tree-linea-content.show {
            display: block;
        }

        .tree-objetivo {
            background: white;
            border-left: 4px solid;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .tree-objetivo-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
        }

        .tree-objetivo-id {
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .tree-objetivo-nombre {
            flex: 1;
            font-weight: 600;
            color: #1f2937;
        }

        .tree-objetivo-toggle {
            font-size: 0.9rem;
            color: #6b7280;
            flex-shrink: 0;
        }

        .tree-objetivo-content {
            display: none;
            margin-top: 1rem;
            padding-left: 2rem;
        }

        .tree-objetivo-content.show {
            display: block;
        }

        .tree-section {
            margin-bottom: 1rem;
        }

        .tree-section-title {
            font-weight: 700;
            color: #4b5563;
            font-size: 0.85rem;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tree-section-icon {
            font-size: 1rem;
        }

        .tree-list {
            list-style: none;
            padding: 0;
        }

        .tree-list-item {
            padding: 0.5rem;
            background: #f9fafb;
            border-radius: 0.25rem;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: #374151;
            line-height: 1.5;
        }

        .tree-programa {
            background: #fef3c7;
            border-left: 3px solid #f59e0b;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .tree-programa-codigo {
            display: inline-block;
            background: #f59e0b;
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 700;
            margin-right: 0.5rem;
        }

        .tree-programa-nombre {
            font-weight: 700;
            color: #92400e;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .tree-actuacion {
            padding: 0.4rem 0.4rem 0.4rem 0rem;
            font-size: 0.85rem;
            color: #78350f;
            line-height: 1.4;
            margin-bottom: 0.25rem;
        }

        /* Entornos y agendas */
        .entorno-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .entorno-card {
            background: white;
            border: 3px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .entorno-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .entorno-card.active {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .entorno-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .entorno-name {
            font-weight: 700;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .year-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .year-tab {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .year-tab:hover {
            border-color: #667eea;
        }

        .year-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .actividad-registro {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .actividad-item {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        textarea.input-field {
            min-height: 100px;
            resize: vertical;
        }

        input[type="checkbox"] {
            cursor: pointer;
            accent-color: #667eea;
        }

        input[type="checkbox"]:hover {
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.75rem;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                min-width: 100%;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .entorno-selector {
                grid-template-columns: 1fr;
            }
        }

        /* Estilos para el Compilador Word */
        .compile-section {
            background: #f0fdf4;
            border: 3px solid #16a34a;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .btn-compile {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 0.75rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-compile:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(22, 163, 74, 0.4);
        }

        .btn-compile:active {
            transform: translateY(0);
        }

        .btn-compile:disabled {
            background: #9ca3af !important;
            cursor: not-allowed !important;
            transform: none !important;
        }
    </style>
</head>
<body>
    <!-- MEJORA 8: Modal Tutorial -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üëã Bienvenido al Planificador EPVSA 2024-2030</h2>
            </div>
            <div class="modal-body">
                <h3 style="color: #667eea; margin-bottom: 1rem;">¬øPrimera vez usando el planificador?</h3>
                <p style="margin-bottom: 1.5rem; line-height: 1.6; color: #4b5563;">
                    Te guiaremos paso a paso en la elaboraci√≥n de tu Plan Local de Salud. El proceso completo toma aproximadamente 2-3 horas.
                </p>
                
                <div style="background: #f0f9ff; border-left: 4px solid #38bdf8; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <h4 style="color: #0369a1; margin-bottom: 0.5rem;">üìã Pasos del planificador:</h4>
                    <ol style="margin-left: 1.5rem; color: #4b5563; line-height: 2;">
                        <li><strong>Configuraci√≥n:</strong> Identifica tu municipio y carga el Perfil de Salud</li>
                        <li><strong>Selecci√≥n EPVSA:</strong> Elige l√≠neas, objetivos y programas</li>
                        <li><strong>Plan Local:</strong> Genera el documento estructurado</li>
                        <li><strong>Cuadro de Mandos:</strong> Completa los 58 indicadores</li>
                        <li><strong>Agendas Anuales:</strong> Planifica actuaciones por a√±o y entorno</li>
                        <li><strong>Conclusiones:</strong> Revisa y exporta el plan completo</li>
                    </ol>
                </div>

                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <span style="font-size: 1.5rem;">üí°</span>
                    <div>
                        <strong>Consejo:</strong> El planificador te sugerir√° objetivos seg√∫n tu √°rea prioritaria. Tambi√©n incluye plantillas de actuaciones para facilitar tu trabajo.
                    </div>
                </div>

                <div class="alert alert-warning">
                    <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                    <div>
                        <strong>Importante:</strong> Usa el bot√≥n "üíæ Guardar borrador" para no perder tu progreso si necesitas hacer una pausa.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarTutorial()">Ya s√© usarlo</button>
                <button class="btn btn-primary" onclick="iniciarTutorial()">Comenzar tutorial guiado</button>
            </div>
        </div>
    </div>

    <!-- Overlay del Tutorial Interactivo -->
    <div id="tutorialOverlay" class="tutorial-overlay"></div>
    <div id="tutorialTooltip" class="tutorial-tooltip" style="display: none;"></div>


    <!-- MEJORA 10: Modal Info EPVSA -->
    <div id="epvsaInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ÑπÔ∏è Informaci√≥n del Programa EPVSA</h2>
            </div>
            <div class="modal-body" id="epvsaInfoBody">
                <!-- Contenido din√°mico -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="cerrarEpvsaInfo()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- MEJORA 6: Modal Recuperar Borrador -->
    <div id="borradorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üíæ Borrador encontrado</h2>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <span style="font-size: 1.5rem;">üìã</span>
                    <div>
                        <strong>Tienes un borrador guardado</strong><br>
                        <span id="borradorFecha">Guardado el: --</span>
                    </div>
                </div>
                <p style="margin: 1rem 0; line-height: 1.6; color: #4b5563;">
                    ¬øDeseas recuperar tu trabajo anterior o empezar un nuevo plan desde cero?
                </p>
                <div style="background: #fef3c7; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem;">
                    <strong style="color: #92400e;">‚ö†Ô∏è Atenci√≥n:</strong>
                    <p style="color: #78350f; font-size: 0.9rem; margin-top: 0.5rem;">
                        Si empiezas de cero, perder√°s todo el trabajo guardado en el borrador.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="empezarDeCero()">üóëÔ∏è Empezar de cero</button>
                <button class="btn btn-primary" onclick="recuperarBorrador()">‚úÖ Recuperar borrador</button>
            </div>
        </div>
    </div>

    <!-- Modal Panel de Administraci√≥n -->
    <div id="adminModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);">
                <h2>üîê Panel de Administraci√≥n RELAS</h2>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
                    <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                    <div>
                        <strong>√Årea de Administraci√≥n</strong><br>
                        Aqu√≠ puedes ver todos los planes creados por los municipios RELAS. Esta informaci√≥n es solo para coordinaci√≥n y an√°lisis.
                    </div>
                </div>
                
                <div id="listaMunicipios" style="margin-top: 2rem;">
                    <h3 style="color: #dc2626; margin-bottom: 1rem;">üìä Municipios con Planes Guardados</h3>
                    <div id="municipiosContainer"></div>
                </div>
                
                <div id="detallesPlan" style="display: none; margin-top: 2rem; border-top: 2px solid #e5e7eb; padding-top: 2rem;">
                    <h3 style="color: #dc2626; margin-bottom: 1rem;">üìã Detalles del Plan</h3>
                    <div id="detallesPlanContainer"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarAdminPanel()">Cerrar</button>
                <button class="btn btn-primary" onclick="exportarTodosDatos()">üì• Exportar Todos los Datos</button>
            </div>
        </div>
    </div>

    <!-- Modal de Login (OCULTO por defecto, T√ö entras directo como admin) -->
    <div id="loginModal" class="modal" style="z-index: 10000; display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);">
                <h2>üîê Acceso al Sistema</h2>
            </div>
            <div class="modal-body">
                <div class="alert alert-info" style="background: #dbeafe; border-left: 4px solid #3b82f6;">
                    <span style="font-size: 1.5rem;">üëã</span>
                    <div>
                        <strong>Bienvenido al Planificador EPVSA</strong><br>
                        Introduce tus credenciales para acceder
                    </div>
                </div>
                
                <form id="loginForm" onsubmit="intentarLogin(event)" style="margin-top: 2rem;">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                            üë§ Usuario:
                        </label>
                        <input 
                            type="text" 
                            id="loginUsuario" 
                            class="input-field" 
                            placeholder="Nombre del municipio o 'admin'"
                            style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 1rem;"
                            required
                            autocomplete="username"
                        >
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #6b7280;">
                            üí° Municipios: introduce el nombre de tu municipio<br>
                            üí° Administrador: escribe "admin"
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                            üîë Contrase√±a:
                        </label>
                        <input 
                            type="password" 
                            id="loginPassword" 
                            class="input-field" 
                            placeholder="Tu contrase√±a"
                            style="width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; font-size: 1rem;"
                            required
                            autocomplete="current-password"
                        >
                    </div>
                    
                    <div id="loginError" style="display: none; background: #fee2e2; border: 2px solid #ef4444; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem;">
                        <span style="color: #dc2626; font-weight: 600;">‚ùå Error de acceso</span>
                        <p style="color: #991b1b; margin-top: 0.5rem; font-size: 0.9rem;" id="loginErrorMsg"></p>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 700;">
                        üöÄ Acceder al Sistema
                    </button>
                </form>
                
                <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
                    <p style="font-size: 0.9rem; color: #6b7280; text-align: center;">
                        ‚ÑπÔ∏è <strong>Municipios:</strong> Si no tienes contrase√±a, solic√≠tala al coordinador RELAS<br>
                        üìß Contacto: coordinador@relas-andalucia.es
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="appContainer">
        <!-- HEADER -->
        <div class="header">
            <h1 id="headerTitle">üéØ Planificador EPVSA 2024-2030</h1>
            <p id="headerSubtitle">Estrategia para una Vida Saludable en Andaluc√≠a</p>
            <span class="version-badge">üìã Sistema de Planificaci√≥n Local de la Salud</span>
            <div class="license-footer">
                ¬© 2024 BR HERMOSO | Licencia MIT
            </div>
            <!-- MEJORA 6: Bot√≥n Guardar Borrador -->
            <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-secondary btn-small" onclick="guardarBorrador()" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white;">
                    üíæ Guardar borrador
                </button>
                <button class="btn btn-danger btn-small" onclick="limpiarFormulario()" style="background: rgba(220, 38, 38, 0.8); color: white; border: 2px solid white;">
                    üóëÔ∏è Limpiar formulario
                </button>
                <button class="btn btn-small" onclick="cerrarSesion()" style="background: rgba(107, 114, 128, 0.8); color: white; border: 2px solid white;">
                    üö™ Cerrar sesi√≥n
                </button>
            </div>
        </div>

        <!-- STATS BAR -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-number" id="statIndicadores">0</div>
                <div class="stat-label">Indicadores CMI</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statProgramas">0</div>
                <div class="stat-label">Programas EPVSA</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statConclusiones">0</div>
                <div class="stat-label">Conclusiones</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statPrioridad">0</div>
                <div class="stat-label">√Åreas Prioritarias</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statActuaciones">0</div>
                <div class="stat-label">Actuaciones</div>
            </div>
        </div>

        <!-- Bot√≥n de Administraci√≥n VISIBLE -->
        <div style="text-align: center; padding: 1rem 2rem; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-top: 3px solid #dc2626;">
            <button onclick="verificarAccesoAdmin()" 
                    style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); 
                           color: white; 
                           border: none; 
                           padding: 1rem 2rem; 
                           border-radius: 0.75rem; 
                           font-size: 1.1rem; 
                           font-weight: 700; 
                           cursor: pointer; 
                           box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                           transition: all 0.3s;
                           display: inline-flex;
                           align-items: center;
                           gap: 0.75rem;"
                    onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 12px rgba(220, 38, 38, 0.4)'"
                    onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.3)'">
                <span style="font-size: 1.5rem;">üîê</span>
                <span>PANEL DE ADMINISTRACI√ìN RELAS</span>
            </button>
            <div style="margin-top: 0.75rem; color: #94a3b8; font-size: 0.85rem;">
                üîë Gestiona claves y visualiza planes de todos los municipios
            </div>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <div class="tab active" data-tab="configuracion">
                <span class="tab-icon">‚öôÔ∏è</span>
                Configuraci√≥n
            </div>
            <div class="tab" data-tab="lineas">
                <span class="tab-icon">üéØ</span>
                Selecci√≥n EPVSA
            </div>
            <div class="tab" data-tab="plan">
                <span class="tab-icon">üìã</span>
                Plan de Acci√≥n
            </div>
            <div class="tab" data-tab="agendas">
                <span class="tab-icon">üìÖ</span>
                Agendas Anuales
            </div>
            <div class="tab" data-tab="conclusiones">
                <span class="tab-icon">üì¶</span>
                Compilador
            </div>
            <div class="tab" data-tab="indicadores">
                <span class="tab-icon">üìä</span>
                Cuadro de Mandos
            </div>
        </div>

        <!-- TAB: CONFIGURACI√ìN -->
        <div id="configuracion" class="tab-content active">
            <div class="step-indicator">
                <div class="step-number">0</div>
                <div class="step-text">
                    <h3>Dise√±o asistido de planes locales de salud</h3>
                    <p>Identifica tu municipio y carga el Perfil de Salud Local</p>
                </div>
            </div>

            <!-- NOMBRE DEL MUNICIPIO -->
            <div style="background: white; border: 3px solid #667eea; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                <h3 style="color: #667eea; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    üèõÔ∏è Datos del Municipio
                </h3>
                <div class="input-group">
                    <label class="input-label">Municipio *</label>
                    <input type="text" id="nombreMunicipio" class="input-field" 
                           placeholder="Ej: Granada, M√°laga, Sevilla..." 
                           style="font-size: 1.1rem; padding: 1rem;">
                </div>
                <div class="input-row" style="margin-top: 1rem;">
                    <div class="input-group">
                        <label class="input-label">Provincia</label>
                        <input type="text" id="provinciaMunicipio" class="input-field" 
                               placeholder="Ej: Granada, M√°laga, Sevilla...">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Poblaci√≥n</label>
                        <input type="number" id="poblacionMunicipio" class="input-field" 
                               placeholder="Ej: 50000">
                    </div>
                </div>

                <!-- MEJORA 9: Equipo Elaborador -->
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e5e7eb;">
                    <h4 style="color: #667eea; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        üë• Equipo Elaborador del Plan
                    </h4>
                    <div id="equipoElaborador">
                        <div class="input-row" style="margin-bottom: 1rem;">
                            <div class="input-group">
                                <label class="input-label">Coordinador/a</label>
                                <input type="text" id="coordinador" class="input-field" placeholder="Nombre y cargo">
                            </div>
                            <div class="input-group">
                                <label class="input-label">T√©cnico/a Salud P√∫blica</label>
                                <input type="text" id="tecnicoSalud" class="input-field" placeholder="Nombre y cargo">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label class="input-label">Representante Municipal</label>
                                <input type="text" id="representanteMunicipal" class="input-field" placeholder="Nombre y cargo">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Otros miembros (opcional)</label>
                                <input type="text" id="otrosMiembros" class="input-field" placeholder="Nombres separados por comas">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ANALIZADOR DE PDF -->
            <div style="background: white; border: 3px solid #10b981; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                <h3 style="color: #10b981; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    üìä Analizador de Perfil de Salud Local
                </h3>
                
                <div id="uploadZone" class="upload-zone">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: #10b981; margin-bottom: 0.5rem;">
                        Arrastra tu Perfil de Salud aqu√≠ o haz clic para seleccionar
                    </div>
                    <div style="color: #6b7280; font-size: 0.9rem;">
                        Archivo PDF (ejemplo: OI241_Modelo_IS_inf.pdf)
                    </div>
                    <input type="file" id="pdfInput" accept=".pdf" style="display: none;">
                </div>

                <div id="analisisResultados" style="display: none;">
                    <div class="alert alert-success" style="margin-bottom: 1.5rem;">
                        <span style="font-size: 1.5rem;">‚úÖ</span>
                        <div>
                            <strong>Perfil analizado correctamente</strong><br>
                            Se han extra√≠do los 58 indicadores del Cuadro de Mandos Integral
                        </div>
                    </div>

                    <!-- √ÅREA PRIORITARIA -->
                    <div id="priorizacionCard" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">üéØ √ÅREA PRIORITARIA IDENTIFICADA</div>
                        <div style="font-size: 1.8rem; font-weight: 700;">
                            <input type="text" 
                                   id="areaPrioritaria" 
                                   value="Bienestar Emocional"
                                   placeholder="Ej: Bienestar Emocional, Alimentaci√≥n Saludable..."
                                   style="background: transparent; border: none; border-bottom: 2px solid white; color: white; font-size: 1.8rem; font-weight: 700; width: 100%; outline: none;"
                                   onchange="actualizarAreaPrioritaria(this.value)">
                        </div>
                        <p style="margin-top: 0.5rem; opacity: 0.9; font-size: 0.9rem;">Puedes editar el √°rea seg√∫n tu diagn√≥stico local</p>
                    </div>

                    <!-- SESI√ìN GRUPO MOTOR -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem;">üìÖ SESI√ìN DE PRIORIZACI√ìN DEL GRUPO-MOTOR</div>
                        <div style="font-size: 1.3rem; font-weight: 700;">
                            <input type="text" 
                                   id="sesionGrupoMotor" 
                                   value="Febrero de 2025"
                                   placeholder="Ej: Febrero de 2025, 15 de marzo de 2024..."
                                   style="background: transparent; border: none; border-bottom: 2px solid white; color: white; font-size: 1.3rem; font-weight: 700; width: 100%; outline: none;"
                                   onchange="state.sesionGrupoMotor = this.value">
                        </div>
                        <p style="margin-top: 0.75rem; opacity: 0.95; font-size: 0.9rem; line-height: 1.5;">
                            En esta sesi√≥n, el Grupo-Motor acord√≥ establecer el <strong>Bienestar Emocional</strong> como eje central articulador del II Plan Local de Salud.
                        </p>
                    </div>

                    <!-- CONCLUSIONES PRINCIPALES -->
                    <div style="background: white; border: 3px solid #10b981; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="color: #10b981; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            ‚úÖ Conclusiones Principales del Diagn√≥stico
                        </h3>
                        <div id="conclusionesResumen"></div>
                    </div>

                    <!-- RECOMENDACIONES ESTRAT√âGICAS -->
                    <div style="background: white; border: 3px solid #f59e0b; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h3 style="color: #f59e0b; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üí° Recomendaciones Estrat√©gicas
                        </h3>
                        <div id="recomendacionesResumen"></div>
                    </div>

                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem; font-size: 1.05rem; padding: 1rem;" onclick="mostrarIndicadoresExtraidos()">
                        üìä Ver Cuadro de Mandos Integral Completo (58 Indicadores)
                    </button>
                </div>

                <div class="alert alert-info" style="margin-top: 1.5rem;">
                    <span style="font-size: 1.5rem;">‚ÑπÔ∏è</span>
                    <div>
                        <strong>An√°lisis Autom√°tico</strong><br>
                        El analizador extrae del documento:<br>
                        ‚Ä¢ 58 indicadores del Cuadro de Mandos Integral completo<br>
                        ‚Ä¢ 4 conclusiones principales del diagn√≥stico<br>
                        ‚Ä¢ 4 recomendaciones estrat√©gicas<br>
                        ‚Ä¢ Priorizaci√≥n identificada (Bienestar Emocional)
                    </div>
                </div>
            </div>

            <!-- MEJORA 2: Panel de Validaci√≥n -->
            <div id="validacionConfiguracion" style="display: none;">
                <div class="validation-panel">
                    <div class="validation-header">
                        <span style="font-size: 1.5rem;">üîç</span>
                        <h3 style="color: #f59e0b; font-size: 1.2rem; margin: 0;">Estado de la Configuraci√≥n</h3>
                    </div>
                    <div id="validacionItems"></div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <button id="btnContinuar" class="btn btn-primary" 
                        style="font-size: 1.1rem; padding: 1rem 2rem;" 
                        onclick="continuarAPlanificacion()">
                    ‚û°Ô∏è Continuar a Planificaci√≥n
                </button>
            </div>
        </div>

        <!-- TAB: L√çNEAS ESTRAT√âGICAS -->
        <div id="lineas" class="tab-content">
            <div class="step-indicator">
                <div class="step-number">1</div>
                <div class="step-text">
                    <h3>L√≠neas Estrat√©gicas del Plan Local de Salud</h3>
                    <p>Selecciona las l√≠neas, objetivos, indicadores, programas y actuaciones de la EPVSA 2024-2030</p>
                </div>
            </div>

            <!-- MENSAJE CUANDO NO HAY PERFIL CARGADO -->
            <div id="mensajeSinPerfil" class="alert alert-warning" style="margin-bottom: 2rem;">
                <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                <div>
                    <strong>Primero debes cargar el Perfil de Salud Local</strong><br>
                    Para ver el √°rea prioritaria y las sugerencias inteligentes, ve al tab "Configuraci√≥n" y carga el PDF de tu Perfil de Salud Local.<br><br>
                    Mientras tanto, puedes explorar libremente la estructura completa de la EPVSA 2024-2030 m√°s abajo.
                </div>
            </div>

            <!-- PRIORIZACI√ìN PRINCIPAL -->
            <div id="areaPrioritariaBanner" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem; display: none;">
                <h3 style="margin-bottom: 1rem; font-size: 1.5rem;">üéØ √ÅREA PRIORITARIA</h3>
                <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;" id="areaPrioritariaDisplay">Bienestar Emocional</div>
                <p style="opacity: 0.95; font-size: 1rem;">Seg√∫n la sesi√≥n de priorizaci√≥n del Grupo-Motor</p>
            </div>

            <!-- MEJORA 3: Sugerencias Inteligentes -->
            <div id="sugerenciasInteligentes" class="suggestion-card" style="display: none;">
                <div class="suggestion-header">
                    <span class="suggestion-icon">üí°</span>
                    <div>
                        <div class="suggestion-title">Selecci√≥n Sugerida seg√∫n tu √Årea Prioritaria</div>
                        <p style="color: #0369a1; font-size: 0.9rem; margin-top: 0.25rem;">
                            Basado en "<span id="areaSugerida">Bienestar Emocional</span>", te recomendamos estos objetivos:
                        </p>
                    </div>
                </div>
                <ul class="suggestion-list" id="sugerenciasList">
                    <!-- Se generar√° din√°micamente -->
                </ul>
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="aplicarSeleccionSugerida()">
                        ‚ú® Aplicar selecci√≥n sugerida
                    </button>
                    <button class="btn btn-secondary" style="margin-left: 0.5rem;" onclick="cerrarSugerencias()">
                        Seleccionar manualmente
                    </button>
                </div>
            </div>

            <div class="alert alert-info" style="margin-bottom: 2rem;">
                <span style="font-size: 1.5rem;">‚ÑπÔ∏è</span>
                <div>
                    <strong>Estructura Completa de la EPVSA 2024-2030</strong><br>
                    4 L√≠neas Estrat√©gicas ‚Üí 10 Objetivos ‚Üí 30+ Indicadores ‚Üí 15 Programas Oficiales ‚Üí Actuaciones Espec√≠ficas<br><br>
                    Selecciona los elementos que se alinean con tu √°rea prioritaria y las necesidades de tu municipio.
                </div>
            </div>

            <!-- L√çNEAS ESTRAT√âGICAS -->
            <div id="lineasEstrategicasContainer" class="tree-container">
                <!-- El contenido se generar√° din√°micamente -->
            </div>

            <!-- RESUMEN DE SELECCI√ìN -->
            <div style="background: #f0f4ff; border: 3px solid #667eea; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                <h3 style="color: #667eea; margin-bottom: 1rem;">üìã Resumen de tu selecci√≥n</h3>
                <div id="resumenLineas" style="color: #4b5563; font-size: 1rem; line-height: 1.8;">
                    Has seleccionado <strong id="numLineas">0</strong> l√≠neas estrat√©gicas para tu Plan Local de Salud.
                </div>
            </div>

            <!-- MEJORA 2: Validaci√≥n de Selecci√≥n -->
            <div id="validacionSeleccion" style="display: none;">
                <div class="validation-panel">
                    <div class="validation-header">
                        <span style="font-size: 1.5rem;">üîç</span>
                        <h3 style="color: #f59e0b; font-size: 1.2rem; margin: 0;">Completitud de la Selecci√≥n</h3>
                    </div>
                    <div id="validacionSeleccionItems"></div>
                </div>
            </div>

            <!-- BOTONES DE NAVEGACI√ìN -->
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="cambiarTab('configuracion')" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                    ‚¨ÖÔ∏è Volver al Planificador
                </button>
                <button class="btn btn-primary" onclick="guardarYGenerarPlan()" style="font-size: 1.1rem; padding: 1rem 2rem;">
                    ‚û°Ô∏è Generar Plan de Acci√≥n
                </button>
            </div>
        </div>

        <!-- TAB: PLAN DE ACCI√ìN -->
        <div id="plan" class="tab-content">
            <div class="step-indicator">
                <div class="step-number">2</div>
                <div class="step-text">
                    <h3>Plan de Acci√≥n seg√∫n Metodolog√≠a RELAS</h3>
                    <p>Documento estructurado con tu selecci√≥n de l√≠neas, objetivos, indicadores y programas EPVSA</p>
                </div>
            </div>

            <div id="planContainer"></div>

            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="cambiarTab('lineas')" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                    ‚¨ÖÔ∏è Volver a Selecci√≥n
                </button>
                <button class="btn btn-primary" onclick="cambiarTab('conclusiones')" style="font-size: 1.1rem; padding: 1rem 2rem;">
                    ‚û°Ô∏è Ir al Compilador
                </button>
            </div>
        </div>

        <!-- TAB: CUADRO DE MANDOS -->
        <div id="indicadores" class="tab-content">
            <div class="step-indicator">
                <div class="step-number">5</div>
                <div class="step-text">
                    <h3>Cuadro de Mandos Integral - 58 Indicadores</h3>
                    <p>Herramienta para el seguimiento y la evaluaci√≥n del Plan Local de Salud</p>
                </div>
            </div>

            <!-- Selector de A√±o para Cuadro de Mandos -->
            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #38bdf8; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem;">
                <h3 style="color: #0369a1; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    üìÖ Selecciona el A√±o del Cuadro de Mandos
                </h3>
                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                    <button class="year-btn active" data-year="2024" onclick="cambiarAnoCuadro(2024)">
                        2024
                    </button>
                    <button class="year-btn" data-year="2025" onclick="cambiarAnoCuadro(2025)">
                        2025
                    </button>
                    <button class="year-btn" data-year="2026" onclick="cambiarAnoCuadro(2026)">
                        2026
                    </button>
                    <button class="year-btn" data-year="2027" onclick="cambiarAnoCuadro(2027)">
                        2027
                    </button>
                    <button class="year-btn" data-year="2028" onclick="cambiarAnoCuadro(2028)">
                        2028
                    </button>
                    <button class="year-btn" data-year="2029" onclick="cambiarAnoCuadro(2029)">
                        2029
                    </button>
                    <button class="year-btn" data-year="2030" onclick="cambiarAnoCuadro(2030)">
                        2030
                    </button>
                </div>
                <p style="margin: 0; color: #0369a1; font-size: 0.9rem; display: flex; align-items: flex-start; gap: 0.5rem;">
                    <span style="flex-shrink: 0;">üí°</span>
                    <span><strong>Tip:</strong> Cada a√±o tiene su propio cuadro de mandos independiente. Los datos del 2024 ya est√°n pre-rellenados con informaci√≥n de AVISTA.</span>
                </p>
            </div>

            <!-- MEJORA 2: Validaci√≥n de Indicadores -->
            <div id="validacionIndicadores" style="display: none;">
                <div class="validation-panel">
                    <div class="validation-header">
                        <span style="font-size: 1.5rem;">üîç</span>
                        <h3 style="color: #f59e0b; font-size: 1.2rem; margin: 0;">Estado del Cuadro de Mandos</h3>
                    </div>
                    <div id="validacionIndicadoresItems"></div>
                </div>
            </div>

            <div id="indicadoresContainer"></div>

            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="cambiarTab('configuracion')" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); font-size: 1.1rem; padding: 1rem 2rem;">
                    ‚¨ÖÔ∏è Volver a Configuraci√≥n
                </button>
                <button class="btn btn-primary" onclick="cambiarTab('lineas')" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 1.1rem; padding: 1rem 2rem;">
                    ‚¨ÖÔ∏è Volver a Selecci√≥n EPVSA
                </button>
            </div>
        </div>

        <!-- TAB: AGENDAS ANUALES -->
        <div id="agendas" class="tab-content">
            <div class="step-indicator">
                <div class="step-number">3</div>
                <div class="step-text">
                    <h3>Planifica Actuaciones por Entornos y A√±os</h3>
                    <p>Registra actuaciones concretas diferenciadas por entornos (Sanitario, Comunitario, Educativo, Laboral)</p>
                </div>
            </div>

            <!-- MEJORA 2: Validaci√≥n de Actuaciones -->
            <div id="validacionActuaciones" style="display: none;">
                <div class="validation-panel">
                    <div class="validation-header">
                        <span style="font-size: 1.5rem;">üîç</span>
                        <h3 style="color: #f59e0b; font-size: 1.2rem; margin: 0;">Estado de las Actuaciones RELAS</h3>
                    </div>
                    <div id="validacionActuacionesItems"></div>
                </div>
            </div>

            <div class="alert alert-info">
                <span style="font-size: 1.5rem;">‚ÑπÔ∏è</span>
                <div>
                    <strong>4 Entornos de Intervenci√≥n EPVSA</strong><br>
                    Las actuaciones se organizan por: Sanitario, Comunitario, Educativo y Laboral
                </div>
            </div>

            <!-- Selector de Entorno -->
            <div class="entorno-selector" id="entornoSelector"></div>

            <!-- Contenido del Entorno Activo -->
            <div id="entornoContent"></div>

            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <button class="btn btn-primary" onclick="generarAgendaRELAS()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    üìÖ Generar Agendas RELAS
                </button>
                <button class="btn btn-primary" onclick="cambiarTab('conclusiones')" style="font-size: 1.1rem; padding: 1rem 2rem;">
                    ‚û°Ô∏è Ir al Compilador
                </button>
            </div>
        </div>

        <!-- TAB: COMPILADOR DE PLANES LOCALES DE SALUD -->
        <div id="conclusiones" class="tab-content">
            <div class="step-indicator">
                <div class="step-number">4</div>
                <div class="step-text">
                    <h3>Compilador de Planes Locales de Salud</h3>
                    <p>Genera el documento final completo con Perfil de Salud, Plan de Acci√≥n y Agendas RELAS</p>
                </div>
            </div>

            <div id="conclusionesContainer"></div>
        </div>
    </div>

    <script>
        // Configurar PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // MEJORA 10: Base de datos de informaci√≥n de programas EPVSA
        const PROGRAMAS_EPVSA_INFO = {
            'P01': {
                codigo: 'P01',
                nombre: 'Promoci√≥n de h√°bitos saludables y redes de apoyo comunitario a trav√©s de la Red de Acci√≥n Local en Salud (RELAS)',
                descripcion: 'Este programa promueve h√°bitos saludables a trav√©s de la participaci√≥n comunitaria, creando redes de apoyo social y dinamizando activos locales para la salud. Se basa en el enfoque salutog√©nico y de activos comunitarios.',
                ambito: '√Åmbito comunitario',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Creaci√≥n de grupos comunitarios de apoyo',
                    'Talleres de h√°bitos saludables en centros comunitarios',
                    'Ferias y mercados locales de salud',
                    'Mapeo y dinamizaci√≥n de activos comunitarios',
                    'Formaci√≥n de agentes comunitarios de salud'
                ]
            },
            'P02': {
                codigo: 'P02',
                nombre: 'Medidas espec√≠ficas en entornos y sistemas de movilidad y transporte para facilitar los h√°bitos saludables en la poblaci√≥n',
                descripcion: 'Intervenciones en el entorno urbano para facilitar la movilidad activa y el acceso a espacios saludables. Incluye carriles bici, zonas peatonales, espacios verdes y mejoras en transporte p√∫blico.',
                ambito: '√Åmbito comunitario',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Carriles bici y v√≠as ciclistas urbanas',
                    'Zonas peatonales y calles con prioridad peatonal',
                    'Sistemas de pr√©stamo de bicicletas p√∫blicas',
                    'Mejora de espacios p√∫blicos para actividad f√≠sica',
                    'Fuentes de agua potable en espacios p√∫blicos'
                ]
            },
            'P03': {
                codigo: 'P03',
                nombre: 'Promoci√≥n de h√°bitos saludables en los centros sanitarios',
                descripcion: 'Integra la promoci√≥n de salud en la pr√°ctica cl√≠nica habitual. Incluye valoraci√≥n de h√°bitos, consejo sanitario, intervenci√≥n avanzada y prescripci√≥n social de activos comunitarios.',
                ambito: '√Åmbito sanitario',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Valoraci√≥n de h√°bitos en consultas de atenci√≥n primaria',
                    'Consejo sanitario breve sobre estilos de vida',
                    'Intervenci√≥n Avanzada en H√°bitos Saludables (IAHS)',
                    'Prescripci√≥n social de activos comunitarios',
                    'Derivaci√≥n a Unidades de Actividad F√≠sica (UAEF)'
                ]
            },
            'P04': {
                codigo: 'P04',
                nombre: 'Identificaci√≥n y dinamizaci√≥n de activos para la salud',
                descripcion: 'Mapeo sistem√°tico de recursos comunitarios (asociaciones, espacios, servicios) que promueven la salud, creando cat√°logos accesibles para profesionales y ciudadan√≠a.',
                ambito: '√Åmbito sanitario',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Mapeo de activos para la salud',
                    'Cat√°logo de recursos comunitarios',
                    'Plataforma digital de activos',
                    'Formaci√≥n de activos en salud comunitaria',
                    'Coordinaci√≥n intersectorial de activos'
                ]
            },
            'P05': {
                codigo: 'P05',
                nombre: 'Promoci√≥n de h√°bitos saludables en los centros de atenci√≥n a personas con adicciones',
                descripcion: 'Programas de promoci√≥n de salud integral en centros de tratamiento de adicciones, abordando alimentaci√≥n, actividad f√≠sica y bienestar emocional.',
                ambito: '√Åmbito sanitario',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Talleres de h√°bitos saludables en centros de adicciones',
                    'Actividad f√≠sica terap√©utica',
                    'Grupos de apoyo emocional',
                    'Alimentaci√≥n saludable en programas de tratamiento'
                ]
            },
            'P06': {
                codigo: 'P06',
                nombre: 'Promoci√≥n de h√°bitos saludables en centros educativos',
                descripcion: 'Programa Creciendo en Salud y otras iniciativas para promover estilos de vida saludables en el entorno escolar, incluyendo alimentaci√≥n, actividad f√≠sica y bienestar emocional.',
                ambito: 'Centros docentes',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Programa Creciendo en Salud',
                    'Men√∫s escolares saludables',
                    'Recreos activos y din√°micos',
                    'Huertos escolares educativos',
                    'Educaci√≥n emocional y convivencia'
                ]
            },
            'P07': {
                codigo: 'P07',
                nombre: 'Promoci√≥n de h√°bitos saludables en centros universitarios',
                descripcion: 'Programa Universidad Saludable para promover estilos de vida saludables en el √°mbito universitario, adaptado a las necesidades de poblaci√≥n joven adulta.',
                ambito: 'Centros docentes',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.7'],
                actuaciones_tipo: [
                    'Programa Universidad Saludable',
                    'Instalaciones deportivas universitarias',
                    'Servicios de apoyo psicol√≥gico',
                    'Comedores universitarios saludables',
                    'Talleres de gesti√≥n del estr√©s'
                ]
            },
            'P08': {
                codigo: 'P08',
                nombre: 'Promoci√≥n de h√°bitos saludables en los centros de servicios sociales',
                descripcion: 'Programas de promoci√≥n de salud en residencias, centros de d√≠a y servicios sociales comunitarios, con especial atenci√≥n a personas mayores y en situaci√≥n de vulnerabilidad.',
                ambito: 'Centros de servicios sociales',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Programas de envejecimiento activo',
                    'Men√∫s saludables en residencias',
                    'Actividades de estimulaci√≥n cognitiva',
                    'Talleres de cocina saludable',
                    'Actividades de relaci√≥n social'
                ]
            },
            'P09': {
                codigo: 'P09',
                nombre: 'Promoci√≥n de h√°bitos saludables en los programas de apoyo social para personas con enfermedad mental',
                descripcion: 'Intervenciones de promoci√≥n de salud f√≠sica en dispositivos de salud mental comunitaria, abordando la importancia de los h√°bitos saludables en la recuperaci√≥n.',
                ambito: 'Centros de servicios sociales',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Talleres de h√°bitos saludables en salud mental',
                    'Actividad f√≠sica adaptada',
                    'Grupos de apoyo mutuo',
                    'Alimentaci√≥n saludable terap√©utica'
                ]
            },
            'P10': {
                codigo: 'P10',
                nombre: 'Promoci√≥n de h√°bitos saludables en los centros de acogida temporal para inmigrantes',
                descripcion: 'Programas de promoci√≥n de salud adaptados culturalmente para poblaci√≥n inmigrante en centros de acogida.',
                ambito: 'Centros de servicios sociales',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Talleres interculturales de alimentaci√≥n saludable',
                    'Actividades deportivas inclusivas',
                    'Apoyo psicosocial y bienestar emocional'
                ]
            },
            'P11': {
                codigo: 'P11',
                nombre: 'Promoci√≥n de h√°bitos saludables en centros y servicios de justicia juvenil y centros penitenciarios',
                descripcion: 'Programas de promoci√≥n de salud en entornos de internamiento, como herramienta de reinserci√≥n social.',
                ambito: 'Centros de servicios sociales',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Talleres de h√°bitos saludables en centros de justicia juvenil',
                    'Actividades deportivas terap√©uticas',
                    'Alimentaci√≥n saludable en comedores',
                    'Apoyo psicosocial'
                ]
            },
            'P12': {
                codigo: 'P12',
                nombre: 'Promoci√≥n de la Salud en el Lugar de Trabajo (PSLT)',
                descripcion: 'Programa para crear entornos laborales saludables, promoviendo h√°bitos saludables entre trabajadores y mejorando condiciones de trabajo.',
                ambito: 'Centros de trabajo',
                objetivos: ['1.1', '1.2', '1.3', '1.4', '1.6', '1.7'],
                actuaciones_tipo: [
                    'Comedores laborales con opciones saludables',
                    'Pausas activas en el trabajo',
                    'Programas de actividad f√≠sica para empleados',
                    'Medidas de conciliaci√≥n',
                    'Prevenci√≥n del estr√©s laboral'
                ]
            },
            'P13': {
                codigo: 'P13',
                nombre: 'Establecimiento de alianzas con los operadores econ√≥micos en el campo de la alimentaci√≥n, la restauraci√≥n, el deporte y el ocio',
                descripcion: 'Convenios con sector empresarial para promover oferta saludable y consumo responsable.',
                ambito: 'Sector empresarial',
                objetivos: ['2.1'],
                actuaciones_tipo: [
                    'Convenios con empresas de alimentaci√≥n',
                    'Acuerdos con sector de restauraci√≥n',
                    'Colaboraci√≥n con empresas de deporte',
                    'Certificaci√≥n de empresas responsables con la salud'
                ]
            },
            'P14': {
                codigo: 'P14',
                nombre: 'Difusi√≥n de informaci√≥n veraz sobre h√°bitos saludables y medidas para hacer frente a la publicidad de productos y actividades perjudiciales para la salud',
                descripcion: 'Campa√±as de comunicaci√≥n basadas en evidencia cient√≠fica y regulaci√≥n de publicidad de productos no saludables.',
                ambito: 'Informaci√≥n y comunicaci√≥n',
                objetivos: ['3.1'],
                actuaciones_tipo: [
                    'Portal Mi Gu√≠a de Salud',
                    'Campa√±as en redes sociales institucionales',
                    'Material divulgativo basado en evidencia',
                    'Regulaci√≥n de publicidad de productos no saludables',
                    'Colaboraci√≥n con medios de comunicaci√≥n'
                ]
            },
            'P15': {
                codigo: 'P15',
                nombre: 'Fomento de la formaci√≥n, investigaci√≥n e innovaci√≥n en promoci√≥n de h√°bitos saludables y los determinantes que los condicionan',
                descripcion: 'Formaci√≥n de profesionales, investigaci√≥n en determinantes sociales de la salud e innovaci√≥n en metodolog√≠as de intervenci√≥n comunitaria.',
                ambito: 'Formaci√≥n e investigaci√≥n',
                objetivos: ['4.1'],
                actuaciones_tipo: [
                    'Formaci√≥n de profesionales en promoci√≥n de salud',
                    'Investigaci√≥n en determinantes sociales',
                    'Evaluaci√≥n de impacto de pol√≠ticas',
                    'Observatorio de h√°bitos saludables',
                    'Innovaci√≥n en intervenci√≥n comunitaria'
                ]
            }
        };

        // MEJORA 5: Plantillas de actuaciones por entorno
        const PLANTILLAS_ACTUACIONES = {
            'sanitario': [
                {
                    titulo: 'Consulta de valoraci√≥n de h√°bitos saludables',
                    descripcion: 'Evaluaci√≥n sistem√°tica de alimentaci√≥n, actividad f√≠sica, sue√±o y bienestar emocional en consultas de atenci√≥n primaria.',
                    icon: 'üè•'
                },
                {
                    titulo: 'Intervenci√≥n Avanzada en H√°bitos Saludables (IAHS)',
                    descripcion: 'Programa intensivo individual o grupal para personas con factores de riesgo relacionados con estilos de vida.',
                    icon: 'üí™'
                },
                {
                    titulo: 'Prescripci√≥n social de activos comunitarios',
                    descripcion: 'Recomendaci√≥n de recursos comunitarios (grupos de paseo, talleres, asociaciones) desde atenci√≥n primaria.',
                    icon: 'üåç'
                },
                {
                    titulo: 'Grupos de apoyo para cuidadores',
                    descripcion: 'Sesiones grupales de apoyo mutuo y educaci√≥n para salud de personas cuidadoras.',
                    icon: 'üë•'
                },
                {
                    titulo: 'Consultas de salud mental en atenci√≥n primaria',
                    descripcion: 'Detecci√≥n e intervenci√≥n precoz en malestar emocional, ansiedad y depresi√≥n leve-moderada.',
                    icon: 'üß†'
                }
            ],
            'comunitario': [
                {
                    titulo: 'Rutas saludables comunitarias',
                    descripcion: 'Circuitos peatonales se√±alizados en el municipio para promover la actividad f√≠sica.',
                    icon: 'üö∂'
                },
                {
                    titulo: 'Huertos comunitarios',
                    descripcion: 'Espacios de cultivo compartido que promueven alimentaci√≥n saludable, actividad f√≠sica y cohesi√≥n social.',
                    icon: 'üå±'
                },
                {
                    titulo: 'Ferias de salud y bienestar',
                    descripcion: 'Eventos comunitarios con talleres, actividades y stands informativos sobre estilos de vida saludables.',
                    icon: 'üé™'
                },
                {
                    titulo: 'Grupos de actividad f√≠sica comunitaria',
                    descripcion: 'Actividades dirigidas de ejercicio f√≠sico en espacios p√∫blicos (gimnasia de mantenimiento, tai chi, baile).',
                    icon: 'ü§∏'
                },
                {
                    titulo: 'Talleres de cocina saludable',
                    descripcion: 'Sesiones pr√°cticas de elaboraci√≥n de recetas saludables basadas en dieta mediterr√°nea.',
                    icon: 'üë®‚Äçüç≥'
                },
                {
                    titulo: 'Programa de prevenci√≥n de la soledad no deseada',
                    descripcion: 'Actividades de relaci√≥n social y acompa√±amiento para personas en riesgo de aislamiento social.',
                    icon: '‚ù§Ô∏è'
                }
            ],
            'educativo': [
                {
                    titulo: 'Programa Creciendo en Salud - Alimentaci√≥n',
                    descripcion: 'Actividades educativas sobre alimentaci√≥n saludable, desayuno saludable y comedores escolares.',
                    icon: 'üçé'
                },
                {
                    titulo: 'Recreos activos y din√°micos',
                    descripcion: 'Organizaci√≥n de actividades f√≠sicas y juegos en los recreos escolares.',
                    icon: '‚öΩ'
                },
                {
                    titulo: 'Huertos escolares educativos',
                    descripcion: 'Espacios de cultivo en centros educativos como herramienta pedag√≥gica transversal.',
                    icon: 'üåª'
                },
                {
                    titulo: 'Programa de educaci√≥n emocional',
                    descripcion: 'Sesiones de gesti√≥n emocional, habilidades sociales y prevenci√≥n del acoso escolar.',
                    icon: 'üòä'
                },
                {
                    titulo: 'Rutas escolares seguras',
                    descripcion: 'Caminos seguros para ir andando o en bicicleta al centro educativo.',
                    icon: 'üö∏'
                }
            ],
            'laboral': [
                {
                    titulo: 'Pausas activas en el trabajo',
                    descripcion: 'Breves sesiones de ejercicios de estiramiento y movilidad durante la jornada laboral.',
                    icon: 'üßò'
                },
                {
                    titulo: 'Comedores laborales saludables',
                    descripcion: 'Men√∫s equilibrados basados en dieta mediterr√°nea en comedores de empresa.',
                    icon: 'ü•ó'
                },
                {
                    titulo: 'Programa de prevenci√≥n del estr√©s laboral',
                    descripcion: 'Formaci√≥n en gesti√≥n del estr√©s, mindfulness y t√©cnicas de relajaci√≥n para trabajadores.',
                    icon: 'üòå'
                },
                {
                    titulo: 'Incentivos para desplazamiento activo',
                    descripcion: 'Medidas para fomentar ir al trabajo andando, en bicicleta o en transporte p√∫blico.',
                    icon: 'üö¥'
                },
                {
                    titulo: 'Espacios de descanso y desconexi√≥n',
                    descripcion: '√Åreas acondicionadas para pausas, con opciones de lectura, juegos o relajaci√≥n.',
                    icon: '‚òï'
                }
            ]
        };

        // ESTRUCTURA JER√ÅRQUICA EPVSA 2024-2030 CON PROGRAMAS INTEGRADOS
        const ESTRUCTURA_EPVSA = [
            {
                id: 1,
                codigo: "LE 1",
                nombre: "Promoci√≥n de h√°bitos de vida saludable mediante intervenciones en pol√≠ticas y entornos y dinamizaci√≥n de activos comunitarios para la salud",
                color: "#667eea",
                objetivos: [
                    {
                        id: "1.1",
                        codigo: "OE 1.1",
                        nombre: "Incrementar los niveles de lactancia materna y el consumo de alimentos saludables en detrimento de los no saludables",
                        indicadores: [
                            "Indicador 1.1.1.a - Porcentaje de menores que recibieron lactancia materna exclusiva los 6 primeros meses (CONTEXTO)",
                            "Indicador 1.1.1.b - Aumento del porcentaje de menores que recibieron lactancia materna exclusiva los 6 primeros meses (IMPACTO)",
                            "Indicador 1.1.2.a - Porcentaje de menores que consume verduras 5 o m√°s veces por semana (CONTEXTO)",
                            "Indicador 1.1.3.a - Porcentaje de menores con buena adherencia a la dieta mediterr√°nea (CONTEXTO)",
                            "Indicador 1.1.3.b - Aumento del porcentaje de menores con buena adherencia a la dieta mediterr√°nea (IMPACTO)",
                            "Indicador 1.1.4.a - Porcentaje de personas adultas que toman comida r√°pida 3 o m√°s veces por semana (CONTEXTO)",
                            "Indicador 1.1.5.a - Porcentaje de personas adultas con buena adherencia a la dieta mediterr√°nea (CONTEXTO)",
                            "Indicador 1.1.5.b - Aumento del porcentaje de personas adultas con buena adherencia a la dieta mediterr√°nea (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Promoci√≥n de h√°bitos saludables y redes de apoyo comunitario a trav√©s de la Red de Acci√≥n Local en Salud (RELAS)',
                                actuaciones: [
                                    'Creaci√≥n y dinamizaci√≥n de grupos comunitarios de apoyo a la lactancia materna',
                                    'Talleres de alimentaci√≥n saludable en centros comunitarios',
                                    'Ferias y mercados locales de productos saludables',
                                    'Programa de huertos comunitarios escolares y vecinales',
                                    'Formaci√≥n de agentes comunitarios en promoci√≥n de alimentaci√≥n saludable'
                                ]
                            },
                            {
                                codigo: 'P02',
                                nombre: 'Medidas espec√≠ficas en entornos y sistemas de movilidad y transporte',
                                actuaciones: [
                                    'Creaci√≥n de espacios p√∫blicos amigables para la lactancia materna',
                                    'Instalaci√≥n de fuentes de agua potable en espacios p√∫blicos',
                                    'Mercados de proximidad y puntos de venta de productos frescos'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoci√≥n de h√°bitos saludables en los centros sanitarios',
                                actuaciones: [
                                    'Acreditaci√≥n IHAN (Iniciativa para la Humanizaci√≥n de la Asistencia al Nacimiento y la Lactancia)',
                                    'Consultas de asesoramiento en lactancia materna',
                                    'Programas de educaci√≥n alimentaria en atenci√≥n primaria',
                                    'Intervenci√≥n avanzada en h√°bitos saludables (IAHS)',
                                    'Prescripci√≥n social de activos comunitarios para alimentaci√≥n saludable'
                                ]
                            },
                            {
                                codigo: 'P06',
                                nombre: 'Promoci√≥n de h√°bitos saludables en centros educativos',
                                actuaciones: [
                                    'Programa Creciendo en Salud: m√≥dulo de alimentaci√≥n',
                                    'Men√∫s escolares saludables basados en dieta mediterr√°nea',
                                    'Eliminaci√≥n de m√°quinas expendedoras de productos no saludables',
                                    'Desayunos saludables en centros educativos',
                                    'Huertos escolares educativos'
                                ]
                            },
                            {
                                codigo: 'P08',
                                nombre: 'Promoci√≥n de h√°bitos saludables en centros de servicios sociales',
                                actuaciones: [
                                    'Men√∫s saludables en residencias y centros de d√≠a',
                                    'Talleres de cocina saludable para mayores',
                                    'Asesoramiento nutricional en servicios sociales'
                                ]
                            },
                            {
                                codigo: 'P12',
                                nombre: 'Promoci√≥n de la Salud en el Lugar de Trabajo (PSLT)',
                                actuaciones: [
                                    'Comedores laborales con opciones saludables',
                                    'M√°quinas expendedoras con productos saludables',
                                    'Talleres de alimentaci√≥n saludable para trabajadores',
                                    'Espacios habilitados para lactancia materna en centros de trabajo'
                                ]
                            }
                        ]
                    },
                    {
                        id: "1.2",
                        codigo: "OE 1.2",
                        nombre: "Aumentar los niveles de actividad f√≠sica y disminuir los h√°bitos sedentarios",
                        indicadores: [
                            "Indicador 1.2.1.a - Porcentaje de poblaci√≥n infantil que practica ejercicio f√≠sico regular o varias veces por semana (CONTEXTO)",
                            "Indicador 1.2.1.b - Aumento del porcentaje de poblaci√≥n infantil que practica ejercicio f√≠sico regular (IMPACTO)",
                            "Indicador 1.2.2.a - Porcentaje de personas adultas que practica ejercicio f√≠sico regular o varias veces por semana (CONTEXTO)",
                            "Indicador 1.2.2.b - Aumento del porcentaje de personas adultas que practica ejercicio f√≠sico regular (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Red de Acci√≥n Local en Salud (RELAS)',
                                actuaciones: [
                                    'Rutas saludables comunitarias se√±alizadas',
                                    'Grupos de caminata y actividad f√≠sica comunitaria',
                                    'Gimnasios al aire libre en espacios p√∫blicos',
                                    'Programas de deporte inclusivo en barrios',
                                    'Escuelas deportivas municipales'
                                ]
                            },
                            {
                                codigo: 'P02',
                                nombre: 'Medidas en entornos y sistemas de movilidad',
                                actuaciones: [
                                    'Carriles bici y v√≠as ciclistas urbanas',
                                    'Zonas peatonales y calles con prioridad peatonal',
                                    'Aparcamientos seguros para bicicletas',
                                    'Sistemas de pr√©stamo de bicicletas p√∫blicas',
                                    'Se√±alizaci√≥n de rutas peatonales y ciclistas'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoci√≥n en centros sanitarios',
                                actuaciones: [
                                    'Consultas de actividad f√≠sica en atenci√≥n primaria',
                                    'Prescripci√≥n de ejercicio f√≠sico personalizado',
                                    'Derivaci√≥n a Unidades de Actividad F√≠sica (UAEF)',
                                    'Prescripci√≥n social de activos comunitarios deportivos',
                                    'Programa Forma Joven en centros de salud'
                                ]
                            },
                            {
                                codigo: 'P04',
                                nombre: 'Identificaci√≥n y dinamizaci√≥n de activos para la salud',
                                actuaciones: [
                                    'Mapeo de instalaciones deportivas y espacios para actividad f√≠sica',
                                    'Cat√°logo de recursos comunitarios para ejercicio f√≠sico',
                                    'Red de activos deportivos municipales',
                                    'Programa de prescripci√≥n social de actividad f√≠sica'
                                ]
                            },
                            {
                                codigo: 'P06',
                                nombre: 'Promoci√≥n en centros educativos',
                                actuaciones: [
                                    'Programa Creciendo en Salud: m√≥dulo de actividad f√≠sica',
                                    'Recreos activos y din√°micos',
                                    'Descansos activos en el aula',
                                    'Programa de Deporte en la Escuela',
                                    'Rutas escolares seguras a pie o en bicicleta'
                                ]
                            },
                            {
                                codigo: 'P07',
                                nombre: 'Promoci√≥n en centros universitarios',
                                actuaciones: [
                                    'Instalaciones deportivas universitarias accesibles',
                                    'Programa Universidad Saludable: actividad f√≠sica',
                                    'Competiciones deportivas interuniversitarias',
                                    'Descuentos en instalaciones deportivas para estudiantes'
                                ]
                            },
                            {
                                codigo: 'P12',
                                nombre: 'Promoci√≥n en el Lugar de Trabajo',
                                actuaciones: [
                                    'Pausas activas en el trabajo',
                                    'Instalaciones deportivas en centros de trabajo',
                                    'Programas de actividad f√≠sica para empleados',
                                    'Incentivos para desplazamiento activo al trabajo',
                                    'Formaci√≥n de empresas en entornos laborales saludables'
                                ]
                            }
                        ]
                    },
                    {
                        id: "1.3",
                        codigo: "OE 1.3",
                        nombre: "Incrementar las horas y la calidad del sue√±o en la poblaci√≥n",
                        indicadores: [
                            "Indicador 1.3.1.a - Porcentaje de poblaci√≥n infantil que duerme las horas recomendadas (CONTEXTO)",
                            "Indicador 1.3.1.b - Aumento del porcentaje de poblaci√≥n infantil que duerme las horas recomendadas (IMPACTO)",
                            "Indicador 1.3.2.a - Porcentaje de poblaci√≥n adulta que duerme las horas recomendadas (CONTEXTO)",
                            "Indicador 1.3.2.b - Aumento del porcentaje de poblaci√≥n adulta que duerme las horas recomendadas (IMPACTO)",
                            "Indicador 1.3.3.a - Porcentaje de poblaci√≥n adulta que descansa lo suficiente (CONTEXTO)",
                            "Indicador 1.3.3.b - Aumento del porcentaje de poblaci√≥n adulta que descansa lo suficiente (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Red de Acci√≥n Local en Salud',
                                actuaciones: [
                                    'Talleres comunitarios sobre higiene del sue√±o',
                                    'Sesiones informativas sobre h√°bitos de sue√±o saludable',
                                    'Programa de educaci√≥n para familias sobre sue√±o infantil'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoci√≥n en centros sanitarios',
                                actuaciones: [
                                    'Consultas de asesoramiento en higiene del sue√±o',
                                    'Valoraci√≥n de h√°bitos de sue√±o en atenci√≥n primaria',
                                    'Intervenci√≥n avanzada en h√°bitos de sue√±o',
                                    'Programa Forma Joven: m√≥dulo de sue√±o saludable'
                                ]
                            },
                            {
                                codigo: 'P06',
                                nombre: 'Promoci√≥n en centros educativos',
                                actuaciones: [
                                    'Programa Creciendo en Salud: m√≥dulo de descanso y sue√±o',
                                    'Educaci√≥n sobre higiene del sue√±o en el curr√≠culo',
                                    'Horarios escolares que respeten el descanso',
                                    'Informaci√≥n a familias sobre sue√±o infantil y adolescente'
                                ]
                            },
                            {
                                codigo: 'P12',
                                nombre: 'Promoci√≥n en el Lugar de Trabajo',
                                actuaciones: [
                                    'Formaci√≥n en higiene del sue√±o para trabajadores',
                                    'Medidas de conciliaci√≥n que favorezcan el descanso',
                                    'Espacios de descanso en centros de trabajo',
                                    'Gesti√≥n de turnos que respeten el ciclo circadiano'
                                ]
                            }
                        ]
                    },
                    {
                        id: "1.4",
                        codigo: "OE 1.4",
                        nombre: "Incrementar la percepci√≥n de calidad de vida y de bienestar emocional",
                        indicadores: [
                            "Indicador 1.4.1.a - Media del √≠ndice de calidad de vida en poblaci√≥n infantil - Kidscreen (CONTEXTO)",
                            "Indicador 1.4.1.b - Aumento de la calidad de vida media en poblaci√≥n infantil - Kidscreen (IMPACTO)",
                            "Indicador 1.4.2.a - Media del √≠ndice de calidad de vida en poblaci√≥n adulta - componente f√≠sica (CONTEXTO)",
                            "Indicador 1.4.2.b - Aumento de la media del √≠ndice de calidad de vida - componente f√≠sica (IMPACTO)",
                            "Indicador 1.4.3.a - Media del √≠ndice de calidad de vida en poblaci√≥n adulta - componente mental (CONTEXTO)",
                            "Indicador 1.4.3.b - Aumento de la media del √≠ndice de calidad de vida - componente mental (IMPACTO)",
                            "Indicador 1.4.4.a - Porcentaje de poblaci√≥n adulta que se considera completamente feliz (CONTEXTO)",
                            "Indicador 1.4.4.b - Aumento del porcentaje de poblaci√≥n adulta que se considera completamente feliz (IMPACTO)",
                            "Indicador 1.4.5.a - Porcentaje de poblaci√≥n adulta con apoyo social y afectivo bajo (CONTEXTO)",
                            "Indicador 1.4.5.b - Disminuci√≥n del porcentaje de poblaci√≥n adulta con apoyo social y afectivo bajo (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Red de Acci√≥n Local en Salud',
                                actuaciones: [
                                    'Grupos de apoyo mutuo y redes comunitarias',
                                    'Actividades de ocio saludable y relaci√≥n social',
                                    'Programas intergeneracionales',
                                    'Espacios de encuentro y convivencia comunitaria',
                                    'Voluntariado social y participaci√≥n ciudadana',
                                    'Programas de prevenci√≥n de la soledad no deseada'
                                ]
                            },
                            {
                                codigo: 'P02',
                                nombre: 'Medidas en entornos y movilidad',
                                actuaciones: [
                                    'Espacios p√∫blicos de calidad para la convivencia',
                                    'Zonas verdes y espacios naturales accesibles',
                                    'Plazas y parques comunitarios',
                                    'Mejora de la accesibilidad universal'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoci√≥n en centros sanitarios',
                                actuaciones: [
                                    'Detecci√≥n de malestar emocional en atenci√≥n primaria',
                                    'Intervenciones breves en salud mental',
                                    'Programa Forma Joven: salud mental y bienestar emocional',
                                    'Prescripci√≥n social de activos comunitarios',
                                    'Derivaci√≥n a recursos de salud mental cuando proceda'
                                ]
                            },
                            {
                                codigo: 'P04',
                                nombre: 'Identificaci√≥n y dinamizaci√≥n de activos',
                                actuaciones: [
                                    'Mapeo de activos comunitarios para el bienestar emocional',
                                    'Cat√°logo de recursos de apoyo social y emocional',
                                    'Red de activos para la salud mental comunitaria',
                                    'Programa de recomendaci√≥n social de activos'
                                ]
                            },
                            {
                                codigo: 'P06',
                                nombre: 'Promoci√≥n en centros educativos',
                                actuaciones: [
                                    'Programa Creciendo en Salud: educaci√≥n emocional',
                                    'Programa de prevenci√≥n del acoso escolar',
                                    'Formaci√≥n en gesti√≥n emocional y habilidades sociales',
                                    'Espacios de mediaci√≥n y convivencia',
                                    'Red andaluza de Escuelas Promotoras de Salud'
                                ]
                            },
                            {
                                codigo: 'P07',
                                nombre: 'Promoci√≥n en centros universitarios',
                                actuaciones: [
                                    'Programa Universidad Saludable: salud mental',
                                    'Servicios de apoyo psicol√≥gico universitario',
                                    'Talleres de gesti√≥n del estr√©s y ansiedad',
                                    'Actividades de cohesi√≥n y relaci√≥n social'
                                ]
                            },
                            {
                                codigo: 'P08',
                                nombre: 'Promoci√≥n en centros de servicios sociales',
                                actuaciones: [
                                    'Programas de envejecimiento activo y saludable',
                                    'Talleres de estimulaci√≥n cognitiva',
                                    'Actividades de ocio y relaci√≥n social para mayores',
                                    'Programas de apoyo a cuidadores'
                                ]
                            },
                            {
                                codigo: 'P09',
                                nombre: 'Promoci√≥n en programas de salud mental',
                                actuaciones: [
                                    'Apoyo psicosocial en centros de rehabilitaci√≥n',
                                    'Talleres de habilidades sociales',
                                    'Grupos de apoyo mutuo',
                                    'Programas de inserci√≥n social y laboral'
                                ]
                            },
                            {
                                codigo: 'P12',
                                nombre: 'Promoci√≥n en el Lugar de Trabajo',
                                actuaciones: [
                                    'Programas de prevenci√≥n del estr√©s laboral',
                                    'Medidas de conciliaci√≥n trabajo-vida personal',
                                    'Formaci√≥n en gesti√≥n emocional para trabajadores',
                                    'Protocolo de actuaci√≥n ante riesgos psicosociales',
                                    'Espacios de descanso y desconexi√≥n'
                                ]
                            }
                        ]
                    },
                    {
                        id: "1.5",
                        codigo: "OE 1.5",
                        nombre: "Incrementar la percepci√≥n de satisfacci√≥n con las relaciones sexuales para todas las partes",
                        indicadores: [
                            "Indicador 1.5.1.a - Porcentaje de poblaci√≥n adulta que considera satisfactorias las relaciones sexuales (CONTEXTO)",
                            "Indicador 1.5.1.b - Aumento del porcentaje de poblaci√≥n adulta que considera satisfactorias las relaciones sexuales (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Red de Acci√≥n Local en Salud',
                                actuaciones: [
                                    'Talleres de educaci√≥n sexual integral en espacios comunitarios',
                                    'Charlas sobre sexualidad saludable y diversidad',
                                    'Formaci√≥n en igualdad y prevenci√≥n de violencia de g√©nero'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoci√≥n en centros sanitarios',
                                actuaciones: [
                                    'Consultas de salud sexual y reproductiva',
                                    'Asesoramiento en salud sexual',
                                    'Programa Forma Joven: educaci√≥n afectivo-sexual',
                                    'Detecci√≥n de violencia de g√©nero'
                                ]
                            },
                            {
                                codigo: 'P06',
                                nombre: 'Promoci√≥n en centros educativos',
                                actuaciones: [
                                    'Programa Creciendo en Salud: educaci√≥n afectivo-sexual',
                                    'Formaci√≥n en igualdad y respeto a la diversidad',
                                    'Prevenci√≥n de violencia de g√©nero entre adolescentes',
                                    'Talleres de educaci√≥n sexual integral'
                                ]
                            },
                            {
                                codigo: 'P07',
                                nombre: 'Promoci√≥n en centros universitarios',
                                actuaciones: [
                                    'Talleres de salud sexual en universidades',
                                    'Programas de prevenci√≥n de violencia de g√©nero',
                                    'Servicios de asesoramiento en salud sexual'
                                ]
                            }
                        ]
                    },
                    {
                        id: "1.6",
                        codigo: "OE 1.6",
                        nombre: "Disminuir el tiempo dedicado al uso de aparatos electr√≥nicos",
                        indicadores: [
                            "Indicador 1.6.1.a - Porcentaje de poblaci√≥n infantil que ve TV 2+ horas diarias (CONTEXTO)",
                            "Indicador 1.6.2.a - Porcentaje de ni√±os/as 3-7 a√±os que usa aparatos electr√≥nicos 1+ hora/d√≠a (CONTEXTO)",
                            "Indicador 1.6.2.b - Disminuci√≥n del porcentaje de ni√±os/as 3-7 a√±os que usa aparatos electr√≥nicos 1+ hora/d√≠a (IMPACTO)",
                            "Indicador 1.6.3.a - Porcentaje de ni√±os/as 8-15 a√±os que usa aparatos electr√≥nicos 2+ horas/d√≠a (CONTEXTO)",
                            "Indicador 1.6.3.b - Disminuci√≥n del porcentaje de ni√±os/as 8-15 a√±os que usa aparatos electr√≥nicos 2+ horas/d√≠a (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Red de Acci√≥n Local en Salud',
                                actuaciones: [
                                    'Talleres para familias sobre uso saludable de pantallas',
                                    'Actividades de ocio alternativo sin pantallas',
                                    'Espacios libres de tecnolog√≠a en centros comunitarios',
                                    'Campa√±as de concienciaci√≥n sobre uso responsable de tecnolog√≠a'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoci√≥n en centros sanitarios',
                                actuaciones: [
                                    'Valoraci√≥n del tiempo de uso de pantallas en consultas',
                                    'Consejo sanitario sobre uso saludable de tecnolog√≠a',
                                    'Intervenci√≥n en uso problem√°tico de pantallas',
                                    'Programa Forma Joven: uso saludable de tecnolog√≠a'
                                ]
                            },
                            {
                                codigo: 'P06',
                                nombre: 'Promoci√≥n en centros educativos',
                                actuaciones: [
                                    'Programa Creciendo en Salud: uso responsable de tecnolog√≠a',
                                    'Normas sobre uso de dispositivos en centros educativos',
                                    'Educaci√≥n digital y prevenci√≥n de adicciones tecnol√≥gicas',
                                    'Recreos sin pantallas',
                                    'Formaci√≥n a familias sobre control parental'
                                ]
                            },
                            {
                                codigo: 'P08',
                                nombre: 'Promoci√≥n en centros de servicios sociales',
                                actuaciones: [
                                    'Talleres de ocio alternativo para mayores',
                                    'Uso responsable de tecnolog√≠a en residencias',
                                    'Actividades sin pantallas en centros de d√≠a'
                                ]
                            },
                            {
                                codigo: 'P12',
                                nombre: 'Promoci√≥n en el Lugar de Trabajo',
                                actuaciones: [
                                    'Medidas de desconexi√≥n digital laboral',
                                    'Formaci√≥n en uso saludable de tecnolog√≠a en el trabajo',
                                    'Pausas sin pantallas durante la jornada laboral'
                                ]
                            }
                        ]
                    },
                    {
                        id: "1.7",
                        codigo: "OE 1.7",
                        nombre: "Incrementar las recomendaciones sobre activos comunitarios para la salud",
                        indicadores: [
                            "Indicador 1.7.1.a - N√∫mero de recomendaciones sobre activos comunitarios desde el SSPA (CONTEXTO)",
                            "Indicador 1.7.1.b - Aumento anual del n√∫mero de recomendaciones sobre activos comunitarios desde el SSPA (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P01',
                                nombre: 'Red de Acci√≥n Local en Salud',
                                actuaciones: [
                                    'Identificaci√≥n de activos comunitarios locales',
                                    'Gu√≠a de activos para la salud del municipio',
                                    'Difusi√≥n de activos comunitarios disponibles',
                                    'Coordinaci√≥n entre activos y servicios sanitarios'
                                ]
                            },
                            {
                                codigo: 'P03',
                                nombre: 'Promoci√≥n en centros sanitarios',
                                actuaciones: [
                                    'Formaci√≥n de profesionales en prescripci√≥n social',
                                    'Sistema de registro de recomendaciones a activos',
                                    'Cat√°logo de activos disponible en atenci√≥n primaria',
                                    'Coordinaci√≥n entre atenci√≥n primaria y activos locales'
                                ]
                            },
                            {
                                codigo: 'P04',
                                nombre: 'Identificaci√≥n y dinamizaci√≥n de activos',
                                actuaciones: [
                                    'Mapeo sistem√°tico de activos para la salud',
                                    'Base de datos de activos comunitarios',
                                    'Plataforma digital de activos para la salud',
                                    'Formaci√≥n de activos en salud comunitaria',
                                    'Coordinaci√≥n intersectorial de activos'
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                id: 2,
                codigo: "LE 2",
                nombre: "Fomento de responsabilidad social ante la salud por parte del sector empresarial",
                color: "#10b981",
                objetivos: [
                    {
                        id: "2.1",
                        codigo: "OE 2.1",
                        nombre: "Incrementar el n√∫mero de empresas que favorezcan h√°bitos saludables y consumo sostenible",
                        indicadores: [
                            "Indicador 2.1.1.a - N√∫mero de empresas andaluzas que favorecen h√°bitos saludables y consumo sostenible (CONTEXTO)",
                            "Indicador 2.1.1.b - Aumento anual del n√∫mero de empresas andaluzas que favorecen h√°bitos saludables (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P13',
                                nombre: 'Establecimiento de alianzas con operadores econ√≥micos',
                                actuaciones: [
                                    'Convenios con empresas de alimentaci√≥n para promoci√≥n de productos saludables',
                                    'Acuerdos con sector de restauraci√≥n para oferta saludable',
                                    'Colaboraci√≥n con empresas de deporte y ocio activo',
                                    'Certificaci√≥n de empresas responsables con la salud',
                                    'Incentivos fiscales para empresas que promuevan salud',
                                    'Red de empresas comprometidas con h√°bitos saludables',
                                    'Eliminaci√≥n de publicidad de productos no saludables en espacios p√∫blicos'
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                id: 3,
                codigo: "LE 3",
                nombre: "Difusi√≥n y comunicaci√≥n de informaci√≥n veraz sobre vida saludable",
                color: "#f59e0b",
                objetivos: [
                    {
                        id: "3.1",
                        codigo: "OE 3.1",
                        nombre: "Incrementar la difusi√≥n de informaci√≥n sobre h√°bitos saludables",
                        indicadores: [
                            "Indicador 3.1.1.a - N√∫mero de visitas al portal 'Mi Gu√≠a de Salud' (CONTEXTO)",
                            "Indicador 3.1.1.b - Aumento anual del n√∫mero de visitas al portal 'Mi Gu√≠a de Salud' (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P14',
                                nombre: 'Difusi√≥n de informaci√≥n veraz sobre h√°bitos saludables',
                                actuaciones: [
                                    'Portal web "Mi Gu√≠a de Salud" con informaci√≥n basada en evidencia',
                                    'Campa√±as de comunicaci√≥n en medios sobre h√°bitos saludables',
                                    'Redes sociales institucionales con contenido de salud',
                                    'Material divulgativo impreso y digital',
                                    'Participaci√≥n en ferias y eventos de salud',
                                    'Colaboraci√≥n con medios de comunicaci√≥n para informaci√≥n veraz',
                                    'Formaci√≥n de periodistas en informaci√≥n de salud',
                                    'Actuaciones contra publicidad enga√±osa de productos no saludables',
                                    'Protecci√≥n frente a influencers que promocionen productos no saludables',
                                    'Regulaci√≥n de publicidad de alimentos y bebidas no saludables dirigida a menores'
                                ]
                            }
                        ]
                    }
                ]
            },
            {
                id: 4,
                codigo: "LE 4",
                nombre: "Impulso a la gesti√≥n del conocimiento, investigaci√≥n e innovaci√≥n en promoci√≥n de salud",
                color: "#ef4444",
                objetivos: [
                    {
                        id: "4.1",
                        codigo: "OE 4.1",
                        nombre: "Incrementar la formaci√≥n y la investigaci√≥n en promoci√≥n de h√°bitos saludables",
                        indicadores: [
                            "Indicador 4.1.1.a - N√∫mero de profesionales en actividades formativas sobre h√°bitos saludables (CONTEXTO)",
                            "Indicador 4.1.1.b - Aumento anual del n√∫mero de profesionales en actividades formativas (IMPACTO)",
                            "Indicador 4.1.2.a - N√∫mero de proyectos de investigaci√≥n financiados sobre h√°bitos saludables (CONTEXTO)",
                            "Indicador 4.1.2.b - Aumento anual del n√∫mero de proyectos de investigaci√≥n financiados (IMPACTO)"
                        ],
                        programas: [
                            {
                                codigo: 'P15',
                                nombre: 'Fomento de la formaci√≥n, investigaci√≥n e innovaci√≥n',
                                actuaciones: [
                                    'Cursos de formaci√≥n para profesionales sanitarios en promoci√≥n de salud',
                                    'Formaci√≥n en prescripci√≥n social y uso de activos',
                                    'Formaci√≥n para profesionales de educaci√≥n en promoci√≥n de salud',
                                    'Formaci√≥n para profesionales de servicios sociales',
                                    'Jornadas y congresos sobre promoci√≥n de h√°bitos saludables',
                                    'L√≠neas de investigaci√≥n en determinantes sociales de la salud',
                                    'Proyectos de investigaci√≥n en intervenciones comunitarias',
                                    'Estudios sobre efectividad de programas de promoci√≥n de salud',
                                    'Observatorio de h√°bitos saludables en Andaluc√≠a',
                                    'Encuestas poblacionales sobre estilos de vida',
                                    'Evaluaci√≥n de impacto de pol√≠ticas de salud p√∫blica',
                                    'Innovaci√≥n en metodolog√≠as de intervenci√≥n comunitaria'
                                ]
                            }
                        ]
                    }
                ]
            }
        ];

        // DATOS DEL CUADRO DE MANDOS INTEGRAL (58 INDICADORES)
        const INDICADORES_CMI = [
            // Poblaci√≥n
            { numero: 1, indicador: "Poblaci√≥n total", unidad: "N√∫mero", dato: "9.536", fuente: "IECA (2024)", categoria: "Poblaci√≥n" },
            { numero: 2, indicador: "Poblaci√≥n mayor de 65", unidad: "%", dato: "17,5", fuente: "IECA (2024)", categoria: "Poblaci√≥n" },
            { numero: 3, indicador: "Poblaci√≥n menor de 20", unidad: "%", dato: "20,1", fuente: "IECA (2024)", categoria: "Poblaci√≥n" },
            { numero: 4, indicador: "√çndice de envejecimiento", unidad: "%", dato: "104,3", fuente: "IECA (2022)", categoria: "Poblaci√≥n" },
            
            // G√©nero
            { numero: 5, indicador: "Partes remitidos a los juzgados de violencia de g√©nero", unidad: "N√∫mero", dato: "5", fuente: "HERMES (2024)", categoria: "G√©nero" },
            { numero: 6, indicador: "Interrupci√≥n voluntaria del embarazo", unidad: "N√∫mero", dato: "‚Äî", fuente: "UE (2025)", categoria: "G√©nero" },
            
            // Mortalidad
            { numero: 7, indicador: "Mortalidad cardiovascular", unidad: "%", dato: "35", fuente: "IECA (2022)", categoria: "Mortalidad" },
            { numero: 8, indicador: "Mortalidad tumoral", unidad: "%", dato: "19", fuente: "IECA (2022)", categoria: "Mortalidad" },
            { numero: 9, indicador: "Mortalidad respiratoria", unidad: "%", dato: "6", fuente: "IECA (2022)", categoria: "Mortalidad" },
            { numero: 10, indicador: "Mortalidad infecciosa", unidad: "%", dato: "10", fuente: "IECA (2022)", categoria: "Mortalidad" },
            { numero: 11, indicador: "Mortalidad sistema nervioso y √≥rganos sentidos", unidad: "%", dato: "3", fuente: "IECA (2022)", categoria: "Mortalidad" },
            
            // Morbilidad
            { numero: 12, indicador: "Dislipemia", unidad: "Casos", dato: "3.551", fuente: "BPS (2023)", categoria: "Morbilidad" },
            { numero: 13, indicador: "Artrosis/Espondiloartrosis", unidad: "Casos", dato: "801", fuente: "BPS (2023)", categoria: "Morbilidad" },
            { numero: 14, indicador: "HTA", unidad: "Casos", dato: "945", fuente: "BPS (2023)", categoria: "Morbilidad" },
            { numero: 15, indicador: "Trastornos de ansiedad", unidad: "Casos", dato: "416", fuente: "BPS (2023)", categoria: "Morbilidad" },
            { numero: 16, indicador: "Asma", unidad: "Casos", dato: "547", fuente: "BPS (2023)", categoria: "Morbilidad" },
            { numero: 17, indicador: "Hipotiroidismo", unidad: "Casos", dato: "121", fuente: "BPS (2023)", categoria: "Morbilidad" },
            
            // C√°ncer Hombres
            { numero: 18, indicador: "C√°ncer piel no melanoma (H)", unidad: "Casos", dato: "184", fuente: "Reg. c√°ncer", categoria: "C√°ncer Hombres" },
            { numero: 19, indicador: "C√°ncer pr√≥stata", unidad: "Casos", dato: "151", fuente: "Reg. c√°ncer", categoria: "C√°ncer Hombres" },
            { numero: 20, indicador: "C√°ncer colon-recto (H)", unidad: "Casos", dato: "61", fuente: "Reg. c√°ncer", categoria: "C√°ncer Hombres" },
            { numero: 21, indicador: "C√°ncer vejiga (H)", unidad: "Casos", dato: "44", fuente: "Reg. c√°ncer", categoria: "C√°ncer Hombres" },
            { numero: 22, indicador: "C√°ncer pulm√≥n, tr√°quea, bronquios (H)", unidad: "Casos", dato: "40", fuente: "Reg. c√°ncer", categoria: "C√°ncer Hombres" },
            
            // C√°ncer Mujeres
            { numero: 23, indicador: "C√°ncer piel no melanoma (M)", unidad: "Casos", dato: "143", fuente: "Reg. c√°ncer", categoria: "C√°ncer Mujeres" },
            { numero: 24, indicador: "C√°ncer mama", unidad: "Casos", dato: "118", fuente: "Reg. c√°ncer", categoria: "C√°ncer Mujeres" },
            { numero: 25, indicador: "C√°ncer cuerpo uterino", unidad: "Casos", dato: "50", fuente: "Reg. c√°ncer", categoria: "C√°ncer Mujeres" },
            { numero: 26, indicador: "C√°ncer colon-recto (M)", unidad: "Casos", dato: "39", fuente: "Reg. c√°ncer", categoria: "C√°ncer Mujeres" },
            { numero: 27, indicador: "C√°ncer vejiga (M)", unidad: "Casos", dato: "17", fuente: "Reg. c√°ncer", categoria: "C√°ncer Mujeres" },
            
            // Programas
            { numero: 28, indicador: "Vacunaci√≥n infantil captaci√≥n (1 a√±o antes)", unidad: "%", dato: "98,8", fuente: "INFOWEB (2023)", categoria: "Programas" },
            { numero: 29, indicador: "Vacunaci√≥n infantil captaci√≥n (2 a√±os antes)", unidad: "%", dato: "100", fuente: "INFOWEB (2023)", categoria: "Programas" },
            { numero: 30, indicador: "Vacunaci√≥n infantil captaci√≥n (4 a√±os antes)", unidad: "%", dato: "98,87", fuente: "INFOWEB (2021)", categoria: "Programas" },
            { numero: 31, indicador: "Cribado c√°ncer colon-recto (% participaci√≥n invitadas)", unidad: "%", dato: "39,8", fuente: "INFOWEB (2024)", categoria: "Programas" },
            { numero: 32, indicador: "Cribado c√°ncer colon-recto (% participaci√≥n aceptaci√≥n)", unidad: "%", dato: "‚Äî", fuente: "INFOWEB (2023)", categoria: "Programas" },
            { numero: 33, indicador: "Cribado c√°ncer mama (% participaci√≥n invitadas)", unidad: "%", dato: "37,5", fuente: "INFOWEB (2023)", categoria: "Programas" },
            { numero: 34, indicador: "Cribado c√°ncer mama (% participaci√≥n aceptaci√≥n)", unidad: "%", dato: "‚Äî", fuente: "INFOWEB (2023)", categoria: "Programas" },
            { numero: 35, indicador: "Cribado c√°ncer c√©rvix (% participaci√≥n invitadas)", unidad: "%", dato: "‚Äî", fuente: "INFOWEB (2023)", categoria: "Programas" },
            { numero: 36, indicador: "Cribado c√°ncer c√©rvix (% participaci√≥n aceptaci√≥n)", unidad: "%", dato: "‚Äî", fuente: "INFOWEB (2023)", categoria: "Programas" },
            
            // H√°bitos
            { numero: 37, indicador: "Personas valoradas en dieta", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 38, indicador: "Personas valoradas en dieta con baja adhesi√≥n", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 39, indicador: "Personas valoradas en actividad f√≠sica (15-64 a√±os)", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 40, indicador: "Personas valoradas en actividad f√≠sica con sedentarismo (15-64 a√±os)", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 41, indicador: "Personas valoradas en actividad f√≠sica inactivas (15-64 a√±os)", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 42, indicador: "Personas valoradas en actividad f√≠sica con sedentarismo (65+ a√±os)", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 43, indicador: "Personas valoradas en actividad f√≠sica inactivas (65+ a√±os)", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 44, indicador: "Personas valoradas en consumo de alcohol", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 45, indicador: "Personas valoradas en alcohol posible alto riesgo", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 46, indicador: "Personas valoradas en alcohol alto riesgo", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 47, indicador: "Intervenci√≥n avanzada individual en h√°bitos", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 48, indicador: "Intervenci√≥n avanzada grupal en h√°bitos", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 49, indicador: "Personas con registros en formulario IAHS", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 50, indicador: "Personas con al menos una visita IAHS individual", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 51, indicador: "Personas con al menos una sesi√≥n IAHS grupal", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 52, indicador: "Personas derivadas a UAEF", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 53, indicador: "Personas a las que se recomienda activo para salud", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 54, indicador: "PITA: intervenciones individuales", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 55, indicador: "PITA: intervenciones grupales", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 56, indicador: "PITA: intervenciones con poblaci√≥n fumadora", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 57, indicador: "PITA: intervenciones con poblaci√≥n ex-fumadora", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" },
            { numero: 58, indicador: "PITA: intervenciones con poblaci√≥n no fumadora", unidad: "N√∫mero", dato: "‚Äî", fuente: "INFOWEB (2024)", categoria: "H√°bitos" }
        ];

        const CONCLUSIONES = [
            {
                numero: '01',
                titulo: 'Trastornos de ansiedad y malestar emocional',
                texto: 'Los trastornos de ansiedad aparecen tanto en hombres como en mujeres entre las causas de morbilidad m√°s frecuentes. Las adicciones y el malestar emocional destacan tambi√©n entre las principales preocupaciones ciudadanas.'
            },
            {
                numero: '02',
                titulo: 'Oportunidad de la Estrategia',
                texto: 'La Estrategia es una oportunidad para incorporarse a una herramienta de planificaci√≥n validada, a trav√©s de una selecci√≥n de sus l√≠neas estrat√©gicas, objetivos e indicadores de contexto e impacto.'
            },
            {
                numero: '03',
                titulo: 'Enfoque de Salud comunitaria basada en activos',
                texto: 'El enfoque de Salud comunitaria basada en activos se considera el m√°s adecuado para orientar el Plan Local de Salud. Son principios transversales de la acci√≥n local en salud la intersectorialidad, la participaci√≥n ciudadana y la reducci√≥n de las inequidades y desigualdades sociales en materia de salud.'
            },
            {
                numero: '04',
                titulo: 'Necesidad de datos locales mediante encuesta',
                texto: 'La planificaci√≥n requiere de datos que con frecuencia no est√°n disponibles para el nivel municipal. Pero es posible producirlos mediante encuesta local. Dadas las limitaciones metodol√≥gicas, los resultados de la encuesta no son un reflejo estad√≠stico de la realidad, pero resultan de ayuda en el momento de priorizar.'
            }
        ];

        const RECOMENDACIONES = [
            {
                numero: '01',
                titulo: 'Bienestar Emocional como eje central articulador',
                texto: 'Establecer el Bienestar Emocional como eje central articulador del Plan Local de Salud.'
            },
            {
                numero: '02',
                titulo: 'Acompasar el dise√±o y evaluaci√≥n del II Plan a la Estrategia',
                texto: 'Acompasar el dise√±o y la evaluaci√≥n del Plan Local de Salud a la Estrategia, articulando sectores, actores, medidas, programas y actuaciones en los distintos entornos potencialmente salutog√©nicos del espacio local: el centro de salud; los centros educativos; el lugar de trabajo y el espacio social y comunitario.'
            },
            {
                numero: '03',
                titulo: 'Vigilancia de h√°bitos, mapeo de activos y recomendaci√≥n social',
                texto: 'Promover la vigilancia de los h√°bitos a trav√©s de la Encuesta local de salud; dinamizar el Mapeo continuo de activos para la salud en el espacio comunitario, y favorecer la Recomendaci√≥n social de esos activos, a trav√©s de Campa√±as de comunicaci√≥n y de Generaci√≥n de contenido para redes sociales.'
            },
            {
                numero: '04',
                titulo: 'Realizar Encuesta local de salud',
                texto: 'Realizar, durante el periodo de ejecuci√≥n del Plan Local de Salud, una Encuesta local de salud, incluyendo en ella preguntas sobre autopercepci√≥n de salud y h√°bitos saludables de la EAS_2024, con objeto de facilitar la comparaci√≥n de datos y la evaluabilidad del Plan.'
            }
        ];

        // ENTORNOS Y A√ëOS PARA AGENDAS
        const ENTORNOS = [
            { id: 'sanitario', nombre: 'Sanitario', icono: 'üè•' },
            { id: 'comunitario', nombre: 'Comunitario', icono: 'üèòÔ∏è' },
            { id: 'educativo', nombre: 'Educativo', icono: 'üéì' },
            { id: 'laboral', nombre: 'Laboral', icono: 'üíº' }
        ];

        const ANOS = [2024, 2025, 2026, 2027, 2028, 2029, 2030];

        // MEJORA 3: Mapeo de sugerencias seg√∫n √°rea prioritaria
        const SUGERENCIAS_POR_AREA = {
            'bienestar emocional': [
                { objetivo: '1.4', linea: 1, descripcion: 'OE 1.4: Incrementar la percepci√≥n de calidad de vida y de bienestar emocional' },
                { objetivo: '1.3', linea: 1, descripcion: 'OE 1.3: Incrementar las horas y la calidad del sue√±o (relacionado con bienestar)' },
                { objetivo: '1.7', linea: 1, descripcion: 'OE 1.7: Incrementar las recomendaciones sobre activos comunitarios' },
                { objetivo: '3.1', linea: 3, descripcion: 'OE 3.1: Incrementar la difusi√≥n de informaci√≥n sobre h√°bitos saludables' }
            ],
            'alimentaci√≥n saludable': [
                { objetivo: '1.1', linea: 1, descripcion: 'OE 1.1: Incrementar lactancia materna y consumo de alimentos saludables' },
                { objetivo: '2.1', linea: 2, descripcion: 'OE 2.1: Empresas que favorezcan h√°bitos saludables y consumo sostenible' },
                { objetivo: '3.1', linea: 3, descripcion: 'OE 3.1: Difusi√≥n de informaci√≥n veraz sobre alimentaci√≥n' }
            ],
            'actividad f√≠sica': [
                { objetivo: '1.2', linea: 1, descripcion: 'OE 1.2: Aumentar niveles de actividad f√≠sica y disminuir sedentarismo' },
                { objetivo: '1.7', linea: 1, descripcion: 'OE 1.7: Incrementar recomendaciones sobre activos comunitarios' },
                { objetivo: '3.1', linea: 3, descripcion: 'OE 3.1: Difusi√≥n de informaci√≥n sobre actividad f√≠sica' }
            ],
            'sue√±o': [
                { objetivo: '1.3', linea: 1, descripcion: 'OE 1.3: Incrementar horas y calidad del sue√±o' },
                { objetivo: '1.6', linea: 1, descripcion: 'OE 1.6: Disminuir tiempo de uso de aparatos electr√≥nicos' },
                { objetivo: '3.1', linea: 3, descripcion: 'OE 3.1: Difusi√≥n de informaci√≥n sobre higiene del sue√±o' }
            ],
            'default': [
                { objetivo: '1.4', linea: 1, descripcion: 'OE 1.4: Incrementar la percepci√≥n de calidad de vida y de bienestar emocional' },
                { objetivo: '1.7', linea: 1, descripcion: 'OE 1.7: Incrementar las recomendaciones sobre activos comunitarios' },
                { objetivo: '3.1', linea: 3, descripcion: 'OE 3.1: Incrementar la difusi√≥n de informaci√≥n sobre h√°bitos saludables' }
            ]
        };

        // Estado de la aplicaci√≥n
        // ============================================
        // SISTEMA DE LOGIN Y AUTENTICACI√ìN
        // ============================================
        
        // Usuario actual (se establece despu√©s del login)
        let usuarioActual = {
            tipo: null, // 'admin' o 'municipio'
            nombre: null,
            esAdmin: false
        };
        
        // Funci√≥n principal de login
        function intentarLogin(event) {
            event.preventDefault();
            
            const usuario = document.getElementById('loginUsuario').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            console.log('üîê Intento de login:', {usuario, password: '***'});
            
            // Verificar si es admin
            if (usuario === 'admin' && password === 'admin') {
                console.log('‚úÖ Login admin correcto');
                loginExitoso('admin', 'Administrador', true);
                return;
            }
            
            console.log('‚ùå No es admin, verificando municipios...');
            
            // Verificar si es un municipio con contrase√±a v√°lida
            const passwordsMunicipios = JSON.parse(localStorage.getItem('planificadorEPVSA_passwords_municipios') || '{}');
            console.log('üìã Contrase√±as municipios:', passwordsMunicipios);
            
            if (passwordsMunicipios[usuario] === password) {
                console.log('‚úÖ Login municipio correcto:', usuario);
                loginExitoso('municipio', usuario, false);
                return;
            }
            
            console.log('‚ùå Login fallido');
            // Login fallido
            mostrarErrorLogin('Usuario o contrase√±a incorrectos.\n\nMunicipios: Si no tienes contrase√±a, solic√≠tala al coordinador RELAS.');
        }
        
        function loginExitoso(tipo, nombre, esAdmin) {
            console.log('‚úÖ Login exitoso:', {tipo, nombre, esAdmin});
            
            usuarioActual = {
                tipo: tipo,
                nombre: nombre,
                esAdmin: esAdmin
            };
            
            // Guardar sesi√≥n
            sessionStorage.setItem('planificadorEPVSA_sesion', JSON.stringify(usuarioActual));
            console.log('üíæ Sesi√≥n guardada:', usuarioActual);
            
            // Ocultar modal de login
            document.getElementById('loginModal').classList.remove('active');
            console.log('üö™ Modal de login cerrado');
            
            // Mostrar aplicaci√≥n
            document.getElementById('appContainer').style.display = 'block';
            console.log('üì± Aplicaci√≥n mostrada');
            
            // Si es municipio, auto-rellenar nombre
            if (tipo === 'municipio') {
                state.municipio.nombre = nombre;
                document.getElementById('nombreMunicipio').value = nombre;
                document.getElementById('nombreMunicipio').disabled = true; // No puede cambiarlo
                console.log('üèõÔ∏è Nombre municipio auto-rellenado:', nombre);
            }
            
            // Ocultar bot√≥n de admin si no es admin
            if (!esAdmin) {
                const botonAdmin = document.querySelector('[onclick="verificarAccesoAdmin()"]');
                if (botonAdmin) {
                    botonAdmin.parentElement.style.display = 'none';
                    console.log('üîí Bot√≥n admin ocultado');
                }
            } else {
                console.log('üëë Usuario es admin, bot√≥n visible');
            }
            
            // Cargar borrador si existe
            setTimeout(() => {
                cargarBorradorSiExiste();
            }, 500);
            
            // Mensaje de bienvenida
            const mensajeBienvenida = esAdmin 
                ? 'üëã Bienvenido, Administrador\n\n‚úÖ Acceso completo al sistema'
                : `üëã Bienvenido, ${nombre}\n\n‚úÖ Puedes trabajar en el plan local de salud de tu municipio`;
            
            setTimeout(() => {
                alert(mensajeBienvenida);
            }, 300);
        }
        
        function mostrarErrorLogin(mensaje) {
            const errorDiv = document.getElementById('loginError');
            const errorMsg = document.getElementById('loginErrorMsg');
            errorMsg.textContent = mensaje;
            errorDiv.style.display = 'block';
            
            // Limpiar contrase√±a
            document.getElementById('loginPassword').value = '';
        }
        
        function cerrarSesion() {
            if (confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
                sessionStorage.removeItem('planificadorEPVSA_sesion');
                location.reload();
            }
        }
        
        // Verificar sesi√≥n al cargar
        function verificarSesionExistente() {
            const sesionGuardada = sessionStorage.getItem('planificadorEPVSA_sesion');
            if (sesionGuardada) {
                const sesion = JSON.parse(sesionGuardada);
                usuarioActual = sesion;
                
                // Ocultar login y mostrar app
                document.getElementById('loginModal').classList.remove('active');
                document.getElementById('appContainer').style.display = 'block';
                
                // Si es municipio, auto-rellenar
                if (sesion.tipo === 'municipio') {
                    state.municipio.nombre = sesion.nombre;
                    setTimeout(() => {
                        document.getElementById('nombreMunicipio').value = sesion.nombre;
                        document.getElementById('nombreMunicipio').disabled = true;
                    }, 100);
                }
                
                // Ocultar bot√≥n admin si no es admin
                if (!sesion.esAdmin) {
                    setTimeout(() => {
                        const botonAdmin = document.querySelector('[onclick="verificarAccesoAdmin()"]');
                        if (botonAdmin) {
                            botonAdmin.parentElement.style.display = 'none';
                        }
                    }, 100);
                }
                
                return true;
            }
            return false;
        }

        const state = {
            municipio: {
                nombre: '',
                provincia: '',
                poblacion: null
            },
            equipo: {
                coordinador: '',
                tecnicoSalud: '',
                representanteMunicipal: '',
                otrosMiembros: ''
            },
            perfilCargado: false,
            indicadoresExtraidos: [],
            areaPrioritaria: 'Bienestar Emocional',
            sesionGrupoMotor: 'Febrero de 2025',
            lineasEstrategicas: [],
            programasSeleccionados: [],
            actuaciones: {},
            currentEntorno: 'sanitario',
            currentYear: 2024,
            planGenerado: null,
            sugerenciasAplicadas: false,
            pdfData: null,
            pdfNumPages: 0,
            // Sistema multianual de cuadros de mandos
            cuadrosMandosAnuales: {
                2024: JSON.parse(JSON.stringify(INDICADORES_CMI)) // Copia profunda con datos 2024
            },
            anoActivoCuadro: 2024
        };


        // MEJORA 6: Funciones de localStorage
        function guardarBorrador() {
            const borrador = {
                state: state,
                fecha: new Date().toISOString(),
                version: '2.0'
            };
            
            try {
                localStorage.setItem('planificadorEPVSA_borrador', JSON.stringify(borrador));
                alert('‚úÖ Borrador guardado correctamente\n\nPuedes cerrar y recuperar tu trabajo m√°s tarde.');
            } catch (e) {
                alert('‚ö†Ô∏è Error al guardar el borrador. Es posible que el navegador no permita almacenamiento local.');
            }
        }

        function cargarBorradorSiExiste() {
            try {
                // Primero intentar cargar el municipio actual si existe
                const municipioId = generarIdMunicipio();
                let borradorStr = localStorage.getItem(`planificadorEPVSA_${municipioId}`);
                
                // Si no existe para este municipio, buscar el borrador antiguo
                if (!borradorStr) {
                    borradorStr = localStorage.getItem('planificadorEPVSA_borrador');
                }
                
                if (borradorStr) {
                    const borrador = JSON.parse(borradorStr);
                    
                    // Mostrar modal de recuperaci√≥n
                    const fecha = new Date(borrador.fechaGuardado || borrador.fecha).toLocaleString('es-ES');
                    const nombreMunicipio = borrador.nombreMunicipio || 'Municipio';
                    document.getElementById('borradorFecha').textContent = `${nombreMunicipio} - Guardado el: ${fecha}`;
                    document.getElementById('borradorModal').classList.add('active');
                    
                    return true;
                }
            } catch (e) {
                console.error('Error al cargar borrador:', e);
            }
            return false;
        }

        function recuperarBorrador() {
            try {
                const municipioId = generarIdMunicipio();
                let borradorStr = localStorage.getItem(`planificadorEPVSA_${municipioId}`);
                
                if (!borradorStr) {
                    borradorStr = localStorage.getItem('planificadorEPVSA_borrador');
                }
                
                if (borradorStr) {
                    const borrador = JSON.parse(borradorStr);
                    
                    // Restaurar estado
                    Object.assign(state, borrador.state);
                    
                    // Asegurar que cuadrosMandosAnuales existe
                    if (!state.cuadrosMandosAnuales) {
                        state.cuadrosMandosAnuales = {
                            2024: JSON.parse(JSON.stringify(INDICADORES_CMI))
                        };
                    }
                    if (!state.anoActivoCuadro) {
                        state.anoActivoCuadro = 2024;
                    }
                    
                    // Actualizar UI
                    document.getElementById('nombreMunicipio').value = state.municipio.nombre || '';
                    document.getElementById('provinciaMunicipio').value = state.municipio.provincia || '';
                    document.getElementById('poblacionMunicipio').value = state.municipio.poblacion || '';
                    
                    document.getElementById('coordinador').value = state.equipo.coordinador || '';
                    document.getElementById('tecnicoSalud').value = state.equipo.tecnicoSalud || '';
                    document.getElementById('representanteMunicipal').value = state.equipo.representanteMunicipal || '';
                    document.getElementById('otrosMiembros').value = state.equipo.otrosMiembros || '';
                    
                    if (state.perfilCargado) {
                        document.getElementById('uploadZone').style.display = 'none';
                        document.getElementById('analisisResultados').style.display = 'block';
                        renderConclusionesResumen();
                        renderRecomendacionesResumen();
                    }
                    
                    actualizarEstadisticas();
                    
                    document.getElementById('borradorModal').classList.remove('active');
                    
                    alert('‚úÖ Borrador recuperado correctamente\n\n¬°Puedes continuar donde lo dejaste!');
                }
            } catch (e) {
                alert('‚ùå Error al recuperar el borrador');
                console.error(e);
            }
        }

        function empezarDeCero() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres empezar de cero?\n\nSe eliminar√° el trabajo guardado para este municipio.')) {
                const municipioId = generarIdMunicipio();
                localStorage.removeItem(`planificadorEPVSA_${municipioId}`);
                localStorage.removeItem('planificadorEPVSA_borrador'); // Limpiar tambi√©n el antiguo
                document.getElementById('borradorModal').classList.remove('active');
            }
        }

        // ============================================
        // SISTEMA MULTI-MUNICIPIO
        // ============================================
        
        function generarIdMunicipio() {
            const nombre = state.municipio.nombre || 'sin-nombre';
            const pdfHash = state.pdfData ? simpleHash(state.pdfData) : 'sin-pdf';
            return `municipio_${nombre.toLowerCase().replace(/\s+/g, '-')}_${pdfHash}`;
        }
        
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < Math.min(str.length, 1000); i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36).substring(0, 8);
        }
        
        function guardarEstado() {
            try {
                const municipioId = generarIdMunicipio();
                const borrador = {
                    fechaGuardado: new Date().toISOString(),
                    municipioId: municipioId,
                    nombreMunicipio: state.municipio.nombre,
                    state: state
                };
                
                // Guardar con ID espec√≠fico del municipio
                localStorage.setItem(`planificadorEPVSA_${municipioId}`, JSON.stringify(borrador));
                
                // Mantener lista de municipios (solo para administrador)
                const listaMunicipios = JSON.parse(localStorage.getItem('planificadorEPVSA_lista_municipios') || '[]');
                if (!listaMunicipios.includes(municipioId)) {
                    listaMunicipios.push(municipioId);
                    localStorage.setItem('planificadorEPVSA_lista_municipios', JSON.stringify(listaMunicipios));
                }
                
                console.log('üíæ Estado guardado para:', municipioId);
            } catch (e) {
                console.error('Error al guardar estado:', e);
            }
        }

        // ============================================
        // PANEL DE ADMINISTRACI√ìN
        // ============================================
        
        function verificarAccesoAdmin() {
            // Verificar que el usuario actual sea admin
            if (!usuarioActual.esAdmin) {
                alert('‚ùå Acceso denegado\n\nEsta funci√≥n es solo para administradores.');
                return;
            }
            
            mostrarMenuMaestro();
        }
        
        function mostrarMenuMaestro() {
            const opciones = 
                'üîê MEN√ö DE ADMINISTRACI√ìN\n\n' +
                '1Ô∏è‚É£ Ver Panel de Municipios\n' +
                '2Ô∏è‚É£ Gestionar Contrase√±as de Municipios\n' +
                '3Ô∏è‚É£ Cerrar Sesi√≥n\n\n' +
                'Selecciona una opci√≥n (1-3):';
            
            const opcion = prompt(opciones);
            
            switch(opcion) {
                case '1':
                    abrirAdminPanel();
                    break;
                case '2':
                    gestionarPasswordsMunicipios();
                    break;
                case '3':
                    cerrarSesion();
                    break;
                default:
                    return;
            }
        }
        
        function gestionarPasswordsMunicipios() {
            const passwords = JSON.parse(localStorage.getItem('planificadorEPVSA_passwords_municipios') || '{}');
            const municipios = Object.keys(passwords);
            
            const menu = 
                'üîë GESTI√ìN DE CONTRASE√ëAS MUNICIPIOS\n\n' +
                `Municipios registrados: ${municipios.length}\n` +
                (municipios.length > 0 ? `\nüìã Lista:\n${municipios.map((m, i) => `${i+1}. ${m}`).join('\n')}\n` : '') +
                '\n' +
                '1Ô∏è‚É£ Crear/Actualizar contrase√±a de municipio\n' +
                '2Ô∏è‚É£ Eliminar contrase√±a de municipio\n' +
                '3Ô∏è‚É£ Ver todas las contrase√±as\n' +
                '4Ô∏è‚É£ Volver\n\n' +
                'Selecciona (1-4):';
            
            const opcion = prompt(menu);
            
            switch(opcion) {
                case '1':
                    crearPasswordMunicipio();
                    break;
                case '2':
                    eliminarPasswordMunicipio();
                    break;
                case '3':
                    verPasswordsMunicipios();
                    break;
                default:
                    mostrarMenuMaestro();
                    return;
            }
        }
        
        function crearPasswordMunicipio() {
            const municipio = prompt('üèõÔ∏è Nombre del municipio:\n\n(Escribe el nombre exacto como aparecer√° en el login)');
            
            if (!municipio || municipio.trim() === '') {
                alert('‚ùå Operaci√≥n cancelada');
                gestionarPasswordsMunicipios();
                return;
            }
            
            const municipioNombre = municipio.trim();
            
            const password = prompt(`üîë Contrase√±a para "${municipioNombre}":\n\n(M√≠nimo 4 caracteres)`);
            
            if (!password || password.length < 4) {
                alert('‚ùå La contrase√±a debe tener al menos 4 caracteres');
                crearPasswordMunicipio();
                return;
            }
            
            // Guardar
            const passwords = JSON.parse(localStorage.getItem('planificadorEPVSA_passwords_municipios') || '{}');
            const esNuevo = !passwords[municipioNombre];
            passwords[municipioNombre] = password;
            localStorage.setItem('planificadorEPVSA_passwords_municipios', JSON.stringify(passwords));
            
            alert(
                `‚úÖ ${esNuevo ? 'Contrase√±a creada' : 'Contrase√±a actualizada'}\n\n` +
                `üèõÔ∏è Municipio: ${municipioNombre}\n` +
                `üîë Contrase√±a: ${password}\n\n` +
                `üí° Comparte estas credenciales con el municipio`
            );
            
            gestionarPasswordsMunicipios();
        }
        
        function eliminarPasswordMunicipio() {
            const passwords = JSON.parse(localStorage.getItem('planificadorEPVSA_passwords_municipios') || '{}');
            const municipios = Object.keys(passwords);
            
            if (municipios.length === 0) {
                alert('No hay contrase√±as para eliminar');
                gestionarPasswordsMunicipios();
                return;
            }
            
            const lista = municipios.map((m, i) => `${i+1}. ${m}`).join('\n');
            const indice = prompt(`üóëÔ∏è Eliminar contrase√±a\n\nMunicipios:\n${lista}\n\nIntroduce el n√∫mero del municipio:`);
            
            const idx = parseInt(indice) - 1;
            
            if (isNaN(idx) || idx < 0 || idx >= municipios.length) {
                alert('‚ùå N√∫mero inv√°lido');
                gestionarPasswordsMunicipios();
                return;
            }
            
            const municipio = municipios[idx];
            
            if (confirm(`¬øEliminar la contrase√±a de "${municipio}"?\n\nEste municipio perder√° el acceso.`)) {
                delete passwords[municipio];
                localStorage.setItem('planificadorEPVSA_passwords_municipios', JSON.stringify(passwords));
                alert(`‚úÖ Contrase√±a de "${municipio}" eliminada`);
            }
            
            gestionarPasswordsMunicipios();
        }
        
        function verPasswordsMunicipios() {
            const passwords = JSON.parse(localStorage.getItem('planificadorEPVSA_passwords_municipios') || '{}');
            const municipios = Object.keys(passwords);
            
            if (municipios.length === 0) {
                alert('üì≠ No hay contrase√±as creadas\n\nCrea contrase√±as para dar acceso a los municipios.');
            } else {
                const lista = municipios.map((m, i) => `${i+1}. ${m} ‚Üí ${passwords[m]}`).join('\n');
                alert(`üîë CONTRASE√ëAS DE MUNICIPIOS (${municipios.length}):\n\n${lista}\n\nüí° Comparte estas credenciales con cada municipio.`);
            }
            
            gestionarPasswordsMunicipios();
        }
        
        function abrirAdminPanel() {
            const listaMunicipios = JSON.parse(localStorage.getItem('planificadorEPVSA_lista_municipios') || '[]');
            const container = document.getElementById('municipiosContainer');
            
            if (listaMunicipios.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <span style="font-size: 1.5rem;">üì≠</span>
                        <div>
                            <strong>No hay planes guardados</strong><br>
                            A√∫n no se han creado planes municipales.
                        </div>
                    </div>
                `;
            } else {
                let html = '<div style="display: grid; gap: 1rem;">';
                
                listaMunicipios.forEach(municipioId => {
                    const borradorStr = localStorage.getItem(`planificadorEPVSA_${municipioId}`);
                    if (borradorStr) {
                        const borrador = JSON.parse(borradorStr);
                        const fecha = new Date(borrador.fechaGuardado).toLocaleString('es-ES');
                        const nombre = borrador.nombreMunicipio || 'Sin nombre';
                        const poblacion = borrador.state.municipio.poblacion || 'N/A';
                        const programas = borrador.state.programasSeleccionados.length;
                        const actuaciones = Object.values(borrador.state.actuaciones || {}).flat().length;
                        
                        html += `
                            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; cursor: pointer; transition: all 0.3s;"
                                 onclick="verDetallePlan('${municipioId}')"
                                 onmouseover="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)'"
                                 onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                                <h4 style="color: #1f2937; margin: 0 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem;">
                                    üèõÔ∏è ${nombre}
                                </h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-top: 1rem;">
                                    <div style="background: #f0f9ff; padding: 0.5rem; border-radius: 0.5rem;">
                                        <div style="font-size: 0.75rem; color: #0369a1;">Poblaci√≥n</div>
                                        <div style="font-weight: 700; color: #1e40af;">${poblacion}</div>
                                    </div>
                                    <div style="background: #f0fdf4; padding: 0.5rem; border-radius: 0.5rem;">
                                        <div style="font-size: 0.75rem; color: #065f46;">Programas</div>
                                        <div style="font-weight: 700; color: #047857;">${programas}</div>
                                    </div>
                                    <div style="background: #fef3c7; padding: 0.5rem; border-radius: 0.5rem;">
                                        <div style="font-size: 0.75rem; color: #92400e;">Actuaciones</div>
                                        <div style="font-weight: 700; color: #b45309;">${actuaciones}</div>
                                    </div>
                                </div>
                                <div style="margin-top: 0.75rem; font-size: 0.85rem; color: #6b7280;">
                                    üìÖ √öltima actualizaci√≥n: ${fecha}
                                </div>
                                <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #9ca3af; font-family: monospace;">
                                    ID: ${municipioId}
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += '</div>';
                container.innerHTML = html;
            }
            
            document.getElementById('adminModal').classList.add('active');
        }
        
        function verDetallePlan(municipioId) {
            const borradorStr = localStorage.getItem(`planificadorEPVSA_${municipioId}`);
            if (!borradorStr) return;
            
            const borrador = JSON.parse(borradorStr);
            const st = borrador.state;
            
            const container = document.getElementById('detallesPlanContainer');
            let html = `
                <div style="background: white; border: 2px solid #3b82f6; border-radius: 0.75rem; padding: 1.5rem;">
                    <h4 style="color: #1f2937; margin-bottom: 1rem;">üèõÔ∏è ${st.municipio.nombre}</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div>
                            <strong style="color: #6b7280;">Provincia:</strong><br>
                            ${st.municipio.provincia || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #6b7280;">Poblaci√≥n:</strong><br>
                            ${st.municipio.poblacion || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #6b7280;">√Årea Prioritaria:</strong><br>
                            ${st.areaPrioritaria || 'N/A'}
                        </div>
                    </div>
                    
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem;">
                        <strong style="color: #1f2937;">üìä Estad√≠sticas:</strong>
                        <ul style="margin-top: 0.5rem; color: #4b5563;">
                            <li>L√≠neas estrat√©gicas: ${st.lineasEstrategicas.length}</li>
                            <li>Programas seleccionados: ${st.programasSeleccionados.length}</li>
                            <li>Total actuaciones: ${Object.values(st.actuaciones || {}).flat().length}</li>
                        </ul>
                    </div>
                    
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem;">
                        <strong style="color: #1f2937;">üë• Equipo:</strong>
                        <ul style="margin-top: 0.5rem; color: #4b5563; font-size: 0.9rem;">
                            ${st.equipo.coordinador ? `<li><strong>Coordinador:</strong> ${st.equipo.coordinador}</li>` : ''}
                            ${st.equipo.tecnicoSalud ? `<li><strong>T√©cnico de Salud:</strong> ${st.equipo.tecnicoSalud}</li>` : ''}
                            ${st.equipo.representanteMunicipal ? `<li><strong>Representante Municipal:</strong> ${st.equipo.representanteMunicipal}</li>` : ''}
                        </ul>
                    </div>
                    
                    <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem;">
                        <button class="btn btn-small btn-primary" onclick="exportarPlanMunicipio('${municipioId}')">
                            üì• Exportar Datos
                        </button>
                        <button class="btn btn-small btn-danger" onclick="eliminarPlanMunicipio('${municipioId}')">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            document.getElementById('detallesPlan').style.display = 'block';
        }
        
        function cerrarAdminPanel() {
            document.getElementById('adminModal').classList.remove('active');
            document.getElementById('detallesPlan').style.display = 'none';
        }
        
        function exportarPlanMunicipio(municipioId) {
            const borradorStr = localStorage.getItem(`planificadorEPVSA_${municipioId}`);
            if (!borradorStr) return;
            
            const blob = new Blob([borradorStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Plan_${municipioId}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportarTodosDatos() {
            const listaMunicipios = JSON.parse(localStorage.getItem('planificadorEPVSA_lista_municipios') || '[]');
            const todosLosDatos = {};
            
            listaMunicipios.forEach(municipioId => {
                const borradorStr = localStorage.getItem(`planificadorEPVSA_${municipioId}`);
                if (borradorStr) {
                    todosLosDatos[municipioId] = JSON.parse(borradorStr);
                }
            });
            
            const blob = new Blob([JSON.stringify(todosLosDatos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Todos_Planes_RELAS_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Exportados ${Object.keys(todosLosDatos).length} planes municipales`);
        }
        
        function eliminarPlanMunicipio(municipioId) {
            if (confirm(`‚ö†Ô∏è ¬øEst√°s seguro de eliminar este plan?\n\nEsta acci√≥n no se puede deshacer.`)) {
                localStorage.removeItem(`planificadorEPVSA_${municipioId}`);
                
                const listaMunicipios = JSON.parse(localStorage.getItem('planificadorEPVSA_lista_municipios') || '[]');
                const nuevaLista = listaMunicipios.filter(id => id !== municipioId);
                localStorage.setItem('planificadorEPVSA_lista_municipios', JSON.stringify(nuevaLista));
                
                alert('‚úÖ Plan eliminado');
                abrirAdminPanel(); // Recargar lista
            }
        }

        function limpiarFormulario() {
            // Confirmaci√≥n con doble verificaci√≥n para evitar borrados accidentales
            const confirmacion1 = confirm(
                '‚ö†Ô∏è ADVERTENCIA: LIMPIAR FORMULARIO\n\n' +
                'Esta acci√≥n eliminar√°:\n' +
                '‚úó Todos los datos del municipio\n' +
                '‚úó El perfil de salud cargado\n' +
                '‚úó Todas las l√≠neas y objetivos seleccionados\n' +
                '‚úó Todas las actuaciones registradas\n' +
                '‚úó El borrador guardado\n\n' +
                '¬øEst√°s seguro de que deseas continuar?'
            );
            
            if (!confirmacion1) return;
            
            // Segunda confirmaci√≥n
            const confirmacion2 = confirm(
                'üö® √öLTIMA CONFIRMACI√ìN\n\n' +
                'Esta acci√≥n NO se puede deshacer.\n' +
                'Perder√°s TODO el trabajo realizado.\n\n' +
                '¬øConfirmas que deseas ELIMINAR TODO?'
            );
            
            if (!confirmacion2) return;
            
            try {
                // Limpiar localStorage completamente
                localStorage.removeItem('planificadorEPVSA_borrador');
                
                // Resetear COMPLETAMENTE el estado a los valores iniciales originales
                state.municipio = { nombre: '', provincia: '', poblacion: null };
                state.equipo = { coordinador: '', tecnicoSalud: '', representanteMunicipal: '', otrosMiembros: '' };
                state.perfilCargado = false;
                state.indicadoresExtraidos = [];
                state.areaPrioritaria = 'Bienestar Emocional';
                state.sesionGrupoMotor = 'Febrero de 2025';
                state.lineasEstrategicas = [];
                state.programasSeleccionados = [];
                state.actuaciones = {};
                state.currentEntorno = 'sanitario';
                state.currentYear = 2024;
                state.planGenerado = null;
                state.sugerenciasAplicadas = false;
                state.pdfData = null;
                state.pdfNumPages = 0;
                
                // Limpiar TODOS los campos del formulario
                const camposTexto = [
                    'nombreMunicipio', 'provinciaMunicipio', 'poblacionMunicipio',
                    'coordinador', 'tecnicoSalud', 'representanteMunicipal', 'otrosMiembros',
                    'areaPrioritaria'
                ];
                
                camposTexto.forEach(id => {
                    const campo = document.getElementById(id);
                    if (campo) campo.value = '';
                });
                
                // Resetear input de archivo PDF
                const pdfInput = document.getElementById('pdfInput');
                if (pdfInput) pdfInput.value = '';
                
                // Resetear visualizaci√≥n del perfil
                const uploadZone = document.getElementById('uploadZone');
                const analisisResultados = document.getElementById('analisisResultados');
                if (uploadZone) uploadZone.style.display = 'block';
                if (analisisResultados) analisisResultados.style.display = 'none';
                
                // Limpiar TODOS los contenedores din√°micos
                const contenedoresDinamicos = [
                    'conclusionesResumen', 'recomendacionesResumen', 'planGeneradoContainer',
                    'lineasEstrategicasContainer', 'indicadoresContainer', 'planContainer',
                    'resumenLineas', 'resumenProgramas', 'entornoContent', 'conclusionesContainer'
                ];
                
                contenedoresDinamicos.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) container.innerHTML = '';
                });
                
                // Limpiar actuaciones en TODOS los entornos
                ['sanitario', 'comunitario', 'educativo', 'laboral'].forEach(entorno => {
                    const container = document.getElementById(`actuaciones-${entorno}`);
                    if (container) container.innerHTML = '';
                });
                
                // Resetear todos los selectores y checks
                const checkboxes = document.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
                
                const selects = document.querySelectorAll('select');
                selects.forEach(sel => sel.selectedIndex = 0);
                
                // Limpiar banners y displays
                const areaBanner = document.getElementById('areaPrioritariaBanner');
                const areaDisplay = document.getElementById('areaPrioritariaDisplay');
                if (areaBanner) areaBanner.style.display = 'none';
                if (areaDisplay) areaDisplay.textContent = '';
                
                // Actualizar estad√≠sticas a CERO
                actualizarEstadisticas();
                
                // Resetear las estad√≠sticas manualmente por si acaso
                const stats = ['statIndicadores', 'statProgramas', 'statConclusiones', 'statPrioridad', 'statActuaciones'];
                stats.forEach(id => {
                    const stat = document.getElementById(id);
                    if (stat) stat.textContent = '0';
                });
                
                // Volver a la primera pesta√±a y limpiar clases
                const tabs = document.querySelectorAll('.tab');
                const tabContents = document.querySelectorAll('.tab-content');
                tabs.forEach(t => t.classList.remove('active', 'completed'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                if (tabs.length > 0) tabs[0].classList.add('active');
                if (tabContents.length > 0) tabContents[0].classList.add('active');
                
                // Mensaje de confirmaci√≥n
                alert('‚úÖ Formulario limpiado completamente\n\n' +
                      'Todos los datos han sido eliminados.\n' +
                      'Puedes comenzar un nuevo plan desde cero.');
                
                // Recargar la p√°gina para asegurar limpieza total
                if (confirm('üí° ¬øDeseas recargar la p√°gina para asegurar una limpieza completa?')) {
                    location.reload();
                }
                      
            } catch (e) {
                console.error('Error al limpiar formulario:', e);
                alert('‚ùå Error al limpiar el formulario\n\n' +
                      'Detalles: ' + e.message + '\n\n' +
                      'Recarga la p√°gina manualmente (F5) para comenzar de nuevo.');
            }
        }

        // MEJORA 8: Funciones de tutorial
        function mostrarTutorialSiNecesario() {
            // Mostrar el modal de bienvenida si no hay un borrador guardado
            // (ya no usamos localStorage para esto, as√≠ siempre aparece en sesiones nuevas)
            if (!cargarBorradorSiExiste()) {
                document.getElementById('tutorialModal').classList.add('active');
            }
        }

        function cerrarTutorial() {
            // Solo cerrar el modal, no guardar nada en localStorage
            document.getElementById('tutorialModal').classList.remove('active');
        }

        // Variables globales del tutorial
        let tutorialPasoActual = 0;
        let elementoAnterior = null;

        const pasosTutorial = [
            {
                selector: '.tabs',
                titulo: 'üìë Paso 1: Navegaci√≥n por Pesta√±as',
                descripcion: 'El planificador est√° organizado en 6 pesta√±as. Cada pesta√±a representa una etapa del proceso. Completa cada secci√≥n en orden para crear tu Plan Local de Salud.',
                posicion: 'bottom'
            },
            {
                selector: '[data-tab="configuracion"]',
                titulo: '‚öôÔ∏è Paso 2: Configuraci√≥n Inicial',
                descripcion: 'Comienza aqu√≠ identificando tu municipio y subiendo el Perfil de Salud Local en PDF. Selecciona el √°rea prioritaria que trabajar√°s.',
                posicion: 'bottom',
                accion: () => cambiarTab('configuracion')
            },
            {
                selector: '#nombreMunicipio',
                titulo: 'üèõÔ∏è Paso 3: Nombre del Municipio',
                descripcion: 'Escribe el nombre de tu municipio. Este dato aparecer√° en todos los documentos generados. Es un campo obligatorio.',
                posicion: 'bottom'
            },
            {
                selector: '#areaPrioritaria',
                titulo: 'üéØ Paso 4: √Årea Prioritaria',
                descripcion: 'Selecciona el √°rea de salud prioritaria identificada en tu Perfil de Salud. El sistema te sugerir√° objetivos EPVSA relacionados.',
                posicion: 'bottom'
            },
            {
                selector: '[data-tab="lineas"]',
                titulo: '‚úÖ Paso 5: Selecci√≥n de L√≠neas EPVSA',
                descripcion: 'Aqu√≠ seleccionar√°s las l√≠neas estrat√©gicas, objetivos y programas EPVSA que implementar√°s en tu municipio. Puedes elegir m√∫ltiples opciones.',
                posicion: 'bottom',
                accion: () => cambiarTab('lineas')
            },
            {
                selector: '[data-tab="plan"]',
                titulo: 'üìã Paso 6: Plan Local de Salud',
                descripcion: 'En esta pesta√±a ver√°s el plan completo estructurado con todas las l√≠neas, objetivos y programas que has seleccionado.',
                posicion: 'bottom',
                accion: () => cambiarTab('plan')
            },
            {
                selector: '[data-tab="indicadores"]',
                titulo: 'üìä Paso 7: Cuadro de Mandos',
                descripcion: 'Completa los 58 indicadores del cuadro de mandos EPVSA. Puedes guardar tu progreso y volver m√°s tarde.',
                posicion: 'bottom',
                accion: () => cambiarTab('indicadores')
            },
            {
                selector: '[data-tab="agendas"]',
                titulo: 'üìÖ Paso 8: Agendas Anuales RELAS',
                descripcion: 'Planifica las actuaciones concretas que realizar√°s cada a√±o (2024-2030) organizadas por entornos: Sanitario, Comunitario, Educativo y Laboral.',
                posicion: 'bottom',
                accion: () => cambiarTab('agendas')
            },
            {
                selector: '.stats-bar',
                titulo: 'üíæ Paso 9: Estad√≠sticas y Progreso',
                descripcion: 'En la parte superior ver√°s siempre el resumen de tu progreso: l√≠neas seleccionadas, objetivos, programas y actuaciones registradas.',
                posicion: 'bottom'
            },
            {
                selector: '[data-tab="conclusiones"]',
                titulo: 'üì• Paso 10: Exportar Documentos',
                descripcion: 'Cuando termines, aqu√≠ podr√°s exportar todos los documentos en formato PDF. Incluye el Plan Completo con los 3 documentos principales.',
                posicion: 'bottom',
                accion: () => cambiarTab('conclusiones')
            }
        ];

        function iniciarTutorial() {
            // Cerrar el modal de bienvenida
            document.getElementById('tutorialModal').classList.remove('active');
            
            tutorialPasoActual = 0;
            mostrarPasoTutorial();
        }

        function mostrarPasoTutorial() {
            if (tutorialPasoActual >= pasosTutorial.length) {
                finalizarTutorial();
                return;
            }

            const paso = pasosTutorial[tutorialPasoActual];
            const elemento = document.querySelector(paso.selector);
            
            if (!elemento) {
                console.warn('Elemento no encontrado:', paso.selector);
                tutorialPasoActual++;
                mostrarPasoTutorial();
                return;
            }

            // Ejecutar acci√≥n si existe (como cambiar de tab)
            if (paso.accion) {
                paso.accion();
                setTimeout(() => continuarConPaso(paso, elemento), 300);
            } else {
                continuarConPaso(paso, elemento);
            }
        }

        function continuarConPaso(paso, elemento) {
            // Limpiar spotlight anterior
            if (elementoAnterior) {
                elementoAnterior.classList.remove('tutorial-spotlight');
            }

            // Activar overlay
            const overlay = document.getElementById('tutorialOverlay');
            overlay.classList.add('active');

            // A√±adir spotlight al elemento actual
            elemento.classList.add('tutorial-spotlight');
            elementoAnterior = elemento;

            // Scroll al elemento
            elemento.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Mostrar tooltip
            setTimeout(() => {
                mostrarTooltip(paso, elemento);
            }, 500);
        }

        function mostrarTooltip(paso, elemento) {
            const tooltip = document.getElementById('tutorialTooltip');
            const rect = elemento.getBoundingClientRect();
            
            const progreso = Math.round(((tutorialPasoActual + 1) / pasosTutorial.length) * 100);
            
            tooltip.innerHTML = `
                <div class="tutorial-progress">
                    <span>Paso ${tutorialPasoActual + 1} de ${pasosTutorial.length}</span>
                    <div class="tutorial-progress-bar">
                        <div class="tutorial-progress-fill" style="width: ${progreso}%"></div>
                    </div>
                </div>
                <h3>${paso.titulo}</h3>
                <p>${paso.descripcion}</p>
                <div class="tutorial-buttons">
                    <button class="btn btn-secondary" onclick="salirTutorial()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        Salir
                    </button>
                    ${tutorialPasoActual > 0 ? 
                        '<button class="btn btn-secondary" onclick="pasoAnteriorTutorial()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">‚Üê Anterior</button>' 
                        : ''}
                    <button class="btn btn-primary" onclick="siguientePasoTutorial()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        ${tutorialPasoActual === pasosTutorial.length - 1 ? 'Finalizar ‚úì' : 'Siguiente ‚Üí'}
                    </button>
                </div>
            `;

            // Posicionar tooltip
            tooltip.style.display = 'block';
            
            let top, left;
            const tooltipRect = tooltip.getBoundingClientRect();
            
            if (paso.posicion === 'bottom') {
                top = rect.bottom + 20;
                left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            } else if (paso.posicion === 'left') {
                top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                left = rect.left - tooltipRect.width - 20;
            } else if (paso.posicion === 'right') {
                top = rect.top + (rect.height / 2) - (tooltipRect.height / 2);
                left = rect.right + 20;
            }

            // Asegurar que el tooltip est√© dentro de la ventana
            if (left < 20) left = 20;
            if (left + tooltipRect.width > window.innerWidth - 20) {
                left = window.innerWidth - tooltipRect.width - 20;
            }
            if (top < 20) top = 20;
            if (top + tooltipRect.height > window.innerHeight - 20) {
                top = window.innerHeight - tooltipRect.height - 20;
            }

            tooltip.style.top = top + 'px';
            tooltip.style.left = left + 'px';
        }

        function siguientePasoTutorial() {
            tutorialPasoActual++;
            mostrarPasoTutorial();
        }

        function pasoAnteriorTutorial() {
            if (tutorialPasoActual > 0) {
                tutorialPasoActual--;
                mostrarPasoTutorial();
            }
        }

        function salirTutorial() {
            // Limpiar spotlight
            if (elementoAnterior) {
                elementoAnterior.classList.remove('tutorial-spotlight');
                elementoAnterior = null;
            }

            // Ocultar overlay y tooltip
            document.getElementById('tutorialOverlay').classList.remove('active');
            document.getElementById('tutorialTooltip').style.display = 'none';
            
            // Resetear paso
            tutorialPasoActual = 0;
        }

        function finalizarTutorial() {
            // Limpiar spotlight
            if (elementoAnterior) {
                elementoAnterior.classList.remove('tutorial-spotlight');
                elementoAnterior = null;
            }

            // Ocultar overlay y tooltip
            document.getElementById('tutorialOverlay').classList.remove('active');
            document.getElementById('tutorialTooltip').style.display = 'none';

            // Mensaje de finalizaci√≥n
            alert('‚úÖ ¬°Tutorial completado!\n\nYa puedes comenzar a crear tu Plan Local de Salud.\n\nüí° Recuerda guardar tu progreso frecuentemente usando el bot√≥n "üíæ Guardar borrador".');
        }

        function reiniciarTutorial() {
            tutorialPasoActual = 0;
            iniciarTutorial();
        }


        // MEJORA 10: Funciones de informaci√≥n EPVSA
        function mostrarInfoEPVSA(codigoPrograma) {
            const programa = PROGRAMAS_EPVSA_INFO[codigoPrograma];
            if (!programa) return;
            
            const body = document.getElementById('epvsaInfoBody');
            body.innerHTML = `
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #38bdf8; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <div style="display: inline-block; background: #3b82f6; color: white; padding: 0.35rem 0.75rem; border-radius: 9999px; font-size: 0.85rem; font-weight: 800; margin-bottom: 0.75rem;">
                        ${programa.codigo}
                    </div>
                    <h3 style="color: #0369a1; font-size: 1.2rem; font-weight: 700; margin-bottom: 0.75rem; line-height: 1.4;">
                        ${programa.nombre}
                    </h3>
                    <div style="background: white; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <strong style="color: #0284c7;">√Åmbito:</strong>
                        <span style="color: #4b5563;">${programa.ambito}</span>
                    </div>
                    <p style="color: #4b5563; line-height: 1.7; margin-bottom: 1rem;">
                        ${programa.descripcion}
                    </p>
                </div>

                <div style="background: #f9fafb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h4 style="color: #667eea; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        üéØ Objetivos EPVSA relacionados
                    </h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${programa.objetivos.map(obj => `
                            <span style="background: #667eea; color: white; padding: 0.35rem 0.75rem; border-radius: 9999px; font-size: 0.85rem; font-weight: 600;">
                                ${obj}
                            </span>
                        `).join('')}
                    </div>
                </div>

                <div style="background: #fffbeb; border-radius: 0.75rem; padding: 1.5rem;">
                    <h4 style="color: #f59e0b; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        üí° Ejemplos de actuaciones
                    </h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        ${programa.actuaciones_tipo.map(act => `
                            <li style="display: flex; align-items: start; gap: 0.5rem; padding: 0.5rem; color: #78350f; line-height: 1.6;">
                                <span style="color: #f59e0b; font-weight: 700; flex-shrink: 0;">‚ñ∏</span>
                                <span>${act}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>

                <div class="alert alert-info" style="margin-top: 1.5rem;">
                    <span style="font-size: 1.5rem;">üìñ</span>
                    <div>
                        <strong>M√°s informaci√≥n oficial:</strong><br>
                        Consulta el documento completo de la EPVSA 2024-2030 en el portal de la Consejer√≠a de Salud y Consumo de la Junta de Andaluc√≠a.
                    </div>
                </div>
            `;
            
            document.getElementById('epvsaInfoModal').classList.add('active');
        }

        function cerrarEpvsaInfo() {
            document.getElementById('epvsaInfoModal').classList.remove('active');
        }

        // MEJORA 2: Funciones de validaci√≥n
        function validarConfiguracion() {
            const nombre = document.getElementById('nombreMunicipio').value.trim();
            const perfilCargado = state.perfilCargado;
            
            const validacion = {
                municipio: nombre !== '',
                perfil: perfilCargado,
                area: state.areaPrioritaria !== '',
                sesion: state.sesionGrupoMotor !== ''
            };
            
            // Mostrar panel de validaci√≥n
            const panel = document.getElementById('validacionConfiguracion');
            if (nombre || perfilCargado) {
                panel.style.display = 'block';
                
                const items = document.getElementById('validacionItems');
                items.innerHTML = `
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.municipio ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.municipio ? 'Completo' : 'Pendiente'}:</span>
                            Municipio identificado
                        </div>
                    </div>
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.perfil ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.perfil ? 'Completo' : 'Pendiente'}:</span>
                            Perfil de salud cargado
                        </div>
                    </div>
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.area ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.area ? 'Completo' : 'Pendiente'}:</span>
                            √Årea prioritaria definida
                        </div>
                    </div>
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.sesion ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.sesion ? 'Completo' : 'Pendiente'}:</span>
                            Sesi√≥n Grupo-Motor registrada
                        </div>
                    </div>
                `;
            }
            
            // Habilitar/deshabilitar bot√≥n continuar
            document.getElementById('btnContinuar').disabled = !validacion.municipio;
        }

        function validarSeleccion() {
            let objetivosCount = 0;
            let indicadoresCount = 0;
            let programasCount = 0;
            let actuacionesCount = 0;
            
            ESTRUCTURA_EPVSA.forEach((linea) => {
                linea.objetivos.forEach((objetivo, objIdx) => {
                    const objCheckbox = document.getElementById(`obj${linea.id}_${objIdx}`);
                    if (objCheckbox && objCheckbox.checked) objetivosCount++;
                    
                    objetivo.indicadores.forEach((ind, indIdx) => {
                        const indCheckbox = document.getElementById(`ind${linea.id}_${objIdx}_${indIdx}`);
                        if (indCheckbox && indCheckbox.checked) indicadoresCount++;
                    });
                    
                    objetivo.programas.forEach((programa, progIdx) => {
                        const progCheckbox = document.getElementById(`prog${linea.id}_${objIdx}_${progIdx}`);
                        if (progCheckbox && progCheckbox.checked) programasCount++;
                        
                        programa.actuaciones.forEach((act, actIdx) => {
                            const actCheckbox = document.getElementById(`act${linea.id}_${objIdx}_${progIdx}_${actIdx}`);
                            if (actCheckbox && actCheckbox.checked) actuacionesCount++;
                        });
                    });
                });
            });
            
            const validacion = {
                objetivos: objetivosCount >= 3,
                indicadores: indicadoresCount >= 5,
                programas: programasCount >= 2,
                actuaciones: actuacionesCount >= 5
            };
            
            // Mostrar panel de validaci√≥n
            const panel = document.getElementById('validacionSeleccion');
            if (objetivosCount > 0) {
                panel.style.display = 'block';
                
                const items = document.getElementById('validacionSeleccionItems');
                items.innerHTML = `
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.objetivos ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.objetivos ? 'Adecuado' : 'Insuficiente'}:</span>
                            ${objetivosCount} objetivos seleccionados ${validacion.objetivos ? '' : '(m√≠nimo recomendado: 3)'}
                        </div>
                    </div>
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.indicadores ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.indicadores ? 'Adecuado' : 'Insuficiente'}:</span>
                            ${indicadoresCount} indicadores seleccionados ${validacion.indicadores ? '' : '(m√≠nimo recomendado: 5)'}
                        </div>
                    </div>
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.programas ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.programas ? 'Adecuado' : 'Insuficiente'}:</span>
                            ${programasCount} programas EPVSA seleccionados ${validacion.programas ? '' : '(m√≠nimo recomendado: 2)'}
                        </div>
                    </div>
                    <div class="validation-item">
                        <span class="validation-icon">${validacion.actuaciones ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                        <div class="validation-text">
                            <span class="validation-status">${validacion.actuaciones ? 'Adecuado' : 'Insuficiente'}:</span>
                            ${actuacionesCount} actuaciones seleccionadas ${validacion.actuaciones ? '' : '(m√≠nimo recomendado: 5)'}
                        </div>
                    </div>
                `;
            }
        }

        function validarIndicadores() {
            const indicadoresSinDatos = state.indicadoresExtraidos.filter(i => i.dato === '-').length;
            const total = state.indicadoresExtraidos.length;
            const conDatos = total - indicadoresSinDatos;
            
            const validacion = {
                basico: conDatos >= 20,
                bueno: conDatos >= 40,
                completo: conDatos >= 55
            };
            
            const panel = document.getElementById('validacionIndicadores');
            panel.style.display = 'block';
            
            const items = document.getElementById('validacionIndicadoresItems');
            items.innerHTML = `
                <div class="validation-item">
                    <span class="validation-icon">${validacion.completo ? '‚úÖ' : validacion.bueno ? '‚ö†Ô∏è' : '‚ùå'}</span>
                    <div class="validation-text">
                        <span class="validation-status">${validacion.completo ? 'Excelente' : validacion.bueno ? 'Bien' : 'Insuficiente'}:</span>
                        ${conDatos} de 58 indicadores con datos (${indicadoresSinDatos} sin datos)
                    </div>
                </div>
                ${!validacion.completo ? `
                    <div class="alert alert-warning" style="margin-top: 1rem;">
                        <span style="font-size: 1.2rem;">üí°</span>
                        <div style="font-size: 0.9rem;">
                            <strong>Recomendaci√≥n:</strong> Completa al menos 40 indicadores para garantizar un seguimiento adecuado del Plan.
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function validarActuaciones() {
            const actuacionesPorEntorno = {};
            ENTORNOS.forEach(ent => {
                const total = ANOS.reduce((sum, year) => {
                    const key = `${ent.id}-${year}`;
                    return sum + (state.actuaciones[key] ? state.actuaciones[key].length : 0);
                }, 0);
                actuacionesPorEntorno[ent.id] = total;
            });
            
            const totalActuaciones = Object.values(actuacionesPorEntorno).reduce((a, b) => a + b, 0);
            
            const validacion = {
                basico: totalActuaciones >= 4, // Al menos 1 por entorno
                bueno: totalActuaciones >= 12, // Al menos 3 por entorno
                completo: Object.values(actuacionesPorEntorno).every(n => n >= 3)
            };
            
            const panel = document.getElementById('validacionActuaciones');
            panel.style.display = 'block';
            
            const items = document.getElementById('validacionActuacionesItems');
            items.innerHTML = `
                <div class="validation-item">
                    <span class="validation-icon">${validacion.completo ? '‚úÖ' : validacion.bueno ? '‚ö†Ô∏è' : '‚ùå'}</span>
                    <div class="validation-text">
                        <span class="validation-status">${validacion.completo ? 'Completo' : validacion.bueno ? 'Bien' : 'Insuficiente'}:</span>
                        ${totalActuaciones} actuaciones RELAS registradas
                    </div>
                </div>
                ${ENTORNOS.map(ent => `
                    <div class="validation-item">
                        <span class="validation-icon">${actuacionesPorEntorno[ent.id] >= 3 ? '‚úÖ' : actuacionesPorEntorno[ent.id] > 0 ? '‚ö†Ô∏è' : '‚ùå'}</span>
                        <div class="validation-text">
                            ${ent.icono} <strong>${ent.nombre}:</strong> ${actuacionesPorEntorno[ent.id]} actuaciones
                        </div>
                    </div>
                `).join('')}
                ${!validacion.completo ? `
                    <div class="alert alert-warning" style="margin-top: 1rem;">
                        <span style="font-size: 1.2rem;">üí°</span>
                        <div style="font-size: 0.9rem;">
                            <strong>Recomendaci√≥n:</strong> Registra al menos 3 actuaciones en cada entorno para garantizar una intervenci√≥n integral.
                        </div>
                    </div>
                ` : ''}
            `;
        }

        // MEJORA 3: Funciones de sugerencias inteligentes
        function generarSugerencias() {
            const areaLower = state.areaPrioritaria.toLowerCase();
            const sugerencias = SUGERENCIAS_POR_AREA[areaLower] || SUGERENCIAS_POR_AREA['default'];
            
            document.getElementById('areaSugerida').textContent = state.areaPrioritaria;
            
            const lista = document.getElementById('sugerenciasList');
            lista.innerHTML = sugerencias.map(sug => `
                <li class="suggestion-item">
                    <input type="checkbox" class="suggestion-check" id="sug_${sug.linea}_${sug.objetivo}">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                            ${sug.descripcion}
                        </div>
                        <div style="font-size: 0.85rem; color: #6b7280;">
                            L√≠nea Estrat√©gica ${sug.linea} de la EPVSA 2024-2030
                        </div>
                    </div>
                </li>
            `).join('');
        }

        function aplicarSeleccionSugerida() {
            const areaLower = state.areaPrioritaria.toLowerCase();
            const sugerencias = SUGERENCIAS_POR_AREA[areaLower] || SUGERENCIAS_POR_AREA['default'];
            
            let objetivosSeleccionados = 0;
            
            // Marcar checkboxes sugeridos
            sugerencias.forEach(sug => {
                const linea = ESTRUCTURA_EPVSA.find(l => l.id === sug.linea);
                if (!linea) return;
                
                const objIdx = linea.objetivos.findIndex(o => o.id === sug.objetivo);
                if (objIdx === -1) return;
                
                // Marcar objetivo SOLAMENTE
                const objCheckbox = document.getElementById(`obj${linea.id}_${objIdx}`);
                if (objCheckbox) {
                    objCheckbox.checked = true;
                    objetivosSeleccionados++;
                }
                
                // Expandir objetivo para mostrar programas y actuaciones (pero SIN marcarlos)
                toggleObjetivoExpand(linea.id, objIdx);
            });
            
            // Actualizar despu√©s de marcar los objetivos
            setTimeout(() => {
                actualizarResumenLineas();
                validarSeleccion();
            }, 100);
            
            state.sugerenciasAplicadas = true;
            cerrarSugerencias();
            
            // Mostrar mensaje despu√©s de un peque√±o delay
            setTimeout(() => {
                alert(`‚úÖ Selecci√≥n sugerida aplicada correctamente\n\n` +
                      `üìä Se han seleccionado ${objetivosSeleccionados} objetivos estrat√©gicos recomendados.\n\n` +
                      `‚ö†Ô∏è IMPORTANTE: Ahora debes seleccionar manualmente:\n` +
                      `‚Ä¢ Los indicadores de evaluaci√≥n que consideres relevantes\n` +
                      `‚Ä¢ Los programas EPVSA que implementar√°s\n` +
                      `‚Ä¢ Las actuaciones espec√≠ficas de cada programa\n\n` +
                      `üí° Personaliza la selecci√≥n seg√∫n las necesidades espec√≠ficas de tu municipio.`);
            }, 300);
        }

        function cerrarSugerencias() {
            document.getElementById('sugerenciasInteligentes').style.display = 'none';
        }

        function actualizarAreaPrioritaria(valor) {
            state.areaPrioritaria = valor;
            const display = document.getElementById('areaPrioritariaDisplay');
            if (display) display.textContent = valor;
            
            // Regenerar sugerencias
            if (!state.sugerenciasAplicadas) {
                generarSugerencias();
            }
        }

        // MEJORA 5: Funciones de plantillas de actuaciones
        function mostrarPlantillasActuaciones() {
            const entorno = state.currentEntorno;
            const plantillas = PLANTILLAS_ACTUACIONES[entorno] || [];
            
            if (plantillas.length === 0) return '';
            
            return `
                <div style="background: #f0f9ff; border: 2px solid #38bdf8; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 2rem;">
                    <h4 style="color: #0369a1; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        üí° Plantillas de Actuaciones - Entorno ${ENTORNOS.find(e => e.id === entorno).nombre}
                    </h4>
                    <p style="color: #4b5563; font-size: 0.9rem; margin-bottom: 1rem;">
                        Selecciona una plantilla y personal√≠zala seg√∫n las necesidades de tu municipio:
                    </p>
                    ${plantillas.map((plantilla, idx) => `
                        <div class="plantilla-card" onclick="insertarPlantilla(${idx}, '${entorno}')">
                            <div class="plantilla-header">
                                <span class="plantilla-icon">${plantilla.icon}</span>
                                <span class="plantilla-title">${plantilla.titulo}</span>
                                <button class="btn btn-primary plantilla-btn" onclick="event.stopPropagation(); insertarPlantilla(${idx}, '${entorno}')">
                                    ‚ûï Insertar
                                </button>
                            </div>
                            <div class="plantilla-descripcion">
                                ${plantilla.descripcion}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function insertarPlantilla(idx, entorno) {
            const plantilla = PLANTILLAS_ACTUACIONES[entorno][idx];
            
            document.getElementById('inputTituloActuacion').value = plantilla.titulo;
            document.getElementById('textActuacion').value = plantilla.descripcion;
            
            // Scroll al formulario
            document.querySelector('.actividad-registro').scrollIntoView({ behavior: 'smooth' });
            
            // Efecto visual
            const form = document.querySelector('.actividad-registro');
            form.style.animation = 'pulse 1s ease-in-out';
            setTimeout(() => {
                form.style.animation = '';
            }, 1000);
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            // AUTO-LOGIN COMO ADMIN - T√ö SIEMPRE TIENES ACCESO
            usuarioActual = {
                tipo: 'admin',
                nombre: 'Administrador',
                esAdmin: true
            };
            sessionStorage.setItem('planificadorEPVSA_sesion', JSON.stringify(usuarioActual));
            console.log('‚úÖ AUTO-LOGIN ADMIN ACTIVADO');
            
            inicializarTabs();
            inicializarAnalizadorPDF();
            renderEntornoSelector();
            
            document.getElementById('nombreMunicipio').addEventListener('input', validarConfiguracion);
            document.getElementById('areaPrioritaria').addEventListener('change', (e) => actualizarAreaPrioritaria(e.target.value));
            
            // Sincronizar poblaci√≥n del municipio con indicador #1
            document.getElementById('poblacionMunicipio').addEventListener('input', (e) => {
                const poblacion = e.target.value.trim();
                state.municipio.poblacion = poblacion;
                
                // Actualizar indicador #1 en todos los a√±os
                Object.keys(state.cuadrosMandosAnuales).forEach(ano => {
                    const indicador = state.cuadrosMandosAnuales[ano].find(i => i.numero === 1);
                    if (indicador) {
                        indicador.dato = poblacion || '‚Äî';
                    }
                });
                
                // Si estamos en la pesta√±a de indicadores, re-renderizar
                if (document.getElementById('indicadores').classList.contains('active')) {
                    renderIndicadores();
                }
                
                guardarEstado();
            });
            
            // MEJORA 8: Mostrar tutorial si es primera vez
            setTimeout(() => {
                mostrarTutorialSiNecesario();
            }, 500);
            
            validarConfiguracion();
        });

        function inicializarTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    cambiarTab(tabId);
                });
            });
        }

        function cambiarTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');

            // Resetear scroll al inicio del contenedor al cambiar de tab
            if (tabId === 'lineas') {
                setTimeout(() => {
                    const container = document.querySelector('.container');
                    if (container) container.scrollTop = 0;
                    window.scrollTo(0, 0);
                }, 0);
            }

            if (tabId === 'lineas') {
                renderArbolLineas();
                if (!state.sugerenciasAplicadas) {
                    generarSugerencias();
                }
            }
            if (tabId === 'plan') renderPlanLocal();
            if (tabId === 'indicadores') {
                renderIndicadores();
                if (state.indicadoresExtraidos.length > 0) {
                    validarIndicadores();
                }
            }
            if (tabId === 'agendas') {
                renderAgendas();
                validarActuaciones();
            }
            if (tabId === 'conclusiones') renderConclusiones();
        }

        function inicializarAnalizadorPDF() {
            const uploadZone = document.getElementById('uploadZone');
            const pdfInput = document.getElementById('pdfInput');

            uploadZone.addEventListener('click', () => pdfInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragging');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragging');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragging');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'application/pdf') {
                    procesarPDF(file);
                }
            });

            pdfInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) procesarPDF(file);
            });
        }

        async function procesarPDF(file) {
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
                <div style="font-size: 1.2rem; font-weight: 600; color: #10b981;">
                    Analizando perfil de salud...
                </div>
            `;

            try {
                // Configurar PDF.js worker
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                
                // Leer el archivo PDF
                const arrayBuffer = await file.arrayBuffer();
                
                // Guardar PRIMERO el PDF en memoria (antes de que PDF.js lo consuma)
                state.pdfData = arrayBuffer.slice(0); // copia del arrayBuffer
                
                // AHORA s√≠ procesar con PDF.js
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                state.pdfNumPages = pdf.numPages;
                console.log(`‚úÖ PDF guardado en memoria: ${pdf.numPages} p√°ginas`);
                
                uploadZone.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìÑ</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: #10b981;">
                        Extrayendo indicadores (${pdf.numPages} p√°ginas)...
                    </div>
                `;
                
                // Extraer texto de todas las p√°ginas
                let textoCompleto = '';
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    textoCompleto += pageText + '\n';
                }
                
                // Inicializar array de indicadores extra√≠dos con la estructura base
                // IMPORTANTE: NO intentamos extraer valores autom√°ticamente porque es muy propenso a errores
                // El usuario debe completar los valores manualmente en el tab "Indicadores"
                state.indicadoresExtraidos = INDICADORES_CMI.map(ind => ({...ind}));
                
                // ========== EXTRACCI√ìN DE METADATOS DEL PDF ==========
                
                // 1. EXTRAER NOMBRE DEL MUNICIPIO
                console.log('Buscando nombre del municipio en el PDF...');
                
                // Patrones para detectar el nombre del municipio
                // Buscar en las primeras p√°ginas (portada y primeras secciones)
                const primeras5Paginas = textoCompleto.substring(0, Math.min(textoCompleto.length, 5000));
                
                const patronesMunicipio = [
                    /perfil\s+(?:de\s+)?salud\s+(?:local\s+)?(?:de\s+)?([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+(?:de|del|la|los|las)\s+)?[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+?)/i,
                    /municipio\s+(?:de\s+)?([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+(?:de|del|la|los|las)\s+)?[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+?)/i,
                    /plan\s+(?:local\s+)?(?:de\s+)?salud\s+(?:de\s+)?([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+(?:de|del|la|los|las)\s+)?[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+?)/i,
                    /ayuntamiento\s+(?:de\s+)?([A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+(?:\s+(?:de|del|la|los|las)\s+)?[A-Z√Å√â√ç√ì√ö√ë][a-z√°√©√≠√≥√∫√±]+?)/i
                ];
                
                let nombreMunicipioExtraido = null;
                for (const patron of patronesMunicipio) {
                    const match = primeras5Paginas.match(patron);
                    if (match && match[1]) {
                        const nombre = match[1].trim();
                        
                        // Validar que sea un nombre razonable (entre 3 y 50 caracteres, sin n√∫meros)
                        if (nombre.length >= 3 && nombre.length <= 50 && !/\d/.test(nombre)) {
                            // Limpiar palabras comunes que no son parte del nombre
                            const nombreLimpio = nombre
                                .replace(/\s+(local|municipal|perfil|salud|plan)$/i, '')
                                .trim();
                            
                            if (nombreLimpio.length >= 3) {
                                nombreMunicipioExtraido = nombreLimpio;
                                console.log('‚úÖ Municipio extra√≠do del PDF:', nombreLimpio);
                                
                                // Rellenar autom√°ticamente el campo (con peque√±o delay para asegurar DOM cargado)
                                setTimeout(() => {
                                    const campoMunicipio = document.getElementById('nombreMunicipio');
                                    if (campoMunicipio) {
                                        campoMunicipio.value = nombreLimpio;
                                        state.municipio.nombre = nombreLimpio;
                                        console.log('‚úÖ Campo municipio rellenado con:', nombreLimpio);
                                    } else {
                                        console.error('‚ùå No se encontr√≥ el campo nombreMunicipio en el DOM');
                                    }
                                }, 100);
                                break;
                            }
                        }
                    }
                }
                
                if (!nombreMunicipioExtraido) {
                    console.log('‚ö†Ô∏è No se pudo extraer el nombre del municipio. El usuario deber√° introducirlo manualmente.');
                }
                
                // 2. EXTRAER CONCLUSIONES DEL PDF
                const seccionConclusiones = textoCompleto.match(/conclusiones[:\s]+(.*?)(?=recomendaciones|√°rea prioritaria|$)/is);
                if (seccionConclusiones) {
                    console.log('Conclusiones encontradas en el PDF');
                }
                
                // 3. EXTRAER RECOMENDACIONES
                const seccionRecomendaciones = textoCompleto.match(/recomendaciones[:\s]+(.*?)(?=√°rea prioritaria|$)/is);
                if (seccionRecomendaciones) {
                    console.log('Recomendaciones encontradas en el PDF');
                }
                
                // 4. EXTRAER √ÅREA PRIORITARIA
                const seccionAreaPrioritaria = textoCompleto.match(/√°rea prioritaria[:\s]+(.*?)(?:\n|$)/is);
                if (seccionAreaPrioritaria && seccionAreaPrioritaria[1]) {
                    const areaPrio = seccionAreaPrioritaria[1].trim();
                    if (areaPrio.length > 5 && areaPrio.length < 200) {
                        state.areaPrioritaria = areaPrio;
                        console.log('√Årea prioritaria extra√≠da:', areaPrio);
                    }
                }
                
                // 5. EXTRAER POBLACI√ìN DEL PDF - BUSCAR INDICADOR 1 EN CUADRO DE MANDOS
                // Buscar espec√≠ficamente "Indicador 1 Poblaci√≥n Total" o "Poblaci√≥n total" en el CMI
                
                console.log('Buscando Indicador 1 - Poblaci√≥n Total en el Cuadro de Mandos...');
                
                // Buscar m√∫ltiples patrones posibles
                const patronesPoblacion = [
                    // Patr√≥n 1: Con "Indicador 1"
                    /indicador\s*1[:\s]*poblaci√≥n\s*total[:\s]*(\d{1,3}(?:[.,\s]\d{3})*)/i,
                    // Patr√≥n 2: Solo "Poblaci√≥n total" (tu caso)
                    /poblaci√≥n\s*total[:\s]*(\d{1,3}(?:[.,\s]\d{3})*)/i,
                    // Patr√≥n 3: Con c√≥digo del indicador (ej: D1.1)
                    /d1\.1[:\s]*poblaci√≥n\s*total[:\s]*(\d{1,3}(?:[.,\s]\d{3})*)/i
                ];
                
                let poblacionExtraida = null;
                
                for (const patron of patronesPoblacion) {
                    const matchPoblacion = textoCompleto.match(patron);
                    
                    if (matchPoblacion && matchPoblacion[1]) {
                        // Limpiar el n√∫mero (eliminar puntos, comas y espacios)
                        const numeroLimpio = matchPoblacion[1].replace(/[.,\s]/g, '');
                        const poblacion = parseInt(numeroLimpio);
                        
                        // Validar que sea un n√∫mero razonable para un municipio espa√±ol
                        if (poblacion >= 100 && poblacion <= 3500000) {
                            poblacionExtraida = poblacion;
                            console.log('‚úÖ Poblaci√≥n extra√≠da del Cuadro de Mandos:', poblacion);
                            
                            // Rellenar autom√°ticamente el campo (con peque√±o delay para asegurar DOM cargado)
                            setTimeout(() => {
                                const campoPoblacion = document.getElementById('poblacionMunicipio');
                                if (campoPoblacion) {
                                    campoPoblacion.value = poblacion;
                                    state.municipio.poblacion = poblacion;
                                    console.log('‚úÖ Campo poblaci√≥n rellenado con:', poblacion);
                                } else {
                                    console.error('‚ùå No se encontr√≥ el campo poblacionMunicipio en el DOM');
                                }
                            }, 100);
                            break; // Salir del bucle si encontr√≥ la poblaci√≥n
                        } else {
                            console.log('‚ö†Ô∏è Poblaci√≥n encontrada pero fuera de rango v√°lido:', poblacion);
                        }
                    }
                }
                
                if (!poblacionExtraida) {
                    console.log('‚ö†Ô∏è No se encontr√≥ la Poblaci√≥n Total en el PDF.');
                    console.log('‚ÑπÔ∏è El usuario deber√° introducir la poblaci√≥n manualmente.');
                }
                
                // Contar indicadores (siempre ser√°n 58 con datos en blanco)
                const indicadoresConDatos = 0; // Ninguno extra√≠do autom√°ticamente
                
                state.perfilCargado = true;
                
                // MOSTRAR banner de √°rea prioritaria y sugerencias inteligentes
                document.getElementById('mensajeSinPerfil').style.display = 'none';
                document.getElementById('areaPrioritariaBanner').style.display = 'block';
                document.getElementById('sugerenciasInteligentes').style.display = 'block';
                
                document.getElementById('statIndicadores').textContent = '58';
                document.getElementById('statConclusiones').textContent = '4';
                document.getElementById('statPrioridad').textContent = '1';
                
                document.getElementById('uploadZone').style.display = 'none';
                document.getElementById('analisisResultados').style.display = 'block';
                
                renderConclusionesResumen();
                renderRecomendacionesResumen();
                
                document.querySelector('[data-tab="configuracion"]').classList.add('completed');
                
                validarConfiguracion();
                
                alert('‚úÖ Perfil de salud cargado correctamente\n\n' +
                      'üìä Los 58 indicadores del Cuadro de Mandos est√°n listos en el tab "Indicadores".\n\n' +
                      '‚ö†Ô∏è IMPORTANTE: Debes completar los valores de los indicadores manualmente con tus datos locales.\n\n' +
                      'üí° El sistema NO extrae valores autom√°ticamente del PDF para evitar errores.');
                
            } catch (error) {
                console.error('Error al procesar PDF:', error);
                uploadZone.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                    <div style="font-size: 1.2rem; font-weight: 600; color: #ef4444;">
                        Error al analizar el PDF
                    </div>
                    <div style="font-size: 0.9rem; color: #6b7280; margin-top: 0.5rem;">
                        ${error.message}
                    </div>
                    <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">
                        Reintentar
                    </button>
                `;
            }
        }

        function renderArbolLineas() {
            const container = document.getElementById('lineasEstrategicasContainer');
            
            const html = ESTRUCTURA_EPVSA.map(linea => `
                <div class="tree-linea" style="border: 3px solid ${linea.color};">
                    <div class="tree-linea-header" style="background: ${linea.color};" onclick="toggleLineaExpand(${linea.id})">
                        <input type="checkbox" 
                               id="linea${linea.id}" 
                               class="tree-checkbox"
                               onchange="toggleLineaSeleccion(${linea.id})"
                               onclick="event.stopPropagation();">
                        <span class="tree-expand" id="expand${linea.id}">‚ñ∂</span>
                        <div class="tree-linea-title">
                            L√≠nea ${linea.id}: ${linea.nombre}
                        </div>
                        <span class="tree-linea-count">
                            ${linea.objetivos.length} objetivos
                        </span>
                    </div>
                    <div class="tree-linea-content" id="content${linea.id}">
                        ${linea.objetivos.map((objetivo, objIdx) => `
                            <div class="tree-objetivo" style="border-color: ${linea.color};">
                                <div class="tree-objetivo-header">
                                    <input type="checkbox" 
                                           id="obj${linea.id}_${objIdx}" 
                                           class="tree-checkbox"
                                           style="width: 20px; height: 20px; margin-right: 0.5rem;"
                                           onchange="actualizarResumenLineas(); validarSeleccion();"
                                           onclick="event.stopPropagation();">
                                    <span class="tree-objetivo-id" style="color: ${linea.color};">${objetivo.id}</span>
                                    <span class="tree-objetivo-nombre" style="flex: 1; cursor: pointer;" onclick="toggleObjetivoExpand(${linea.id}, ${objIdx})">${objetivo.nombre}</span>
                                    <span class="tree-objetivo-toggle" id="toggleObj${linea.id}_${objIdx}" style="cursor: pointer;" onclick="toggleObjetivoExpand(${linea.id}, ${objIdx})">Ver m√°s ‚ñº</span>
                                </div>
                                <div class="tree-objetivo-content" id="objContent${linea.id}_${objIdx}">
                                    <!-- Indicadores -->
                                    <div class="tree-section">
                                        <div class="tree-section-title">
                                            <span class="tree-section-icon">üìä</span>
                                            Indicadores de Evaluaci√≥n (${objetivo.indicadores.length})
                                        </div>
                                        <ul class="tree-list" style="list-style: none; padding: 0;">
                                            ${objetivo.indicadores.map((ind, indIdx) => `
                                                <li class="tree-list-item" style="display: flex; align-items: start; gap: 0.5rem;">
                                                    <input type="checkbox" 
                                                           id="ind${linea.id}_${objIdx}_${indIdx}" 
                                                           style="width: 18px; height: 18px; margin-top: 0.2rem; flex-shrink: 0;"
                                                           onchange="actualizarResumenLineas(); validarSeleccion();">
                                                    <span style="flex: 1;">${ind}</span>
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                    
                                    <!-- Programas y Actuaciones -->
                                    <div class="tree-section">
                                        <div class="tree-section-title">
                                            <span class="tree-section-icon">üéØ</span>
                                            Programas y Actuaciones (${objetivo.programas.length} programas)
                                        </div>
                                        ${objetivo.programas.length === 0 ? '<p style="color: #6b7280; font-style: italic; padding: 0.5rem;">No hay programas espec√≠ficos para este objetivo</p>' : ''}
                                        ${objetivo.programas.map((programa, progIdx) => `
                                            <div class="tree-programa">
                                                <div class="tree-programa-nombre" style="display: flex; align-items: start; gap: 0.5rem;">
                                                    <input type="checkbox" 
                                                           id="prog${linea.id}_${objIdx}_${progIdx}" 
                                                           style="width: 18px; height: 18px; margin-top: 0.1rem; flex-shrink: 0;"
                                                           onchange="actualizarProgramasSeleccionados(${linea.id}, ${objIdx}, ${progIdx})">
                                                    <div style="flex: 1;">
                                                        <span class="tree-programa-codigo">${programa.codigo}</span>
                                                        ${programa.nombre}
                                                        <button class="epvsa-info-btn" onclick="event.stopPropagation(); mostrarInfoEPVSA('${programa.codigo}')">
                                                            ‚ÑπÔ∏è Ver detalles
                                                        </button>
                                                    </div>
                                                </div>
                                                <div style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                                    ${programa.actuaciones.map((act, actIdx) => `
                                                        <div class="tree-actuacion" style="display: flex; align-items: start; gap: 0.5rem; padding-left: 0rem;">
                                                            <input type="checkbox" 
                                                                   id="act${linea.id}_${objIdx}_${progIdx}_${actIdx}" 
                                                                   style="width: 16px; height: 16px; margin-top: 0.2rem; flex-shrink: 0;"
                                                                   onchange="actualizarResumenLineas(); validarSeleccion();">
                                                            <span style="flex: 1;">‚Ä¢ ${act}</span>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function toggleLineaExpand(lineaId) {
            const content = document.getElementById(`content${lineaId}`);
            const expand = document.getElementById(`expand${lineaId}`);
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                expand.classList.remove('expanded');
            } else {
                content.classList.add('show');
                expand.classList.add('expanded');
            }
        }

        function toggleLineaSeleccion(lineaId) {
            const lineaCheckbox = document.getElementById(`linea${lineaId}`);
            const isChecked = lineaCheckbox.checked;
            
            const linea = ESTRUCTURA_EPVSA.find(l => l.id === lineaId);
            if (!linea) return;
            
            const content = document.getElementById(`content${lineaId}`);
            const expand = document.getElementById(`expand${lineaId}`);
            
            if (isChecked) {
                content.classList.add('show');
                expand.classList.add('expanded');
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    const objContent = document.getElementById(`objContent${lineaId}_${objIdx}`);
                    const objToggle = document.getElementById(`toggleObj${lineaId}_${objIdx}`);
                    if (objContent && objToggle) {
                        objContent.classList.add('show');
                        objToggle.textContent = 'Ocultar ‚ñ≤';
                    }
                });
            } else {
                linea.objetivos.forEach((objetivo, objIdx) => {
                    const objCheckbox = document.getElementById(`obj${lineaId}_${objIdx}`);
                    if (objCheckbox) objCheckbox.checked = false;
                    
                    objetivo.indicadores.forEach((ind, indIdx) => {
                        const indCheckbox = document.getElementById(`ind${lineaId}_${objIdx}_${indIdx}`);
                        if (indCheckbox) indCheckbox.checked = false;
                    });
                    
                    objetivo.programas.forEach((programa, progIdx) => {
                        const progCheckbox = document.getElementById(`prog${lineaId}_${objIdx}_${progIdx}`);
                        if (progCheckbox) progCheckbox.checked = false;
                        
                        programa.actuaciones.forEach((act, actIdx) => {
                            const actCheckbox = document.getElementById(`act${lineaId}_${objIdx}_${progIdx}_${actIdx}`);
                            if (actCheckbox) actCheckbox.checked = false;
                        });
                    });
                });
            }
            
            actualizarResumenLineas();
            validarSeleccion();
        }

        function toggleObjetivoExpand(lineaId, objIdx) {
            const content = document.getElementById(`objContent${lineaId}_${objIdx}`);
            const toggle = document.getElementById(`toggleObj${lineaId}_${objIdx}`);
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                toggle.textContent = 'Ver m√°s ‚ñº';
            } else {
                content.classList.add('show');
                toggle.textContent = 'Ocultar ‚ñ≤';
            }
        }

        function actualizarProgramasSeleccionados(lineaId, objIdx, progIdx) {
            const linea = ESTRUCTURA_EPVSA.find(l => l.id === lineaId);
            if (!linea) return;
            
            const programa = linea.objetivos[objIdx].programas[progIdx];
            const progCheckbox = document.getElementById(`prog${lineaId}_${objIdx}_${progIdx}`);
            
            if (progCheckbox.checked) {
                if (!state.programasSeleccionados.includes(programa.codigo)) {
                    state.programasSeleccionados.push(programa.codigo);
                }
            } else {
                const index = state.programasSeleccionados.indexOf(programa.codigo);
                if (index > -1) {
                    state.programasSeleccionados.splice(index, 1);
                }
            }
            
            actualizarResumenLineas();
            actualizarEstadisticas();
            validarSeleccion();
        }

        function renderConclusionesResumen() {
            const container = document.getElementById('conclusionesResumen');
            container.innerHTML = CONCLUSIONES.map((c, idx) => `
                <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; margin-bottom: ${idx < CONCLUSIONES.length - 1 ? '0.75rem' : '0'}; border-radius: 0.5rem;">
                    <div style="display: flex; gap: 0.75rem; align-items: start;">
                        <div style="background: #10b981; color: white; width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 800; flex-shrink: 0;">
                            ${c.numero}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #059669; font-size: 0.95rem; margin-bottom: 0.25rem;">${c.titulo}</div>
                            <div style="color: #374151; font-size: 0.85rem; line-height: 1.6;">${c.texto}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderRecomendacionesResumen() {
            const container = document.getElementById('recomendacionesResumen');
            container.innerHTML = RECOMENDACIONES.map((r, idx) => `
                <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: ${idx < RECOMENDACIONES.length - 1 ? '0.75rem' : '0'}; border-radius: 0.5rem;">
                    <div style="display: flex; gap: 0.75rem; align-items: start;">
                        <div style="background: #f59e0b; color: white; width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 800; flex-shrink: 0;">
                            ${r.numero}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #d97706; font-size: 0.95rem; margin-bottom: 0.25rem;">${r.titulo}</div>
                            <div style="color: #374151; font-size: 0.85rem; line-height: 1.6;">${r.texto}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function mostrarIndicadoresExtraidos() {
            cambiarTab('indicadores');
        }

        function renderIndicadores() {
            const container = document.getElementById('indicadoresContainer');
            
            // Obtener indicadores del a√±o activo
            const anoActivo = state.anoActivoCuadro;
            const indicadores = state.cuadrosMandosAnuales[anoActivo] || INDICADORES_CMI;
            const categorias = [...new Set(indicadores.map(i => i.categoria))];
            
            // Contar indicadores completados
            const completados = indicadores.filter(i => i.dato && i.dato !== '-' && i.dato !== '‚Äî').length;
            
            let html = `
                <div class="alert alert-info" style="margin-bottom: 2rem;">
                    <span style="font-size: 1.5rem;">‚ÑπÔ∏è</span>
                    <div>
                        <strong>Cuadro de Mandos Integral ${anoActivo}</strong><br>
                        Estos son los 58 indicadores oficiales para el seguimiento y evaluaci√≥n de tu Plan Local de Salud.
                        ${anoActivo === 2024 ? 'Los datos del 2024 ya est√°n pre-rellenados. ' : ''}Puedes editarlos manualmente.
                        <br><strong>Completados: ${completados}/58</strong>
                    </div>
                </div>
            `;
            
            categorias.forEach(categoria => {
                const indicadoresCategoria = indicadores.filter(i => i.categoria === categoria);
                
                html += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #667eea; margin-bottom: 1rem; padding: 0.75rem; background: #f0f4ff; border-radius: 0.5rem;">
                            üìä ${categoria} (${indicadoresCategoria.length} indicadores)
                        </h3>
                        <div style="background: white; border: 2px solid #10b981; border-radius: 0.75rem; padding: 1.5rem;">
                            ${indicadoresCategoria.map(ind => `
                                <div style="background: #f9fafb; border-left: 4px solid #667eea; padding: 1rem; margin-bottom: 0.75rem; border-radius: 0.5rem; display: grid; grid-template-columns: 60px 1fr 120px 150px; gap: 1rem; align-items: center; font-size: 0.85rem;">
                                    <div style="font-weight: 700; color: #667eea; font-size: 1rem;">#${ind.numero}</div>
                                    <div style="color: #4b5563;">${ind.indicador}</div>
                                    <div style="font-weight: 700; color: #1f2937; text-align: right;">
                                        <input type="text" 
                                               value="${ind.dato}" 
                                               placeholder="-"
                                               style="width: 80px; padding: 0.25rem; border: 1px solid #e5e7eb; border-radius: 0.25rem; text-align: right;"
                                               onchange="actualizarIndicador(${ind.numero}, this.value);">
                                        <span style="margin-left: 0.25rem; color: #6b7280; font-size: 0.85rem;">${ind.unidad}</span>
                                    </div>
                                    <div style="color: #6b7280; font-size: 0.75rem; text-align: right;">${ind.fuente}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            html += `
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="exportarCuadroMandos()" style="margin-right: 1rem;">
                        üì• Exportar Cuadro ${anoActivo} a CSV
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function actualizarIndicador(numero, valor) {
            const anoActivo = state.anoActivoCuadro;
            const index = state.cuadrosMandosAnuales[anoActivo].findIndex(i => i.numero === numero);
            if (index !== -1) {
                state.cuadrosMandosAnuales[anoActivo][index].dato = valor;
                guardarEstado();
            }
        }

        function cambiarAnoCuadro(ano) {
            state.anoActivoCuadro = ano;
            
            // Crear cuadro para este a√±o si no existe
            if (!state.cuadrosMandosAnuales[ano]) {
                // Copiar estructura de INDICADORES_CMI pero sin datos
                state.cuadrosMandosAnuales[ano] = INDICADORES_CMI.map(ind => ({
                    ...ind,
                    dato: "-"
                }));
            }
            
            // Actualizar botones
            document.querySelectorAll('.year-btn').forEach(btn => {
                if (parseInt(btn.dataset.year) === ano) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Re-renderizar indicadores del a√±o seleccionado
            renderIndicadores();
            guardarEstado();
        }

        function exportarCuadroMandos() {
            const anoActivo = state.anoActivoCuadro;
            const datos = state.cuadrosMandosAnuales[anoActivo] || INDICADORES_CMI;
            const csv = 'N√∫mero,Indicador,Unidad,Dato,Fuente,Categor√≠a\n' + 
                datos.map(i => `${i.numero},"${i.indicador}",${i.unidad},${i.dato},${i.fuente},${i.categoria}`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Cuadro_Mandos_${anoActivo}_${state.municipio.nombre || 'Municipal'}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // AGENDAS ANUALES
        function renderEntornoSelector() {
            const container = document.getElementById('entornoSelector');
            container.innerHTML = ENTORNOS.map(ent => `
                <div class="entorno-card ${state.currentEntorno === ent.id ? 'active' : ''}"
                     onclick="cambiarEntorno('${ent.id}')">
                    <div class="entorno-icon">${ent.icono}</div>
                    <div class="entorno-name">${ent.nombre}</div>
                </div>
            `).join('');
        }

        function cambiarEntorno(entornoId) {
            state.currentEntorno = entornoId;
            renderEntornoSelector();
            renderAgendas();
        }

        function renderAgendas() {
            const container = document.getElementById('entornoContent');
            
            if (state.programasSeleccionados.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                        <div>
                            <strong>No hay programas seleccionados</strong><br>
                            Por favor, selecciona programas primero en el paso de L√≠neas Estrat√©gicas.
                        </div>
                    </div>
                `;
                return;
            }

            const entorno = ENTORNOS.find(e => e.id === state.currentEntorno);
            
            container.innerHTML = `
                <h3 style="color: #667eea; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    ${entorno.icono} Entorno ${entorno.nombre}
                </h3>

                <div class="year-tabs">
                    ${ANOS.map(year => `
                        <div class="year-tab ${state.currentYear === year ? 'active' : ''}"
                             onclick="cambiarYear(${year})">${year}</div>
                    `).join('')}
                </div>

                ${mostrarPlantillasActuaciones()}

                <div class="actividad-registro">
                    <h4 style="margin-bottom: 1.5rem; color: #667eea; display: flex; align-items: center; gap: 0.5rem;">
                        ‚ûï Registrar Nueva Actuaci√≥n - ${state.currentYear}
                    </h4>

                    <!-- INFORMACI√ìN B√ÅSICA -->
                    <div style="background: #f0f9ff; border: 2px solid #bae6fd; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h5 style="color: #0284c7; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üìù Informaci√≥n B√°sica
                        </h5>
                        <div class="input-group">
                            <label class="input-label">T√≠tulo de la Actuaci√≥n *</label>
                            <input type="text" id="inputTituloActuacion" class="input-field" 
                                   placeholder="Ej: Campa√±a de promoci√≥n de actividad f√≠sica">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Descripci√≥n Detallada *</label>
                            <textarea id="textActuacion" class="input-field" rows="3"
                                      placeholder="Describe la actuaci√≥n en detalle..."></textarea>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label class="input-label">Fecha de Inicio</label>
                                <input type="date" id="fechaInicioActuacion" class="input-field">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Fecha de Fin</label>
                                <input type="date" id="fechaFinActuacion" class="input-field">
                            </div>
                        </div>
                    </div>

                    <!-- RESPONSABLES -->
                    <div style="background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                        <h5 style="color: #16a34a; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            üë§ Responsables
                        </h5>
                        <div class="input-row">
                            <div class="input-group">
                                <label class="input-label">Responsable Principal *</label>
                                <input type="text" id="inputResponsablePrincipal" class="input-field" 
                                       placeholder="Nombre y cargo">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Entidad Responsable</label>
                                <input type="text" id="inputResponsableEntidad" class="input-field" 
                                       placeholder="Organismo o entidad">
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="agregarActuacion()" 
                            style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                        üíæ Guardar Actuaci√≥n
                    </button>
                </div>

                <div id="listaActuaciones" style="margin-top: 2rem;">
                    ${renderListaActuaciones()}
                </div>
            `;
        }

        function cambiarYear(year) {
            state.currentYear = year;
            renderAgendas();
        }

        function agregarActuacion() {
            const titulo = document.getElementById('inputTituloActuacion').value;
            const descripcion = document.getElementById('textActuacion').value;
            const fechaInicio = document.getElementById('fechaInicioActuacion').value;
            const fechaFin = document.getElementById('fechaFinActuacion').value;
            const responsablePrincipal = document.getElementById('inputResponsablePrincipal').value;
            const responsableEntidad = document.getElementById('inputResponsableEntidad').value;

            if (!titulo) {
                alert('‚ö†Ô∏è Por favor ingresa el T√≠tulo de la actuaci√≥n');
                return;
            }
            if (!descripcion) {
                alert('‚ö†Ô∏è Por favor ingresa la Descripci√≥n de la actuaci√≥n');
                return;
            }
            if (!responsablePrincipal) {
                alert('‚ö†Ô∏è Por favor ingresa el Responsable Principal');
                return;
            }

            const key = `${state.currentEntorno}-${state.currentYear}`;
            if (!state.actuaciones[key]) {
                state.actuaciones[key] = [];
            }

            state.actuaciones[key].push({
                id: Date.now(),
                titulo: titulo,
                descripcion: descripcion,
                fechaInicio: fechaInicio,
                fechaFin: fechaFin,
                responsablePrincipal: responsablePrincipal,
                responsableEntidad: responsableEntidad,
                entorno: state.currentEntorno,
                year: state.currentYear
            });

            renderAgendas();
            actualizarEstadisticas();
            validarActuaciones();
            
            alert('‚úÖ Actuaci√≥n guardada correctamente');
        }

        function renderListaActuaciones() {
            const key = `${state.currentEntorno}-${state.currentYear}`;
            const actuaciones = state.actuaciones[key] || [];

            if (actuaciones.length === 0) {
                return `<div class="alert alert-info">
                    <span style="font-size: 1.5rem;">‚ÑπÔ∏è</span>
                    <div>No hay actuaciones registradas para este entorno y a√±o.</div>
                </div>`;
            }

            return `
                <h4 style="margin-bottom: 1rem;">Actuaciones Registradas (${actuaciones.length})</h4>
                ${actuaciones.map(act => `
                    <div class="actividad-item" style="margin-bottom: 1.5rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; overflow: hidden;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 0.25rem;">
                                        ${act.titulo || 'Sin t√≠tulo'}
                                    </div>
                                </div>
                                <button class="btn btn-danger btn-small" onclick="eliminarActuacion(${act.id})" 
                                        style="background: rgba(255,255,255,0.2); border: none;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                        
                        <div style="padding: 1.5rem; background: white;">
                            ${act.descripcion ? `
                                <div style="margin-bottom: 1.5rem;">
                                    <h6 style="color: #667eea; font-weight: 700; margin-bottom: 0.5rem;">üìù Descripci√≥n</h6>
                                    <p style="color: #4b5563; line-height: 1.6;">${act.descripcion}</p>
                                </div>
                            ` : ''}

                            ${act.fechaInicio || act.fechaFin ? `
                                <div style="margin-bottom: 1.5rem; padding: 1rem; background: #f0f9ff; border-radius: 0.5rem;">
                                    <h6 style="color: #0284c7; font-weight: 700; margin-bottom: 0.75rem;">üìÖ Temporalidad</h6>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; font-size: 0.9rem;">
                                        ${act.fechaInicio ? `<div><strong>Inicio:</strong> ${act.fechaInicio}</div>` : ''}
                                        ${act.fechaFin ? `<div><strong>Fin:</strong> ${act.fechaFin}</div>` : ''}
                                    </div>
                                </div>
                            ` : ''}

                            ${act.responsablePrincipal || act.responsableEntidad ? `
                                <div style="padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
                                    <h6 style="color: #16a34a; font-weight: 700; margin-bottom: 0.75rem;">üë§ Responsables</h6>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.9rem;">
                                        ${act.responsablePrincipal ? `<div><strong>Principal:</strong> ${act.responsablePrincipal}</div>` : ''}
                                        ${act.responsableEntidad ? `<div><strong>Entidad:</strong> ${act.responsableEntidad}</div>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function eliminarActuacion(id) {
            const key = `${state.currentEntorno}-${state.currentYear}`;
            if (state.actuaciones[key]) {
                state.actuaciones[key] = state.actuaciones[key].filter(act => act.id !== id);
                renderAgendas();
                actualizarEstadisticas();
                validarActuaciones();
            }
        }

        function renderConclusiones() {
            const container = document.getElementById('conclusionesContainer');
            
            if (!state.perfilCargado) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                        <div>
                            <strong>Completa estos pasos primero:</strong><br>
                            1. Carga un Perfil de Salud (PDF) en Configuraci√≥n<br>
                            2. Selecciona objetivos y programas en L√≠neas Estrat√©gicas<br>
                            3. Vuelve aqu√≠ para descargar tu Plan de Acci√≥n en PDF
                        </div>
                    </div>
                `;
                return;
            }
            
            const totalActuaciones = Object.values(state.actuaciones).reduce((sum, arr) => sum + arr.length, 0);
            
            container.innerHTML = `
                <!-- PRIORIZACI√ìN -->
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; font-size: 1.5rem;">üéØ PRIORIZACI√ìN</h3>
                    <div style="font-size: 1.8rem; font-weight: 700; margin-bottom: 1rem;">${state.areaPrioritaria || 'Bienestar Emocional'}</div>
                    <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 1rem; font-weight: 600;">
                        üìÖ Sesi√≥n del Grupo-Motor: ${state.sesionGrupoMotor || 'Febrero de 2025'}
                    </div>
                </div>

                <!-- RESUMEN EJECUTIVO -->
                <div style="background: #f9fafb; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
                    <h2 style="color: #667eea; margin-bottom: 1.5rem;">üìä Resumen Ejecutivo del Plan</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center; border: 2px solid #667eea;">
                            <div style="font-size: 3rem; font-weight: 800; color: #667eea;" id="resumenLineas">0</div>
                            <div style="color: #6b7280; font-weight: 600;">L√≠neas Seleccionadas</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center; border: 2px solid #10b981;">
                            <div style="font-size: 3rem; font-weight: 800; color: #10b981;" id="resumenProgramas">0</div>
                            <div style="color: #6b7280; font-weight: 600;">Programas</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center; border: 2px solid #f59e0b;">
                            <div style="font-size: 3rem; font-weight: 800; color: #f59e0b;">${totalActuaciones}</div>
                            <div style="color: #6b7280; font-weight: 600;">Actuaciones</div>
                        </div>
                        <div style="background: white; padding: 1.5rem; border-radius: 0.75rem; text-align: center; border: 2px solid #ef4444;">
                            <div style="font-size: 3rem; font-weight: 800; color: #ef4444;">58</div>
                            <div style="color: #6b7280; font-weight: 600;">Indicadores CMI</div>
                        </div>
                    </div>
                </div>

                <!-- CONCLUSIONES -->
                <div style="background: white; border: 3px solid #10b981; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="color: #10b981; margin-bottom: 1.5rem; font-size: 1.5rem;">
                        ‚úÖ CONCLUSIONES DEL DIAGN√ìSTICO (${CONCLUSIONES.length})
                    </h3>
                    ${CONCLUSIONES.map(c => `
                        <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: #10b981; color: white; width: 3rem; height: 3rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 800;">
                                    ${c.numero}
                                </div>
                                <div style="font-weight: 700; color: #059669; font-size: 1.1rem;">${c.titulo}</div>
                            </div>
                            <div style="color: #374151; line-height: 1.8; padding-left: 4rem;">${c.texto}</div>
                        </div>
                    `).join('')}
                </div>

                <!-- RECOMENDACIONES -->
                <div style="background: white; border: 3px solid #f59e0b; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="color: #f59e0b; margin-bottom: 1.5rem; font-size: 1.5rem;">
                        üí° RECOMENDACIONES ESTRAT√âGICAS (${RECOMENDACIONES.length})
                    </h3>
                    ${RECOMENDACIONES.map(r => `
                        <div style="background: #fffbeb; border-left: 4px solid #f59e0b; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="background: #f59e0b; color: white; width: 3rem; height: 3rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 800;">
                                    ${r.numero}
                                </div>
                                <div style="font-weight: 700; color: #d97706; font-size: 1.1rem;">${r.titulo}</div>
                            </div>
                            <div style="color: #374151; line-height: 1.8; padding-left: 4rem;">${r.texto}</div>
                        </div>
                    `).join('')}
                </div>

                <!-- COMPILADOR FINAL - 3 DOCUMENTOS -->
                <div class="compile-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; margin-bottom: 2rem;">
                    <h3 style="color: white; font-size: 1.8rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 2.5rem;">üì¶</span>
                        Compilador de Plan Local de Salud Completo
                    </h3>
                    
                    <p style="color: white; margin-bottom: 1.5rem; line-height: 1.6; font-size: 1.05rem; opacity: 0.95;">
                        <strong>Genera un √∫nico PDF</strong> que integra los 3 documentos esenciales de tu Plan Local de Salud
                    </p>
                    
                    <div style="background: rgba(255,255,255,0.15); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 1.5rem;">
                        <div style="color: white; font-size: 1rem; line-height: 1.8;">
                            <strong style="font-size: 1.1rem;">üìã El Plan Local de Salud Completo incluye:</strong><br><br>
                            
                            <div style="margin-left: 1rem;">
                                <strong>1Ô∏è‚É£ Perfil de Salud Local</strong><br>
                                <span style="opacity: 0.9; font-size: 0.95rem;">‚Üí Documento PDF cargado con diagn√≥stico y 58 indicadores CMI</span><br><br>
                                
                                <strong>2Ô∏è‚É£ Plan de Acci√≥n Generado</strong><br>
                                <span style="opacity: 0.9; font-size: 0.95rem;">‚Üí L√≠neas estrat√©gicas, objetivos, indicadores, programas EPVSA y actuaciones seleccionadas</span><br><br>
                                
                                <strong>3Ô∏è‚É£ Agendas Anuales RELAS</strong><br>
                                <span style="opacity: 0.9; font-size: 0.95rem;">‚Üí Actuaciones registradas organizadas por entornos (Sanitario, Comunitario, Educativo-Laboral)</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-compile" onclick="generarPDFCompleto()" 
                            style="background: white; color: #667eea; border: 3px solid white; font-weight: 700; box-shadow: 0 6px 20px rgba(0,0,0,0.3); font-size: 1.1rem; padding: 1.25rem 2rem;">
                        <span style="font-size: 1.8rem;">üìÑ</span>
                        Descargar Plan Local de Salud Completo
                    </button>
                    
                    <p style="margin-top: 1.5rem; font-size: 0.9rem; color: rgba(255,255,255,0.9); font-style: italic; text-align: center;">
                        ‚ú® Documento profesional listo para presentar, aprobar e implementar
                    </p>
                </div>


            `;
            
            // Actualizar contadores en el resumen
            document.getElementById('resumenLineas').textContent = state.lineasEstrategicas.length;
            document.getElementById('resumenProgramas').textContent = state.programasSeleccionados.length;
        }

        function exportarInformeCompleto() {
            const municipio = state.municipio.nombre || 'Municipal';
            const fecha = new Date().toLocaleDateString('es-ES');
            
            const contenido = `
INFORME DE SALUD LOCAL - ${municipio.toUpperCase()}
Estrategia para una Vida Saludable en Andaluc√≠a (EPVSA) 2024-2030
Fecha de elaboraci√≥n: ${fecha}

================================================================================
EQUIPO ELABORADOR
================================================================================

Coordinador/a: ${state.equipo.coordinador || '-'}
T√©cnico/a Salud P√∫blica: ${state.equipo.tecnicoSalud || '-'}
Representante Municipal: ${state.equipo.representanteMunicipal || '-'}
Otros miembros: ${state.equipo.otrosMiembros || '-'}

================================================================================
PRIORIZACI√ìN
================================================================================

√Årea Prioritaria: ${state.areaPrioritaria || 'Bienestar Emocional'}
Sesi√≥n del Grupo-Motor: ${state.sesionGrupoMotor || 'Febrero de 2025'}

================================================================================
CONCLUSIONES DEL DIAGN√ìSTICO
================================================================================

${CONCLUSIONES.map(c => `[${c.numero}] ${c.titulo}\n${c.texto}`).join('\n\n')}

================================================================================
RECOMENDACIONES ESTRAT√âGICAS
================================================================================

${RECOMENDACIONES.map(r => `[${r.numero}] ${r.titulo}\n${r.texto}`).join('\n\n')}

================================================================================
CUADRO DE MANDOS INTEGRAL (58 INDICADORES)
================================================================================

${(state.indicadoresExtraidos.length > 0 ? state.indicadoresExtraidos : INDICADORES_CMI).map(i => 
`[${i.numero}] ${i.indicador}: ${i.dato} ${i.unidad} (${i.fuente})`
).join('\n')}

================================================================================
Documento generado autom√°ticamente por el Planificador EPVSA 2024-2030 v2.0
UGC Interniveles Prevenci√≥n, Promoci√≥n y Vigilancia de la Salud
`;

            const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Informe_Salud_${municipio.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
            link.click();
            
            alert('‚úÖ Informe completo exportado correctamente');
        }

        function imprimirInforme() {
            window.print();
        }

        function continuarAPlanificacion() {
            const nombre = document.getElementById('nombreMunicipio').value.trim();
            
            if (!nombre) {
                alert('‚ö†Ô∏è Por favor, ingresa el nombre del municipio antes de continuar.');
                return;
            }
            
            state.municipio.nombre = nombre;
            state.municipio.provincia = document.getElementById('provinciaMunicipio').value.trim();
            state.municipio.poblacion = parseInt(document.getElementById('poblacionMunicipio').value) || null;
            
            state.equipo.coordinador = document.getElementById('coordinador').value.trim();
            state.equipo.tecnicoSalud = document.getElementById('tecnicoSalud').value.trim();
            state.equipo.representanteMunicipal = document.getElementById('representanteMunicipal').value.trim();
            state.equipo.otrosMiembros = document.getElementById('otrosMiembros').value.trim();
            
            document.getElementById('headerTitle').innerHTML = `üéØ Plan Local de Salud - ${state.municipio.nombre}`;
            if (state.municipio.provincia) {
                document.getElementById('headerSubtitle').innerHTML = `${state.municipio.nombre}, ${state.municipio.provincia} ‚Ä¢ EPVSA 2024-2030`;
            } else {
                document.getElementById('headerSubtitle').innerHTML = `${state.municipio.nombre} ‚Ä¢ EPVSA 2024-2030`;
            }
            
            document.querySelector('[data-tab="configuracion"]').classList.add('completed');
            cambiarTab('lineas');
            
            setTimeout(() => {
                const areaPrioEl = document.getElementById('areaPrioritariaDisplay');
                if (areaPrioEl && state.areaPrioritaria) {
                    areaPrioEl.textContent = state.areaPrioritaria;
                }
            }, 100);
        }

        function guardarYGenerarPlan() {
            // Si ya hay un plan generado previamente, simplemente regenerar la vista y cambiar de tab
            if (state.planGenerado && state.planGenerado.length > 0) {
                console.log('Plan ya generado, regenerando vista...');
                
                // Calcular totales del plan existente
                let totalObjetivos = 0;
                let totalIndicadores = 0;
                let totalProgramas = 0;
                let totalActuaciones = 0;
                
                state.planGenerado.forEach(linea => {
                    totalObjetivos += linea.objetivos.length;
                    linea.objetivos.forEach(obj => {
                        totalIndicadores += obj.indicadores.length;
                        totalProgramas += obj.programas.length;
                        obj.programas.forEach(prog => {
                            totalActuaciones += prog.actuaciones.length;
                        });
                    });
                });
                
                // Mostrar confirmaci√≥n
                const confirmar = confirm(
                    `Ya tienes un Plan de Acci√≥n generado:\n\n` +
                    `üìä Contenido actual:\n` +
                    `‚Ä¢ ${state.planGenerado.length} L√≠neas Estrat√©gicas\n` +
                    `‚Ä¢ ${totalObjetivos} Objetivos Estrat√©gicos\n` +
                    `‚Ä¢ ${totalIndicadores} Indicadores\n` +
                    `‚Ä¢ ${totalProgramas} Programas EPVSA\n` +
                    `‚Ä¢ ${totalActuaciones} Actuaciones\n\n` +
                    `¬øDeseas regenerar el plan con las selecciones actuales?\n\n` +
                    `‚Ä¢ SI = Regenerar con selecciones actuales\n` +
                    `‚Ä¢ NO = Mantener el plan actual`
                );
                
                if (!confirmar) {
                    // Mantener el plan actual y solo cambiar de tab
                    cambiarTab('plan');
                    return;
                }
                // Si confirma, continuar con la regeneraci√≥n normal
            }
            
            // Recopilar elementos seleccionados del DOM
            let lineasSeleccionadas = [];
            
            ESTRUCTURA_EPVSA.forEach((linea) => {
                let lineaData = {
                    id: linea.id,
                    codigo: linea.codigo,
                    nombre: linea.nombre,
                    color: linea.color,
                    objetivos: []
                };
                
                let lineaTieneSeleccion = false;
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    const objCheckbox = document.getElementById(`obj${linea.id}_${objIdx}`);
                    
                    if (objCheckbox && objCheckbox.checked) {
                        let objetivoData = {
                            id: objetivo.id,
                            codigo: objetivo.codigo,
                            nombre: objetivo.nombre,
                            indicadores: [],
                            programas: []
                        };
                        
                        // Recopilar indicadores seleccionados
                        objetivo.indicadores.forEach((ind, indIdx) => {
                            const indCheckbox = document.getElementById(`ind${linea.id}_${objIdx}_${indIdx}`);
                            if (indCheckbox && indCheckbox.checked) {
                                objetivoData.indicadores.push(ind);
                            }
                        });
                        
                        // Recopilar programas y actuaciones seleccionados
                        objetivo.programas.forEach((programa, progIdx) => {
                            const progCheckbox = document.getElementById(`prog${linea.id}_${objIdx}_${progIdx}`);
                            if (progCheckbox && progCheckbox.checked) {
                                let programaData = {
                                    codigo: programa.codigo,
                                    nombre: programa.nombre,
                                    actuaciones: []
                                };
                                
                                programa.actuaciones.forEach((act, actIdx) => {
                                    const actCheckbox = document.getElementById(`act${linea.id}_${objIdx}_${progIdx}_${actIdx}`);
                                    if (actCheckbox && actCheckbox.checked) {
                                        programaData.actuaciones.push(act);
                                    }
                                });
                                
                                objetivoData.programas.push(programaData);
                            }
                        });
                        
                        lineaData.objetivos.push(objetivoData);
                        lineaTieneSeleccion = true;
                    }
                });
                
                if (lineaTieneSeleccion) {
                    lineasSeleccionadas.push(lineaData);
                }
            });
            
            if (lineasSeleccionadas.length === 0) {
                // Si no hay checkboxes marcados, verificar si existe un plan previo
                if (state.planGenerado && state.planGenerado.length > 0) {
                    console.log('No hay checkboxes marcados, pero existe plan previo. Usando plan existente.');
                    
                    // Calcular totales del plan existente
                    let totalObjetivos = 0;
                    let totalIndicadores = 0;
                    let totalProgramas = 0;
                    let totalActuaciones = 0;
                    
                    state.planGenerado.forEach(linea => {
                        totalObjetivos += linea.objetivos.length;
                        linea.objetivos.forEach(obj => {
                            totalIndicadores += obj.indicadores.length;
                            totalProgramas += obj.programas.length;
                            obj.programas.forEach(prog => {
                                totalActuaciones += prog.actuaciones.length;
                            });
                        });
                    });
                    
                    // Usar el plan existente y cambiar al tab
                    alert(`‚úÖ Mostrando tu Plan de Acci√≥n guardado\n\n` +
                          `üìä Contenido del Plan:\n` +
                          `‚Ä¢ ${state.planGenerado.length} L√≠neas Estrat√©gicas\n` +
                          `‚Ä¢ ${totalObjetivos} Objetivos Estrat√©gicos\n` +
                          `‚Ä¢ ${totalIndicadores} Indicadores\n` +
                          `‚Ä¢ ${totalProgramas} Programas EPVSA\n` +
                          `‚Ä¢ ${totalActuaciones} Actuaciones Seleccionadas`);
                    
                    cambiarTab('plan');
                    return;
                }
                
                // Si no hay checkboxes marcados ni plan previo, mostrar error
                alert('‚ö†Ô∏è Por favor, selecciona al menos un objetivo estrat√©gico para generar el Plan de Acci√≥n.\n\n' +
                      'Ve al tab "Selecci√≥n EPVSA" y marca las casillas de:\n' +
                      '‚Ä¢ Objetivos estrat√©gicos\n' +
                      '‚Ä¢ Indicadores\n' +
                      '‚Ä¢ Programas EPVSA\n' +
                      '‚Ä¢ Actuaciones');
                cambiarTab('lineas');
                return;
            }
            
            // Guardar en el estado
            state.planGenerado = lineasSeleccionadas;
            
            // Marcar tab como completado
            document.querySelector('[data-tab="lineas"]').classList.add('completed');
            
            // Calcular totales
            let totalObjetivos = 0;
            let totalIndicadores = 0;
            let totalProgramas = 0;
            let totalActuaciones = 0;
            
            lineasSeleccionadas.forEach(linea => {
                totalObjetivos += linea.objetivos.length;
                linea.objetivos.forEach(obj => {
                    totalIndicadores += obj.indicadores.length;
                    totalProgramas += obj.programas.length;
                    obj.programas.forEach(prog => {
                        totalActuaciones += prog.actuaciones.length;
                    });
                });
            });
            
            alert(`‚úÖ Plan de Acci√≥n generado correctamente\n\n` +
                  `üìä Resumen del Plan de Acci√≥n:\n` +
                  `‚Ä¢ ${lineasSeleccionadas.length} L√≠neas Estrat√©gicas\n` +
                  `‚Ä¢ ${totalObjetivos} Objetivos Estrat√©gicos\n` +
                  `‚Ä¢ ${totalIndicadores} Indicadores\n` +
                  `‚Ä¢ ${totalProgramas} Programas EPVSA\n` +
                  `‚Ä¢ ${totalActuaciones} Actuaciones Seleccionadas`);
            
            // Cambiar al tab del Plan
            cambiarTab('plan');
        }

        function generarPlanSilencioso() {
            // Versi√≥n silenciosa de guardarYGenerarPlan (sin alertas ni cambio de tab)
            let lineasSeleccionadas = [];
            
            ESTRUCTURA_EPVSA.forEach((linea) => {
                let lineaData = {
                    id: linea.id,
                    codigo: linea.codigo,
                    nombre: linea.nombre,
                    color: linea.color,
                    objetivos: []
                };
                
                let lineaTieneSeleccion = false;
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    const objCheckbox = document.getElementById(`obj${linea.id}_${objIdx}`);
                    
                    if (objCheckbox && objCheckbox.checked) {
                        let objetivoData = {
                            id: objetivo.id,
                            codigo: objetivo.codigo,
                            nombre: objetivo.nombre,
                            indicadores: [],
                            programas: []
                        };
                        
                        // Recopilar indicadores seleccionados
                        objetivo.indicadores.forEach((ind, indIdx) => {
                            const indCheckbox = document.getElementById(`ind${linea.id}_${objIdx}_${indIdx}`);
                            if (indCheckbox && indCheckbox.checked) {
                                objetivoData.indicadores.push(ind);
                            }
                        });
                        
                        // Recopilar programas y actuaciones seleccionados
                        objetivo.programas.forEach((programa, progIdx) => {
                            const progCheckbox = document.getElementById(`prog${linea.id}_${objIdx}_${progIdx}`);
                            if (progCheckbox && progCheckbox.checked) {
                                let programaData = {
                                    codigo: programa.codigo,
                                    nombre: programa.nombre,
                                    actuaciones: []
                                };
                                
                                programa.actuaciones.forEach((act, actIdx) => {
                                    const actCheckbox = document.getElementById(`act${linea.id}_${objIdx}_${progIdx}_${actIdx}`);
                                    if (actCheckbox && actCheckbox.checked) {
                                        programaData.actuaciones.push(act);
                                    }
                                });
                                
                                objetivoData.programas.push(programaData);
                            }
                        });
                        
                        lineaData.objetivos.push(objetivoData);
                        lineaTieneSeleccion = true;
                    }
                });
                
                if (lineaTieneSeleccion) {
                    lineasSeleccionadas.push(lineaData);
                }
            });
            
            // Guardar en el estado (sin alertas)
            state.planGenerado = lineasSeleccionadas;
            
            return lineasSeleccionadas.length > 0;
        }

        function renderPlanLocal() {
            const container = document.getElementById('planContainer');
            
            if (!state.planGenerado || state.planGenerado.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                        <div>
                            <strong>No hay plan generado</strong><br>
                            Por favor, vuelve al paso anterior y selecciona elementos de la EPVSA.
                        </div>
                    </div>
                `;
                return;
            }
            
            const municipio = state.municipio.nombre || 'Municipal';
            const fecha = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // Calcular totales
            let totalObjetivos = 0;
            let totalIndicadores = 0;
            let totalProgramas = 0;
            let totalActuaciones = 0;
            
            state.planGenerado.forEach(linea => {
                totalObjetivos += linea.objetivos.length;
                linea.objetivos.forEach(obj => {
                    totalIndicadores += obj.indicadores.length;
                    totalProgramas += obj.programas.length;
                    obj.programas.forEach(prog => {
                        totalActuaciones += prog.actuaciones.length;
                    });
                });
            });
            
            let html = `
                <!-- PORTADA DEL PLAN -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3rem; border-radius: 1rem; margin-bottom: 2rem; text-align: center;">
                    <h1 style="font-size: 2.5rem; margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                        üìã Plan de Acci√≥n Local en Salud
                    </h1>
                    <h2 style="font-size: 2rem; margin-bottom: 0.5rem;">${municipio}</h2>
                    <p style="font-size: 1.2rem; opacity: 0.95; margin-bottom: 1.5rem;">
                        ${state.municipio.provincia ? state.municipio.provincia : 'Andaluc√≠a'}
                    </p>
                    ${state.equipo.coordinador ? `
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; display: inline-block;">
                            <p style="font-size: 0.9rem; margin: 0;">
                                <strong>Coordinaci√≥n:</strong> ${state.equipo.coordinador}
                            </p>
                        </div>
                    ` : ''}
                    <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 0.5rem; display: inline-block;">
                        <p style="font-size: 1rem; margin: 0;">
                            En el marco de la Estrategia para una Vida Saludable en Andaluc√≠a (EPVSA) 2024-2030
                        </p>
                    </div>
                    <div style="margin-top: 1.5rem; font-size: 0.9rem; opacity: 0.9;">
                        üìÖ Fecha de elaboraci√≥n: ${fecha}
                    </div>
                </div>

                <!-- √ÅREA PRIORITARIA -->
                <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
                    <h3 style="font-size: 1.3rem; margin-bottom: 0.5rem; opacity: 0.9;">üéØ √ÅREA PRIORITARIA</h3>
                    <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;">
                        ${state.areaPrioritaria || 'Bienestar Emocional'}
                    </div>
                    <p style="font-size: 1rem; opacity: 0.95; line-height: 1.6;">
                        Establecida como eje central articulador del Plan de Acci√≥n en la sesi√≥n de priorizaci√≥n del Grupo-Motor (${state.sesionGrupoMotor || 'Febrero de 2025'})
                    </p>
                </div>

                <!-- RESUMEN EJECUTIVO -->
                <div style="background: white; border: 3px solid #667eea; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="color: #667eea; margin-bottom: 1.5rem; font-size: 1.5rem;">üìä Resumen Ejecutivo</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div style="text-align: center; padding: 1.5rem; background: #f0f4ff; border-radius: 0.75rem;">
                            <div style="font-size: 3rem; font-weight: 800; color: #667eea; line-height: 1;">${state.planGenerado.length}</div>
                            <div style="font-size: 0.9rem; color: #6b7280; font-weight: 600; margin-top: 0.5rem;">L√≠neas Estrat√©gicas</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: #f0fdf4; border-radius: 0.75rem;">
                            <div style="font-size: 3rem; font-weight: 800; color: #10b981; line-height: 1;">${totalObjetivos}</div>
                            <div style="font-size: 0.9rem; color: #6b7280; font-weight: 600; margin-top: 0.5rem;">Objetivos Estrat√©gicos</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: #fffbeb; border-radius: 0.75rem;">
                            <div style="font-size: 3rem; font-weight: 800; color: #f59e0b; line-height: 1;">${totalIndicadores}</div>
                            <div style="font-size: 0.9rem; color: #6b7280; font-weight: 600; margin-top: 0.5rem;">Indicadores</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: #fef2f2; border-radius: 0.75rem;">
                            <div style="font-size: 3rem; font-weight: 800; color: #ef4444; line-height: 1;">${totalProgramas}</div>
                            <div style="font-size: 0.9rem; color: #6b7280; font-weight: 600; margin-top: 0.5rem;">Programas EPVSA</div>
                        </div>
                        <div style="text-align: center; padding: 1.5rem; background: #faf5ff; border-radius: 0.75rem;">
                            <div style="font-size: 3rem; font-weight: 800; color: #8b5cf6; line-height: 1;">${totalActuaciones}</div>
                            <div style="font-size: 0.9rem; color: #6b7280; font-weight: 600; margin-top: 0.5rem;">Actuaciones</div>
                        </div>
                    </div>
                </div>

                <!-- ESTRUCTURA DEL PLAN -->
                <div style="background: white; border: 3px solid #10b981; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem;">
                    <h3 style="color: #10b981; margin-bottom: 1.5rem; font-size: 1.5rem;">üìã Estructura del Plan de Acci√≥n</h3>
                    
                    ${state.planGenerado.map((linea, lineaIdx) => `
                        <div style="margin-bottom: 3rem; ${lineaIdx < state.planGenerado.length - 1 ? 'padding-bottom: 3rem; border-bottom: 3px solid #e5e7eb;' : ''}">
                            <!-- L√çNEA ESTRAT√âGICA -->
                            <div style="background: ${linea.color}; color: white; padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem;">
                                <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem; font-weight: 600;">
                                    L√çNEA ESTRAT√âGICA ${linea.id}
                                </div>
                                <div style="font-size: 1.4rem; font-weight: 700; line-height: 1.4;">
                                    ${linea.nombre}
                                </div>
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid rgba(255,255,255,0.3); display: flex; gap: 2rem; font-size: 0.9rem;">
                                    <div><strong>${linea.objetivos.length}</strong> Objetivos</div>
                                    <div><strong>${linea.objetivos.reduce((sum, obj) => sum + obj.indicadores.length, 0)}</strong> Indicadores</div>
                                    <div><strong>${linea.objetivos.reduce((sum, obj) => sum + obj.programas.length, 0)}</strong> Programas</div>
                                </div>
                            </div>

                            <!-- OBJETIVOS -->
                            ${linea.objetivos.map((objetivo, objIdx) => `
                                <div style="margin-left: 2rem; margin-bottom: 2.5rem;">
                                    <!-- OBJETIVO ESTRAT√âGICO -->
                                    <div style="background: #f9fafb; border-left: 5px solid ${linea.color}; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                                        <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1rem;">
                                            <div style="background: ${linea.color}; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 800; font-size: 1rem; flex-shrink: 0;">
                                                ${objetivo.codigo}
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 700; color: #1f2937; font-size: 1.1rem; line-height: 1.5;">
                                                    ${objetivo.nombre}
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- INDICADORES -->
                                    ${objetivo.indicadores.length > 0 ? `
                                        <div style="margin-left: 2rem; margin-bottom: 1.5rem;">
                                            <div style="background: #dbeafe; padding: 1rem 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                                <h5 style="color: #1e40af; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                                    <span>üìä</span> Indicadores de Evaluaci√≥n (${objetivo.indicadores.length})
                                                </h5>
                                            </div>
                                            ${objetivo.indicadores.map((ind, indIdx) => `
                                                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem;">
                                                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                                                        <div style="background: #3b82f6; color: white; width: 2rem; height: 2rem; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 700; flex-shrink: 0;">
                                                            ${indIdx + 1}
                                                        </div>
                                                        <div style="flex: 1; color: #374151; font-size: 0.95rem; line-height: 1.6;">
                                                            ${ind}
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}

                                    <!-- PROGRAMAS Y ACTUACIONES -->
                                    ${objetivo.programas.length > 0 ? `
                                        <div style="margin-left: 2rem;">
                                            <div style="background: #fef3c7; padding: 1rem 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                                                <h5 style="color: #92400e; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                                    <span>üéØ</span> Programas EPVSA y Actuaciones (${objetivo.programas.length})
                                                </h5>
                                            </div>
                                            ${objetivo.programas.map((programa, progIdx) => `
                                                <div style="background: white; border: 3px solid #f59e0b; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem;">
                                                    <div style="margin-bottom: 1rem;">
                                                        <div style="display: inline-block; background: #f59e0b; color: white; padding: 0.35rem 0.85rem; border-radius: 9999px; font-size: 0.85rem; font-weight: 800; margin-bottom: 0.75rem;">
                                                            ${programa.codigo}
                                                        </div>
                                                        <div style="font-weight: 700; color: #92400e; font-size: 1.05rem; line-height: 1.5;">
                                                            ${programa.nombre}
                                                        </div>
                                                    </div>
                                                    
                                                    ${programa.actuaciones.length > 0 ? `
                                                        <div style="background: #fffbeb; padding: 1rem; border-radius: 0.5rem;">
                                                            <div style="font-weight: 600; color: #78350f; font-size: 0.9rem; margin-bottom: 0.75rem;">
                                                                Actuaciones Seleccionadas:
                                                            </div>
                                                            ${programa.actuaciones.map((act, actIdx) => `
                                                                <div style="display: flex; align-items: start; gap: 0.5rem; margin-bottom: 0.5rem; color: #78350f; font-size: 0.9rem; line-height: 1.6;">
                                                                    <span style="color: #f59e0b; font-weight: 700; flex-shrink: 0;">‚ñ∏</span>
                                                                    <span>${act}</span>
                                                                </div>
                                                            `).join('')}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `).join('')}
                </div>

                <!-- BOTONES DE EXPORTACI√ìN -->
                <div style="background: #f9fafb; padding: 2rem; border-radius: 1rem; margin-bottom: 2rem;">
                    <h4 style="color: #667eea; margin-bottom: 1.5rem;">üíæ Exportar Plan de Acci√≥n</h4>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="exportarPlanPDF()" style="padding: 1rem 2rem;">
                            üìÑ Exportar como PDF
                        </button>
                        <button class="btn btn-secondary" onclick="exportarPlanEditable()" style="padding: 1rem 2rem; background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);">
                            üìù Exportar Plan Editable (Texto)
                        </button>
                        <button class="btn btn-primary" onclick="imprimirPlan()" style="padding: 1rem 2rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            üñ®Ô∏è Imprimir
                        </button>
                    </div>
                    <p style="margin-top: 1rem; color: #6b7280; font-size: 0.9rem; text-align: center;">
                        El <strong>Plan Editable</strong> genera un archivo de texto estructurado que puedes copiar y pegar en Word, Google Docs o cualquier editor
                    </p>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Marcar tab como completado
            document.querySelector('[data-tab="plan"]').classList.add('completed');
        }

        function exportarPlanPDF() {
            console.log('Intentando exportar PDF...');
            console.log('Estado actual planGenerado:', state.planGenerado);
            
            // Si no hay plan generado, intentar generarlo autom√°ticamente
            if (!state.planGenerado || state.planGenerado.length === 0) {
                console.log('No hay plan generado, intentando generar autom√°ticamente...');
                const generado = generarPlanSilencioso();
                console.log('Resultado de generaci√≥n:', generado);
                console.log('Plan despu√©s de generar:', state.planGenerado);
            }
            
            // Verificar de nuevo despu√©s de generar
            if (!state.planGenerado || state.planGenerado.length === 0) {
                alert('‚ö†Ô∏è No se puede exportar el plan.\n\n' +
                      'Por favor, ve al tab "L√≠neas Estrat√©gicas" y:\n' +
                      '1. Selecciona al menos un objetivo estrat√©gico\n' +
                      '2. Selecciona al menos un programa EPVSA\n' +
                      '3. Selecciona al menos una actuaci√≥n\n\n' +
                      'Luego intenta exportar nuevamente.');
                cambiarTab('lineas');
                return;
            }
            
            console.log('Preparando para abrir ventana de impresi√≥n...');
            
            // Intentar abrir window.print() inmediatamente (sin setTimeout)
            try {
                console.log('Ejecutando window.print()...');
                window.print();
                console.log('window.print() ejecutado');
            } catch (error) {
                console.error('ERROR al ejecutar window.print():', error);
                alert('‚ùå No se pudo abrir la ventana de impresi√≥n.\n\n' +
                      'Por favor, usa el atajo de teclado:\n' +
                      '‚Ä¢ Windows/Linux: Ctrl + P\n' +
                      '‚Ä¢ Mac: Cmd + P\n\n' +
                      'O intenta con otro navegador.');
            }
        }

        function exportarPlanWord() {
            console.log('Intentando exportar Word...');
            console.log('Estado actual planGenerado:', state.planGenerado);
            
            // Si no hay plan generado, intentar generarlo autom√°ticamente
            if (!state.planGenerado || state.planGenerado.length === 0) {
                console.log('No hay plan generado, intentando generar autom√°ticamente...');
                const generado = generarPlanSilencioso();
                console.log('Resultado de generaci√≥n:', generado);
                console.log('Plan despu√©s de generar:', state.planGenerado);
            }
            
            // Verificar de nuevo despu√©s de generar
            if (!state.planGenerado || state.planGenerado.length === 0) {
                alert('‚ö†Ô∏è No se puede exportar el plan.\n\n' +
                      'Por favor, ve al tab "L√≠neas Estrat√©gicas" y:\n' +
                      '1. Selecciona al menos un objetivo estrat√©gico\n' +
                      '2. Selecciona al menos un programa EPVSA\n' +
                      '3. Selecciona al menos una actuaci√≥n\n\n' +
                      'Luego intenta exportar nuevamente.');
                cambiarTab('lineas');
                return;
            }
            
            console.log('Generando contenido del plan...');
            
            const municipio = state.municipio.nombre || 'Municipal';
            const fecha = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let contenido = `PLAN LOCAL DE SALUD - ${municipio.toUpperCase()}\n`;
            contenido += `${state.municipio.provincia ? state.municipio.provincia : 'Andaluc√≠a'}\n\n`;
            contenido += `En el marco de la Estrategia para una Vida Saludable en Andaluc√≠a (EPVSA) 2024-2030\n`;
            contenido += `Fecha de elaboraci√≥n: ${fecha}\n\n`;
            
            if (state.equipo.coordinador) {
                contenido += `EQUIPO ELABORADOR\n`;
                contenido += `Coordinador/a: ${state.equipo.coordinador}\n`;
                if (state.equipo.tecnicoSalud) contenido += `T√©cnico/a Salud P√∫blica: ${state.equipo.tecnicoSalud}\n`;
                if (state.equipo.representanteMunicipal) contenido += `Representante Municipal: ${state.equipo.representanteMunicipal}\n`;
                if (state.equipo.otrosMiembros) contenido += `Otros miembros: ${state.equipo.otrosMiembros}\n`;
                contenido += `\n`;
            }
            
            contenido += `${'='.repeat(80)}\n\n`;
            
            contenido += `√ÅREA PRIORITARIA\n\n`;
            contenido += `${state.areaPrioritaria || 'Bienestar Emocional'}\n\n`;
            contenido += `Establecida como eje central articulador del Plan de Acci√≥n en la sesi√≥n de\n`;
            contenido += `priorizaci√≥n del Grupo-Motor (${state.sesionGrupoMotor || 'Febrero de 2025'})\n\n`;
            contenido += `${'='.repeat(80)}\n\n`;
            
            state.planGenerado.forEach((linea, lineaIdx) => {
                contenido += `L√çNEA ESTRAT√âGICA ${linea.id}\n`;
                contenido += `${linea.nombre}\n\n`;
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    contenido += `  ${objetivo.codigo} - ${objetivo.nombre}\n\n`;
                    
                    if (objetivo.indicadores.length > 0) {
                        contenido += `    INDICADORES DE EVALUACI√ìN:\n`;
                        objetivo.indicadores.forEach((ind, indIdx) => {
                            contenido += `      ${indIdx + 1}. ${ind}\n`;
                        });
                        contenido += `\n`;
                    }
                    
                    if (objetivo.programas.length > 0) {
                        contenido += `    PROGRAMAS EPVSA:\n`;
                        objetivo.programas.forEach((programa, progIdx) => {
                            contenido += `      ${programa.codigo} - ${programa.nombre}\n`;
                            if (programa.actuaciones.length > 0) {
                                contenido += `        Actuaciones:\n`;
                                programa.actuaciones.forEach((act, actIdx) => {
                                    contenido += `          ‚Ä¢ ${act}\n`;
                                });
                            }
                            contenido += `\n`;
                        });
                    }
                    
                    contenido += `\n`;
                });
                
                contenido += `${'-'.repeat(80)}\n\n`;
            });
            
            console.log('Contenido generado. Longitud:', contenido.length, 'caracteres');
            console.log('Creando blob...');
            
            try {
                const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8;' });
                console.log('Blob creado:', blob);
                
                const nombreArchivo = `Plan_Local_Salud_${municipio.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
                console.log('Nombre del archivo:', nombreArchivo);
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nombreArchivo;
                
                console.log('Link creado:', link.href);
                console.log('Agregando link al documento...');
                
                // Agregar el link al documento temporalmente
                document.body.appendChild(link);
                
                console.log('Haciendo clic en el link...');
                link.click();
                
                console.log('Click ejecutado. Removiendo link...');
                
                // Remover el link despu√©s de un momento
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    console.log('Link removido y URL liberada');
                }, 100);
                
                alert('‚úÖ Plan exportado correctamente como archivo de texto.\n\nPuedes abrirlo en Word para darle formato adicional.');
                
            } catch (error) {
                console.error('ERROR al crear el archivo:', error);
                alert('‚ùå Error al crear el archivo de exportaci√≥n.\n\nError: ' + error.message + '\n\nPor favor, intenta de nuevo o contacta con soporte.');
            }
        }

        function imprimirPlan() {
            console.log('Intentando imprimir...');
            console.log('Estado actual planGenerado:', state.planGenerado);
            
            // Si no hay plan generado, intentar generarlo autom√°ticamente
            if (!state.planGenerado || state.planGenerado.length === 0) {
                console.log('No hay plan generado, intentando generar autom√°ticamente...');
                const generado = generarPlanSilencioso();
                console.log('Resultado de generaci√≥n:', generado);
                console.log('Plan despu√©s de generar:', state.planGenerado);
            }
            
            // Verificar de nuevo despu√©s de generar
            if (!state.planGenerado || state.planGenerado.length === 0) {
                alert('‚ö†Ô∏è No se puede imprimir el plan.\n\n' +
                      'Por favor, ve al tab "L√≠neas Estrat√©gicas" y:\n' +
                      '1. Selecciona al menos un objetivo estrat√©gico\n' +
                      '2. Selecciona al menos un programa EPVSA\n' +
                      '3. Selecciona al menos una actuaci√≥n\n\n' +
                      'Luego intenta imprimir nuevamente.');
                cambiarTab('lineas');
                return;
            }
            
            console.log('Preparando para abrir ventana de impresi√≥n...');
            
            // Intentar abrir window.print()
            try {
                console.log('Ejecutando window.print()...');
                window.print();
                console.log('window.print() ejecutado');
            } catch (error) {
                console.error('ERROR al ejecutar window.print():', error);
                alert('‚ùå No se pudo abrir la ventana de impresi√≥n.\n\n' +
                      'Por favor, usa el atajo de teclado:\n' +
                      '‚Ä¢ Windows/Linux: Ctrl + P\n' +
                      '‚Ä¢ Mac: Cmd + P\n\n' +
                      'O intenta con otro navegador.');
            }
        }

        function exportarPlanEditable() {
            console.log('Iniciando exportaci√≥n de plan editable...');
            
            // Si no hay plan generado, intentar generarlo autom√°ticamente
            if (!state.planGenerado || state.planGenerado.length === 0) {
                const generado = generarPlanSilencioso();
                if (!generado || !state.planGenerado || state.planGenerado.length === 0) {
                    alert('‚ö†Ô∏è No se puede exportar el plan.\n\n' +
                          'Por favor, ve al tab "Selecci√≥n EPVSA" y:\n' +
                          '1. Selecciona al menos un objetivo estrat√©gico\n' +
                          '2. Selecciona al menos un programa EPVSA\n' +
                          '3. Selecciona al menos una actuaci√≥n\n\n' +
                          'Luego intenta exportar nuevamente.');
                    cambiarTab('lineas');
                    return;
                }
            }
            
            // Generar contenido estructurado
            const municipio = state.municipio.nombre || 'Sin especificar';
            const provincia = state.municipio.provincia || 'Andaluc√≠a';
            const poblacion = state.municipio.poblacion || 'Sin especificar';
            const fecha = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let contenido = '';
            
            // ========== PORTADA ==========
            contenido += '‚ïê'.repeat(80) + '\n';
            contenido += 'PLAN LOCAL DE SALUD\n';
            contenido += `${municipio.toUpperCase()}\n`;
            contenido += `${provincia}\n`;
            contenido += '‚ïê'.repeat(80) + '\n\n';
            
            contenido += 'En el marco de:\n';
            contenido += 'ESTRATEGIA PARA UNA VIDA SALUDABLE EN ANDALUC√çA (EPVSA) 2024-2030\n\n';
            contenido += `Fecha de elaboraci√≥n: ${fecha}\n`;
            contenido += `Poblaci√≥n: ${poblacion} habitantes\n\n`;
            
            // ========== EQUIPO ELABORADOR ==========
            contenido += '‚îÄ'.repeat(80) + '\n';
            contenido += 'EQUIPO ELABORADOR DEL PLAN\n';
            contenido += '‚îÄ'.repeat(80) + '\n\n';
            
            if (state.equipo.coordinador) {
                contenido += `‚Ä¢ Coordinador/a: ${state.equipo.coordinador}\n`;
            }
            if (state.equipo.tecnicoSalud) {
                contenido += `‚Ä¢ T√©cnico/a de Salud P√∫blica: ${state.equipo.tecnicoSalud}\n`;
            }
            if (state.equipo.representanteMunicipal) {
                contenido += `‚Ä¢ Representante Municipal: ${state.equipo.representanteMunicipal}\n`;
            }
            if (state.equipo.otrosMiembros) {
                contenido += `‚Ä¢ Otros miembros: ${state.equipo.otrosMiembros}\n`;
            }
            
            if (!state.equipo.coordinador && !state.equipo.tecnicoSalud) {
                contenido += '(Equipo por determinar)\n';
            }
            contenido += '\n';
            
            // ========== √ÅREA PRIORITARIA ==========
            contenido += '‚ïê'.repeat(80) + '\n';
            contenido += '√ÅREA PRIORITARIA DE SALUD\n';
            contenido += '‚ïê'.repeat(80) + '\n\n';
            
            contenido += `üìå ${state.areaPrioritaria || 'Bienestar Emocional'}\n\n`;
            contenido += 'Establecida como eje central articulador del Plan de Acci√≥n\n';
            contenido += `en la sesi√≥n de priorizaci√≥n del Grupo-Motor.\n`;
            contenido += `Fecha de la sesi√≥n: ${state.sesionGrupoMotor || 'Febrero de 2025'}\n\n`;
            
            // ========== CONCLUSIONES DEL PERFIL DE SALUD ==========
            if (state.perfilCargado) {
                contenido += '‚ïê'.repeat(80) + '\n';
                contenido += 'CONCLUSIONES DEL PERFIL DE SALUD LOCAL\n';
                contenido += '‚ïê'.repeat(80) + '\n\n';
                
                CONCLUSIONES.forEach((c, idx) => {
                    contenido += `${c.numero}. ${c.titulo.toUpperCase()}\n`;
                    contenido += `${c.texto}\n\n`;
                });
                
                // ========== RECOMENDACIONES ==========
                contenido += '‚îÄ'.repeat(80) + '\n';
                contenido += 'RECOMENDACIONES ESTRAT√âGICAS\n';
                contenido += '‚îÄ'.repeat(80) + '\n\n';
                
                RECOMENDACIONES.forEach((r, idx) => {
                    contenido += `${r.numero}. ${r.titulo.toUpperCase()}\n`;
                    contenido += `${r.texto}\n\n`;
                });
            }
            
            // ========== PLAN DE ACCI√ìN ==========
            contenido += '‚ïê'.repeat(80) + '\n';
            contenido += 'PLAN DE ACCI√ìN - L√çNEAS ESTRAT√âGICAS EPVSA\n';
            contenido += '‚ïê'.repeat(80) + '\n\n';
            
            state.planGenerado.forEach((linea, lineaIdx) => {
                contenido += `\n${'‚ñì'.repeat(80)}\n`;
                contenido += `L√çNEA ESTRAT√âGICA ${linea.id}: ${linea.nombre.toUpperCase()}\n`;
                contenido += `${'‚ñì'.repeat(80)}\n\n`;
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    contenido += `‚îå${'‚îÄ'.repeat(78)}‚îê\n`;
                    contenido += `‚îÇ OBJETIVO ${objetivo.codigo}: ${objetivo.nombre}\n`;
                    contenido += `‚îî${'‚îÄ'.repeat(78)}‚îò\n\n`;
                    
                    // Indicadores
                    if (objetivo.indicadores && objetivo.indicadores.length > 0) {
                        contenido += `  üìä INDICADORES DE EVALUACI√ìN:\n`;
                        objetivo.indicadores.forEach((ind, indIdx) => {
                            contenido += `     ${indIdx + 1}. ${ind}\n`;
                        });
                        contenido += `\n`;
                    }
                    
                    // Programas EPVSA
                    if (objetivo.programas && objetivo.programas.length > 0) {
                        contenido += `  üéØ PROGRAMAS EPVSA SELECCIONADOS:\n\n`;
                        objetivo.programas.forEach((programa, progIdx) => {
                            contenido += `     ‚ñ∫ ${programa.codigo} - ${programa.nombre}\n\n`;
                            
                            // Actuaciones del programa
                            if (programa.actuaciones && programa.actuaciones.length > 0) {
                                contenido += `       ACTUACIONES:\n`;
                                programa.actuaciones.forEach((act, actIdx) => {
                                    contenido += `       ‚Ä¢ ${act}\n`;
                                });
                                contenido += `\n`;
                            }
                        });
                    }
                    
                    contenido += `\n`;
                });
                
                contenido += `${'‚ïê'.repeat(80)}\n`;
            });
            
            // ========== AGENDAS ANUALES RELAS ==========
            const totalActuaciones = Object.values(state.actuaciones).reduce((sum, arr) => sum + arr.length, 0);
            
            if (totalActuaciones > 0) {
                contenido += `\n\n`;
                contenido += '‚ïê'.repeat(80) + '\n';
                contenido += 'AGENDAS ANUALES - RED LOCAL DE ACCI√ìN EN SALUD (RELAS)\n';
                contenido += '‚ïê'.repeat(80) + '\n\n';
                
                contenido += `Total de actuaciones registradas: ${totalActuaciones}\n\n`;
                
                const entornos = [
                    { key: 'sanitario', nombre: 'ENTORNO SANITARIO', icono: 'üè•' },
                    { key: 'comunitario', nombre: 'ENTORNO COMUNITARIO', icono: 'üåç' },
                    { key: 'educativo', nombre: 'ENTORNO EDUCATIVO', icono: 'üéì' },
                    { key: 'laboral', nombre: 'ENTORNO LABORAL', icono: 'üíº' }
                ];
                
                entornos.forEach(entorno => {
                    const actuaciones = state.actuaciones[entorno.key] || [];
                    
                    if (actuaciones.length > 0) {
                        contenido += `\n${'‚ñì'.repeat(80)}\n`;
                        contenido += `${entorno.icono} ${entorno.nombre} (${actuaciones.length} actuaciones)\n`;
                        contenido += `${'‚ñì'.repeat(80)}\n\n`;
                        
                        actuaciones.forEach((act, idx) => {
                            contenido += `${idx + 1}. ${act.nombre}\n`;
                            if (act.descripcion) contenido += `   Descripci√≥n: ${act.descripcion}\n`;
                            if (act.responsable) contenido += `   Responsable: ${act.responsable}\n`;
                            if (act.fecha) contenido += `   Fecha prevista: ${act.fecha}\n`;
                            if (act.indicadores) contenido += `   Indicadores: ${act.indicadores}\n`;
                            contenido += `\n`;
                        });
                    }
                });
            }
            
            // ========== PIE DE DOCUMENTO ==========
            contenido += '\n\n' + '‚ïê'.repeat(80) + '\n';
            contenido += 'Documento generado con el Planificador EPVSA 2024-2030\n';
            contenido += `Fecha de generaci√≥n: ${new Date().toLocaleString('es-ES')}\n`;
            contenido += '‚ïê'.repeat(80) + '\n';
            
            // ========== EXPORTAR ARCHIVO ==========
            try {
                const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
                const nombreArchivo = `Plan_Local_Salud_${municipio.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nombreArchivo;
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }, 100);
                
                alert('‚úÖ Plan exportado correctamente\n\n' +
                      `Archivo: ${nombreArchivo}\n\n` +
                      'üí° Este archivo de texto est√° estructurado y listo para:\n' +
                      '‚Ä¢ Copiar y pegar en Microsoft Word\n' +
                      '‚Ä¢ Abrir en Google Docs\n' +
                      '‚Ä¢ Editar en cualquier procesador de texto\n\n' +
                      'Puedes darle el formato visual que prefieras manteniendo la estructura del contenido.');
                
            } catch (error) {
                console.error('Error al exportar:', error);
                alert('‚ùå Error al generar el archivo\n\n' +
                      `Detalles: ${error.message}\n\n` +
                      'Por favor, intenta de nuevo.');
            }
        }

        function exportarPlanWord() {
            console.log('Intentando exportar Word...');
            console.log('Estado actual planGenerado:', state.planGenerado);
            
            // Si no hay plan generado, intentar generarlo autom√°ticamente
            if (!state.planGenerado || state.planGenerado.length === 0) {
                console.log('No hay plan generado, intentando generar autom√°ticamente...');
                const generado = generarPlanSilencioso();
                console.log('Resultado de generaci√≥n:', generado);
                console.log('Plan despu√©s de generar:', state.planGenerado);
            }
            
            // Verificar de nuevo despu√©s de generar
            if (!state.planGenerado || state.planGenerado.length === 0) {
                alert('‚ö†Ô∏è No se puede exportar el plan.\n\n' +
                      'Por favor, ve al tab "L√≠neas Estrat√©gicas" y:\n' +
                      '1. Selecciona al menos un objetivo estrat√©gico\n' +
                      '2. Selecciona al menos un programa EPVSA\n' +
                      '3. Selecciona al menos una actuaci√≥n\n\n' +
                      'Luego intenta exportar nuevamente.');
                cambiarTab('lineas');
                return;
            }
            
            console.log('Generando contenido del plan...');
            
            const municipio = state.municipio.nombre || 'Municipal';
            const fecha = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
            
            let contenido = `PLAN LOCAL DE SALUD - ${municipio.toUpperCase()}\n`;
            contenido += `${state.municipio.provincia ? state.municipio.provincia : 'Andaluc√≠a'}\n\n`;
            contenido += `En el marco de la Estrategia para una Vida Saludable en Andaluc√≠a (EPVSA) 2024-2030\n`;
            contenido += `Fecha de elaboraci√≥n: ${fecha}\n\n`;
            
            if (state.equipo.coordinador) {
                contenido += `EQUIPO ELABORADOR\n`;
                contenido += `Coordinador/a: ${state.equipo.coordinador}\n`;
                if (state.equipo.tecnicoSalud) contenido += `T√©cnico/a Salud P√∫blica: ${state.equipo.tecnicoSalud}\n`;
                if (state.equipo.representanteMunicipal) contenido += `Representante Municipal: ${state.equipo.representanteMunicipal}\n`;
                if (state.equipo.otrosMiembros) contenido += `Otros miembros: ${state.equipo.otrosMiembros}\n`;
                contenido += `\n`;
            }
            
            contenido += `${'='.repeat(80)}\n\n`;
            
            contenido += `√ÅREA PRIORITARIA\n\n`;
            contenido += `${state.areaPrioritaria || 'Bienestar Emocional'}\n\n`;
            contenido += `Establecida como eje central articulador del Plan de Acci√≥n en la sesi√≥n de\n`;
            contenido += `priorizaci√≥n del Grupo-Motor (${state.sesionGrupoMotor || 'Febrero de 2025'})\n\n`;
            contenido += `${'='.repeat(80)}\n\n`;
            
            state.planGenerado.forEach((linea, lineaIdx) => {
                contenido += `L√çNEA ESTRAT√âGICA ${linea.id}\n`;
                contenido += `${linea.nombre}\n\n`;
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    contenido += `  ${objetivo.codigo} - ${objetivo.nombre}\n\n`;
                    
                    if (objetivo.indicadores.length > 0) {
                        contenido += `    INDICADORES DE EVALUACI√ìN:\n`;
                        objetivo.indicadores.forEach((ind, indIdx) => {
                            contenido += `      ${indIdx + 1}. ${ind}\n`;
                        });
                        contenido += `\n`;
                    }
                    
                    if (objetivo.programas.length > 0) {
                        contenido += `    PROGRAMAS EPVSA:\n`;
                        objetivo.programas.forEach((programa, progIdx) => {
                            contenido += `      ${programa.codigo} - ${programa.nombre}\n`;
                            if (programa.actuaciones.length > 0) {
                                contenido += `        Actuaciones:\n`;
                                programa.actuaciones.forEach((act, actIdx) => {
                                    contenido += `          ‚Ä¢ ${act}\n`;
                                });
                            }
                            contenido += `\n`;
                        });
                    }
                    
                    contenido += `\n`;
                });
                
                contenido += `${'-'.repeat(80)}\n\n`;
            });
            
            console.log('Contenido generado. Longitud:', contenido.length, 'caracteres');
            console.log('Creando blob...');
            
            try {
                const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8;' });
                console.log('Blob creado:', blob);
                
                const nombreArchivo = `Plan_Local_Salud_${municipio.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
                console.log('Nombre del archivo:', nombreArchivo);
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nombreArchivo;
                
                console.log('Link creado:', link.href);
                console.log('Agregando link al documento...');
                
                // Agregar el link al documento temporalmente
                document.body.appendChild(link);
                
                console.log('Haciendo clic en el link...');
                link.click();
                
                console.log('Click ejecutado. Removiendo link...');
                
                // Remover el link despu√©s de un momento
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    console.log('Link removido y URL liberada');
                }, 100);
                
                alert('‚úÖ Plan exportado correctamente como archivo de texto.\n\nPuedes abrirlo en Word para darle formato adicional.');
                
            } catch (error) {
                console.error('ERROR al crear el archivo:', error);
                alert('‚ùå Error al crear el archivo de exportaci√≥n.\n\nError: ' + error.message + '\n\nPor favor, intenta de nuevo o contacta con soporte.');
            }
        }

        function imprimirPlan() {
            console.log('Intentando imprimir...');
            console.log('Estado actual planGenerado:', state.planGenerado);
            
            // Si no hay plan generado, intentar generarlo autom√°ticamente
            if (!state.planGenerado || state.planGenerado.length === 0) {
                console.log('No hay plan generado, intentando generar autom√°ticamente...');
                const generado = generarPlanSilencioso();
                console.log('Resultado de generaci√≥n:', generado);
                console.log('Plan despu√©s de generar:', state.planGenerado);
            }
            
            // Verificar de nuevo despu√©s de generar
            if (!state.planGenerado || state.planGenerado.length === 0) {
                alert('‚ö†Ô∏è No se puede imprimir el plan.\n\n' +
                      'Por favor, ve al tab "L√≠neas Estrat√©gicas" y:\n' +
                      '1. Selecciona al menos un objetivo estrat√©gico\n' +
                      '2. Selecciona al menos un programa EPVSA\n' +
                      '3. Selecciona al menos una actuaci√≥n\n\n' +
                      'Luego intenta imprimir nuevamente.');
                cambiarTab('lineas');
                return;
            }
            
            window.print();
        }

        function actualizarResumenLineas() {
            let lineasCount = 0;
            let objetivosCount = 0;
            let indicadoresCount = 0;
            let programasCount = 0;
            let actuacionesCount = 0;
            
            ESTRUCTURA_EPVSA.forEach((linea) => {
                // Verificar si hay algo seleccionado en esta l√≠nea
                let tieneSeleccion = false;
                
                linea.objetivos.forEach((objetivo, objIdx) => {
                    const objCheckbox = document.getElementById(`obj${linea.id}_${objIdx}`);
                    if (objCheckbox && objCheckbox.checked) {
                        objetivosCount++;
                        tieneSeleccion = true;
                    }
                    
                    objetivo.indicadores.forEach((ind, indIdx) => {
                        const indCheckbox = document.getElementById(`ind${linea.id}_${objIdx}_${indIdx}`);
                        if (indCheckbox && indCheckbox.checked) {
                            indicadoresCount++;
                            tieneSeleccion = true;
                        }
                    });
                    
                    objetivo.programas.forEach((programa, progIdx) => {
                        const progCheckbox = document.getElementById(`prog${linea.id}_${objIdx}_${progIdx}`);
                        if (progCheckbox && progCheckbox.checked) {
                            programasCount++;
                            tieneSeleccion = true;
                        }
                        
                        programa.actuaciones.forEach((act, actIdx) => {
                            const actCheckbox = document.getElementById(`act${linea.id}_${objIdx}_${progIdx}_${actIdx}`);
                            if (actCheckbox && actCheckbox.checked) {
                                actuacionesCount++;
                                tieneSeleccion = true;
                            }
                        });
                    });
                });
                
                // Marcar o desmarcar el checkbox de la l√≠nea seg√∫n si tiene selecci√≥n
                const lineaCheckbox = document.getElementById(`linea${linea.id}`);
                if (lineaCheckbox) {
                    lineaCheckbox.checked = tieneSeleccion;
                    if (tieneSeleccion) lineasCount++;
                }
            });
            
            // Actualizar estado
            state.lineasEstrategicas = Array.from({length: lineasCount}, (_, i) => i + 1);
            
            const resumenEl = document.getElementById('resumenLineas');
            if (resumenEl) {
                resumenEl.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 800; color: #667eea;">${lineasCount}</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">L√≠neas</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 800; color: #10b981;">${objetivosCount}</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Objetivos</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 800; color: #f59e0b;">${indicadoresCount}</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Indicadores</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 800; color: #ef4444;">${programasCount}</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Programas</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 800; color: #8b5cf6;">${actuacionesCount}</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">Actuaciones</div>
                        </div>
                    </div>
                `;
            }
            
            actualizarEstadisticas();
        }

        function actualizarEstadisticas() {
            document.getElementById('statProgramas').textContent = state.programasSeleccionados.length;
            
            const totalActuaciones = Object.values(state.actuaciones).reduce((sum, arr) => sum + arr.length, 0);
            document.getElementById('statActuaciones').textContent = totalActuaciones;
        }

        // ========== COMPILADOR DE DOCUMENTOS WORD ==========
        


        // ========== FUNCI√ìN PARA GENERAR PDF DE SELECCIONES ==========
        async function generarPDFSelecciones() {
            console.log('üîÑ Iniciando generaci√≥n de PDF...');
            
            const btn = event.target;
            const textoOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Generando PDF...';
            
            try {
                // VALIDACI√ìN 1: Verificar que jsPDF est√° disponible
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('La librer√≠a jsPDF no est√° cargada. Por favor, recarga la p√°gina.');
                }
                
                console.log('‚úÖ jsPDF disponible');
                
                // VALIDACI√ìN 2: Verificar que hay selecciones
                if (!state.planGenerado || state.planGenerado.length === 0) {
                    alert('‚ö†Ô∏è No hay selecciones para exportar.\n\nPor favor:\n1. Ve al tab "L√≠neas Estrat√©gicas"\n2. Marca al menos un objetivo\n3. Marca al menos un programa\n4. Marca al menos una actuaci√≥n\n\nLuego vuelve aqu√≠ para generar el PDF.');
                    btn.disabled = false;
                    btn.innerHTML = textoOriginal;
                    return;
                }
                
                console.log('‚úÖ Selecciones encontradas:', state.planGenerado.length, 'l√≠neas');
                
                // Crear el PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                console.log('‚úÖ Documento PDF creado');
                
                let yPos = 20;
                const margen = 20;
                const anchoMaximo = 170;
                const altoLinea = 7;
                
                // Funci√≥n auxiliar para a√±adir texto
                const agregarTexto = (texto, fontSize, negrita = false, color = [0, 0, 0]) => {
                    doc.setFontSize(fontSize);
                    doc.setTextColor(color[0], color[1], color[2]);
                    doc.setFont(undefined, negrita ? 'bold' : 'normal');
                    
                    const lineas = doc.splitTextToSize(texto, anchoMaximo);
                    
                    lineas.forEach(linea => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(linea, margen, yPos);
                        yPos += altoLinea;
                    });
                };
                
                const agregarEspacio = (cantidad = 1) => {
                    yPos += altoLinea * cantidad;
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                };
                
                // === PORTADA ===
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text('PLAN LOCAL DE SALUD', 105, yPos, { align: 'center' });
                yPos += 15;
                
                doc.setFontSize(18);
                doc.setTextColor(118, 75, 162);
                doc.text('Selecci√≥n EPVSA 2024-2030', 105, yPos, { align: 'center' });
                yPos += 20;
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const nombreMunicipio = state.municipio.nombre || 'Municipio';
                doc.text(nombreMunicipio, 105, yPos, { align: 'center' });
                yPos += 10;
                
                if (state.municipio.provincia) {
                    doc.setFontSize(12);
                    doc.text(state.municipio.provincia, 105, yPos, { align: 'center' });
                    yPos += 8;
                }
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                const fecha = new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                doc.text(fecha, 105, yPos, { align: 'center' });
                yPos += 20;
                
                // √Årea prioritaria si existe
                if (state.areaPrioritaria) {
                    agregarEspacio(2);
                    doc.setFillColor(245, 87, 108);
                    doc.rect(margen, yPos - 5, anchoMaximo, 12, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('√ÅREA PRIORITARIA', margen + 3, yPos);
                    yPos += 7;
                    doc.setFontSize(11);
                    doc.text(state.areaPrioritaria, margen + 3, yPos);
                    yPos += 10;
                }
                
                console.log('‚úÖ Portada creada');
                
                // Nueva p√°gina para contenido
                doc.addPage();
                yPos = 20;
                
                // === CONTENIDO ===
                agregarTexto('SELECCI√ìN DE L√çNEAS ESTRAT√âGICAS Y PROGRAMAS', 16, true, [102, 126, 234]);
                agregarEspacio(1);
                
                console.log('üìù Generando contenido de', state.planGenerado.length, 'l√≠neas...');
                
                state.planGenerado.forEach((linea, idxLinea) => {
                    console.log('  Procesando l√≠nea', linea.id);
                    
                    // L√≠nea estrat√©gica
                    agregarEspacio(1);
                    doc.setFillColor(240, 240, 250);
                    doc.rect(margen - 2, yPos - 5, anchoMaximo + 4, 8, 'F');
                    agregarTexto(`L√çNEA ${linea.id}: ${linea.nombre.toUpperCase()}`, 13, true, [102, 126, 234]);
                    agregarEspacio(0.5);
                    
                    // Objetivos
                    linea.objetivos.forEach((objetivo, idxObj) => {
                        agregarTexto(`${objetivo.codigo} ${objetivo.nombre}`, 11, true, [0, 0, 0]);
                        
                        // Indicadores
                        if (objetivo.indicadores && objetivo.indicadores.length > 0) {
                            agregarTexto('Indicadores de Evaluaci√≥n:', 9, true, [80, 80, 80]);
                            objetivo.indicadores.forEach(indicador => {
                                agregarTexto(`  ‚Ä¢ ${indicador}`, 9, false, [60, 60, 60]);
                            });
                            agregarEspacio(0.3);
                        }
                        
                        // Programas
                        if (objetivo.programas && objetivo.programas.length > 0) {
                            agregarTexto('Programas EPVSA:', 9, true, [16, 185, 129]);
                            objetivo.programas.forEach(programa => {
                                agregarTexto(`  ${programa.codigo} - ${programa.nombre}`, 9, true, [16, 185, 129]);
                                
                                // Actuaciones
                                if (programa.actuaciones && programa.actuaciones.length > 0) {
                                    agregarTexto('    Actuaciones:', 8, false, [80, 80, 80]);
                                    programa.actuaciones.forEach(actuacion => {
                                        agregarTexto(`      ‚óã ${actuacion}`, 8, false, [60, 60, 60]);
                                    });
                                }
                                agregarEspacio(0.3);
                            });
                        }
                        
                        agregarEspacio(0.5);
                    });
                    
                    agregarEspacio(1);
                });
                
                console.log('‚úÖ Contenido generado');
                
                // Pie de p√°gina
                const totalPaginas = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPaginas; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`P√°gina ${i} de ${totalPaginas}`, 105, 290, { align: 'center' });
                    doc.text('Planificador EPVSA 2024-2030', margen, 290);
                }
                
                console.log('‚úÖ Pie de p√°gina a√±adido');
                
                // Guardar el PDF
                const fechaArchivo = new Date().toISOString().split('T')[0];
                const nombreArchivo = `Plan_Salud_${nombreMunicipio.replace(/\s+/g, '_')}_${fechaArchivo}.pdf`;
                
                console.log('üíæ Guardando PDF:', nombreArchivo);
                doc.save(nombreArchivo);
                console.log('‚úÖ PDF guardado');
                
                // Mensaje de √©xito
                setTimeout(() => {
                    alert(`‚úÖ PDF generado exitosamente!\n\nArchivo: ${nombreArchivo}\n\nP√°ginas: ${totalPaginas}\n\nEl documento incluye todas tus selecciones de l√≠neas estrat√©gicas, objetivos, programas y actuaciones.\n\nAhora puedes combinar este PDF con tu Perfil de Salud usando iLovePDF.com`);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error al generar PDF:', error);
                console.error('Stack:', error.stack);
                alert(`‚ùå Error al generar el PDF:\n\n${error.message}\n\nDetalles en la consola del navegador (presiona F12).`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = textoOriginal;
            }
        }

        // ========== NUEVA FUNCI√ìN: GENERAR AGENDA RELAS ==========
        async function generarAgendaRELAS() {
            console.log('üîÑ Iniciando generaci√≥n de Agenda RELAS...');
            
            const btn = event.target;
            const textoOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Generando Agenda...';
            
            try {
                // VALIDACI√ìN: Verificar que jsPDF est√° disponible
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('La librer√≠a jsPDF no est√° cargada. Por favor, recarga la p√°gina.');
                }
                
                // Verificar que hay actuaciones registradas
                const totalActuaciones = Object.values(state.actuaciones).reduce((sum, arr) => sum + arr.length, 0);
                
                if (totalActuaciones === 0) {
                    alert('‚ö†Ô∏è No hay actuaciones RELAS registradas.\n\nPor favor:\n1. Registra al menos una actuaci√≥n en la secci√≥n de Agendas Anuales\n2. Vuelve aqu√≠ para generar la Agenda');
                    btn.disabled = false;
                    btn.innerHTML = textoOriginal;
                    return;
                }
                
                console.log('‚úÖ Actuaciones encontradas:', totalActuaciones);
                
                // Crear el PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                let yPos = 20;
                const margen = 20;
                const anchoMaximo = 170;
                const altoLinea = 6;
                
                // Funci√≥n auxiliar para a√±adir texto
                const agregarTexto = (texto, fontSize, negrita = false, color = [0, 0, 0]) => {
                    doc.setFontSize(fontSize);
                    doc.setTextColor(color[0], color[1], color[2]);
                    doc.setFont(undefined, negrita ? 'bold' : 'normal');
                    
                    const lineas = doc.splitTextToSize(texto, anchoMaximo);
                    
                    lineas.forEach(linea => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(linea, margen, yPos);
                        yPos += altoLinea;
                    });
                };
                
                const agregarEspacio = (cantidad = 1) => {
                    yPos += altoLinea * cantidad;
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                };
                
                // === PORTADA ===
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(16, 185, 129);
                doc.text('AGENDAS ANUALES RELAS', 105, yPos, { align: 'center' });
                yPos += 15;
                
                doc.setFontSize(16);
                doc.setTextColor(102, 126, 234);
                doc.text('Red de Acci√≥n Local en Salud', 105, yPos, { align: 'center' });
                yPos += 20;
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const nombreMunicipio = state.municipio.nombre || 'Municipio';
                doc.text(nombreMunicipio, 105, yPos, { align: 'center' });
                yPos += 10;
                
                if (state.municipio.provincia) {
                    doc.setFontSize(12);
                    doc.text(state.municipio.provincia, 105, yPos, { align: 'center' });
                    yPos += 8;
                }
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                const fecha = new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                doc.text(fecha, 105, yPos, { align: 'center' });
                yPos += 30;
                
                // Nueva p√°gina para contenido
                doc.addPage();
                yPos = 20;
                
                // === ACTUACIONES POR A√ëO Y ENTORNO ===
                agregarTexto('ACTUACIONES RELAS 2024-2030', 18, true, [16, 185, 129]);
                agregarTexto('Organizadas por a√±o y entorno', 11, false, [100, 100, 100]);
                agregarEspacio(2);
                
                const anos = [2024, 2025, 2026, 2027, 2028, 2029, 2030];
                const entornos = [
                    { key: 'sanitario', nombre: 'ENTORNO SANITARIO', icono: 'üè•', color: [59, 130, 246] },
                    { key: 'comunitario', nombre: 'ENTORNO COMUNITARIO', icono: 'üåç', color: [16, 185, 129] },
                    { key: 'educativo', nombre: 'ENTORNO EDUCATIVO', icono: 'üéì', color: [245, 158, 11] },
                    { key: 'laboral', nombre: 'ENTORNO LABORAL', icono: 'üíº', color: [139, 92, 246] }
                ];
                
                // Iterar por cada a√±o
                anos.forEach(ano => {
                    let tieneActuacionesEnAno = false;
                    
                    // Verificar si hay actuaciones en este a√±o
                    entornos.forEach(entorno => {
                        const key = `${entorno.key}-${ano}`;
                        const actuaciones = state.actuaciones[key] || [];
                        if (actuaciones.length > 0) {
                            tieneActuacionesEnAno = true;
                        }
                    });
                    
                    // Si hay actuaciones, mostrar el a√±o
                    if (tieneActuacionesEnAno) {
                        agregarEspacio(2);
                        doc.setFillColor(102, 126, 234);
                        doc.rect(margen - 2, yPos - 5, anchoMaximo + 4, 12, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(16);
                        doc.setFont(undefined, 'bold');
                        doc.text(`üìÖ A√ëO ${ano}`, margen + 3, yPos + 3);
                        yPos += 14;
                        doc.setTextColor(0, 0, 0);
                        
                        // Mostrar actuaciones por entorno dentro del a√±o
                        entornos.forEach(entorno => {
                            const key = `${entorno.key}-${ano}`;
                            const actuaciones = state.actuaciones[key] || [];
                            
                            if (actuaciones.length > 0) {
                                agregarEspacio(1);
                                
                                // T√≠tulo del entorno
                                doc.setFillColor(240, 240, 250);
                                doc.rect(margen - 2, yPos - 5, anchoMaximo + 4, 10, 'F');
                                agregarTexto(`${entorno.icono} ${entorno.nombre} (${actuaciones.length} actuaciones)`, 12, true, entorno.color);
                                agregarEspacio(0.5);
                                
                                // Listar actuaciones
                                actuaciones.forEach((act, idx) => {
                                    agregarTexto(`${idx + 1}. ${act.titulo || act.nombre}`, 10, true, [0, 0, 0]);
                                    
                                    if (act.descripcion) {
                                        agregarTexto(`   Descripci√≥n: ${act.descripcion}`, 9, false, [60, 60, 60]);
                                    }
                                    
                                    if (act.responsablePrincipal) {
                                        agregarTexto(`   Responsable: ${act.responsablePrincipal}`, 9, false, [60, 60, 60]);
                                    }
                                    
                                    if (act.responsableEntidad) {
                                        agregarTexto(`   Entidad: ${act.responsableEntidad}`, 9, false, [60, 60, 60]);
                                    }
                                    
                                    if (act.fechaInicio || act.fechaFin) {
                                        const periodo = act.fechaInicio && act.fechaFin ? `${act.fechaInicio} - ${act.fechaFin}` : (act.fechaInicio || act.fechaFin);
                                        agregarTexto(`   Periodo: ${periodo}`, 9, false, [60, 60, 60]);
                                    }
                                    
                                    agregarEspacio(0.4);
                                });
                                
                                agregarEspacio(0.5);
                            }
                        });
                    }
                });
                
                // Resumen final
                agregarEspacio(2);
                doc.setFillColor(240, 253, 244);
                doc.rect(margen - 2, yPos - 3, anchoMaximo + 4, 15, 'F');
                agregarTexto(`TOTAL DE ACTUACIONES REGISTRADAS: ${totalActuaciones}`, 12, true, [16, 185, 129]);
                
                // Pie de p√°gina
                const totalPaginas = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPaginas; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`P√°gina ${i} de ${totalPaginas}`, 105, 290, { align: 'center' });
                    doc.text('Agendas RELAS - Planificador EPVSA 2024-2030', margen, 290);
                }
                
                // Guardar el PDF
                const fechaArchivo = new Date().toISOString().split('T')[0];
                const nombreArchivo = `Agendas_RELAS_${nombreMunicipio.replace(/\s+/g, '_')}_${fechaArchivo}.pdf`;
                
                console.log('üíæ Guardando Agenda:', nombreArchivo);
                doc.save(nombreArchivo);
                console.log('‚úÖ Agenda guardada');
                
                // Mensaje de √©xito
                setTimeout(() => {
                    alert(`‚úÖ Agendas RELAS generadas exitosamente!\n\nArchivo: ${nombreArchivo}\n\nTotal de actuaciones: ${totalActuaciones}\nP√°ginas: ${totalPaginas}\n\nEl documento incluye todas las actuaciones registradas organizadas por a√±o (2024-2030) y por entorno.`);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error al generar Agenda:', error);
                alert(`‚ùå Error al generar la Agenda:\n\n${error.message}\n\nDetalles en la consola del navegador (presiona F12).`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = textoOriginal;
            }
        }

        // ========== NUEVA FUNCI√ìN: GENERAR PDF COMPLETO (3 DOCUMENTOS) ==========
        async function generarPDFCompleto() {
            console.log('üîÑ Iniciando compilaci√≥n de Plan Local de Salud Completo...');
            
            const btn = event.target;
            const textoOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Compilando documentos...';
            
            try {
                // VALIDACIONES
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('La librer√≠a jsPDF no est√° cargada. Por favor, recarga la p√°gina.');
                }
                
                if (!state.perfilCargado) {
                    alert('‚ö†Ô∏è No se ha cargado el Perfil de Salud Local.\n\nPor favor:\n1. Ve al tab "Configuraci√≥n"\n2. Carga el PDF del Perfil de Salud\n3. Vuelve aqu√≠ para compilar');
                    btn.disabled = false;
                    btn.innerHTML = textoOriginal;
                    return;
                }
                
                if (!state.planGenerado || state.planGenerado.length === 0) {
                    alert('‚ö†Ô∏è No hay Plan de Acci√≥n generado.\n\nPor favor:\n1. Ve al tab "L√≠neas Estrat√©gicas"\n2. Selecciona objetivos y programas\n3. Genera el Plan de Acci√≥n\n4. Vuelve aqu√≠ para compilar');
                    btn.disabled = false;
                    btn.innerHTML = textoOriginal;
                    return;
                }
                
                console.log('‚úÖ Validaciones pasadas');
                
                // Crear el PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                let yPos = 20;
                const margen = 20;
                const anchoMaximo = 170;
                const altoLinea = 6;
                
                const agregarTexto = (texto, fontSize, negrita = false, color = [0, 0, 0]) => {
                    doc.setFontSize(fontSize);
                    doc.setTextColor(color[0], color[1], color[2]);
                    doc.setFont(undefined, negrita ? 'bold' : 'normal');
                    
                    const lineas = doc.splitTextToSize(texto, anchoMaximo);
                    
                    lineas.forEach(linea => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(linea, margen, yPos);
                        yPos += altoLinea;
                    });
                };
                
                const agregarEspacio = (cantidad = 1) => {
                    yPos += altoLinea * cantidad;
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                };
                
                // ===== PORTADA PRINCIPAL =====
                doc.setFontSize(26);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text('PLAN LOCAL DE SALUD', 105, 60, { align: 'center' });
                yPos = 80;
                
                doc.setFontSize(20);
                doc.setTextColor(118, 75, 162);
                doc.text('DOCUMENTO COMPLETO', 105, yPos, { align: 'center' });
                yPos += 25;
                
                doc.setFontSize(16);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                const nombreMunicipio = state.municipio.nombre || 'Municipio';
                doc.text(nombreMunicipio, 105, yPos, { align: 'center' });
                yPos += 12;
                
                if (state.municipio.provincia) {
                    doc.setFontSize(14);
                    doc.text(state.municipio.provincia, 105, yPos, { align: 'center' });
                    yPos += 10;
                }
                
                yPos = 150;
                doc.setFillColor(240, 240, 250);
                doc.rect(margen, yPos, anchoMaximo, 60, 'F');
                yPos += 10;
                
                doc.setFontSize(12);
                doc.setTextColor(102, 126, 234);
                doc.setFont(undefined, 'bold');
                doc.text('Este documento integra:', margen + 5, yPos);
                yPos += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);
                doc.text('1. Perfil de Salud Local', margen + 10, yPos);
                yPos += 7;
                doc.text('2. Plan de Acci√≥n (EPVSA 2024-2030)', margen + 10, yPos);
                yPos += 7;
                doc.text('3. Agendas Anuales RELAS', margen + 10, yPos);
                
                yPos = 240;
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                const fecha = new Date().toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                doc.text(fecha, 105, yPos, { align: 'center' });
                
                // ===== √çNDICE =====
                doc.addPage();
                yPos = 30;
                
                agregarTexto('√çNDICE', 20, true, [102, 126, 234]);
                agregarEspacio(2);
                
                agregarTexto('1. PERFIL DE SALUD LOCAL ................................................ 3', 12, false, [60, 60, 60]);
                agregarTexto('   Diagn√≥stico y Cuadro de Mandos Integral (58 Indicadores)', 10, false, [100, 100, 100]);
                agregarEspacio(1);
                
                agregarTexto('2. PLAN DE ACCI√ìN ........................................................... XX', 12, false, [60, 60, 60]);
                agregarTexto('   L√≠neas Estrat√©gicas, Objetivos, Indicadores, Programas y Actuaciones EPVSA', 10, false, [100, 100, 100]);
                agregarEspacio(1);
                
                agregarTexto('3. AGENDAS ANUALES RELAS ................................................ XX', 12, false, [60, 60, 60]);
                agregarTexto('   Actuaciones Registradas por Entornos', 10, false, [100, 100, 100]);
                
                // ===== DOCUMENTO 1: PERFIL DE SALUD =====
                doc.addPage();
                yPos = 20;
                
                agregarTexto('DOCUMENTO 1', 14, true, [102, 126, 234]);
                agregarTexto('PERFIL DE SALUD LOCAL', 20, true, [102, 126, 234]);
                agregarEspacio(2);
                
                // Incluir PDF completo si est√° disponible
                if (state.pdfData && state.pdfNumPages > 0 && typeof pdfjsLib !== 'undefined') {
                    try {
                        console.log('üìÑ Iniciando inclusi√≥n de PDF...');
                        btn.innerHTML = '‚è≥ Incluyendo Perfil de Salud (17 p√°ginas)...';
                        
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        const pdfDoc = await pdfjsLib.getDocument({ data: state.pdfData }).promise;
                        console.log(`‚úÖ PDF cargado: ${pdfDoc.numPages} p√°ginas`);
                        
                        for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                            console.log(`üìÑ Procesando p√°gina ${pageNum}/${pdfDoc.numPages}...`);
                            btn.innerHTML = `‚è≥ P√°gina ${pageNum}/${pdfDoc.numPages}...`;
                            
                            const page = await pdfDoc.getPage(pageNum);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            const imgData = canvas.toDataURL('image/jpeg', 0.95);
                            if (pageNum > 1) doc.addPage();
                            const imgWidth = 210;
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;
                            doc.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                            console.log(`‚úÖ P√°gina ${pageNum} incluida`);
                        }
                        console.log('‚úÖ PDF completo incluido');
                        btn.innerHTML = '‚è≥ Compilando documentos...';
                    } catch (error) {
                        console.error('‚ùå Error incluyendo PDF:', error);
                        console.error('Detalles del error:', error.message, error.stack);
                        agregarTexto('‚ö†Ô∏è Error al incluir el PDF completo', 11, true, [220, 38, 38]);
                        agregarTexto(`Error: ${error.message}`, 9, false, [220, 38, 38]);
                    }
                } else {
                    console.warn('‚ö†Ô∏è PDF no disponible:', {
                        hasPdfData: !!state.pdfData,
                        numPages: state.pdfNumPages,
                        hasPdfjsLib: typeof pdfjsLib !== 'undefined'
                    });
                    agregarTexto('‚ö†Ô∏è PDF del Perfil de Salud no disponible', 11, true, [220, 38, 38]);
                }
                
                // ===== DOCUMENTO 2: PLAN DE ACCI√ìN =====
                doc.addPage();
                yPos = 20;
                
                agregarTexto('DOCUMENTO 2', 14, true, [102, 126, 234]);
                agregarTexto('PLAN DE ACCI√ìN - EPVSA 2024-2030', 20, true, [102, 126, 234]);
                agregarEspacio(2);
                
                if (state.areaPrioritaria) {
                    doc.setFillColor(245, 87, 108);
                    doc.rect(margen, yPos - 5, anchoMaximo, 12, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('√ÅREA PRIORITARIA', margen + 3, yPos);
                    yPos += 7;
                    doc.setFontSize(11);
                    doc.text(state.areaPrioritaria, margen + 3, yPos);
                    yPos += 12;
                    doc.setTextColor(0, 0, 0);
                }
                
                agregarTexto('L√≠neas Estrat√©gicas y Programas Seleccionados:', 14, true, [102, 126, 234]);
                agregarEspacio(1);
                
                state.planGenerado.forEach((linea) => {
                    agregarEspacio(1);
                    doc.setFillColor(240, 240, 250);
                    doc.rect(margen - 2, yPos - 5, anchoMaximo + 4, 8, 'F');
                    agregarTexto(`L√çNEA ${linea.id}: ${linea.nombre.toUpperCase()}`, 12, true, [102, 126, 234]);
                    agregarEspacio(0.5);
                    
                    linea.objetivos.forEach((objetivo) => {
                        agregarTexto(`${objetivo.codigo} ${objetivo.nombre}`, 11, true, [0, 0, 0]);
                        
                        if (objetivo.indicadores && objetivo.indicadores.length > 0) {
                            agregarTexto('Indicadores:', 9, true, [80, 80, 80]);
                            objetivo.indicadores.forEach(ind => {
                                agregarTexto(`  ‚Ä¢ ${ind}`, 9, false, [60, 60, 60]);
                            });
                            agregarEspacio(0.3);
                        }
                        
                        if (objetivo.programas && objetivo.programas.length > 0) {
                            agregarTexto('Programas EPVSA:', 9, true, [16, 185, 129]);
                            objetivo.programas.forEach(programa => {
                                agregarTexto(`  ${programa.codigo} - ${programa.nombre}`, 9, true, [16, 185, 129]);
                                
                                if (programa.actuaciones && programa.actuaciones.length > 0) {
                                    agregarTexto('    Actuaciones:', 8, false, [80, 80, 80]);
                                    programa.actuaciones.forEach(act => {
                                        agregarTexto(`      ‚óã ${act}`, 8, false, [60, 60, 60]);
                                    });
                                }
                                agregarEspacio(0.3);
                            });
                        }
                        
                        agregarEspacio(0.5);
                    });
                });
                
                // ===== DOCUMENTO 3: AGENDA RELAS =====
                doc.addPage();
                yPos = 20;
                
                agregarTexto('DOCUMENTO 3', 14, true, [102, 126, 234]);
                agregarTexto('AGENDAS ANUALES RELAS', 20, true, [16, 185, 129]);
                agregarEspacio(2);
                
                const totalActuaciones = Object.values(state.actuaciones).reduce((sum, arr) => sum + arr.length, 0);
                
                if (totalActuaciones === 0) {
                    agregarTexto('No hay actuaciones RELAS registradas actualmente.', 11, false, [220, 38, 38]);
                    agregarTexto('Las actuaciones deben registrarse en el tab "Agendas Anuales".', 10, false, [100, 100, 100]);
                } else {
                    agregarTexto(`Total de actuaciones registradas: ${totalActuaciones}`, 11, true, [16, 185, 129]);
                    agregarTexto('(Organizadas por a√±o y entorno)', 10, false, [100, 100, 100]);
                    agregarEspacio(1);
                    
                    const anos = [2024, 2025, 2026, 2027, 2028, 2029, 2030];
                    const entornos = [
                        { key: 'sanitario', nombre: 'ENTORNO SANITARIO', icono: 'üè•' },
                        { key: 'comunitario', nombre: 'ENTORNO COMUNITARIO', icono: 'üåç' },
                        { key: 'educativo', nombre: 'ENTORNO EDUCATIVO', icono: 'üéì' },
                        { key: 'laboral', nombre: 'ENTORNO LABORAL', icono: 'üíº' }
                    ];
                    
                    // Iterar por cada a√±o
                    anos.forEach(ano => {
                        let tieneActuacionesEnAno = false;
                        
                        // Primero verificar si hay actuaciones en este a√±o
                        entornos.forEach(entorno => {
                            const key = `${entorno.key}-${ano}`;
                            const actuaciones = state.actuaciones[key] || [];
                            if (actuaciones.length > 0) {
                                tieneActuacionesEnAno = true;
                            }
                        });
                        
                        // Si hay actuaciones en este a√±o, mostrar el a√±o como encabezado
                        if (tieneActuacionesEnAno) {
                            agregarEspacio(2);
                            doc.setFillColor(102, 126, 234);
                            doc.rect(margen - 2, yPos - 5, anchoMaximo + 4, 10, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(14);
                            doc.setFont(undefined, 'bold');
                            doc.text(`üìÖ A√ëO ${ano}`, margen + 3, yPos + 2);
                            yPos += 12;
                            doc.setTextColor(0, 0, 0);
                            
                            // Ahora mostrar cada entorno dentro de este a√±o
                            entornos.forEach(entorno => {
                                const key = `${entorno.key}-${ano}`;
                                const actuaciones = state.actuaciones[key] || [];
                                
                                if (actuaciones.length > 0) {
                                    agregarEspacio(1);
                                    doc.setFillColor(240, 253, 244);
                                    doc.rect(margen - 2, yPos - 5, anchoMaximo + 4, 8, 'F');
                                    agregarTexto(`${entorno.icono} ${entorno.nombre} (${actuaciones.length} actuaciones)`, 11, true, [16, 185, 129]);
                                    agregarEspacio(0.5);
                                    
                                    actuaciones.forEach((act, idx) => {
                                        agregarTexto(`${idx + 1}. ${act.titulo || act.nombre}`, 10, true, [0, 0, 0]);
                                        if (act.descripcion) agregarTexto(`   ${act.descripcion}`, 9, false, [60, 60, 60]);
                                        if (act.responsablePrincipal) agregarTexto(`   Responsable: ${act.responsablePrincipal}`, 9, false, [60, 60, 60]);
                                        if (act.responsableEntidad) agregarTexto(`   Entidad: ${act.responsableEntidad}`, 9, false, [60, 60, 60]);
                                        if (act.fechaInicio || act.fechaFin) {
                                            const periodo = act.fechaInicio && act.fechaFin ? `${act.fechaInicio} - ${act.fechaFin}` : (act.fechaInicio || act.fechaFin);
                                            agregarTexto(`   Periodo: ${periodo}`, 9, false, [60, 60, 60]);
                                        }
                                        agregarEspacio(0.3);
                                    });
                                }
                            });
                        }
                    });
                }
                
                // Pie de p√°gina en todas las p√°ginas
                const totalPaginas = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPaginas; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`P√°gina ${i} de ${totalPaginas}`, 105, 290, { align: 'center' });
                    doc.text(`Plan Local de Salud - ${nombreMunicipio}`, margen, 290);
                }
                
                // Guardar el PDF
                const fechaArchivo = new Date().toISOString().split('T')[0];
                const nombreArchivo = `Plan_Local_Salud_COMPLETO_${nombreMunicipio.replace(/\s+/g, '_')}_${fechaArchivo}.pdf`;
                
                console.log('üíæ Guardando Plan Completo:', nombreArchivo);
                doc.save(nombreArchivo);
                console.log('‚úÖ Plan Completo guardado');
                
                // Mensaje de √©xito
                setTimeout(() => {
                    alert(`‚úÖ ¬°Plan Local de Salud Completo generado!\n\nArchivo: ${nombreArchivo}\n\nP√°ginas: ${totalPaginas}\n\nEl documento incluye:\n1. Perfil de Salud Local (conclusiones y recomendaciones)\n2. Plan de Acci√≥n completo (${state.planGenerado.length} l√≠neas)\n3. Agendas RELAS (${totalActuaciones} actuaciones)\n\nüìå Nota: Para incluir el PDF completo del Perfil de Salud, combina este documento con tu PDF original usando iLovePDF.com`);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error al compilar Plan Completo:', error);
                alert(`‚ùå Error al generar el Plan Completo:\n\n${error.message}\n\nDetalles en la consola del navegador (presiona F12).`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = textoOriginal;
            }
        }

    </script>
</body>
</html>